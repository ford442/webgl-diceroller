try{window||(self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}})}catch(e$$8){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}
(function(m,v,r,l,o){function q(a,c){if("object"!==typeof a)return g("enumerator validation failed, invalid type base object."),o;if(c===o)return o;if("number"===typeof c)return c;if("string"===typeof c){var h=parseInt(c,10);if(""!==c&&isFinite(h))return h;h=c.toUpperCase();h=a[h];if(h!==o)return h;g("enumerator validation failed, unknown enum value: "+c);var h="",b;for(b in a)a.hasOwnProperty(b)&&(""!==h&&(h+=", "),h+=b.toLowerCase());g("possible enum values are: "+h)}return o}var f="";try{for(var e=
v.querySelectorAll("script"),d=0,b=e.length;d<b;d++){var n=e[d].src.lastIndexOf("/CubicVR.js");-1<n&&(f=e[d].src.substr(0,n)+"/")}}catch(a){}var c=m.CubicVR={};c.contexts={};var g;try{g=void 0!==console&&console.log?function(a){console.log("CubicVR Log: "+a)}:function(){}}catch(h){g=l}var t={quality:{LOW:0,MEDIUM:1,HIGH:2},classType:{MESH:1,SCENEOBJECT:2,LIGHT:3,CAMERA:4,TEXTURE:5,IMAGE:6,MATERIAL:7,MOTION:8,SHADER:9,SCENE:10,CUSTOMSHADER:11,EVENT:12}};m.cubicvr=t;var F={},w=[1,0,0,0,0,1,0,0,0,0,
1,0,0,0,0,1],s=function(a){function h(a,c,g){var b=function(){};b.prototype=a.prototype;c.prototype=new b;for(var d in g)c.prototype[d]=g[d];return c}function b(){var a=v.createElement("menu");a.setAttribute("type","context");var c=v.createElement("menuitem");c.setAttribute("label","Enter full-screen");c.setAttribute("onclick","CubicVR.setFullScreen()");a.id="fullScreenMenu";a.appendChild(c);v.body.appendChild(a);z.canvas.setAttribute("contextmenu","fullScreenMenu")}function d(){}function n(a){(v.fullScreenEnabled||
!1===a)&&v.cancelFullScreen();!1!==a&&(a===o&&(a=c.getCanvas()),a.onwebkitfullscreenchange=d,a.onmozfullscreenchange=d,a.onfullscreenchange=d,a.webkitEnterFullScreen?a.webkitEnterFullScreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.requestFullscreen())}var e=this,s;a&&(s=a+"",Object.defineProperty(this,"context",{enumerable:!0,configurable:!1,get:function(){return s}}));e.undef=o;e.nop=l;e.scriptLocation=f;e.GLCore=z;e.Textures=[];e.Textures_obj=[];e.Textures_ref=[];e.Images=[];e.ShaderPool=
[];e.log=g;e.enums=c.enums;e.MAX_LIGHTS=8;e.extendClassGeneral=h;e.extendClass=function(a,c,g){return h(a,function(){a.apply(this);c.apply(this,arguments)},g)};e.features={};e.quality=c.enums.HIGH;var D={antiAlias:!1,lightPerPixel:!1,lightShadows:!1,texturePerPixel:!1,postProcess:!1},C={antiAlias:!1,lightPerPixel:!0,lightShadows:!1,texturePerPixel:!1,postProcess:!1},E={antiAlias:!0,lightPerPixel:!0,lightShadows:!0,texturePerPixel:!0,postProcess:!0};e.features=E;var z={CoreShader_vs:null,CoreShader_fs:null,
canvas:null,width:null,height:null,fixed_aspect:0,fixed_size:null,depth_alpha:!1,default_filter:1,mainloop:null,shadow_near:0.1,shadow_far:100,soft_shadow:!1,fogLinear:!1,fogExp:!1,fogNoise:!1,fogColor:[1,1,1],fogDensity:0,fogNear:0,fogFar:0,resize_active:!1,emptyLight:null,resizeList:[],canvasSizeFactor:1,extensions:{},init:function(a,h,g){var d,n=e.util,t=c.enums;if(h&&g){h=n.getScriptContents(h);g=n.getScriptContents(g)}else if(m.CubicVRShader.CubicVRCoreVS&&m.CubicVRShader.CubicVRCoreFS){h=m.CubicVRShader.CubicVRCoreVS;
g=m.CubicVRShader.CubicVRCoreFS}else{h=n.getScriptContents(f+"CubicVR_Core.vs");g=n.getScriptContents(f+"CubicVR_Core.fs")}if(a===o){a=v.createElement("canvas");a.style.background="black";if(!d)try{d=a.getContext("experimental-webgl",{antialias:e.features.antiAlias})}catch(s){return null}z.gl=d;if(z.fixed_size!==null){z.width=z.fixed_size[0];z.height=z.fixed_size[1];z.resizeElement(a,z.width,z.height)}else{z.addResizeable(a);if(z.canvasSizeFactor!==1&&a.getContext!==o){var n=r.round(m.innerWidth*
z.canvasSizeFactor),w=r.round(m.innerHeight*z.canvasSizeFactor);z.resizeElement(a,n,w);a.style.top=m.innerHeight/2-w/2+"px";a.style.left=m.innerWidth/2-n/2+"px";a.style.position="absolute"}else z.resizeElement(a,m.innerWidth,m.innerHeight)}v.body.appendChild(a)}if(a.getContext!==o&&a.width!==o&&a.height!==o){try{d||(d=a.getContext("experimental-webgl",{antialias:e.features.antiAlias}));d.viewport(0,0,a.width,a.height);z.canvas=a;z.width=a.width;z.height=a.height;d.clearColor(0,0,0,1);d.clearDepth(1);
d.enable(d.DEPTH_TEST);d.depthFunc(d.LEQUAL)}catch(F){}if(!d)return null}else d=a;z.gl=d;z.CoreShader_vs=h;z.CoreShader_fs=g;z.viewportWidth=z.width;z.viewportHeight=z.height;z.gl._viewport=z.gl.viewport;d.viewport=function(a){return function(c,h,g,b){a.viewportWidth=g;a.viewportHeight=b;a.gl._viewport(c,h,g,b)}}(z);d.enable(d.CULL_FACE);d.cullFace(d.BACK);d.frontFace(d.CCW);d.getSupportedExtensions();z.extensions.texture_filter_anisotropic=d.getExtension("EXT_texture_filter_anisotropic");z.extensions.element_index_uint=
d.getExtension("OES_element_index_uint");z.extensions.standard_derivatives=d.getExtension("OES_standard_derivatives");z.extensions.texture_float=d.getExtension("OES_texture_float");z.extensions.texture_float_linear=d.getExtension("OES_texture_float_linear");z.extensions.compressed_texture_s3tc=d.getExtension("WEBGL_compressed_texture_s3tc");for(a=c.enums.light.type.NULL;a<t.light.type.MAX;a++)e.ShaderPool[a]=[];new e.Texture;a=z.emptyLight=new e.Light(t.light.type.POINT);a.diffuse=[0,0,0];a.specular=
[0,0,0];a.distance=0;a.intensity=0;a.cutoff=0;for(a=t.light.type.NULL;a<t.light.type.MAX;a++)e.ShaderPool[a]=[];if(z.resizeList.length){m.addEventListener("resize",function(){e.GLCore.onResize()},false);z.resize_active=true}b();return d},addResizeable:function(a){e.GLCore.resizeList.push(a)},onResize:function(){var a=m.innerWidth,c=m.innerHeight;if(z.fixed_size!==null){a=e.GLCore.fixed_size[0];c=e.GLCore.fixed_size[1]}for(var h=0,g=e.GLCore.resizeList.length;h<g;h++)z.resizeElement(e.GLCore.resizeList[h],
a,c)},setFixedAspect:function(a){e.GLCore.fixed_aspect=a},setFixedSize:function(a,c){e.GLCore.fixed_size=[a,c]},getCanvas:function(){return e.GLCore.canvas},resizeElement:function(a,c,h){var g=z.gl;if(z.fixed_aspect!==0){var b=c*(1/e.GLCore.fixed_aspect);if(b>h){b=h;c=h*e.GLCore.fixed_aspect}h=b}if(a.getContext!==o){a.width=c;a.height=h;if(!e.GLCore.fixed_size){a.style.left=(m.innerWidth/2-c/2|0)+"px";a.style.top=(m.innerHeight/2-h/2|0)+"px";a.style.position="absolute"}g.viewport(0,0,c,h)}else a.resize(c,
h)},setDepthAlpha:function(a,c,h){z.depth_alpha=a;z.depth_alpha_near=c;z.depth_alpha_far=h},setDefaultFilter:function(a){z.default_filter=q(e.enums.texture.filter,a)},setSoftShadows:function(a){z.soft_shadow=a},setFog:function(a){z.fog_enabled=a},setFogExp:function(a,c){z.fog_enabled=true;z.fogLinear=false;z.fogExp=true;z.fogColor=a;z.fogDensity=c},setNoise:function(a){z.fogNoise=a},setFogLinear:function(a,c,h){z.fog_enabled=true;z.fogExp=false;z.fogLinear=true;z.fogColor=a;z.fogNear=c;z.fogFar=h},
setCanvasSizeFactor:function(a){z.canvasSizeFactor=a},setQuality:function(a){a=q(t.quality,a);if(a===t.quality.HIGH)e.features=E;else if(a===t.quality.MEDIUM)e.features=C;else if(a===t.quality.LOW)e.features=D;e.quality=a;return e.features},getQuality:function(){return e.features}},J=function(a,c,h){for(var g,d=v.getElementsByTagName("script"),n=0;n<d.length;++n){var f=d[n];if(f.getAttribute("data-cubicvr")){var t=f.getAttribute("src");if(t){var s=new XMLHttpRequest;s.open("GET",t,false);s.send(null);
if(s.status===200||s.status===0)f.text=s.responseText}}}if(typeof a==="object"){a.quality&&z.setQuality(a.quality);if(a.getContext)g=a;else{g=a.canvas;c=a.vertexShader||c;h=a.fragmentShader||h}}else if(a){a[0]=="#"&&(a=a.substr(1));g=v.getElementById(a)}for(var w in F){var a=F[w](e),l;for(l in a)a.hasOwnProperty(l)&&(e[l]=a[l])}z.init(g,c,h);b();return z.gl};e.GLCore=z;e.setFullScreen=n;e.init=J;e.start=function(a,c,h,g,b){typeof a==="string"&&a.toLowerCase()==="auto"&&(a=o);h=h||"Sorry, your browser does not appear to support WebGL :-(";
if(a=J(a,g,b)){c&&typeof c==="function"&&c(a,e.getCanvas());return a}if(!a){h&&typeof h==="function"?h():alert(h);return false}};e.addResizeable=z.addResizeable;e.setFixedAspect=z.setFixedAspect;e.setFixedSize=z.setFixedSize;e.setCanvasSizeFactor=z.setCanvasSizeFactor;e.getCanvas=z.getCanvas;e.enums=t;e.IdentityMatrix=w;e.Textures=e.Textures;e.Textures_obj=e.Textures_obj;e.Images=e.Images;e.globalAmbient=[0.1,0.1,0.1];e.setGlobalAmbient=function(a){e.globalAmbient=a};e.setGlobalDepthAlpha=z.setDepthAlpha;
e.setDefaultFilter=z.setDefaultFilter;e.setSoftShadows=z.setSoftShadows;e.setQuality=z.setQuality;e.getQuality=z.getQuality;e.RegisterModule=c.RegisterModule;e.getScriptLocation=c.getScriptLocation;e.setFogExp=z.setFogExp;e.setFogLinear=z.setFogLinear;e.setFogNoise=z.setFogNoise;e.parseEnum=q;e.setFullScreen=n};c.init=function(a,h,g){var b;a&&(a.context&&"string"===typeof a.context)&&(b=a.context);b=new s(b);if(b.context)return c.contexts[b.context]=b,b.init(a,h,g),b;m.CubicVR=c=b;b.init(a,h,g);return b.GLCore.gl};
c.start=function(a,h,g,b,d){var n=new s;m.CubicVR=c=n;n.start(a,h,g,b,d);return n};c.RegisterModule=function(a,c){F[a]=c};c.getScriptLocation=function(){return f};c.enums=t})(window,window.document,Math,function(){});window.CubicVRShader={};
CubicVR.RegisterModule("Math",function(m){function v(a){return this.clearStack(a)}function r(){1===arguments.length&&(this.x=arguments[0][0],this.y=arguments[0][1],this.z=arguments[0][2],this.w=arguments[0][3]);4===arguments.length&&(this.x=arguments[0],this.y=arguments[1],this.z=arguments[2],this.w=arguments[3])}function l(){this.last_in=[];this._planes=[];this.sphere=null;for(var a=0;6>a;++a)this._planes[a]=[0,0,0,0]}var o=m.undef,q=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],f=Math.PI/2,e=m.enums;e.aabb=
{DISJOINT:0,A_INSIDE_B:1,B_INSIDE_A:2,INTERSECT:3};e.frustum_plane={LEFT:0,RIGHT:1,TOP:2,BOTTOM:3,NEAR:4,FAR:5};var d={length:function(a,c){var g,h,b;c===o?(g=a[0],h=a[1],b=a[2]):(g=c[0]-a[0],h=c[1]-a[1],b=c[2]-a[2]);return Math.sqrt(g*g+h*h+b*b)},normalize:function(a){var c=a[0],g=a[1],h=a[2];return(c=Math.sqrt(c*c+g*g+h*h))?[a[0]/c,a[1]/c,a[2]/c]:[0,0,0]},dot:function(a,c){return a[0]*c[0]+a[1]*c[1]+a[2]*c[2]},angle:function(a,c){return Math.acos((a[0]*c[0]+a[1]*c[1]+a[2]*c[2])/(Math.sqrt(a[0]*
a[0]+a[1]*a[1]+a[2]*a[2])*Math.sqrt(c[0]*c[0]+c[1]*c[1]+c[2]*c[2])))},cross:function(a,c){return[a[1]*c[2]-c[1]*a[2],a[2]*c[0]-c[2]*a[0],a[0]*c[1]-c[0]*a[1]]},multiply:function(a,c){return[a[0]*c,a[1]*c,a[2]*c]},add:function(a,c){return[a[0]+c[0],a[1]+c[1],a[2]+c[2]]},subtract:function(a,c){return[a[0]-c[0],a[1]-c[1],a[2]-c[2]]},equal:function(a,c,g){g===o&&(g=1.0E-7);return a===o&&c===o?!0:a===o||c===o?!1:Math.abs(a[0]-c[0])<g&&Math.abs(a[1]-c[1])<g&&Math.abs(a[2]-c[2])<g},moveViewRelative:function(a,
c,g,h,b){var d=Math.atan2(h,g),c=Math.atan2(c[2]-a[2],c[0]-a[0]),g=Math.sqrt(g*g+h*h),d=c+d+f;return"object"===typeof b?[b[0]+g*Math.cos(d),b[1],b[2]+g*Math.sin(d)]:[a[0]+g*Math.cos(d),a[1],a[2]+g*Math.sin(d)]},trackTarget:function(a,c,g,h){var c=d.subtract(c,a),b=d.length(c),n;n=d.normalize(c);n=d.multiply(n,g*(1/(1/(b-h))));b>h?a=d.add(a,n):b<h?(n=d.normalize(c),n=d.multiply(n,g*(1/(1/Math.abs(b-h)))),a=d.subtract(a,n)):a=[a[0],a[1]+n[2],a[2]];return a},getClosestTo:function(a,c,g){c=d.subtract(c,
a);g=d.subtract(g,a);return d.add(d.multiply(c,d.dot(c,g)/d.dot(c,c)),a)},linePlaneIntersect:function(a,c,g,h){var b=-a[0]*c[0]-a[1]*c[1]-a[2]*c[2],c=a[0]*(h[0]-g[0])+a[1]*(h[1]-g[1])+a[2]*(h[2]-g[2]);if(0.001>Math.abs(c))return!1;a=-(b+a[0]*g[0]+a[1]*g[1]+a[2]*g[2])/c;return[g[0]+a*(h[0]-g[0]),g[1]+a*(h[1]-g[1]),g[2]+a*(h[2]-g[2])]}},b={lookat:function(a,c,g,h,b,n,e,f,l){var o=[],q=[],r=[],q=[];o[0]=h-a;o[1]=b-c;o[2]=n-g;r[0]=e;r[1]=f;r[2]=l;o=d.normalize(o);q=d.cross(o,r);q=d.normalize(q);r=d.cross(q,
o);q=[q[0],r[0],-o[0],0,q[1],r[1],-o[1],0,q[2],r[2],-o[2],0,0,0,0,1];h=new m.Transform(q);h.translate([-a,-c,-g]);return h.getResult()},multiply:function(a,c,g){g===o&&(g=[]);g[0]=a[0]*c[0]+a[4]*c[1]+a[8]*c[2]+a[12]*c[3];g[1]=a[1]*c[0]+a[5]*c[1]+a[9]*c[2]+a[13]*c[3];g[2]=a[2]*c[0]+a[6]*c[1]+a[10]*c[2]+a[14]*c[3];g[3]=a[3]*c[0]+a[7]*c[1]+a[11]*c[2]+a[15]*c[3];g[4]=a[0]*c[4]+a[4]*c[5]+a[8]*c[6]+a[12]*c[7];g[5]=a[1]*c[4]+a[5]*c[5]+a[9]*c[6]+a[13]*c[7];g[6]=a[2]*c[4]+a[6]*c[5]+a[10]*c[6]+a[14]*c[7];g[7]=
a[3]*c[4]+a[7]*c[5]+a[11]*c[6]+a[15]*c[7];g[8]=a[0]*c[8]+a[4]*c[9]+a[8]*c[10]+a[12]*c[11];g[9]=a[1]*c[8]+a[5]*c[9]+a[9]*c[10]+a[13]*c[11];g[10]=a[2]*c[8]+a[6]*c[9]+a[10]*c[10]+a[14]*c[11];g[11]=a[3]*c[8]+a[7]*c[9]+a[11]*c[10]+a[15]*c[11];g[12]=a[0]*c[12]+a[4]*c[13]+a[8]*c[14]+a[12]*c[15];g[13]=a[1]*c[12]+a[5]*c[13]+a[9]*c[14]+a[13]*c[15];g[14]=a[2]*c[12]+a[6]*c[13]+a[10]*c[14]+a[14]*c[15];g[15]=a[3]*c[12]+a[7]*c[13]+a[11]*c[14]+a[15]*c[15];return g},vec4_multiply:function(a,c,g){g===o&&(g=[]);g[0]=
c[0]*a[0]+c[4]*a[1]+c[8]*a[2]+c[12]*a[3];g[1]=c[1]*a[0]+c[5]*a[1]+c[9]*a[2]+c[13]*a[3];g[2]=c[2]*a[0]+c[6]*a[1]+c[10]*a[2]+c[14]*a[3];g[3]=c[3]*a[0]+c[7]*a[1]+c[11]*a[2]+c[15]*a[3];return g},vec3_multiply:function(a,c,g){g===o&&(g=[]);g[0]=c[0]*a[0]+c[4]*a[1]+c[8]*a[2]+c[12];g[1]=c[1]*a[0]+c[5]*a[1]+c[9]*a[2]+c[13];g[2]=c[2]*a[0]+c[6]*a[1]+c[10]*a[2]+c[14];return g},perspective:function(a,c,g,h){a=Math.tan(a*Math.PI/360);return[1/(a*c),0,0,0,0,1/a,0,0,0,0,-(h+g)/(h-g),-1,0,0,-(2*h*g)/(h-g),0]},ortho:function(a,
c,g,h,b,d){return[2/(c-a),0,0,0,0,2/(h-g),0,0,0,0,-2/(d-b),0,-(a+c)/(c-a),-(h+g)/(h-g),-(d+b)/(d-b),1]},determinant:function(a){return(a[0]*a[5]-a[1]*a[4])*(a[10]*a[15]-a[11]*a[14])-(a[0]*a[6]-a[2]*a[4])*(a[9]*a[15]-a[11]*a[13])+(a[0]*a[7]-a[3]*a[4])*(a[9]*a[14]-a[10]*a[13])+(a[1]*a[6]-a[2]*a[5])*(a[8]*a[15]-a[11]*a[12])-(a[1]*a[7]-a[3]*a[5])*(a[8]*a[14]-a[10]*a[12])+(a[2]*a[7]-a[3]*a[6])*(a[8]*a[13]-a[9]*a[12])},coFactor:function(){},transpose:function(a){return[a[0],a[4],a[8],a[12],a[1],a[5],a[9],
a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]},inverse_mat3:function(a){var c=[],g=a[0],h=a[1],b=a[2],d=a[4],n=a[5],e=a[6],f=a[8],l=a[9],a=a[10],o=a*n-e*l,m=-a*d+e*f,u=l*d-n*f,q=g*o+h*m+b*u;if(!q)return null;q=1/q;c[0]=o*q;c[1]=(-a*h+b*l)*q;c[2]=(e*h-b*n)*q;c[3]=m*q;c[4]=(a*g-b*f)*q;c[5]=(-e*g+b*d)*q;c[6]=u*q;c[7]=(-l*g+h*f)*q;c[8]=(n*g-h*d)*q;return c},inverse:function(a,c){var g=a[0]*a[5]-a[1]*a[4],h=a[0]*a[6]-a[2]*a[4],b=a[0]*a[7]-a[3]*a[4],d=a[1]*a[6]-a[2]*a[5],n=a[1]*a[7]-a[3]*a[5],e=a[2]*
a[7]-a[3]*a[6],f=a[8]*a[13]-a[9]*a[12],l=a[8]*a[14]-a[10]*a[12],m=a[8]*a[15]-a[11]*a[12],q=a[9]*a[14]-a[10]*a[13],u=a[9]*a[15]-a[11]*a[13],x=a[10]*a[15]-a[11]*a[14],r=g*x-h*u+b*q+d*m-n*l+e*f;return 0!==r?(c===o&&(c=[]),c[0]=0+a[5]*x-a[6]*u+a[7]*q,c[4]=0-a[4]*x+a[6]*m-a[7]*l,c[8]=0+a[4]*u-a[5]*m+a[7]*f,c[12]=0-a[4]*q+a[5]*l-a[6]*f,c[1]=0-a[1]*x+a[2]*u-a[3]*q,c[5]=0+a[0]*x-a[2]*m+a[3]*l,c[9]=0-a[0]*u+a[1]*m-a[3]*f,c[13]=0+a[0]*q-a[1]*l+a[2]*f,c[2]=0+a[13]*e-a[14]*n+a[15]*d,c[6]=0-a[12]*e+a[14]*b-a[15]*
h,c[10]=0+a[12]*n-a[13]*b+a[15]*g,c[14]=0-a[12]*d+a[13]*h-a[14]*g,c[3]=0-a[9]*e+a[10]*n-a[11]*d,c[7]=0+a[8]*e-a[10]*b+a[11]*h,c[11]=0-a[8]*n+a[9]*b-a[11]*g,c[15]=0+a[8]*d-a[9]*h+a[10]*g,g=1/r,c[0]*=g,c[1]*=g,c[2]*=g,c[3]*=g,c[4]*=g,c[5]*=g,c[6]*=g,c[7]*=g,c[8]*=g,c[9]*=g,c[10]*=g,c[11]*=g,c[12]*=g,c[13]*=g,c[14]*=g,c[15]*=g,c):null},identity:function(a){if(a==o)return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=
0;a[14]=0;a[15]=1},translate:function(a,c,g,h){a=[1,0,0,0,0,1,0,0,0,0,1,0,a,c,g,1];if(h===o)return a;b.multiply(h.slice(0),a,h)},rotateAxis:function(a,c,g,h,d){var n=Math.sin(a*(Math.PI/180)),a=Math.cos(a*(Math.PI/180)),c=[a+c*c*(1-a),c*g*(1-a)-h*n,c*h*(1-a)+g*n,0,g*c*(1-a)+h*n,a+g*g*(1-a),g*h*(1-a)-c*n,0,h*c*(1-a)-g*n,h*g*(1-a)+c*n,a+h*h*(1-a),0,0,0,0,1];if(d===o)return c;b.multiply(d.slice(0),c,d)},rotate:function(a,c,g,h){var d;h===o&&(h=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);0!==g&&(d=Math.sin(g*
(Math.PI/180)),g=Math.cos(g*(Math.PI/180)),b.multiply(h.slice(0),[g,d,0,0,-d,g,0,0,0,0,1,0,0,0,0,1],h));0!==c&&(d=Math.sin(c*(Math.PI/180)),g=Math.cos(c*(Math.PI/180)),b.multiply(h.slice(0),[g,0,-d,0,0,1,0,0,d,0,g,0,0,0,0,1],h));0!==a&&(d=Math.sin(a*(Math.PI/180)),g=Math.cos(a*(Math.PI/180)),b.multiply(h.slice(0),[1,0,0,0,0,g,d,0,0,-d,g,0,0,0,0,1],h));return h},scale:function(a,c,g,h){if(h===o)return[a,0,0,0,0,c,0,0,0,0,g,0,0,0,0,1];b.multiply(h.slice(0),[a,0,0,0,0,c,0,0,0,0,g,0,0,0,0,1],h)},transform:function(a,
c,g){var h=b.identity();a&&b.translate(a[0],a[1],a[2],h);c&&(0===c[0]&&0===c[1]&&0===c[2]||b.rotate(c[0],c[1],c[2],h));g&&(1===g[0]&&1===g[1]&&1===g[2]||b.scale(g[0],g[1],g[2],h));return h}};v.prototype={setIdentity:function(){this.m_stack[this.c_stack]=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},getIdentity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},invalidate:function(){this.valid=0;this.result=null;return this},getResult:function(){var a=
m.mat4;if(!this.c_stack)return this.m_stack[0];var c=q;this.valid>this.c_stack-1&&(this.valid=this.c_stack-1);for(var g=this.valid;g<this.c_stack+1;g++)c=a.multiply(c,this.m_stack[g]),this.m_cache[g]=c;this.valid=this.c_stack-1;return this.result=this.m_cache[this.c_stack]},pushMatrix:function(a){this.c_stack++;this.m_stack[this.c_stack]=a?a:q;return this},popMatrix:function(){if(0!==this.c_stack)return this.c_stack--,this},clearStack:function(a){this.m_stack=[];this.m_cache=[];this.valid=this.c_stack=
0;this.result=null;a!==o?this.m_stack[0]=a:this.setIdentity();return this},translate:function(a,c,g){var h=m.mat4;if("object"===typeof a)return this.translate(a[0],a[1],a[2]);var b=this.getIdentity();b[12]=a;b[13]=c;b[14]=g;this.m_stack[this.c_stack]=h.multiply(this.m_stack[this.c_stack],b);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},scale:function(a,c,g){var h=m.mat4;if("object"===typeof a)return this.scale(a[0],a[1],a[2]);var b=this.getIdentity();b[0]=a;b[5]=c;b[10]=g;this.m_stack[this.c_stack]=
h.multiply(this.m_stack[this.c_stack],b);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},rotate:function(a,c,g,h){var b=m.mat4;if("object"===typeof a)return this.rotate(a[0],1,0,0),this.rotate(a[1],0,1,0),this.rotate(a[2],0,0,1),this;var d,n;if(c||g||h)d=Math.sin(-a*(Math.PI/180)),n=Math.cos(-a*(Math.PI/180));c&&(a=this.getIdentity(),a[5]=n*c,a[9]=d*c,a[6]=-d*c,a[10]=n*c,this.m_stack[this.c_stack]=b.multiply(a,this.m_stack[this.c_stack]));g&&(c=this.getIdentity(),c[0]=n*g,c[8]=
-d*g,c[2]=d*g,c[10]=n*g,this.m_stack[this.c_stack]=b.multiply(c,this.m_stack[this.c_stack]));h&&(g=this.getIdentity(),g[0]=n*h,g[4]=d*h,g[1]=-d*h,g[5]=n*h,this.m_stack[this.c_stack]=b.multiply(g,this.m_stack[this.c_stack]));this.valid===this.c_stack&&this.c_stack&&this.valid--;return this}};r.prototype={length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var a=Math.sqrt(this.length());this.x/=a;this.y/=a;this.z/=a;this.w/=a},fromMatrix:function(a){var c=
1+a[0]+a[5]+a[10],g,h,b;1.0E-8<c?(g=2*Math.sqrt(c),c=(a[9]-a[6])/g,h=(a[2]-a[8])/g,b=(a[4]-a[1])/g,a=0.25*g):a[0]>a[5]&&a[0]>a[10]?(g=2*Math.sqrt(1+a[0]-a[5]-a[10]),c=0.25*g,h=(a[4]+a[1])/g,b=(a[2]+a[8])/g,a=(a[9]-a[6])/g):a[5]>a[10]?(g=2*Math.sqrt(1+a[5]-a[0]-a[10]),c=(a[4]+a[1])/g,h=0.25*g,b=(a[9]+a[6])/g,a=(a[2]-a[8])/g):(g=2*Math.sqrt(1+a[10]-a[0]-a[5]),c=(a[2]+a[8])/g,h=(a[9]+a[6])/g,b=0.25*g,a=(a[4]-a[1])/g);this.x=c;this.y=h;this.z=b;this.w=a},fromEuler:function(a,c,g){var h=Math.cos(Math.PI/
180*c/2),c=Math.sin(Math.PI/180*c/2),b=Math.cos(Math.PI/180*g/2),g=Math.sin(Math.PI/180*g/2),d=Math.cos(Math.PI/180*a/2),a=Math.sin(Math.PI/180*a/2),n=h*b,e=c*g;this.w=n*d-e*a;this.x=n*a+e*d;this.y=c*b*d+h*g*a;this.z=h*g*d-c*b*a},toEuler:function(){var a=this.w*this.w,c=this.x*this.x,g=this.y*this.y,h=this.z*this.z,b=180/Math.PI*Math.atan2(2*(this.y*this.z+this.x*this.w),-c-g+h+a),d=180/Math.PI*Math.asin(-2*(this.x*this.z-this.y*this.w)),a=180/Math.PI*Math.atan2(2*(this.x*this.y+this.z*this.w),c-
g-h+a);return[b,d,a]},multiply:function(a,c){c===o&&(c=a,a=this);return new r(a.x*c.w+a.w*c.x+a.y*c.z-a.z*c.y,a.y*c.w+a.w*c.y+a.z*c.x-a.x*c.z,a.z*c.w+a.w*c.z+a.x*c.y-a.y*c.x,a.w*c.w-a.x*c.x-a.y*c.y-a.z*c.z)}};var n={classifyPoint:function(a,c){var g=a[0]*c[0]+a[1]*c[1]+a[2]*c[2]+a[3];return 0>g?-1:0<g?1:0},normalize:function(a){var c=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);a[0]/=c;a[1]/=c;a[2]/=c;a[3]/=c}};l.prototype.extract=function(a,c,g){var h=m.mat4,b=m.vec3;if(!(c===o||g===o)){h=h.multiply(g,
c);c=this._planes;c[e.frustum_plane.LEFT][0]=h[3]+h[0];c[e.frustum_plane.LEFT][1]=h[7]+h[4];c[e.frustum_plane.LEFT][2]=h[11]+h[8];c[e.frustum_plane.LEFT][3]=h[15]+h[12];c[e.frustum_plane.RIGHT][0]=h[3]-h[0];c[e.frustum_plane.RIGHT][1]=h[7]-h[4];c[e.frustum_plane.RIGHT][2]=h[11]-h[8];c[e.frustum_plane.RIGHT][3]=h[15]-h[12];c[e.frustum_plane.TOP][0]=h[3]-h[1];c[e.frustum_plane.TOP][1]=h[7]-h[5];c[e.frustum_plane.TOP][2]=h[11]-h[9];c[e.frustum_plane.TOP][3]=h[15]-h[13];c[e.frustum_plane.BOTTOM][0]=h[3]+
h[1];c[e.frustum_plane.BOTTOM][1]=h[7]+h[5];c[e.frustum_plane.BOTTOM][2]=h[11]+h[9];c[e.frustum_plane.BOTTOM][3]=h[15]+h[13];c[e.frustum_plane.NEAR][0]=h[3]+h[2];c[e.frustum_plane.NEAR][1]=h[7]+h[6];c[e.frustum_plane.NEAR][2]=h[11]+h[10];c[e.frustum_plane.NEAR][3]=h[15]+h[14];c[e.frustum_plane.FAR][0]=h[3]-h[2];c[e.frustum_plane.FAR][1]=h[7]-h[6];c[e.frustum_plane.FAR][2]=h[11]-h[10];c[e.frustum_plane.FAR][3]=h[15]-h[14];for(var d=0;6>d;++d)n.normalize(c[d]);d=-c[e.frustum_plane.NEAR][3];c=c[e.frustum_plane.FAR][3]-
d;g=c*(1/g[5]);g=b.subtract([0,0,d+0.5*c],[g,g,d+c]);g=b.length(g);h=[h[3],h[9],h[10]];d=b.length(h);h=b.multiply(h,1/d);a=[a.position[0],a.position[1],a.position[2]];a=b.add(a,b.multiply(h,0.5*c));a=b.add(a,b.multiply(h,1));this.sphere=[a[0],a[1],a[2],g]}};l.prototype.contains_sphere=function(a){for(var c=m.vec3,g=this._planes,h=0;6>h;++h){var b=g[h],b=c.dot([b[0],b[1],b[2]],[a[0],a[1],a[2]])+b[3];this.last_in[h]=1;if(b<-a[3])return-1;if(Math.abs(b)<a[3])return 0}return 1};l.prototype.draw_on_map=
function(a,c){var g=a.width/2,h=a.height/2;c.save();for(var b=this._planes,d=[0,1,4,5],n=0,e=d.length;n<e;++n){var f=b[d[n]];c.strokeStyle="#FF00FF";n<this.last_in.length&&this.last_in[n]&&(c.strokeStyle="#FFFF00");var l=-g,o=g,m=(-f[3]-f[0]*o)/f[2];c.moveTo(g+l,h+(-f[3]-f[0]*l)/f[2]);c.lineTo(g+o,h+m);c.stroke()}c.strokeStyle="#0000FF";c.beginPath();c.arc(g+this.sphere[0],h+this.sphere[2],this.sphere[3],0,2*Math.PI,!1);c.closePath();c.stroke();c.restore()};l.prototype.contains_box=function(a){var c=
0,g=[];g[0]=a[0];g[1]=[a[0][0],a[0][1],a[1][2]];g[2]=[a[0][0],a[1][1],a[0][2]];g[3]=[a[0][0],a[1][1],a[1][2]];g[4]=[a[1][0],a[0][1],a[0][2]];g[5]=[a[1][0],a[0][1],a[1][2]];g[6]=[a[1][0],a[1][1],a[0][2]];g[7]=a[1];for(var a=this._planes,h=0;6>h;++h){for(var b=8,d=1,e=0;8>e;++e)-1===n.classifyPoint(a[h],g[e])&&(d=0,--b);this.last_in[h]=d;if(0===b)return-1;c+=d}return 6===c?1:0};return{vec2:{equal:function(a,c,g){g===o&&(g=1.0E-8);return a===o&&c===o?!0:a===o||c===o?!1:Math.abs(a[0]-c[0])<g&&Math.abs(a[1]-
c[1])<g},onLine:function(a,c,g){var h=a[1]<c[1]?a[1]:c[1],b=a[0]>c[0]?a[0]:c[0],d=a[1]>c[1]?a[1]:c[1];return(a[0]<c[0]?a[0]:c[0])<=g[0]&&g[0]<=b&&h<=g[1]&&g[1]<=d?!0:!1},lineIntersect:function(a,c,g,h){var b=a[0],a=a[1],d=c[0],c=c[1],n=g[0],g=g[1],e=h[0],h=h[1],f=(b-d)*(g-h)-(a-c)*(n-e);return 0===f?!1:[((n-e)*(b*c-a*d)-(b-d)*(n*h-g*e))/f,((g-h)*(b*c-a*d)-(a-c)*(n*h-g*e))/f]},add:function(a,c){return[a[0]+c[0],a[1]+c[1]]},subtract:function(a,c){return[a[0]-c[0],a[1]-c[1]]},length:function(a,c){if(c===
o)return Math.sqrt(a[0]*a[0]+a[1]*a[1]);var g=[a[0]-c[0],a[1]-c[1]];return Math.sqrt(g[0]*g[0]+g[1]*g[1])}},vec3:d,mat3:{transpose_inline:function(a){var c=a[1],g=a[2],h=a[5];a[1]=a[3];a[2]=a[6];a[3]=c;a[5]=a[7];a[6]=g;a[7]=h},vec3_multiply:function(a,c,g){g===o&&(g=[]);g[0]=c[0]*a[0]+c[3]*a[1]+c[6]*a[2];g[1]=c[1]*a[0]+c[4]*a[1]+c[7]*a[2];g[2]=c[2]*a[0]+c[5]*a[1]+c[8]*a[2];return g}},mat4:b,aabb:{engulf:function(a,c){a[0][0]>c[0]&&(a[0][0]=c[0]);a[0][1]>c[1]&&(a[0][1]=c[1]);a[0][2]>c[2]&&(a[0][2]=
c[2]);a[1][0]<c[0]&&(a[1][0]=c[0]);a[1][1]<c[1]&&(a[1][1]=c[1]);a[1][2]<c[2]&&(a[1][2]=c[2])},reset:function(a,c){void 0===c&&(c=[0,0,0]);a[0][0]=c[0];a[0][1]=c[1];a[0][2]=c[2];a[1][0]=c[0];a[1][1]=c[1];a[1][2]=c[2]},size:function(a){return[a[0][0]<a[1][0]?a[1][0]-a[0][0]:a[0][0]-a[1][0],a[0][1]<a[1][1]?a[1][1]-a[0][1]:a[0][1]-a[1][1],a[0][2]<a[1][2]?a[1][2]-a[0][2]:a[0][2]-a[1][2]]},intersects:function(a,c){return a[0][0]>c[1][0]||a[1][0]<c[0][0]||a[0][1]>c[1][1]||a[1][1]<c[0][1]||a[0][2]>c[1][2]||
a[1][2]<c[0][2]?e.aabb.DISJOINT:a[0][0]>=c[0][0]&&a[1][0]<=c[1][0]&&a[0][1]>=c[0][1]&&a[1][1]<=c[1][1]&&a[0][2]>=c[0][2]&&a[1][2]<=c[1][2]?e.aabb.A_INSIDE_B:c[0][0]>=a[0][0]&&c[1][0]<=a[1][0]&&c[0][1]>=a[0][1]&&c[1][1]<=a[1][1]&&c[0][2]>=a[0][2]&&c[1][2]<=a[1][2]?e.aabb.B_INSIDE_A:e.aabb.INTERSECT}},plane:n,sphere:{intersects:function(a,c){var g=m.vec3.subtract([a[0],a[1],a[2]],[c[0],c[1],c[2]]),g=Math.sqrt(g[0]*g[0]+g[1]*g[1]+g[2]*g[2]),h=a[3]+c[3];return g*g<h*h?!0:!1}},triangle:{normal:function(a,
c,g,h){h===o&&(h=[]);var b=a[0]-c[0],d=a[1]-c[1],a=a[2]-c[2],n=c[0]-g[0],e=c[1]-g[1],c=c[2]-g[2];h[0]=d*c-a*e;h[1]=a*n-b*c;h[2]=b*e-d*n;return h}},Transform:v,Quaternion:r,Frustum:l}});
CubicVR.RegisterModule("Utility",function(m){var v=m.undef,r=m.log,l={},o={},q={multiSplit:function(f,e){for(var d=f.split(e[0]),b=1,n=e.length;b<n;b++)for(var a=e[b],c=0,g=d.length;c<g;c++){var h=d[c].trim().split(a),t=!0;if(1<h.length)for(var l=0;l<h.length;l++)""!==h[l].trim()&&(d.splice(c+l,0===l?1:0,h[l]),l&&g++,t=!1);else d[c]=d[c].trim().replace(a,""),""!==d[c]&&(t=!1);t&&(d.splice(c,1),g--,c--)}return d},getJSONScriptObj:function(f,e){if("string"===typeof f&&0<f.length&&"#"===f.charAt(0)){var d=
document.getElementById(f.substr(1));if(d)return d=JSON.parse(d.innerHTML||d.text),e&&e(d),d}return f},getScriptContents:function(f){var e=document.getElementById(f),d="",b="";if(e){if(""!==e.src||e.attributes.srcUrl!==v)b=""!==e.src?e.src:e.attributes.srcUrl.value}else b=f;if(0!==b.length){if(f=new XMLHttpRequest,f.overrideMimeType&&f.overrideMimeType("application/json"),f.open("GET",b,!1),f.send(null),200===f.status||0===f.status)d=f.responseText}else for(b=e.firstChild;b;)3===b.nodeType&&(d+=b.textContent),
b=b.nextSibling;return d},xmlNeedsBadgerFish:function(f){for(f=[f];f.length;){var e=f.pop();if(e.attributes&&e.attributes.length)return!0;for(var d=0,b=e.childNodes.length;d<b;d++)f.push(e.childNodes[d])}return!1},getFirstEntry:function(f){for(var e in f)if(f.hasOwnProperty(e))return f[e]},getURIFileType:function(f){function e(a){for(var c in n)if(n.hasOwnProperty(c)&&-1!==n[c].indexOf(a))return c;return v}var d=f.toLowerCase(),b=["_ext","ext"],n={json:["js","javascript","json"],xml:["xml"]};if(-1!==
d.indexOf("?")){var a=d.split("?"),d=a[0];if(a[1])for(var a=-1===a[1].indexOf("&")?[a[1]]:a[1].split("&"),c=0,g=a.length;c<g;c++){var h=a[c];if(-1!==h.indexOf("=")&&(h=h.split("="),-1!==b.indexOf(h[0]))){var t=e(h[1]);if(t)return t;r("Unable to determine extension type '"+h[1]+"' provided for URI: ["+f+"], falling back to filename part.")}}}return-1!==d.indexOf(".")?(f=d.split("."),e(f[f.length-1])):v},get:function(f,e){var d=null,b=null,n=null,e=e||null;if(f===v)return v;if(isFinite(f))return f;
"function"===typeof f&&(f=f(e));if("object"===typeof f)return e&&!(f instanceof e)?new e(f):f;if("string"==typeof f){if(-1!==f.indexOf("\n"))return f;"#"==f[0]&&(d=f.substr(1),(n=document.getElementById(d))&&(b=n.src||null));!n&&(!d&&!b&&f)&&(b=f)}if(n&&!b)return CubicVR.util.collectTextNode(n);if(b){var d=null,a=o[b]||null;if(!a){var c=q.getURIFileType(b);if(c===v&&!n)return b;"json"===c?a=CubicVR.util.getJSON(b):d="xml"===c?CubicVR.util.getXML(b):CubicVR.util.getURL(b);d&&d.childNodes?a=q.getFirstEntry(q.xml2json(d)):
d&&(a=d)}a&&o[b]===v&&(o[b]=a);if(e){if(l[b]&&l[b]instanceof e)return l[b];if(a)return l[b]=new e(a),l[b]}else if(a)return a;return b}d&&!n&&console.log("Unable to retrieve requested ID: '"+f+"'");return v},clearCache:function(){l={};o={}},getURL:function(f){try{var e=new XMLHttpRequest;e.open("GET",f,!1);e.send(null);if(200===e.status||0===e.status){if(e.responseText.length)return e.responseText;if(e.responseXML)return e.responseXML}}catch(d){alert(f+" failed to load.")}return null},getXML:function(f){try{var e=
new XMLHttpRequest;e.open("GET",f,!1);e.overrideMimeType("application/xml");e.send(null);if(200===e.status||0===e.status)return e.responseXML}catch(d){try{alert(f+" failed to load.")}catch(b){throw d;}}return null},getJSON:function(f){try{var e=new XMLHttpRequest;e.open("GET",f,!1);e.overrideMimeType("application/json");e.send(null);if(200===e.status||0===e.status)return eval("("+e.responseText+")")}catch(d){try{alert(f+" failed to load.")}catch(b){throw d;}}return null},repackArray:function(f,e,
d){f.length!==parseInt(e,10)*parseInt(d,10)&&r("array repack error, data size !== stride*count: data.length="+f.length+" stride="+e+" count="+d);for(var d=[],b=0,n=0,a=f.length;n<a;n++){var c=n%e;0===c&&(d[b]=[]);d[b][c]=f[n];c===e-1&&b++}return d},collectTextNode:function(f){if(!f)return"";for(var e="",f=f.childNodes,d=0,b=f.length;d<b;d++)e+=f[d].nodeValue;return e},floatDelimArray:function(f,e){"\n"!=e&&(f=f.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var d=f.split(e?e:","),b=0,n=d.length;b<
n;b++)d[b]=parseFloat(d[b]);d[d.length-1]!==d[d.length-1]&&d.pop();return d},intDelimArray:function(f,e){"\n"!=e&&(f=f.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var d=f.split(e?e:","),b=0,n=d.length;b<n;b++)d[b]=parseInt(d[b],10);d[d.length-1]!==d[d.length-1]&&d.pop();return d},textDelimArray:function(f,e){"\n"!=e&&(f=f.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var d=f.split(e?e:","),b=0,n=d.length;b<n;b++)d[b]=d[b];return d},xmlstring2json:function(f){for(var f=f.replace(/<\!--.*?--\>/gm,
"").replace(/\n/g," ").split(/(<[^>]*>)([^<]*)/gm),e=/^\s+$/gm,d,b=[],n=[],a={},c=a,g=0,h=f.length;g<h;g++){var t=f[g];if(!(e.test(t)||""===t)&&!/<\?\s?xml[^>]*>/.test(t))if(/<.*?>/.test(t)){d=t.split(/<([^>]*?)(.*)?>/g)[2];if("/"!==d[0]&&(t=d.split(" "),d=t[0],t=t.slice(1).join(" "),b.push(d),n.push(a),a[d]&&!(a[d]instanceof Array)?a[d]=[a[d]]:(a[d]||(a[d]={}),a=a[d]),a instanceof Array&&(a.push({}),a=a[a.length-1]),"/"===d.substr(d.length-1)||"/"===t.substr(t.length-1)))d="/"+d;if("/"===d[0]){d=
d.substr(1);if(b.length&&b[b.length-1]!==d)return console.log("Unmatched tag, aborting: "+d),!1;b.pop();a=n.length?n[n.length-1]:null;n.pop()}}else{var l=n[n.length-1][d];l instanceof Array?(l.pop(),l.push(q.parseNumeric(t))):n[n.length-1][d]=q.parseNumeric(t)}}return c},xmlstring2badgerfish:function(f){for(var f=f.replace(/<\!--.*?--\>/gm,"").replace(/\n/g," ").split(/(<[^>]*>)([^<]*)/gm),e=/^\s+$/gm,d,b=[],n=[],a={},c=a,g=0,h=f.length;g<h;g++)if(d=f[g],!(e.test(d)||""===d)&&!/<\?\s?xml[^>]*>/.test(d))if(/<.*?>/.test(d)){d=
d.split(/<([^>]*?)(.*)?>/g)[2];if("/"!==d[0]){var t=d.split(" ");d=t[0];t=t.slice(1).join(" ");b.push(d);n.push(a);a[d]&&!(a[d]instanceof Array)?a[d]=[a[d]]:a[d]||(a[d]={});a=a[d];a instanceof Array&&(a.push({}),a=a[a.length-1]);if("/"===d.substr(d.length-1)||"/"===t.substr(t.length-1))d="/"+d;for(var t=q.multiSplit(t,"= "),l="",w=0;w<t.length;w++){var s=t[w];"/"===s[s.length-1]&&(s=s.substr(0,s.length-1));if(1===w%2){if("'"===s[0]||'"'===s[0]){for(var o=s[0],s=s.substr(1);s[s.length-1]!==o&&t.length+
1<w;)s+=t.splice(w+1,1);s[s.length-1]===o&&(s=s.substr(0,s.length-1))}a["@"+l]=s}else l=s}}if("/"===d[0]){d=d.substr(1);if(b.length&&b[b.length-1]!==d)return console.log("Unmatched tag, aborting: "+b[b.length-1]),!1;b.pop();a=n.length?n[n.length-1]:null;n.pop()}}else a.$=d;return c},xml2badgerfish:function(f){var e={},d=[],b,n,a,c,g,h=/^\s+|\s+$/g;f.jsonParent=e;for(d.push(f);d.length;){n=d.pop();var t=null;a=n.jsonParent;f=0;for(b=n.childNodes.length;f<b;f++)c=n.childNodes[f],g=c.tagName,g!==v&&
(t=t||{},t[g]=t[g]||0,t[g]++);if(n.attributes&&n.attributes.length){f=0;for(b=n.attributes.length;f<b;f++)c=n.attributes[f],a["@"+c.name]=c.value}f=0;for(b=n.childNodes.length;f<b;f++)c=n.childNodes[f],g=c.tagName,1===c.nodeType?(1<t[g]?(a[g]=a[g]||[],a[g].push({}),c.jsonParent=a[g][a[g].length-1]):(a[g]=a[g]||{},c.jsonParent=a[g]),d.push(c)):3===c.nodeType&&""!==c.nodeValue.replace(h,"")&&(a.$=a.$||"",a.$+=c.nodeValue)}return e},isTextNode:function(f){for(var f=f.childNodes,e=0,d=f.length;e<d;e++)if(3!==
f[e].nodeType||f[e].childNodes.length)return!1;return!0},parseNumeric:function(f){var e=null,d,e=f.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\n/g," ").replace(/ *, */gm,",").replace(/\s+/g," ");if(""===e)return e;if((-1!==e.indexOf(" ")||-1!==e.indexOf(","))&&/[0-9\.,e\-\+ ]+/g.test(e))if(/[^0-9\-\+]+/g.test(e))if(/[^0-9\- ]+/g.test(e))if(/[^0-9\-,]+/g.test(e))if(/[^0-9\.e\-\+ ]+/g.test(e))if(/[^0-9\.,e\+\-]+/g.test(e))if(/[^0-9,\-\+ ]+/g.test(e)){if(!/[^0-9\.,e\-\+ ]+/g.test(e)){e=e.split(" ");
f=0;for(d=e.length;f<d;f++)e[f]=q.floatDelimArray(e[f],",");return e}}else{e=e.split(" ");f=0;for(d=e.length;f<d;f++)e[f]=q.intDelimArray(e[f],",");return e}else return q.floatDelimArray(e,",");else return q.floatDelimArray(e," ");else return q.intDelimArray(e,",");else return q.intDelimArray(e," ");else return parseInt(e,10);d=parseFloat(e);return!isNaN(d)?/[^0-9\-\+]+/g.test(e)?d:parseInt(e,10):f},xml2json:function(f){var e={},d=[],b,n,a,c,g;f.jsonParent=e;for(d.push(f);d.length;){n=d.pop();var h=
null;a=n.jsonParent;f=0;for(b=n.childNodes.length;f<b;f++)c=n.childNodes[f],g=c.tagName,g!==v&&(h=h||{},h[g]=h[g]||0,h[g]++);f=0;for(b=n.childNodes.length;f<b;f++){c=n.childNodes[f];g=c.tagName;var t=q.isTextNode(c);1===c.nodeType&&(1<h[g]?(a[g]=a[g]||[],t?a[g].push(q.parseNumeric(q.collectTextNode(c))):(a[g].push({}),c.jsonParent=a[g][a[g].length-1])):t?a[g]=q.parseNumeric(q.collectTextNode(c)):(a[g]=a[g]||{},c.jsonParent=a[g]),t||d.push(c))}}return e}};return{util:q,get:q.get,clearCache:q.clearCache}});
"undefined"===typeof Iuppiter&&(Iuppiter={version:"3026 $".replace(" $","")});Iuppiter.toByteArray=function(m){var v=[],r,l;for(r=0;r<m.length;r++)l=m.charCodeAt(r),127>=l?v.push(l):(2047>=l?v.push(l>>6|192):(65535>=l?v.push(l>>12|224):(v.push(l>>18|240),v.push(l>>12&63|128)),v.push(l>>6&63|128)),v.push(l&63|128));return v};
Iuppiter.Base64={CA:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",CAS:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",IA:Array(256),IAS:Array(256),init:function(){var m;for(m=0;256>m;m++)Iuppiter.Base64.IA[m]=-1,Iuppiter.Base64.IAS[m]=-1;m=0;for(iS=Iuppiter.Base64.CA.length;m<iS;m++)Iuppiter.Base64.IA[Iuppiter.Base64.CA.charCodeAt(m)]=m,Iuppiter.Base64.IAS[Iuppiter.Base64.CAS.charCodeAt(m)]=m;Iuppiter.Base64.IA["="]=Iuppiter.Base64.IAS["="]=0},encode:function(m,
v){var r,l,o,q,f,e,d,b,n;r=v?Iuppiter.Base64.CAS:Iuppiter.Base64.CA;o=m.constructor==Array?m:Iuppiter.toByteArray(m);q=o.length;f=3*(q/3);e=(q-1)/3+1<<2;l=Array(e);for(b=d=0;d<f;)n=(o[d++]&255)<<16|(o[d++]&255)<<8|o[d++]&255,l[b++]=r.charAt(n>>18&63),l[b++]=r.charAt(n>>12&63),l[b++]=r.charAt(n>>6&63),l[b++]=r.charAt(n&63);d=q-f;0<d&&(n=(o[f]&255)<<10|(2==d?(o[q-1]&255)<<2:0),l[e-4]=r.charAt(n>>12),l[e-3]=r.charAt(n>>6&63),l[e-2]=2==d?r.charAt(n&63):"=",l[e-1]="=");return l.join("")},decode:function(m,
v){var r,l,o,q,f,e,d,b,n,a,c,g;r=v?Iuppiter.Base64.IAS:Iuppiter.Base64.IA;m.constructor==Array?(o=m,f=!0):(o=Iuppiter.toByteArray(m),f=!1);q=o.length;e=0;for(d=q-1;e<d&&0>r[o[e]];)e++;for(;0<d&&0>r[o[d]];)d--;b="="==o[d]?"="==o[d-1]?2:1:0;l=d-e+1;n=76<q?("\r"==o[76]?l/78:0)<<1:0;q=(6*(l-n)>>3)-b;l=Array(q);c=a=0;for(eLen=3*(q/3);a<eLen;)g=r[o[e++]]<<18|r[o[e++]]<<12|r[o[e++]]<<6|r[o[e++]],l[a++]=g>>16&255,l[a++]=g>>8&255,l[a++]=g&255,0<n&&19==++c&&(e+=2,c=0);if(a<q){for(n=g=0;e<=d-b;n++)g|=r[o[e++]]<<
18-6*n;for(r=16;a<q;r-=8)l[a++]=g>>r&255}if(f)return l;for(g=0;g<l.length;g++)l[g]=String.fromCharCode(l[g]);return l.join("")}};Iuppiter.Base64.init();
(function(){Iuppiter.compress=function(m){var v=[],r,l=0,o=0,q,f,e=128,d,b,n=Array(256);for(r=0;256>r;r++)n[r]=3435973836;m=m.constructor==Array?m:Iuppiter.toByteArray(m);for(r=m.length;l<r;){if(256==(e<<=1)){if(o>=r-1-16){d=r;for(o=l=0;d;d--)v[o++]=m[l++];break}e=1;f=o;v[o++]=0}if(l>r-66)v[o++]=m[l++];else if(q=(m[l]+13^m[l+1]-13^m[l+2])&255,b=l-n[q]&1023,n[q]=l,q=l-b,0<=q&&q!=l&&m[l]==m[q]&&m[l+1]==m[q+1]&&m[l+2]==m[q+2]){v[f]|=e;for(d=3;66>d&&m[l+d]==m[q+d];d++);v[o++]=d-3<<2|b>>8;v[o++]=b;l+=
d}else v[o++]=m[l++]}return v};Iuppiter.decompress=function(m,v){var r,l=[],o,q=0,f=0,e,d,b=128,n;r=m.constructor==Array?m:Iuppiter.toByteArray(m);for(o=r.length;q<o;){if(256==(b<<=1))b=1,d=r[q++];if(d&b)if(n=(r[q]>>2)+3,e=(r[q]<<8|r[q+1])&1023,q+=2,0<=(e=f-e))for(;0<=--n;)l[f++]=l[e++];else break;else l[f++]=r[q++]}if(!("undefined"==typeof v?0:v)){for(r=0;r<f;r++)l[r]=String.fromCharCode(l[r]);l=l.join("")}return l}})();
CubicVR.RegisterModule("Shader",function(m){function v(a,c){var g=m.util,h,n,e,w,s=o.gl;this.uniforms=[];this.uniform_type=[];this.uniform_typelist=[];this.success=!0;this.fragmentLog=this.vertexLog="";this.classType=m.enums.classType.SHADER;-1!==a.indexOf("\n")?(e=a,h=d(o.gl,a,"x-shader/x-vertex")):(h=b(o.gl,a),null===h&&(e=g.getURL(a),h=d(o.gl,e,"x-shader/x-vertex")));s.getShaderParameter(h,s.COMPILE_STATUS)||(this.vertexLog=s.getShaderInfoLog(h),this.success=!1);-1!==c.indexOf("\n")?(w=c,n=d(o.gl,
c,"x-shader/x-fragment")):(n=b(o.gl,c),null===n&&(w=g.getURL(c),n=d(o.gl,w,"x-shader/x-fragment")));s.getShaderParameter(n,s.COMPILE_STATUS)||(this.fragmentLog=s.getShaderInfoLog(n),this.success=!1);this.success?(this.shader=s.createProgram(),s.attachShader(this.shader,h),s.attachShader(this.shader,n),s.linkProgram(this.shader),o.gl.getProgramParameter(this.shader,s.LINK_STATUS)||(f("Error linking shader:\n"+s.getProgramInfoLog(this.shader)),this.success=!1)):(h=g.multiSplit(this.vertexLog,";\n"),
g=g.multiSplit(this.fragmentLog,";\n"),h.length&&this.dumpErrors(h,e),g.length&&this.dumpErrors(g,w))}function r(a){this._update=a.update||null;this._init=a.init||null;this._vertex=m.get(a.vertex)||null;this._fragment=m.get(a.fragment)||null;this._bindings=[];this._shaderVars=this._shaderInfo=this._shader=null;this._initialized=!1;this.classType=m.enums.classType.CUSTOMSHADER;a=(this._vertex||"")+(this._fragment||"");this._hasDepthPack=""!==a.trim()?/\s\!?LIGHT_DEPTH_PASS\s/.test(a):!1}var l=m.undef,
o=m.GLCore,q=m.enums,f=m.log,e=m.util;q.shader={map:{COLOR:1,SPECULAR:2,NORMAL:4,BUMP:8,REFLECT:16,ENVSPHERE:32,AMBIENT:64,ALPHA:128,COLORMAP:256},mode:{POINT_SPRITE:512,POINT_SIZE:1024,POINT_CIRCLE:2048},uniform:{MATRIX:0,VECTOR:1,FLOAT:2,ARRAY_VERTEX:3,ARRAY_UV:4,ARRAY_FLOAT:5,INT:6}};var d=function(a,c,g){if("x-shader/x-fragment"===g)g=a.createShader(a.FRAGMENT_SHADER);else if("x-shader/x-vertex"===g)g=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(g,c);a.compileShader(g);return g},
b=function(a,c){var g=document.getElementById(c);if(!g)return null;for(var h="",b=g.firstChild;b;)3===b.nodeType&&(h+=b.textContent),b=b.nextSibling;if("x-shader/x-fragment"===g.type)g=a.createShader(a.FRAGMENT_SHADER);else if("x-shader/x-vertex"===g.type)g=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(g,h);a.compileShader(g);return g};v.prototype={isCompiled:function(){return this.success},dumpErrors:function(a,c,g){for(var g=(g||"Error on line")+" ",c=c.split("\n"),h=0,b=a.length;h<
b;h++){var d=a[h];if(0===d.indexOf("ERROR: ")){var d=d.substr(7).trim(),n=d.substr(0,d.indexOf(" ")),d=d.substr(n.length),n=n.split(":"),n=parseInt(n[1],10);console.log(n+"> "+c[n-1]);console.log(g+n+", :"+d)}}},bindSelf:function(a){var c,g,h;-1!==a.indexOf(".")?-1!==a.indexOf("[")?(c=a.split("["),h=c[0],c=c[1].split("]"),g=c[0],c=c[1].split("."),c=c[1],this[h]===l&&(this[h]=[]),this[h][g]===l&&(this[h][g]={}),this[h][g][c]=this.uniforms[a]):(c=a.split("."),h=c[0],c=c[1],this[h]===l&&(this[h]={}),
this[h][c]=this.uniforms[a]):-1!==a.indexOf("[")?(c=a.split("["),h=c[0],c=c[1].split("]"),g=c[0],this[h]===l&&(this[h]=[]),this[h][g]=this.uniforms[a]):this[a]=this.uniforms[a]},addMatrix:function(a,c){this.use();this.uniforms[a]=o.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=q.shader.uniform.MATRIX;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);c!==l&&this.setMatrix(a,c);this.bindSelf(a);return this.uniforms[a]},addVector:function(a,c){this.use();this.uniforms[a]=
o.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=q.shader.uniform.VECTOR;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);c!==l&&this.setVector(a,c);this.bindSelf(a);return this.uniforms[a]},addFloat:function(a,c){this.use();this.uniforms[a]=o.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=q.shader.uniform.FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);c!==l&&this.setFloat(a,c);this.bindSelf(a);return this.uniforms[a]},addVertexArray:function(a){this.use();
this.uniforms[a]=o.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=q.shader.uniform.ARRAY_VERTEX;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addUVArray:function(a){this.use();this.uniforms[a]=o.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=q.shader.uniform.ARRAY_UV;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addFloatArray:function(a){this.use();this.uniforms[a]=
o.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=q.shader.uniform.ARRAY_FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addInt:function(a,c){this.use();this.uniforms[a]=o.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=q.shader.uniform.INT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);c!==l&&this.setInt(a,c);this.bindSelf(a);return this.uniforms[a]},use:function(){o.gl.useProgram(this.shader)},
setMatrix:function(a,c){var g=this.uniforms[a];if(null!==g){var h=c.length;16===h?o.gl.uniformMatrix4fv(g,!1,c):9===h?o.gl.uniformMatrix3fv(g,!1,c):4===h&&o.gl.uniformMatrix2fv(g,!1,c)}},setInt:function(a,c){var g=this.uniforms[a];null!==g&&o.gl.uniform1i(g,c)},setFloat:function(a,c){var g=this.uniforms[a];null!==g&&o.gl.uniform1f(g,c)},setVector:function(a,c){var g=this.uniforms[a];if(null!==g){var h=c.length;4==h?o.gl.uniform4fv(g,c):3==h?o.gl.uniform3fv(g,c):2==h?o.gl.uniform2fv(g,c):o.gl.uniform4fv(g,
c)}},clearArray:function(a){var c=o.gl,a=this.uniforms[a];null!==a&&c.disableVertexAttribArray(a)},bindArray:function(a,c){var g=o.gl,h=this.uniforms[a];if(null!==h){var b=this.uniform_type[a];b===q.shader.uniform.ARRAY_VERTEX?(g.bindBuffer(g.ARRAY_BUFFER,c),g.vertexAttribPointer(h,3,g.FLOAT,!1,0,0),g.enableVertexAttribArray(h)):b===q.shader.uniform.ARRAY_UV?(g.bindBuffer(g.ARRAY_BUFFER,c),g.vertexAttribPointer(h,2,g.FLOAT,!1,0,0)):b===q.shader.uniform.ARRAY_FLOAT&&(g.bindBuffer(g.ARRAY_BUFFER,c),
g.vertexAttribPointer(h,1,g.FLOAT,!1,0,0))}}};var n={tidyScript:function(a){return a.replace(/\t+/g," ").replace(/\/\/.*$/gm,"").replace(/\/\*(.|\n)*\*\//g,"").replace(/ +/g," ").replace(/ *\[ */g,"[").replace(/ *\] */g,"]").replace(/ *; */g,";").replace(/ *$/gm,"").replace(/^ */gm,"")},getDefines:function(a){var c={},a=e.multiSplit(a,"\n;");i=0;for(iMax=a.length;i<iMax;i++){var g=a[i];0===g.indexOf("#define")&&(g=g.split(" "),2<g.length&&(c[g[1]]=g.slice(2).join(" ")))}return c},replaceAll:function(a,
c,g,h){var g=g||"",h=h||"",b;for(b in c)if(c.hasOwnProperty(b))for(var d=g+b+h;-1!==a.indexOf(d);)a=a.replace(d,g+c[b]+h);return a},getShaderInfo:function(a,c){var g,h,b,d,f,s,o=["uniform","attribute","varying"],m=[],q={};s={};var r;c===l&&(c="");a=n.tidyScript(a);c=n.tidyScript(c);q.v_define=n.getDefines(a);q.f_define=n.getDefines(c);a=n.replaceAll(a,q.v_define,"[","]");c=n.replaceAll(c,q.f_define,"[","]");r=e.multiSplit(a+"\n"+c,"\n;");var u=[];d=b=-1;g=0;for(h=r.length;g<h;g++)f=r[g],-1===b&&0===
f.indexOf("struct")?b=g:-1===d&&(-1!==b&&-1!==f.indexOf("}"))&&(d=g+1),-1!==b&&-1!==d&&(f=r.slice(b,d).join("\n").replace(/(\{|\})/g,"\n").replace(/ +$/gm,"").replace(/^ +/gm,"").replace(/\n\n/gm,"\n"),u.push({start:b,end:d,struct:f.split("\n")}),d=b=-1);g=0;for(h=u.length;g<h;g++){var x=u[g].struct,y=null;b=0;for(d=x.length;b<d;b++)f=x[b].split(" "),1>=f.length||("struct"==f[0]?(y=f[1],s[y]={}):y&&(s[y][f[1]]=f[0]))}q.struct=s;g=0;for(h=o.length;g<h;g++)q[o[g]]=[];g=0;for(h=r.length;g<h;g++){f=r[g];
b=0;for(d=o.length;b<d;b++)if(u=o[b],0===f.indexOf(u)&&(s=f.split(" "),3===s.length&&s[0]==u&&-1===m.indexOf(s[2])))if(m.push(s[2]),-1!==s[2].indexOf("[")){var x=s[2].split("["),y=x[1].replace("]",""),v=parseInt(y,10);v===v&&(y=v);q[u].push({name:x[0],type:s[1],isArray:!0,len:y})}else q[u].push({name:s[2],type:s[1]})}return q},genShaderVarList:function(a,c){var g=a[c],h=[],b,d,n,e,f,l;if(!g)return[];b=0;for(d=g.length;b<d;b++){var o=g[b];if(a.struct[o.type]){var m=a.struct[o.type];if(m&&o.isArray){n=
0;for(e=o.len;n<e;n++)for(l in f=o.name+"["+n+"]",m)m.hasOwnProperty(l)&&h.push({location:f+"."+l,type:m[l],basename:o.name})}else for(l in m)h.push({location:o.name+"."+l,type:m[l],basename:o.name})}else if(o.isArray){n=0;for(e=o.len;n<e;n++)f=o.name+"["+n+"]",h.push({location:f,type:o.type,basename:o.name})}else h.push({location:o.name,type:o.type,basename:o.name})}return h},getShaderVars:function(a){var c={};c.uniform=n.genShaderVarList(a,"uniform");c.attribute=n.genShaderVarList(a,"attribute");
return c}};r.prototype={use:function(){this._initialized&&this._shader.use()},getShader:function(){return this._shader},ready:function(){return this._initialized},isReady:function(){return this._initialized},hasDepthPack:function(){return this._hasDepthPack},_init_shader:function(a,c,b,h,d){b=b||[];a=m.util.get(a);c=m.util.get(c);d=d||"#define customShader_splice";if(h=h===l?this._vertex||this._fragment:h)h=a.indexOf(d),d=c.indexOf(d),-1!==h&&this._vertex&&(a=a.substr(0,h)+this._vertex),-1!==d&&this._fragment&&
(c=c.substr(0,d)+this._fragment);this._shader=new m.Shader(a,c);this._shaderInfo=n.getShaderInfo(a,c);this._shaderVars=n.getShaderVars(this._shaderInfo);this._appendShaderVars(this._shaderVars,"uniform",b);this._appendShaderVars(this._shaderVars,"attribute",b);(this._initialized=this._shader.isCompiled())&&this._init&&this._init(this)},_appendShaderVars:function(a,c,b){for(var a=function(a,c){return function(h,b){b!==l&&(f.activeTexture(f.TEXTURE0+h),f.bindTexture(o.gl.TEXTURE_2D,m.Textures[b.tex_id]));
c.value=h;a.update(c)}},h=0,d=this._shaderVars[c].length;h<d;h++){var n=this._shaderVars[c][h],e=n.location;if(-1===b.indexOf(n.basename)&&(n=n.type,"vec3"===n?"attribute"===c?this._shader.addVertexArray(e):this._shader.addVector(e):"vec2"===n?"attribute"===c?this._shader.addUVArray(e):this._shader.addVector(e):"vec4"===n?"attribute"!==c&&this._shader.addVector(e):"float"===n?"attribute"===c?this._shader.addFloatArray(e):this._shader.addFloat(e):"sampler2D"===n||"int"===n?this._shader.addInt(e):("mat4"===
n||"mat3"===n||"mat2"===n)&&this._shader.addMatrix(e),e=this._bindSelf(e),"sampler2D"==n&&e)){var f=o.gl;e.set=a(this,e)}}},_bindSelf:function(a){var c,b,h,d;if(null!==this._shader.uniforms[a]){var n=function(a,c){return function(h){c.value=h;a.update(c)}};-1!==a.indexOf(".")?-1!==a.indexOf("[")?(c=a.split("["),h=c[0],c=c[1].split("]"),b=c[0],c=c[1].split("."),c=c[1],this[h]===l&&(this[h]=[]),this[h][b]===l&&(this[h][b]={}),d={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},
this[h][b][c]=d):(c=a.split("."),h=c[0],c=c[1],this[h]===l&&(this[h]={}),d={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[h][c]=d):-1!==a.indexOf("[")?(c=a.split("["),h=c[0],c=c[1].split("]"),b=c[0],this[h]===l&&(this[h]=[]),d={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[h][b]=d):(d={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[a]=d);this._bindings.push(d);d&&(d.set=n(this,d));return d}},
_doUpdate:function(a){if(this._initialized)if(this._update)this._update(this,a);else for(var c=0,b=this._bindings.length;c<b;c++)this.update(this._bindings[c],a)},update:function(a){if(this._initialized){var c=o.gl,b=a.value,h=a.location;null!==h&&(a.type===q.shader.uniform.MATRIX?(a=b.length,16===a?c.uniformMatrix4fv(h,!1,b):9===a?c.uniformMatrix3fv(h,!1,b):4===a&&c.uniformMatrix2fv(h,!1,b)):a.type===q.shader.uniform.INT?c.uniform1i(h,b):a.type===q.shader.uniform.VECTOR?(a=b.length,4===a&&c.uniform4fv(h,
b),3===a?c.uniform3fv(h,b):2===a?c.uniform2fv(h,b):c.uniform4fv(h,b)):a.type===q.shader.uniform.FLOAT?c.uniform1f(h,b):a.type===q.shader.uniform.ARRAY_VERTEX?(c.bindBuffer(c.ARRAY_BUFFER,b),c.vertexAttribPointer(h,3,c.FLOAT,!1,0,0),c.enableVertexAttribArray(h)):a.type===q.shader.uniform.ARRAY_UV?(c.bindBuffer(c.ARRAY_BUFFER,b),c.vertexAttribPointer(h,2,c.FLOAT,!1,0,0),c.enableVertexAttribArray(h)):a.type===q.shader.uniform.ARRAY_FLOAT&&(c.bindBuffer(c.ARRAY_BUFFER,b),c.vertexAttribPointer(h,1,c.FLOAT,
!1,0,0),c.enableVertexAttribArray(h)))}}};return{Shader:v,shader_util:n,CustomShader:r}});
CubicVR.RegisterModule("MainLoop",function(m){function v(){this.paused_state=this.offset=this.paused_time=this.last_update=this.end_time=this.start_time=this.system_milliseconds=this.time_elapsed=0}function r(){null!==m.GLCore.mainloop&&(window.requestAnimationFrame&&window.requestAnimationFrame(r),m.GLCore.mainloop.interval())}function l(d,b,n){window.requestAnimationFrame===q&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||
window.msRequestAnimationFrame||null);null!==m.GLCore.mainloop&&(!window.requestAnimationFrame&&m.GLCore.mainloop&&clearInterval(m.GLCore.mainloop.interval),m.GLCore.mainloop=null);if(null===d)m.GLCore.mainloop=null;else{if(!(this instanceof l))return new l(d,b,n);this.renderList=[];var a=this.renderStack=[{scenes:[],update:function(){},start:function(){},stop:function(){}}],c=new v;c.start();this.timer=c;this.func=d;this.doclear=b!==q?b:!0;m.GLCore.mainloop=this;e.resizeList.length&&!m.GLCore.resize_active&&
(window.addEventListener("resize",function(){m.GLCore.onResize()},!1),m.GLCore.resize_active=!0);b=function(){return function(){var b=m.GLCore.gl;c.update();m.GLCore.mainloop.doclear&&b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT);d(c,m.GLCore.gl);var h=a[a.length-1],n=h.scenes;h.update&&h.update(c,b);if(n){b=0;for(h=n.length;b<h;++b){var e=n[b];if(!e.paused){e.update&&e.update(c,m.GLCore.gl);e.render()}}}}}();n?this.loopFunc=b:window.requestAnimationFrame?(this.interval=b,window.requestAnimationFrame(r)):
this.interval=setInterval(b,20)}}function o(d,b,n){this.canvas=d;this.camera=b;this.mpos=[0,0];this.mdown=!1;var a=this;this.mEvents={};this.keyState=[];for(var c in f.keyboard)this.keyState[c]=!1;this.getMousePos=function(a,c){var b=a.getBoundingClientRect();return[(c.clientX-b.left)/(b.right-b.left)*a.width,(c.clientY-b.top)/(b.bottom-b.top)*a.height]};this.onMouseDown=function(){return function(c){a.mdown=!0;a.mpos=a.getMousePos(d,c);a.mEvents.mouseDown&&a.mEvents.mouseDown(a,a.mpos,a.keyState)}}();
this.onMouseUp=function(){return function(c){a.mdown=!1;a.mpos=a.getMousePos(d,c);a.mEvents.mouseUp&&a.mEvents.mouseUp(a,a.mpos,a.keyState)}}();this.onMouseMove=function(){return function(c){var b=[],c=a.getMousePos(d,c);b[0]=c[0]-a.mpos[0];b[1]=c[1]-a.mpos[1];a.mpos=c;a.mEvents.mouseMove&&a.mEvents.mouseMove(a,a.mpos,b,a.keyState)}}();this.onMouseWheel=function(){return function(c){c=c.wheelDelta?c.wheelDelta:100*-c.detail;a.mEvents.mouseWheel&&a.mEvents.mouseWheel(a,a.mpos,c,a.keyState)}}();this.onKeyDown=
function(){return function(c){var c=c.keyCode,b=null;a.mEvents.keyPress?(b=a.mEvents.keyPress(a,a.mpos,c,a.keyState),a.keyState[c]=b!==q?!!b:!0):a.keyState[c]=!0;a.keyState[c]&&a.mEvents.keyDown&&(b=a.mEvents.keyDown(a,a.mpos,c,a.keyState),a.keyState[c]=b!==q?!!b:!0)}}();this.onKeyUp=function(){return function(c){c=c.keyCode;a.mEvents.keyUp&&a.mEvents.keyUp(a,a.mpos,c,a.keyState);a.keyState[c]=!1}}();this.eventDefaults={mouseMove:function(a,c,b){a.mdown&&a.orbitView(b)},mouseWheel:function(a,c,b){a.zoomView(b)},
mouseDown:null,mouseUp:null,keyDown:null,keyUp:null,keyPress:null};!1!==n&&this.setEvents(n===q?this.eventDefaults:n);this.bind()}var q=m.undef,f=m.enums,e=m.GLCore;f.keyboard={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,INSERT:45,DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,
KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,LEFT_META:91,RIGHT_META:92,SELECT:93,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,
NUM_LOCK:144,SCROLL_LOCK:145,SEMICOLON:186,EQUALS:187,COMMA:188,DASH:189,PERIOD:190,FORWARD_SLASH:191,GRAVE_ACCENT:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,SINGLE_QUOTE:222};v.prototype={start:function(){this.update();this.num_updates=0;this.last_update=this.start_time=this.system_milliseconds;this.lock_state=this.paused_state=!1;this.offset=this.paused_time=this.lock_rate=0},stop:function(){this.end_time=this.system_milliseconds},reset:function(){this.start()},lockFramerate:function(d){this.lock_rate=
1/d;this.lock_state=!0},unlock:function(){var d=this.system_milliseconds;this.lock_state=!1;this.update();this.last_update=this.system_milliseconds-this.lock_rate;this.offset+=d-this.system_milliseconds;this.lock_rate=0},locked:function(){return this.lock_state},update:function(){this.num_updates++;this.last_update=this.system_milliseconds;this.system_milliseconds=this.lock_state?this.system_milliseconds+(1E3*this.lock_rate|0):Date.now();this.paused_state&&(this.paused_time+=this.system_milliseconds-
this.last_update);this.time_elapsed=this.system_milliseconds-this.start_time-this.paused_time+this.offset},getMilliseconds:function(){return this.time_elapsed},getSeconds:function(){return this.getMilliseconds()/1E3},setMilliseconds:function(d){this.offset-=this.system_milliseconds-this.start_time-this.paused_time+this.offset-d},setSeconds:function(d){this.setMilliseconds(1E3*d|0)},getLastUpdateSeconds:function(){return this.getLastUpdateMilliseconds()/1E3},getLastUpdateMilliseconds:function(){return this.system_milliseconds-
this.last_update},getTotalMilliseconds:function(){return this.system_milliseconds-this.start_time},getTotalSeconds:function(){return this.getTotalMilliseconds()/1E3},getNumUpdates:function(){return this.num_updates},setPaused:function(d){this.paused_state=d},getPaused:function(){return this.paused_state}};l.prototype={setPaused:function(d){this.timer.setPaused(d)},getPaused:function(){return this.timer.getPaused()},setTimerSeconds:function(d){this.timer.setSeconds(d)},getTimerSeconds:function(){return this.timer.getSeconds()},
resetTimer:function(){this.timer.reset()},addScene:function(d){this.renderStack[this.renderStack.length-1].scenes.push(d);return d},pushSceneGroup:function(d){d.scenes=d.scenes||[];this.renderStack.push(d);for(var b=0;b<d.scenes.length;++b)d.scenes[b].enable();d.start&&d.start()},popSceneGroup:function(){for(var d=this.renderStack[this.renderStack.length-1],b=0;b<d.scenes.length;++b)d.scenes[b].disable();1<this.renderStack.length&&this.renderStack.pop();d.stop&&d.stop()},getScene:function(d){for(var b=
renderStack[renderStack.length-1],n,a=0,c=b.scenes.length;a<c;++a)if(b.scenes[a].scene.name===d){n=b.scenes[a];break}return n},resumeScene:function(d){"string"===typeof d&&(d=this.getScene(d));d.enable();d.paused=!1},pauseScene:function(d){"string"===typeof d&&(d=this.getScene(d));d.paused=!0;d.disable()},removeScene:function(d){var b=renderStack[renderStack.length-1];"string"===typeof d&&(d=this.getScene(d));var n=b.scenes.indexOf(d);-1<n&&b.scenes.splice(n,1);return d},runOnce:function(){this.loopFunc()}};
o.prototype={isKeyPressed:function(d){return this.keyState[d]},getKeyState:function(d){return d!==q?this.keyState[d]:this.keyState},setEvents:function(d){this.mEvents={};for(var b in d)this.bindEvent(b,d[b])},orbitView:function(d){var b=m.vec3,n=b.subtract(this.camera.target,this.camera.position),n=b.length(n);this.camera.position=b.moveViewRelative(this.camera.position,this.camera.target,-n*d[0]/300,0);this.camera.position[1]+=n*d[1]/300;this.camera.position=b.add(this.camera.target,b.multiply(b.normalize(b.subtract(this.camera.position,
this.camera.target)),n))},panView:function(d,b){var n=m.vec3;b||(b=!1);var a=n.subtract(this.camera.target,this.camera.position),a=n.length(a),c=this.camera.position;b?this.camera.position=n.moveViewRelative(this.camera.position,this.camera.target,-a*d[0]/300,-a*d[1]/300):(this.camera.position=n.moveViewRelative(this.camera.position,this.camera.target,-a*d[0]/300,0),this.camera.position[1]+=a*d[1]/300);a=n.subtract(this.camera.position,c);this.camera.target=n.add(this.camera.target,a)},zoomView:function(d,
b,n){var a=m.vec3,c=a.subtract(this.camera.target,this.camera.position),c=a.length(c),c=c-d/1E3;b||(b=0.1);n||(n=1E3);c<b&&(c=b);c>n&&(c=n);this.camera.position=a.add(this.camera.target,a.multiply(a.normalize(a.subtract(this.camera.position,this.camera.target)),c))},bindEvent:function(d,b){this.mEvents[d]=b===q?this.eventDefaults[d]:b},unbindEvent:function(d){this.bindEvent(d,null)},bind:function(){this.canvas.addEventListener("mousemove",this.onMouseMove,!1);this.canvas.addEventListener("mousedown",
this.onMouseDown,!1);this.canvas.addEventListener("mouseup",this.onMouseUp,!1);this.canvas.addEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.addEventListener("DOMMouseScroll",this.onMouseWheel,!1);window.addEventListener("keydown",this.onKeyDown,!1);window.addEventListener("keyup",this.onKeyUp,!1)},unbind:function(){this.canvas.removeEventListener("mousemove",this.onMouseMove,!1);this.canvas.removeEventListener("mousedown",this.onMouseDown,!1);this.canvas.removeEventListener("mouseup",
this.onMouseUp,!1);this.canvas.removeEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.removeEventListener("DOMMouseScroll",this.onMouseWheel,!1);window.removeEventListener("keydown",this.onKeyDown,!1);window.removeEventListener("keyup",this.onKeyUp,!1)},setCamera:function(d){this.camera=d},getMousePosition:function(){return this.mpos}};return{Timer:v,MainLoop:l,MouseViewController:o,setMainLoop:function(d){m.GLCore.mainloop=d},keyboard:f.keyboard}});
CubicVR.RegisterModule("Texture",function(m){function v(a,c){if(1===a||1===c)return!1;if(1!==a)for(;0===a%2;)a/=2;if(1!==c)for(;0===c%2;)c/=2;return 1<a||1<c?!1:!0}function r(c){var d=m.GLCore.gl;if("CANVAS"===c.nodeName||"IMG"===c.nodeName||"VIDEO"===c.nodeName)this.canvasSource=c;else{this.canvasSource=document.createElement("CANVAS");if(void 0===c.width||void 0===c.height)throw Error("Width and height must be specified for generating a new CanvasTexture.");this.canvasSource.width=c.width;this.canvasSource.height=
c.height;this.canvasContext=this.canvasSource.getContext("2d")}this.updateFunction=c.update;this.texture=new m.Texture;this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;var g=this.canvasSource;(!g.height||!g.width)&&a("Warning - CanvasTexture input has no initial width and height, edges clamped.");!g.height||!g.width||!v(g.width,g.height)?(this.setFilter(b.texture.filter.LINEAR),d.texParameteri(d.TEXTURE_2D,
d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE)):(this.setFilter(b.texture.filter.LINEAR_MIP),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.REPEAT),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.REPEAT));"IMG"===c.nodeName&&this.update()}function l(a,c){if(!a)throw"PDF Texture Error: page is null.";var d=this,g=m.GLCore.gl,n=this.canvasSource=document.createElement("canvas"),e;n.mozOpaque=!0;n.width=c.width;n.height=c.height;e=this.canvasContext=
n.getContext("2d");e.save();e.fillStyle="rgb(255, 255, 255)";e.fillRect(0,0,n.width,n.height);e.restore();var f=c.viewport||a.getViewport(1);f.width=n.width;f.height=n.height;a.render({canvasContext:e,viewport:f,continueCallback:function(a){a()}}).then(function(){d.update()});this.texture=new m.Texture;this.updateFunction=c.update||function(){};this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;
v(n.width,n.height)?(this.setFilter(b.texture.filter.LINEAR_MIP),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.REPEAT),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.REPEAT)):(this.setFilter(b.texture.filter.LINEAR),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE))}function o(a,c,d){var g=m.GLCore.gl;this.texture=new m.Texture;this.canvas=document.createElement("CANVAS");this.canvas.width=c;this.canvas.height=d;this.pjs=
new Processing(this.canvas,m.util.getURL(a));this.pjs.noLoop();this.pjs.redraw();this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;v(this.canvas.width,this.canvas.height)?this.setFilter(b.texture.filter.LINEAR_MIP):(this.setFilter(b.texture.filter.LINEAR),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE))}function q(a,
c,g){var n=d.gl;this.width=c;this.height=g;this.srcTex=a;this.outTex=new m.RenderBuffer(c,g);v(c,g);a=[1/c,1/g,0];this.outputBuffer=new m.RenderBuffer(c,g,!1);this.fsQuad=m.fsQuad.make(c,g);shaderNMap=new m.Shader("attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\n  vTex = aTex;\n  vec4 vPos = vec4(aVertex.xyz,1.0);\n  gl_Position = vPos;\n}","#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform vec3 texel;\nvoid main(void)\n{\n vec3 color;\n color.r = (texture2D(srcTex,vTex + vec2(texel.x,0)).r-texture2D(srcTex,vTex + vec2(-texel.x,0)).r)/2.0 + 0.5;\n color.g = (texture2D(srcTex,vTex + vec2(0,-texel.y)).r-texture2D(srcTex,vTex + vec2(0,texel.y)).r)/2.0 + 0.5;\n color.b = 1.0;\n gl_FragColor.rgb = color;\n gl_FragColor.a = 1.0;\n}");
shaderNMap.use();shaderNMap.addUVArray("aTex");shaderNMap.addVertexArray("aVertex");shaderNMap.addInt("srcTex",0);shaderNMap.addVector("texel");shaderNMap.setVector("texel",a);this.shaderNorm=shaderNMap;this.setFilter=this.outputBuffer.texture.setFilter;this.clear=this.outputBuffer.texture.clear;this.use=this.outputBuffer.texture.use;this.tex_id=this.outputBuffer.texture.tex_id;this.filterType=this.outputBuffer.texture.filterType;this.outTex.use(n.TEXTURE0);this.setFilter(b.texture.filter.LINEAR);
n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.REPEAT);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.REPEAT)}function f(a,c,g){var n=d.gl;this.width=a;this.height=c;this.outTex=new m.RenderBuffer(a,c,g);this.texture=this.outTex.texture;var e=v(a,c);this.setFilter=this.outTex.texture.setFilter;this.clear=this.outTex.texture.clear;this.use=this.outTex.texture.use;this.tex_id=this.outTex.texture.tex_id;this.filterType=this.outTex.texture.filterType;this.texture.use(n.TEXTURE0);e?(this.setFilter(b.texture.filter.LINEAR),
n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.REPEAT),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.REPEAT)):(this.setFilter(b.texture.filter.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE));this.dims=[a,c];this.depth=g?!0:!1}function e(a,c){this.scene=a;this.renderTex=new f(c?c.width:a.camera.width,c?c.height:a.camera.height,!0);this.setFilter=this.renderTex.texture.setFilter;this.clear=this.renderTex.texture.clear;
this.use=this.renderTex.texture.use;this.tex_id=this.renderTex.texture.tex_id;this.filterType=this.renderTex.texture.filterType}var d=m.GLCore,b=m.enums,n=m.undef,a=m.log;b.texture={map:{COLOR:0,ENVSPHERE:1,NORMAL:2,BUMP:3,REFLECT:4,SPECULAR:5,AMBIENT:6,ALPHA:7,MAX:8},filter:{LINEAR:0,LINEAR_MIP:1,NEAREST:2,NEAREST_MIP:3}};var c=function(a,c){this.img_path=a;this.filter_type=c};c.prototype={getTexture:function(a,c){return new g(this.img_path,this.filter_type,a,c)}};var g=function(a,c,g,e,f){var l=
d.gl;this.tex_id=m.Textures.length;this.filterType=-1;this.onready=f;this.loaded=!1;m.Textures[this.tex_id]=l.createTexture();m.Textures_obj[this.tex_id]=this;a&&("string"===typeof a?m.Images[this.tex_id]=new Image:"object"===typeof a&&"IMG"===a.nodeName&&(m.Images[this.tex_id]=a),m.Textures_ref[a]=this.tex_id);l.bindTexture(l.TEXTURE_2D,m.Textures[this.tex_id]);l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.LINEAR);l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.LINEAR);if(a){var o=this.tex_id,
q=c!==n?c:d.default_filter,r=this;m.Images[this.tex_id].onload=function(){l.bindTexture(l.TEXTURE_2D,m.Textures[o]);l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,true);l.pixelStorei(l.UNPACK_COLORSPACE_CONVERSION_WEBGL,l.NONE);var a=m.Images[o];l.texImage2D(l.TEXTURE_2D,0,l.RGBA,l.RGBA,l.UNSIGNED_BYTE,a);if(a=v(a.width,a.height)){l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.REPEAT);l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.REPEAT)}else{l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE);
l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE)}if(m.Textures_obj[o].filterType===-1){if(a)q=b.texture.filter.LINEAR_MIP;else if(q===b.texture.filter.LINEAR_MIP)q=b.texture.filter.LINEAR;m.Textures_obj[o].filterType===-1&&m.Textures_obj[o].setFilter(q)}else m.Textures_obj[o].setFilter(m.Textures_obj[o].filterType);if(r.onready)r.onready();l.bindTexture(l.TEXTURE_2D,null);r.loaded=true};g?(m.Images[this.tex_id].deferredSrc=a,g.addImage(e,a,m.Images[this.tex_id])):"string"===typeof a&&
(m.Images[this.tex_id].src=a)}this.active_unit=-1};g.prototype={setFilter:function(a){if(-1<this.tex_id){var c=m.GLCore.gl;c.bindTexture(c.TEXTURE_2D,m.Textures[this.tex_id]);a===b.texture.filter.LINEAR?(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR)):a===b.texture.filter.LINEAR_MIP?(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR_MIPMAP_NEAREST),c.generateMipmap(c.TEXTURE_2D)):
a===b.texture.filter.NEAREST?(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST)):a===b.texture.filter.NEAREST_MIP&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST_MIPMAP_LINEAR),c.generateMipmap(c.TEXTURE_2D));this.filterType=a}},use:function(a){-1<this.tex_id&&(d.gl.activeTexture(a),d.gl.bindTexture(d.gl.TEXTURE_2D,m.Textures[this.tex_id]),this.active_unit=
a)},clear:function(){-1<this.tex_id&&-1!==this.active_unit&&(d.gl.activeTexture(this.active_unit),d.gl.bindTexture(d.gl.TEXTURE_2D,null),this.active_unit=-1)},destroy:function(){var a=m.GLCore.gl;-1<this.tex_id&&m.Textures[this.tex_id]&&(a.deleteTexture(m.Textures[this.tex_id]),delete m.Textures_obj[this.tex_id],this.tex_id=-1)}};r.prototype={update:function(){this.updateFunction&&this.updateFunction(this.canvasSource,this.canvasContext);var a=m.GLCore.gl;a.bindTexture(a.TEXTURE_2D,m.Textures[this.texture.tex_id]);
a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvasSource);this.filterType===b.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};l.prototype={update:function(){this.updateFunction(this.canvasSource,this.canvasContext);var a=m.GLCore.gl;a.bindTexture(a.TEXTURE_2D,m.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvasSource);
this.filterType===b.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};o.prototype={update:function(){var a=m.GLCore.gl;this.pjs.redraw();a.bindTexture(a.TEXTURE_2D,m.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvas);this.filterType===b.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};q.prototype={update:function(){var a=
d.gl,c=a.getParameter(a.VIEWPORT);this.outputBuffer.use();a.viewport(0,0,this.width,this.height);a.clearColor(0,0,0,1);a.clear(a.COLOR_BUFFER_BIT);this.srcTex.use(a.TEXTURE0);m.fsQuad.render(this.shaderNorm,this.fsQuad);a.bindFramebuffer(a.FRAMEBUFFER,null);a.viewport(c[0],c[1],c[2],c[3])}};f.prototype={begin:function(){var a=d.gl;this.dims=a.getParameter(a.VIEWPORT);this.outTex.use();a.viewport(0,0,this.width,this.height);this.depth?a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT):a.clear(a.COLOR_BUFFER_BIT)},
end:function(){var a=d.gl;a.bindFramebuffer(a.FRAMEBUFFER,null);a.viewport(this.dims[0],this.dims[1],this.dims[2],this.dims[3])}};e.prototype={update:function(){this.renderTex.begin();this.scene.updateShadows();this.scene.render();this.renderTex.end()}};return{Texture:g,DeferredLoadTexture:c,CanvasTexture:r,PdfTexture:l,TextTexture:function(a,c){var b=c&&c.color||"#fff",d=c&&c.bgcolor,g=c&&c.font||"18pt Arial",e=c&&c.align||"start",f=c&&c.y||0,l=c&&c.width||n,o=c&&c.height||n,m,q=document.createElement("CANVAS"),
y=q.getContext("2d"),v=0,v="string"===typeof a?1:a.length;y.font=g;var C=c&&c.lineHeight||y.measureText("OO").width,E;if(1===v)E=y.measureText(a).width;else for(m=E=0;m<v;++m){var z=y.measureText(a[m]).width;z>E&&(E=z)}q.width=l||E;q.height=o||C*v;d&&(y.fillStyle=d,y.fillRect(0,0,q.width,q.height));y.fillStyle=b;y.font=g;y.textAlign=e;y.textBaseline="top";if(1===v)b=c&&c.x||"center"===e?q.width/2:"right"===e?q.width:0,y.fillText(a,b,f);else for(m=0;m<v;++m)b=c&&c.x||"center"===e?q.width/2:"right"===
e?q.width:0,y.fillText(a[m],b,f+m*C);y.fill();this.use=r.prototype.use;this.clear=r.prototype.clear;this.update=r.prototype.update;r.apply(this,[q]);this.update();this.canvasSource=null},PJSTexture:o,NormalMapGen:q,RenderTexture:f,SceneRenderTexture:e}});
CubicVR.RegisterModule("DrawBufferTexture",function(m){var v=m.GLCore,r=m.enums;r.draw={brush:{SINE:0,SQUARE:1},op:{ADD:0,REPLACE:1,SUBTRACT:2,MULTIPLY:3}};var l=function(l){l=l||{};this.operation=m.parseEnum(r.draw.op,l.operation||l.op)||r.draw.op.REPLACE;this.brushType=m.parseEnum(r.draw.brush,l.brushType)||r.draw.brush.SINE;this.brushSize=l.size||5;this.color=l.color||[255,255,255,255]};l.prototype={setOperation:function(l){this.operation=m.parseEnum(r.draw.op,l)},getOperation:function(){return this.operation},
setBrushType:function(l){this.brushType=m.parseEnum(r.draw.brush,l)||r.draw.brush.SINE},getBrushType:function(){return this.brushType},setSize:function(l){this.brushSize=l},getSize:function(){return this.brushSize},setColor:function(l){this.color=l},getColor:function(){return this.color.slice(0)}};return{DrawBufferTexture:m.extendClassGeneral(m.Texture,function(o){o=o||{};m.Texture.apply(this,[o.image,o.filter,o.deferred_bin,o.binId,o.readyFunc]);this.width=o.width||0;this.height=o.height||0;this.imageBufferData=
this.imageBuffer=null;this.brush=o.brush||new l;this.drawBuffer=[];this.width&&this.height&&this.setupImageBuffer(this.width,this.height)},{getUint8Buffer:function(){return this.imageBuffer},needsFlush:function(){return 0!==this.drawBuffer.length},getWidth:function(){return this.width},getHeight:function(){return this.height},setupImageBuffer:function(){this.imageBufferData=new ArrayBuffer(4*this.width*this.height);this.imageBuffer=new Uint8Array(this.imageBufferData);this.update()},setBrush:function(l){this.brush=
l},getBrush:function(){return this.brush},draw:function(l,m,f){var e=f||this.brush,f=e.getOperation(),d=e.getSize(),b=e.getBrushType(),e=e.getColor();this.drawBuffer.push([l,m,f,d,b,e])},flush:function(){if(!this.drawBuffer.length)return!1;for(;this.drawBuffer.length;){var l=this.drawBuffer.pop();this.drawFunc(l[0],l[1],l[2],l[3],l[4],l[5])}return!0},drawFunc:function(l,m,f,e,d,b){for(var n=this.imageBuffer,a=this.width,c=this.height,g=parseInt(Math.floor(l),10)-e;g<parseInt(Math.ceil(l),10)+e;g++)for(var h=
g-l,t,F=parseInt(Math.floor(m),10)-e;F<parseInt(Math.ceil(m),10)+e;F++)if(!(0>g||g>=a||0>F||F>=c)){t=F-m;var w;0===d&&(w=(1-Math.sqrt(h*h+t*t)/e)/2);t=4*(F*a+g);0===f?0>w&&(w=0):1===f?0>w&&(w=0):2===f&&(w=-w,0<w&&(w=0));var s=Math.floor(n[t]*(1-w)+b[0]*w),G=Math.floor(n[t+1]*(1-w)+b[1]*w),A=Math.floor(n[t+2]*(1-w)+b[2]*w),r=Math.floor(n[t+3]*(1-w)+b[3]*w);255<s?s=255:0>s&&(s=0);255<G?G=255:0>G&&(G=0);255<A?A=255:0>A&&(A=0);255<r?r=255:0>r&&(r=0);n[t]=s;n[t+1]=G;n[t+2]=A;n[t+3]=r}},update:function(){var l=
v.gl;this.flush();l.bindTexture(l.TEXTURE_2D,m.Textures[this.tex_id]);l.texImage2D(l.TEXTURE_2D,0,l.RGBA,this.width,this.height,0,l.RGBA,l.UNSIGNED_BYTE,this.imageBuffer);l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.LINEAR);l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.LINEAR)}}),DrawBufferBrush:l}});
CubicVR.RegisterModule("Material",function(m){function v(b){this.blendEnabled=this.dirtyFlag=this.initialized=!1;this.textures=[];this.shader=[];this.classType=m.enums.classType.MATERIAL;this.customShader=(b=m.get(b)||{},b.shader||null);null===q&&(q=new m.CustomShader({vertex:"precision lowp float; \nattribute vec3 vertexPosition; uniform mat4 matrixModelView; uniform mat4 matrixProjection; uniform mat4 matrixObject;\nvoid main(void) { gl_Position = matrixProjection * matrixModelView * matrixObject * vec4(vertexPosition,1.0); }",
fragment:"precision lowp float; \nvoid main(void) { gl_FragColor = vec4(1.0,0.0,1.0,1.0); }\n"}),q._init_shader(q._vertex,q._fragment,!1));this.customShader&&(!this.customShader._init_shader&&"object"===typeof this.customShader)&&(this.customShader=new m.CustomShader(this.customShader));this.diffuse=b.diffuse||[1,1,1];this.specular=b.specular||[0.1,0.1,0.1];this.color=b.color||[1,1,1];this.ambient=b.ambient||[0,0,0];this.name=b.name||null;this.visible=b.visible!==r?b.visible:!0;this.friction=b.friction!==
r?b.friction:0.3;this.collision=b.visible!==r?b.collision:!0;this.opacity=b.opacity===r?1:b.opacity;this.shininess=b.shininess===r?1:b.shininess;this.max_smooth=b.max_smooth===r?60:b.max_smooth;this.env_amount=b.env_amount===r?0.75:b.env_amount;this.morph=b.morph===r?!1:b.morph;this.color_map=b.colorMap===r?!1:b.colorMap;this.uvOffset=b.uvOffset===r?[0,0]:b.uvOffset;this.noFog=b.noFog===r?!1:b.noFog;this.pointSprite=b.pointSprite||!1;this.pointSize=b.pointSize||0;this.pointCircle=b.pointCircle||0;
if(b.textures)for(var d in b.textures)this.setTexture(b.textures[d],d)}var r=m.undef,l=m.GLCore,o=m.enums,q=null,f=[o.texture.map.REFLECT,o.texture.map.SPECULAR,o.texture.map.NORMAL,o.texture.map.BUMP],e=[],d="textureColor textureEnvSphere textureNormal textureBump textureReflect textureSpecular textureAmbient textureAlpha matrixModelView matrixProjection matrixObject matrixNormal vertexPosition vertexNormal vertexColor vertexTexCoord materialTexOffset vertexMorphPosition vertexMorphNormal materialMorphWeight lightDiffuse lightSpecular lightIntensity lightDistance lightPosition lightDirection lightCutOffAngle lightShadowMap lightProjectionMap lightDepthClip lightShadowMatrix lightAmbient materialDiffuse materialColor materialAmbient materialSpecular materialShininess materialEnvironment materialAlpha postDepthInfo".split(" ");
v.prototype={clone:function(){var b=new m.Material({diffuse:this.diffuse,specular:this.specular,color:this.color,ambient:this.ambient,opacity:this.opacity,shininess:this.shininess,max_smooth:this.max_smooth,env_amount:this.env_amount,morph:this.morph,colorMap:this.color_map,visible:this.visible,friction:this.friction,collision:this.collision,pointSprite:this.pointSprite,pointSize:this.pointSize,pointCircle:this.pointCircle,name:this.name}),d;for(d in this.textures)this.textures.hasOwnProperty(d)&&
b.setTexture(this.textures[d],d);return b},setVisibility:function(b){this.visible=b},getVisibility:function(){return this.visible},setCollision:function(b){this.collision=b},getCollision:function(){return this.collision},setFriction:function(b){this.friction=b},getFriction:function(){return this.friction},setTexture:function(b,d){if(b&&(d=m.parseEnum(o.texture.map,d)||0,m.features.texturePerPixel||-1===f.indexOf(d)))!b.use&&"string"===typeof b&&(b=m.Textures_ref[b]!==r?m.Textures_obj[m.Textures_ref[b]]:
new m.Texture(b)),this.textures[d]=b},calcShaderMask:function(){var b;b=0+("object"===typeof this.textures[o.texture.map.COLOR]?o.shader.map.COLOR:0);b+="object"===typeof this.textures[o.texture.map.SPECULAR]?o.shader.map.SPECULAR:0;b+="object"===typeof this.textures[o.texture.map.NORMAL]?o.shader.map.NORMAL:0;b+="object"===typeof this.textures[o.texture.map.BUMP]?o.shader.map.BUMP:0;b+="object"===typeof this.textures[o.texture.map.REFLECT]?o.shader.map.REFLECT:0;b+="object"===typeof this.textures[o.texture.map.ENVSPHERE]?
o.shader.map.ENVSPHERE:0;b+="object"===typeof this.textures[o.texture.map.AMBIENT]?o.shader.map.AMBIENT:0;b+="object"===typeof this.textures[o.texture.map.ALPHA]?o.shader.map.ALPHA:0;b+=this.pointSprite?o.shader.mode.POINT_SPRITE:0;b+=this.pointSize?o.shader.mode.POINT_SIZE:0;b+=this.pointCircle?o.shader.mode.POINT_CIRCLE:0;b+=1!==this.opacity?o.shader.map.ALPHA:0;b+=this.color_map?o.shader.map.COLORMAP:0;1!==this.opacity&&(this.blendEnabled=!0);return b},getShaderHeader:function(b,d){return(d!==
r?"#define LIGHT_COUNT "+d+"\n":"")+"#define TEXTURE_COLOR "+("object"===typeof this.textures[o.texture.map.COLOR]?1:0)+"\n#define TEXTURE_SPECULAR "+("object"===typeof this.textures[o.texture.map.SPECULAR]?1:0)+"\n#define TEXTURE_NORMAL "+("object"===typeof this.textures[o.texture.map.NORMAL]?1:0)+"\n#define TEXTURE_BUMP "+("object"===typeof this.textures[o.texture.map.BUMP]?1:0)+"\n#define TEXTURE_REFLECT "+("object"===typeof this.textures[o.texture.map.REFLECT]?1:0)+"\n#define TEXTURE_ENVSPHERE "+
("object"===typeof this.textures[o.texture.map.ENVSPHERE]?1:0)+"\n#define TEXTURE_AMBIENT "+("object"===typeof this.textures[o.texture.map.AMBIENT]?1:0)+"\n#define TEXTURE_ALPHA "+("object"===typeof this.textures[o.texture.map.ALPHA]?1:0)+"\n#define MATERIAL_ALPHA "+(1!==this.opacity?1:0)+"\n#define LIGHT_IS_POINT "+(b===o.light.type.POINT?1:0)+"\n#define LIGHT_IS_DIRECTIONAL "+(b===o.light.type.DIRECTIONAL?1:0)+"\n#define LIGHT_IS_SPOT "+(b===o.light.type.SPOT||b===o.light.type.SPOT_SHADOW||b===
o.light.type.SPOT_SHADOW_PROJECTOR?1:0)+"\n#define LIGHT_SHADOWED "+(b===o.light.type.SPOT_SHADOW||b===o.light.type.SPOT_SHADOW_PROJECTOR||b===o.light.type.AREA?1:0)+"\n#define LIGHT_IS_PROJECTOR "+(b===o.light.type.SPOT_SHADOW_PROJECTOR?1:0)+"\n#define LIGHT_SHADOWED_SOFT "+(l.soft_shadow?1:0)+"\n#define LIGHT_IS_AREA "+(b===o.light.type.AREA?1:0)+"\n#define LIGHT_DEPTH_PASS "+(b===o.light.type.DEPTH_PACK?1:0)+"\n#define FX_DEPTH_ALPHA "+(l.depth_alpha?1:0)+"\n#define VERTEX_MORPH "+(this.morph?
1:0)+"\n#define VERTEX_COLOR "+(this.color_map?1:0)+"\n#define FOG_ENABLED "+(l.fog_enabled&&!this.noFog?1:0)+"\n#define USE_FOG_EXP "+(l.fogExp?1:0)+"\n#define USE_FOG_LINEAR "+(l.fogLinear?1:0)+"\n#define LIGHT_PERPIXEL "+(m.features.lightPerPixel?1:0)+"\n#define POINT_SPRITE "+(this.pointSprite?1:0)+"\n#define POINT_SIZE "+(this.pointSize?1:0)+"\n#define POINT_CIRCLE "+(this.pointCircle?1:0)+"\n#define OES_STANDARD_DERIVATIVES "+(l.extensions.standard_derivatives?1:0)+"\n\n"},bindObject:function(b,
d){var a=l.gl,c=d.vertexPosition,g=d.vertexTexCoord,h=d.vertexNormal,f=d.vertexColor;a.bindBuffer(a.ARRAY_BUFFER,b.compiled.gl_points);a.vertexAttribPointer(c,3,a.FLOAT,!1,0,0);a.enableVertexAttribArray(c);g!==r&&(null!==b.compiled.gl_uvs&&-1!==g)&&(a.bindBuffer(a.ARRAY_BUFFER,b.compiled.gl_uvs),a.vertexAttribPointer(g,2,a.FLOAT,!1,0,0),a.enableVertexAttribArray(g));e.uv=g;h!==r&&(null!==b.compiled.gl_normals&&-1!==h)&&(a.bindBuffer(a.ARRAY_BUFFER,b.compiled.gl_normals),a.vertexAttribPointer(h,3,
a.FLOAT,!1,0,0),a.enableVertexAttribArray(h));e.un=h;f!==r&&(null!==b.compiled.gl_colors&&-1!==f)&&(a.bindBuffer(a.ARRAY_BUFFER,b.compiled.gl_colors),a.vertexAttribPointer(f,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(f));e.uc=f;b.morphTarget&&(c=d.vertexMorphPosition,h=d.vertexMorphNormal,a.bindBuffer(a.ARRAY_BUFFER,b.morphTarget.gl_points),a.vertexAttribPointer(c,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(c),h!==r&&(null!==b.morphTarget.gl_normals&&-1!==h)&&(a.bindBuffer(a.ARRAY_BUFFER,b.morphTarget.gl_normals),
a.vertexAttribPointer(h,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(h)),a.uniform1f(d.materialMorphWeight,b.morphWeight));b.compiled.unrolled?a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null):a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,b.compiled.gl_elements)},bindLines:function(b,d){var a=l.gl,c=d.vertexPosition,g=d.vertexTexCoord,h=d.vertexNormal,f=d.vertexColor;b.compiled.unrolled?(a.bindBuffer(a.ARRAY_BUFFER,b.compiled.gl_lines),a.vertexAttribPointer(c,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(c),e.up=c,g!==
r&&(null!==b.compiled.gl_line_uvs&&-1!==g)&&(a.bindBuffer(a.ARRAY_BUFFER,b.compiled.gl_line_uvs),a.vertexAttribPointer(g,2,a.FLOAT,!1,0,0),a.enableVertexAttribArray(g)),e.uv=g,h!==r&&(null!==b.compiled.gl_line_normals&&-1!==h)&&(a.bindBuffer(a.ARRAY_BUFFER,b.compiled.gl_line_normals),a.vertexAttribPointer(h,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(h)),e.un=h,f!==r&&(null!==b.compiled.gl_line_colors&&-1!==f)&&(a.bindBuffer(a.ARRAY_BUFFER,b.compiled.gl_line_colors),a.vertexAttribPointer(f,3,a.FLOAT,
!1,0,0),a.enableVertexAttribArray(f)),e.uc=f):a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,b.compiled.gl_line_elements);b.morphTarget&&(c=d.vertexMorphPosition,h=d.vertexMorphNormal,a.bindBuffer(a.ARRAY_BUFFER,b.morphTarget.gl_lines),a.vertexAttribPointer(c,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(c),h!==r&&(null!==b.morphTarget.gl_line_normals&&-1!==h)&&(a.bindBuffer(a.ARRAY_BUFFER,b.morphTarget.gl_line_normals),a.vertexAttribPointer(h,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(h)),a.uniform1f(d.materialMorphWeight,
b.morphWeight))},clearObject:function(b,d){var a=l.gl;e.uv!==r&&-1!==e.uv&&a.disableVertexAttribArray(e.uv);e.un!==r&&-1!==e.un&&a.disableVertexAttribArray(e.un);e.uc!==r&&-1!==e.uc&&a.disableVertexAttribArray(e.uc);b.morphTarget&&d&&(up=d.vertexMorphPosition,a.disableVertexAttribArray(up),un=d.vertexMorphNormal,null!==un&&(null!==b.compiled.gl_normals&&-1!==un)&&a.disableVertexAttribArray(un))},use:function(b,n){var a,c=l.gl,g=this.textures,h=!0,n=n||0,b=b||0;this.shader[b]||(this.shader[b]=[]);
var e=this.shader[b][n],f=this.customShader&&b===o.light.type.DEPTH_PACK&&!this.customShader.hasDepthPack();e&&(1!==this.opacity&&!0!==this.blendEnabled)&&(this.dirtyFlag=!0);!0===this.dirtyFlag&&(e=null,this.dirtyFlag=!1);if(e)h=e!==q,e.use();else{a=this.calcShaderMask(b);if(!this.customShader||f)m.ShaderPool[b][a]||(m.ShaderPool[b][a]=[]),e=m.ShaderPool[b][a][n];if(!e){var w=this.getShaderHeader(b,n),s=w+l.CoreShader_vs,w=w+l.CoreShader_fs;this.customShader&&!f?this.customShader._initialized||(this.customShader._init_shader(s,
w,d),e=this.customShader.getShader(),e.isCompiled()||(h=!1,e=q.getShader())):(e=new m.Shader(s,w),e.isCompiled()||(h=!1,e=q.getShader()),m.ShaderPool[b][a][n]=e);a=0;if(b!==o.light.type.DEPTH_PACK){if(b===o.light.type.SPOT_SHADOW||b===o.light.type.SPOT_SHADOW_PROJECTOR||b===o.light.type.AREA)a+=n,b===o.light.type.SPOT_SHADOW_PROJECTOR&&(a+=n);"object"===typeof g[o.texture.map.COLOR]&&e.addInt("textureColor",a++);"object"===typeof g[o.texture.map.ENVSPHERE]&&e.addInt("textureEnvSphere",a++);"object"===
typeof g[o.texture.map.NORMAL]&&e.addInt("textureNormal",a++);"object"===typeof g[o.texture.map.BUMP]&&e.addInt("textureBump",a++);"object"===typeof g[o.texture.map.REFLECT]&&e.addInt("textureReflect",a++);"object"===typeof g[o.texture.map.SPECULAR]&&e.addInt("textureSpecular",a++);"object"===typeof g[o.texture.map.AMBIENT]&&e.addInt("textureAmbient",a++)}"object"===typeof g[o.texture.map.ALPHA]&&e.addInt("textureAlpha",a++);e.addMatrix("matrixModelView");e.addMatrix("matrixProjection");e.addMatrix("matrixObject");
e.addMatrix("matrixNormal");e.addVertexArray("vertexPosition",0);e.addVertexArray("vertexNormal");this.color_map&&e.addVertexArray("vertexColor");this.morph&&(e.addVertexArray("vertexMorphPosition"),e.addVertexArray("vertexMorphNormal"),e.addFloat("materialMorphWeight",0));for(a=0;a<n;a++)if(e.addVector("lightDiffuse["+a+"]"),e.addVector("lightSpecular["+a+"]"),e.addFloat("lightIntensity["+a+"]"),e.addFloat("lightDistance["+a+"]"),e.addVector("lightPosition["+a+"]"),e.addVector("lightDirection["+
a+"]"),(b===o.light.type.SPOT_SHADOW||b===o.light.type.SPOT_SHADOW_PROJECTOR||b===o.light.type.SPOT)&&e.addFloat("lightCutOffAngle["+a+"]"),b===o.light.type.SPOT_SHADOW||b===o.light.type.SPOT_SHADOW_PROJECTOR||b===o.light.type.AREA)e.addInt("lightShadowMap["+a+"]"),b===o.light.type.SPOT_SHADOW_PROJECTOR&&e.addInt("lightProjectionMap["+a+"]"),e.addVector("lightDepthClip["+a+"]"),e.addMatrix("lightShadowMatrix["+a+"]");b!==o.light.type.DEPTH_PACK&&(e.addVector("lightAmbient"),e.addVector("materialDiffuse"),
e.addVector("materialColor"),e.addVector("materialAmbient"),e.addVector("materialSpecular"),e.addFloat("materialShininess"),e.addFloat("materialEnvironment"));e.addFloat("materialAlpha");(l.depth_alpha||b===o.light.type.DEPTH_PACK||b===o.light.type.SPOT_SHADOW||b===o.light.type.SPOT_SHADOW_PROJECTOR||b===o.light.type.AREA)&&e.addVector("postDepthInfo");e.addUVArray("vertexTexCoord");e.addVector("materialTexOffset");l.fog_enabled&&!this.noFog&&(e.addVector("fogColor",l.fogColor),e.addFloat("fogDensity",
l.fogDensity),e.addFloat("fogNear",l.fogNear),e.addFloat("fogFar",l.fogFar));if(this.pointSprite||this.pointSize)e.addFloat("pointSize",1),this.pointSize&&!this.pointSprite&&e.addVector("viewPort")}this.shader[b][n]=e;e.use();-1!=e.materialTexOffset&&c.uniform2fv(e.materialTexOffset,[0,0])}a=0;if(b!==o.light.type.DEPTH_PACK){if(b===o.light.type.SPOT_SHADOW||b===o.light.type.SPOT_SHADOW_PROJECTOR||b===o.light.type.AREA)a+=n,b===o.light.type.SPOT_SHADOW_PROJECTOR&&(a+=n);if(s=g[o.texture.map.COLOR])s.use(l.gl.TEXTURE0+
a),a++;if(s=g[o.texture.map.ENVSPHERE])s.use(l.gl.TEXTURE0+a),a++,c.uniform1f(e.materialEnvironment,this.env_amount);if(s=g[o.texture.map.NORMAL])s.use(l.gl.TEXTURE0+a),a++;if(s=g[o.texture.map.BUMP])s.use(l.gl.TEXTURE0+a),a++;if(s=g[o.texture.map.REFLECT])s.use(l.gl.TEXTURE0+a),a++;if(s=g[o.texture.map.SPECULAR])s.use(l.gl.TEXTURE0+a),a++;if(s=g[o.texture.map.AMBIENT])s.use(l.gl.TEXTURE0+a),a++}if(s=g[o.texture.map.ALPHA])s.use(l.gl.TEXTURE0+a),a++;l.fog_enabled&&!this.noFog&&(c.uniform3fv(e.fogColor,
l.fogColor),c.uniform1f(e.fogDensity,l.fogDensity),c.uniform1f(e.fogNear,l.fogNear),c.uniform1f(e.fogFar,l.fogFar));b!==o.light.type.DEPTH_PACK?(c.uniform3fv(e.materialColor,this.color),c.uniform3fv(e.materialDiffuse,this.diffuse),c.uniform3fv(e.materialAmbient,this.ambient),c.uniform3fv(e.materialSpecular,this.specular),c.uniform1f(e.materialShininess,128*this.shininess),c.uniform3fv(e.lightAmbient,m.globalAmbient),1>this.opacity&&c.uniform1f(e.materialAlpha,this.opacity),(l.depth_alpha||b===o.light.type.SPOT_SHADOW||
b===o.light.type.SPOT_SHADOW_PROJECTOR||b===o.light.type.AREA)&&c.uniform3fv(e.postDepthInfo,[l.depth_alpha_near,l.depth_alpha_far,0])):c.uniform3fv(e.postDepthInfo,[l.shadow_near,l.shadow_far,0]);e.materialTexOffset&&c.uniform2fv(e.materialTexOffset,this.uvOffset);if(this.pointSprite||this.pointSize)c.uniform1f(e.pointSize,this.pointSize),this.pointSprite||c.uniform3fv(e.viewPort,[l.viewportWidth,l.viewportHeight,0]);this.customShader&&(b!==o.light.type.DEPTH_PACK||b===o.light.type.DEPTH_PACK&&!f)&&
this.customShader._doUpdate({material:this,textureIndex:a});return h}};return{Material:v}});
CubicVR.RegisterModule("Mesh",function(m){function v(){this.points=[];this.point_normals=[];this.point_colors=[];this.uvs=[];this.normal=[0,0,0];this.segment=this.material=0}function r(f){this.compiled=null;this.materials=[];this.edges=this.instanceMaterials=this.bb=null;this.faces=[];this.points=[];this.currentFace=-1;this.currentSegment=this.currentMaterial=0;this.morphTarget=this.morphTargets=null;this.morphWeight=0;this.morphTargetIndex=this.morphSourceIndex=-1;this.originBuffer=null;this.genNormals=
!0;this.classType=m.enums.classType.MESH;f=m.get(f)||{};if(f instanceof m.Mesh)this.booleanAdd(f),f._clones=f._clones||1,f._clones++,this.name=f.name?f.name+"_copy"+f._clones:null;else{this.name=f.name||null;this.dynamic=f.dynamic||!1;if(f.material){var e=f.material;e.length?this.materials=e:"object"===typeof e&&(e.use?this.setFaceMaterial(e):this.setFaceMaterial(new m.Material(e)))}(f.point||f.points)&&this.build(f);f.part?this.build(f.part):f.parts&&this.build(f.parts);if((this.primitives=f.primitives||
f.primitive||null)&&!this.primitives.length||"string"===typeof this.primitives)this.primitives=[this.primitives];if(this.primitives&&this.primitives.length)for(var e=0,d=this.primitives.length;e<d;e++){var b=this.primitives[e];"string"===typeof b&&(b=m.get(b));var n=m.primitives[b.type];if(b.type&&n)this.booleanAdd(n(b));else if(b.type){q("Mesh error, primitive "+b.type+" is unknown.");var b="",a;for(a in m.primitives)m.primitives.hasOwnProperty(a)&&(""!==b&&(b+=", "),b+=a);q("Available primitive types are: "+
b)}else q("Mesh error, primitive "+(e+1)+" lacks type.")}this.pointMode=f.pointMode;this.buildWireframe=f.buildWireframe||f.wireframe||!!f.wireframeMaterial||!!f.pointModeMaterial||f.triangulateWireframe||f.pointMode||!1;this.triangulateWireframe=f.triangulateWireframe||null;this.wireframeMaterial=m.get(f.wireframeMaterial,m.Material)||null;this.pointModeMaterial=m.get(f.pointModeMaterial,m.Material)||null;this.wireframe=f.wireframe||!1;f.flipFaces&&this.faces.length&&this.flipFaces();(f.prepare||
f.compile&&this.faces.length)&&this.prepare();(f.clean||f.compile&&this.faces.length&&!this.dynamic)&&this.clean();this.genNormals&&(f.calcNormals&&!f.compile&&!f.prepare)&&this.calcNormals()}}var l=m.undef,o=m.GLCore,q=m.log;v.prototype={setUV:function(f,e){e!==l?this.uvs[e]=f:2!==f.length?this.uvs=f:this.uvs.push(f)},setPointNormal:function(f,e){e!==l?this.point_normals[e]=f:"number"===typeof f[0]?this.point_normals.push(f):this.point_normals=f},setNormal:function(f){this.normal=f;if(!this.point_normals.length&&
this.points.length)for(var e=0,d=this.points.length;e<d;e++)this.point_normals[e]=f},setColor:function(f,e){e!==l?this.point_colors[e]=f:"number"!==typeof f[0]?this.point_colors=f:this.point_colors.push(f)},flip:function(){for(var f=0,e=this.point_normals.length;f<e;f++)this.point_normals[f]=[-this.point_normals[f][0],-this.point_normals[f][1],-this.point_normals[f][2]];this.points.reverse();this.point_normals.reverse();this.uvs.reverse();this.normal=[-this.normal[0],-this.normal[1],-this.normal[2]]}};
r.prototype={setPointMode:function(f){this.pointMode=f},isPointMode:function(){return this.pointMode},setWireframe:function(f){this.wireframe=f},isWireframe:function(){return this.wireframe},setWireframeMaterial:function(f){this.wireframeMaterial=f},getWireframeMaterial:function(){return this.wireframeMaterial},setPointModeMaterial:function(f){this.pointModeMaterial=f},getPointModeMaterial:function(){return this.pointModeMaterial},build:function(f,e){var d,b;"string"===typeof f&&(f=m.get(f));f&&!f.length&&
(f=[f]);var n=this.faces.length;e&&e.length&&this.points.concat(e);for(var a=0,c=f.length;a<c;a++){var g=f[a];d=g.material;b=g.points||g.point;var h=g.faces||g.face,t=g.uv||g.uvs,l=g.color||g.colors,o=g.normal||g.normals,g=g.segment||null;null!==g&&this.setSegment(parseInt(g,10));if(b&&b.length&&(this.points=this.points.concat(b),h&&n)){h=h.slice(0);b=0;for(g=h.length;b<g;b++)for(var s=h[b],G=0,A=h.length;G<A;G++)s[G]+=n}d&&(d.length?this.materials=d:"object"===typeof d&&(d.use?this.setFaceMaterial(d):
this.setFaceMaterial(new m.Material(d))));h&&h.length&&this.addFace(h);if(h&&t&&"object"===typeof t){g=null;if(t.length)if(t.length===h.length){d=0;for(b=t.length;d<b;d++)this.faces[d+n].setUV(t[d])}else q("Mesh error in part, face count: "+h.length+", uv count:"+t.length);else g=t.apply?t:new m.UVMapper(t);g&&g.apply(this,this.currentMaterial,this.currentSegment,n,this.faces.length-n)}if(h&&o)if(o.length&&o[0].length)if(o.length===h.length){this.genNormals=!1;t="number"===typeof o[0][0];d=0;for(b=
o.length;d<b;d++)t?this.faces[d+n].setNormal(o[d]):this.faces[d+n].setPointNormal(o[d])}else q("Mesh error in part, face count: "+h.length+", normals count:"+t.length);else q("Mesh error in part, unknown something where normals should be? ["+typeof o+"]");if(h&&l&&"object"===typeof l)if(l.length&&l.length===h.length){d=0;for(b=l.length;d<b;d++)this.faces[d+n].setColor(l[d]);this.materials[this.currentMaterial].colorMap=!0}else q("Mesh error in part, face count: "+h.length+", color count:"+l.length)}return this},
showAllSegments:function(){for(var f in this.segment_state)this.segment_state.hasOwnProperty(f)&&(this.segment_state[f]=!0)},hideAllSegments:function(){for(var f in this.segment_state)this.segment_state.hasOwnProperty(f)&&(this.segment_state[f]=!1)},setSegment:function(f,e){e!==l?this.segment_state[f]=e:this.currentSegment=f},addPoint:function(f){if(3!==f.length||"object"===typeof f[0])for(var e=0,d=f.length;e<d;e++)this.points.push(f[e]);else this.points.push(f);return this.points.length-1},getMaterialIndex:function(f){return this.materials.indexOf(f)},
setFaceMaterial:function(f,e){var d;"number"==typeof f?d=f:(d=this.materials.indexOf(f),-1===d&&(this.materials.push(f),d=this.materials.length-1));e!==l?this.faces[e]!==l&&(this.faces[e].material=d):this.currentMaterial=d;return this},addFace:function(f,e,d,b){if(f===l)return this.currentFace=this.faces.length,this.faces.push(new v),this.currentFace;if("number"!==typeof f[0]){e=0;for(d=f.length;e<d;e++)this.addFace(f[e])}else return e===l?(this.currentFace=this.faces.length,this.faces.push(new v)):
(this.faces[e]===l&&(this.faces[e]=new v),this.currentFace=e),"object"===typeof f&&(this.faces[this.currentFace].points=f),d!==l?this.setFaceMaterial(d,this.currentFace):this.faces[this.currentFace].material=this.currentMaterial,this.faces[this.currentFace].segment=b!==l?b:this.currentSegment,this.currentFace},flipFaces:function(){for(var f=0,e=this.faces.length;f<e;f++)this.faces[f].flip()},triangulate:function(){for(var f,e,d,b,n,a,c=0,g=this.faces.length;c<g;c++)if(n=this.faces[c],b=n.points,4===
b.length){if(a=this.faces[this.addFace([b[2],b.pop(),b[0]],this.faces.length,n.material,n.segment)],a.normal=n.normal.slice(0),f=n.point_colors,4===f.length&&(a.point_colors=[f[2].slice(0),f.pop(),f[0].slice(0)]),e=n.uvs,4===e.length&&(a.uvs=[e[2].slice(0),e.pop(),e[0].slice(0)]),d=n.point_normals,4===d.length)a.point_normals=[d[2].slice(0),d.pop(),d[0].slice(0)]}else if(4<b.length){f=[];a=[];var h,t;e=[0,0,0];d=m.vec3;var l;h=0;for(t=b.length;h<t;h++)e=d.add(e,this.points[b[h]]),a[h]=this.points[b[h]];
e[0]/=b.length;e[1]/=b.length;e[2]/=b.length;h=0;for(t=b.length;h<t;h++)if(!d.equal(e,this.points[b[h]])){l=d.normalize(d.subtract(this.points[b[h]],e));break}h=n.normal=m.polygon.normal(a);a=l;var o=d.normalize(d.cross(l,h));h=0;for(t=b.length;h<t;h++){var s=d.subtract(e,this.points[b[h]]);f[h]=[d.dot(a,s),d.dot(o,s)]}o=m.polygon.triangulate2D(f);if(null!==o){f=n.point_colors;e=n.uvs;d=n.point_normals;h=0;for(t=o.length;h<t;h+=3)if(0===h?(this.faces[c]=new m.Face,a=this.faces[c]):a=this.faces[this.addFace()],
a.material=n.material,a.segment=n.segment,a.points=[b[o[h]],b[o[h+1]],b[o[h+2]]],a.normal=n.normal.slice(0),f.length&&(a.point_colors=[f[o[h]].slice(0),f[o[h+1]].slice(0),f[o[h+2]].slice(0)]),e.length&&(a.uvs=[e[o[h]].slice(0),e[o[h+1]].slice(0),e[o[h+2]].slice(0)]),d.length)a.point_normals=[d[o[h]].slice(0),d[o[h+1]].slice(0),d[o[h+2]].slice(0)]}else m.log("Unable to triangulate face "+c+", possible degenerate poly.")}return this},booleanAdd:function(f,e){var d=m.mat4,b=this.points.length,n,a,c,
g;n=e;e=n===l?l:"array"===typeof n?n:"object"===typeof n?n.getResult?n.getResult():n.position||n.rotation||n.scale?m.mat4.transform(n.position,n.rotation,n.scale):n:void 0;f.wireframeMaterial&&(this.wireframeMaterial=f.wireframeMaterial);f.pointMaterial&&(this.pointMaterial=f.pointMaterial);if(e!==l){a=e;n=0;for(c=f.points.length;n<c;n++)this.addPoint(d.vec3_multiply(f.points[n],a))}else{n=0;for(c=f.points.length;n<c;n++)this.addPoint([f.points[n][0],f.points[n][1],f.points[n][2]])}d=[];n=0;for(c=
f.materials.length;n<c;n++)a=this.materials.indexOf(f.materials[n]),-1===a?(this.materials.push(f.materials[n]),d[n]=this.materials.length-1):d[n]=a;n=0;for(c=f.faces.length;n<c;n++){var h=[];a=0;for(g=f.faces[n].points.length;a<g;a++)h.push(f.faces[n].points[a]+b);h=this.faces[this.addFace(h)];h.segment=f.faces[n].segment;h.material=d[f.faces[n].material];h.material===l&&(h.material=0);a=0;for(g=f.faces[n].uvs.length;a<g;a++)h.uvs[a]=[f.faces[n].uvs[a][0],f.faces[n].uvs[a][1]];a=0;for(g=f.faces[n].point_normals.length;a<
g;a++)h.point_normals[a]=[f.faces[n].point_normals[a][0],f.faces[n].point_normals[a][1],f.faces[n].point_normals[a][2]]}return this},calcFaceNormals:function(f,e){var d=m.vec3,b=m.triangle,n=0,a=this.faces.length,c,g=this.points,h;f&&(n=f);for(e&&(a=e+1);n<a;n++)c=this.faces[n],h=c.points,c.normal=3>h.length?[0,0,0]:d.normalize(b.normal(g[h[0]],g[h[1]],g[h[2]]));return this},getMaterial:function(f){if(!isNaN(parseInt(f,10)))return this.materials[e];for(var e=0,d=this.materials.length;e<d;e++)if(this.materials[e].name===
f)return this.materials[e];return null},getMaterials:function(){return this.materials},bindInstanceMaterials:function(f){this.instanceMaterials=f},calcNormals:function(f){var e=m.vec3,d=!1,b;this.genNormals=!0;this.dynamic&&(b=[],f=f||{});f!==l&&(b=[],d=!0);this.calcFaceNormals();var n,a,c,g,h=Array(this.points.length);n=0;for(g=h.length;n<g;n++)h[n]=[];g=this.faces.length;for(n=0;n<g;n++){c=this.faces[n].points.length;for(a=0;a<c;a++)h[this.faces[n].points[a]].push([n,a])}n=0;for(g=this.points.length;n<
g;n++){var t=h[n].length;for(a=0;a<t;a++){var o=1,w=h[n][a][0],s=h[n][a][1],q=this.materials.length?this.materials[this.faces[w].material].max_smooth:60,A=this.faces[w];d&&(b[w]===l&&(b[w]=[]),b[w][s]===l&&(b[w][s]=[]));var r=Array(3);r[0]=A.normal[0];r[1]=A.normal[1];r[2]=A.normal[2];if(0!==q)for(c=0;c<t;c++)if(a!==c){var B=h[n][c][0],u=this.faces[B],x=e.angle(u.normal,A.normal);if(x!==x||x*(180/Math.PI)<=q)d&&b[w][s].push(B),r[0]+=u.normal[0],r[1]+=u.normal[1],r[2]+=u.normal[2],o++}r[0]/=o;r[1]/=
o;r[2]/=o;this.faces[w].point_normals[s]=e.normalize(r)}}if(d){n=e=0;for(g=b.length;n<g;n++){a=0;for(c=b[n].length;a<c;a++)e+=b[n][a].length}f.faceCount||(f.faceCount=new Uint8Array(3*this.faces.length));f.faceNorm||(f.faceNorm=65535<this.faces.length?new Uint32Array(e):new Uint16Array(e));f.faceNormIdx||(f.faceNormIdx=65535<this.faces.length?new Uint32Array(this.faces.length):new Uint16Array(this.faces.length));n=e=0;for(g=this.faces.length;n<g;n++)for(a=0;3>a;a++)if(d=b[n][a],f.faceCount[3*n+a]=
d?d.length:0,f.faceNormIdx[n]=e,d){c=0;for(d=d.length;c<d;c++)f.faceNorm[e++]=b[n][a][c]}else e++;this.normalMapRef=f}return this},recalcNormals:function(f,e){if(this.genNormals){var d,b,n,a,c,g,h,t,o,m,e=e||{};if(f=f||this.normalMapRef){d=e.segments!==l?!0:!1;b=e.segments;this.calcFaceNormals();var s=0,q=0,A=0,r;if(d)for(var q=this.dynamicData.VBO.dynamicMap,B=f.faceNormIdx,u=0,x=b.length;u<x;u++)for(var y=q.segmentMap[b[u]],v=0,C=y.length;v<C;v++){d=y[v];o=this.faces[d];r=o.normal;s=B[d];for(j=
0;3>j;j++){t=o.point_normals[j];c=r[0];g=r[1];h=r[2];m=f.faceCount[3*d+j];n=0;for(iMax=m;n<iMax;n++)a=f.faceNorm[s+n],a=this.faces[a],a=a.normal,c+=a[0],g+=a[1],h+=a[2];m?(n=m+1,c/=n,g/=n,h/=n,n=Math.sqrt(c*c+g*g+h*h),c/=n,g/=n,h/=n,t[0]=c,t[1]=g,t[2]=h):A++}}else{d=0;for(b=this.faces.length;d<b;d++){o=this.faces[d];r=o.normal;for(j=0;3>j;j++){t=o.point_normals[j];c=r[0];g=r[1];h=r[2];m=f.faceCount[q++];n=0;for(iMax=m;n<iMax;n++)a=f.faceNorm[s++],a=this.faces[a],a=a.normal,c+=a[0],g+=a[1],h+=a[2];
m?(n=m+1,c/=n,g/=n,h/=n,n=Math.sqrt(c*c+g*g+h*h),c/=n,g/=n,h/=n,t[0]=c,t[1]=g,t[2]=h):A++}}}return this}}},removeDoubles:function(f){var e=[],d=[],b,n,a,c;b=0;for(n=this.points.length;b<n;b++){var g=-1,h=this.points[b];a=0;for(c=e.length;a<c;a++)if(m.vec3.equal(h,e[a],f)){g=a;break}-1!=g?d[b]=g:(d[b]=e.length,e.push(this.points[b]))}this.points=e;b=0;for(n=this.faces.length;b<n;b++){f=this.faces[b];a=0;for(c=f.points.length;a<c;a++)f.points[a]=d[f.points[a]]}return this},buildEdges:function(){var f,
e,d,b,n=[],a=[];f=0;for(d=this.faces.length;f<d;f++){var c=this.faces[f];e=0;for(b=c.points.length;e<b;e++){var g,h,t;t=c.segment;matId=c.material;e?(h=c.points[e],g=c.points[e-1]):(h=c.points[e],g=c.points[b-1]);n[g]=n[g]||{};n[g][matId]=n[g][matId]||{};n[g][matId][t]=n[g][matId][t]||{};!n[g][matId][t][h]&&(!n[h]||!n[h][matId][t][g])&&a.push([matId,t,g,h])}}this.edges=a;return this},subdivide:function(f,e){var d=m.vec3,e=e===l?!0:e;f===l&&(f=1);if(0!==f){var b,n,a,c,g,h={},t=[],o=[],w=this.points.length,
s=this.faces.length,G=[],A=[],r=[],B=[];b=0;for(a=s;b<a;b++)if(g=this.faces[b],g.points&&(3===g.points.length||4===g.points.length)){var u=[0,0,0];n=0;for(c=g.points.length;n<c;n++){var x=this.points[g.points[n]];u[0]+=x[0];u[1]+=x[1];u[2]+=x[2]}u[0]/=c;u[1]/=c;u[2]/=c;G[b]=this.addPoint(u);if(g.uvs.length===g.points.length){u=[0,0];n=0;for(c=g.uvs.length;n<c;n++)x=g.uvs[n],u[0]+=x[0],u[1]+=x[1];u[0]/=c;u[1]/=c;A[b]=u}if(g.point_colors.length===g.points.length){u=[0,0,0];n=0;for(c=g.point_colors.length;n<
c;n++)x=g.point_colors[n],u[0]+=x[0],u[1]+=x[1],u[2]+=x[2];u[0]/=c;u[1]/=c;u[2]/=c;r[b]=u}if(g.point_normals.length===g.points.length){u=[0,0,0];n=0;for(c=g.point_normals.length;n<c;n++)x=g.point_normals[n],u[0]+=x[0],u[1]+=x[1],u[2]+=x[2];u[0]/=c;u[1]/=c;u[2]/=c;B[b]=u}}b=0;for(a=this.faces.length;b<a;b++){g=this.faces[b];n=0;for(c=g.points.length;n<c;n++){var y,v;n?(y=n,v=n-1):(y=n,v=c-1);x=g.points[y];u=g.points[v];h[u]=h[u]||{};t[u]=t[u]||[];t[u].push(b);h[u][x]={face:b,a:u,b:x,fpa:y,fpb:v}}}for(b in h)if(h.hasOwnProperty(b))for(n in h[b])if(h[b].hasOwnProperty(n)){a=
h[b][n];g=h[n][b];if(g===l){q("Mesh.subdivide error. Hole at face #"+a.face+", Edge:["+a.fpa+"->"+a.fpb+"], holes not yet supported; perhaps use Mesh.removeDoubles()?");return}a.edge_point||(c=d.multiply(d.add(this.points[a.a],this.points[a.b]),0.5),e?(u=d.multiply(d.add(this.points[G[a.face]],this.points[G[g.face]]),0.5),a.edge_point=d.multiply(d.add(c,u),0.5)):a.edge_point=c,g.edge_point=a.edge_point,a.edge_avg=c,g.edge_avg=c,a.ep_idx=this.addPoint(a.edge_point),g.ep_idx=a.ep_idx);o[a.a]=o[a.a]||
[];o[a.a].push(a.edge_avg);c=this.faces[a.face].uvs;c.length&&(g=c[a.fpa],c=c[a.fpb],a.uv=[(g[0]+c[0])/2,(g[1]+c[1])/2]);g=this.faces[a.face].point_colors;g.length&&(a.color=d.multiply(d.add(g[a.fpa],g[a.fpb]),0.5));g=this.faces[a.face].point_normals;g.length&&(a.normal=d.normalize(d.multiply(d.add(g[a.fpa],g[a.fpb]),0.5)))}if(e){g=[];b=0;for(a=w;b<a;b++)if(u=[0,0,0],t[b]){n=0;for(c=t[b].length;n<c;n++)x=this.points[G[t[b][n]]],u[0]+=x[0],u[1]+=x[1],u[2]+=x[2];u[0]/=c;u[1]/=c;u[2]/=c;g[b]=u}u=[];
b=0;for(a=w;b<a;b++)if(x=[0,0,0],o[b]){n=0;for(c=o[b].length;n<c;n++)y=o[b][n],x[0]+=y[0],x[1]+=y[1],x[2]+=y[2];x[0]/=c;x[1]/=c;x[2]/=c;u[b]=x}b=0;for(a=w;b<a;b++)t[b]&&(w=t[b].length,n=1/w,o=2/w,w=d.multiply(this.points[b],(w-3)/w),w=d.add(w,d.multiply(g[b],n)),w=d.add(w,d.multiply(u[b],o)),this.points[b]=w)}for(b=0;b<s;b++)if(g=this.faces[b],!(3!==g.points.length&&4!==g.points.length))if(d=g.points.slice(0),t=g.uvs.slice(0),n=g.point_colors.slice(0),o=g.point_normals.slice(0),w=t.length===d.length,
a=n.length===d.length,c=o.length===d.length,g=g.material,3===d.length){if(this.setFaceMaterial(g),u=h[d[0]][d[1]],x=h[d[2]][d[0]],this.addFace([d[0],u.ep_idx,G[b],x.ep_idx],b),w&&(this.faces[b].uvs=[t[0],u.uv,A[b],x.uv]),a&&(this.faces[b].point_colors=[n[0],u.color,r[b],x.color]),c&&(this.faces[b].point_normals=[o[0],u.normal,B[b],x.normal]),u=h[d[1]][d[2]],x=h[d[0]][d[1]],g=this.addFace([d[1],u.ep_idx,G[b],x.ep_idx]),w&&(this.faces[g].uvs=[t[1],u.uv,A[b],x.uv]),a&&(this.faces[g].point_colors=[n[1],
u.color,r[b],x.color]),c&&(this.faces[g].point_normals=[o[1],u.normal,B[b],x.normal]),u=h[d[2]][d[0]],x=h[d[1]][d[2]],g=this.addFace([d[2],u.ep_idx,G[b],x.ep_idx]),w&&(this.faces[g].uvs=[t[2],u.uv,A[b],x.uv]),a&&(this.faces[g].point_colors=[n[2],u.color,r[b],x.color]),c)this.faces[g].point_normals=[o[2],u.normal,B[b],x.normal]}else if(this.setFaceMaterial(g),u=h[d[0]][d[1]],x=h[d[3]][d[0]],this.addFace([d[0],u.ep_idx,G[b],x.ep_idx],b),w&&(this.faces[b].uvs=[t[0],u.uv,A[b],x.uv]),a&&(this.faces[b].point_colors=
[n[0],u.color,r[b],x.color]),c&&(this.faces[b].point_normals=[o[0],u.normal,B[b],x.normal]),u=h[d[1]][d[2]],x=h[d[0]][d[1]],g=this.addFace([d[1],u.ep_idx,G[b],x.ep_idx]),w&&(this.faces[g].uvs=[t[1],u.uv,A[b],x.uv]),a&&(this.faces[g].point_colors=[n[1],u.color,r[b],x.color]),c&&(this.faces[g].point_normals=[o[1],u.normal,B[b],x.normal]),u=h[d[2]][d[3]],x=h[d[1]][d[2]],g=this.addFace([d[2],u.ep_idx,G[b],x.ep_idx]),w&&(this.faces[g].uvs=[t[2],u.uv,A[b],x.uv]),a&&(this.faces[g].point_colors=[n[2],u.color,
r[b],x.color]),c&&(this.faces[g].point_normals=[o[2],u.normal,B[b],x.normal]),u=h[d[3]][d[0]],x=h[d[2]][d[3]],g=this.addFace([d[3],u.ep_idx,G[b],x.ep_idx]),w&&(this.faces[g].uvs=[t[3],u.uv,A[b],x.uv]),a&&(this.faces[g].point_colors=[n[3],u.color,r[b],x.color]),c)this.faces[g].point_normals=[o[3],u.normal,B[b],x.normal];f--;if(0!==f)this.subdivide(f,e);else return this}},removeInternals:function(){var f,e,d,b,n,a={},c=this.faces.length,g,h,t,o;f=0;for(d=this.faces.length;f<d;f++){n=this.faces[f];e=
0;for(b=n.points.length;e<b;e++)e?(t=e,o=e-1):(t=e,o=b-1),g=n.points[t],h=n.points[o],a[g]=a[g]||{},a[g][h]===l?a[g][h]=[f]:a[g][h].push(f)}d=function(c){return-1!==a[h][g].indexOf(c)};for(f=0;f<c;f++){n=this.faces[f];var m=null;e=0;for(b=n.points.length;e<b;e++)e?(t=e,o=e-1):(t=e,o=b-1),g=n.points[t],h=n.points[o],m=m?m.filter(d):a[h][g];m.length&&(this.faces.splice(f,1),c--,f--)}return this},prepare:function(f){f===l&&(f=!0);this.buildWireframe&&!this.triangulateWireframe&&this.buildEdges();this.triangulateQuads();
this.genNormals&&this.calcNormals();this.buildWireframe&&this.triangulateWireframe&&this.buildEdges();this.compile();f&&!this.dynamic&&this.clean();return this},clean:function(){var f,e;f=0;for(e=this.points.length;f<e;f++)delete this.points[f],this.points[f]=null;this.points=[];f=0;for(e=this.faces.length;f<e;f++)delete this.faces[f].points,delete this.faces[f].point_normals,delete this.faces[f].uvs,delete this.faces[f].normal,delete this.faces[f],this.faces[f]=null;this.faces=[];return this},compileMap:function(f){var e=
m.vec3,d=m.vec2;f===l&&(f=1.0E-5);var b={segments:[],bounds:[]},n=[],a,c,g,h,t,o,w,s;this.materials.length||this.materials.push(new m.Material);a=0;for(o=this.materials.length;a<o;a++)n[a]=[];a=0;for(o=this.faces.length;a<o;a++)3===this.faces[a].points.length&&(g=this.faces[a].material,h=this.faces[a].segment,n[g][h]===l&&(n[g][h]=[],b.segments.push(h)),n[g][h].push(a));var q=[],A=0,r=!1,B=!1,u=!1,x;a=0;for(o=n.length;a<o;a++)for(c in n[a])if(n[a].hasOwnProperty(c))for(g=0;g<n[a][c].length;g++)x=
n[a][c][g],r=r||0!==this.faces[x].uvs.length,B=B||0!==this.faces[x].point_normals.length,u=u||0!==this.faces[x].point_colors.length;if(r)for(a=0;a<this.faces.length;a++)if(!this.faces[a].uvs.length)for(c=0;c<this.faces[a].points.length;c++)this.faces[a].uvs.push([0,0]);if(B)for(a=0;a<this.faces.length;a++)if(!this.faces[a].point_normals.length)for(c=0;c<this.faces[a].points.length;c++)this.faces[a].point_normals.push([0,0,0]);if(u)for(a=0;a<this.faces.length;a++)if(!this.faces[a].point_colors.length)for(c=
0;c<this.faces[a].points.length;c++)this.faces[a].point_colors.push([0,0,0]);a=0;for(o=n.length;a<o;a++)for(c in n[a])if(n[a].hasOwnProperty(c)){g=0;for(w=n[a][c].length;g<w;g++){x=n[a][c][g];for(h=0;3>h;h++){var y=this.faces[x].points[h],v=-1;if(q[y]!==l){t=0;for(s=q[y].length;t<s;t++){var C=q[y][t][0],E=q[y][t][1],v=q[y][t][2];B&&(v=e.equal(this.faces[C].point_normals[E],this.faces[x].point_normals[h],f)?v:-1);r&&(v=d.equal(this.faces[C].uvs[E],this.faces[x].uvs[h],f)?v:-1);u&&(v=e.equal(this.faces[C].point_colors[E],
this.faces[x].point_colors[h],f)?v:-1)}}-1!==v?(b.elements===l&&(b.elements=[]),b.elements[a]===l&&(b.elements[a]=[]),b.elements[a][c]===l&&(b.elements[a][c]=[]),b.elements[a][c].push(v)):(b.points===l&&(b.points=[]),b.points.push(y),0===b.bounds.length?(b.bounds[0]=[this.points[y][0],this.points[y][1],this.points[y][2]],b.bounds[1]=[this.points[y][0],this.points[y][1],this.points[y][2]]):(this.points[y][0]<b.bounds[0][0]&&(b.bounds[0][0]=this.points[y][0]),this.points[y][1]<b.bounds[0][1]&&(b.bounds[0][1]=
this.points[y][1]),this.points[y][2]<b.bounds[0][2]&&(b.bounds[0][2]=this.points[y][2]),this.points[y][0]>b.bounds[1][0]&&(b.bounds[1][0]=this.points[y][0]),this.points[y][1]>b.bounds[1][1]&&(b.bounds[1][1]=this.points[y][1]),this.points[y][2]>b.bounds[1][2]&&(b.bounds[1][2]=this.points[y][2])),B&&(b.normals===l&&(b.normals=[]),b.normals.push([x,h])),u&&(b.colors===l&&(b.colors=[]),b.colors.push([x,h])),r&&(b.uvs===l&&(b.uvs=[]),b.uvs.push([x,h])),b.elements===l&&(b.elements=[]),b.elements[a]===l&&
(b.elements[a]=[]),b.elements[a][c]===l&&(b.elements[a][c]=[]),b.elements[a][c].push(A),q[y]===l&&(q[y]=[]),q[y].push([x,h,A]),A++)}}}if(this.edges){b.line_elements=[];a=0;for(o=this.edges.length;a<o;a++)e=this.edges[a],g=e[0],h=e[1],f=e[2],e=e[3],b.line_elements[g]=b.line_elements[g]||[],b.line_elements[g][h]=b.line_elements[g][h]||[],b.line_elements[g][h].push(q[f][0][2]),b.line_elements[g][h].push(q[e][0][2])}b.dynamic=this.dynamic;return b},compileVBO:function(f,e,d,b,n,a,c,g){"object"==typeof e?
(e=e.element!==l?e.element:!0,d=e.vertex!==l?e.vertex:!0,a=e.color!==l?e.color:!0,b=e.normal!==l?e.normal:!0,n=e.uv!==l?e.uv:!0,c=e.lines!==l?e.lines:!!f.line_elements,g=e.dynamic!==l?e.dynamic:f.dynamic):(e===l&&(e=!0),d===l&&(d=!0),a===l&&(a=!0),b===l&&(b=!0),n===l&&(n=!0),c===l&&(c=!!f.line_elements),g===l&&(g=f.dynamic));var h={},t,m,w,s,q,r,H,B,u;t=f.points.length||f.uvs.length||f.normals.length||f.colors.length;var x=65535<t,y=x&&!o.extensions.element_index_uint;h.element_type=x&&!y?o.gl.UNSIGNED_INT:
o.gl.UNSIGNED_SHORT;g&&(u={points:x?new Uint32Array(f.points.length):new Uint16Array(f.points.length),face_points:x?new Uint32Array(2*f.points.length):new Uint16Array(2*f.points.length),segments:null},h.dynamicMap=u,h.dynamic=!0);if(d=f.points&&d){h.vbo_points=new Float32Array(3*t);s=0;for(r=t;s<r;s++)w=f.points[s],h.vbo_points[3*s]=this.points[w][0],h.vbo_points[3*s+1]=this.points[w][1],h.vbo_points[3*s+2]=this.points[w][2],g&&(u.points[s]=w)}if(g){m=f.normals||f.colors||f.uvs;s=0;for(r=m.length;s<
r;s++)w=m[s],u.face_points[2*s]=w[0],u.face_points[2*s+1]=w[1]}if(b=f.normals&&b){h.vbo_normals=new Float32Array(3*t);s=m=0;for(r=t;s<r;s++)w=f.normals[s],h.vbo_normals[m++]=this.faces[w[0]].point_normals[w[1]][0],h.vbo_normals[m++]=this.faces[w[0]].point_normals[w[1]][1],h.vbo_normals[m++]=this.faces[w[0]].point_normals[w[1]][2]}if(a=f.colors&&a){h.vbo_colors=new Float32Array(3*t);s=m=0;for(r=t;s<r;s++)w=f.colors[s],h.vbo_colors[m++]=this.faces[w[0]].point_colors[w[1]][0],h.vbo_colors[m++]=this.faces[w[0]].point_colors[w[1]][1],
h.vbo_colors[m++]=this.faces[w[0]].point_colors[w[1]][2]}if(n=f.uvs&&n){t=f.uvs.length;h.vbo_uvs=new Float32Array(2*t);s=m=0;for(r=t;s<r;s++)w=f.uvs[s],h.vbo_uvs[m++]=this.faces[w[0]].uvs[w[1]][0],h.vbo_uvs[m++]=this.faces[w[0]].uvs[w[1]][1]}t=[];w=0;if(e){h.elements_ref=[];h.vbo_elements=[];s=0;for(r=f.elements.length;s<r;s++)for(q in h.elements_ref[s]=[],e=0,f.elements[s])if(f.elements[s].hasOwnProperty(q)){B=f.elements[s][q];m=0;for(H=B.length;m<H;m++)t.push(B[m]);h.elements_ref[s][e]=[q|0,B.length|
0];e++}w=t.length/3;h.vbo_elements=x?new Uint32Array(t):new Uint16Array(t)}h.segments=f.segments;h.bounds=f.bounds;if(c){if(y){if(h.vbo_lines=[],b&&(h.vbo_line_normals=[]),n&&(h.vbo_line_uvs=[]),a)h.vbo_line_colors=[]}else h.vbo_line_elements=[];h.line_elements_ref=[];s=0;for(r=f.line_elements.length;s<r;s++)for(q in h.line_elements_ref[s]=[],e=0,f.line_elements[s])if(f.line_elements[s].hasOwnProperty(q)){B=f.line_elements[s][q];m=0;for(H=B.length;m<H;m++)if(y){if(c=B[m],h.vbo_lines.push(h.vbo_points[3*
c]),h.vbo_lines.push(h.vbo_points[3*c+1]),h.vbo_lines.push(h.vbo_points[3*c+2]),b&&(h.vbo_line_normals.push(h.vbo_normals[3*c]),h.vbo_line_normals.push(h.vbo_normals[3*c+1]),h.vbo_line_normals.push(h.vbo_normals[3*c+2])),a&&(h.vbo_line_colors.push(h.vbo_colors[3*c]),h.vbo_line_colors.push(h.vbo_colors[3*c+1]),h.vbo_line_colors.push(h.vbo_colors[3*c+2])),n)h.vbo_line_uvs.push(h.vbo_uvs[2*c]),h.vbo_line_uvs.push(h.vbo_uvs[2*c+1])}else h.vbo_line_elements.push(B[m]);h.line_elements_ref[s][e]=[q|0,B.length|
0];e++}if(y){if(h.vbo_lines=new Float32Array(h.vbo_lines),b&&(h.vbo_line_normals=new Float32Array(h.vbo_line_normals)),n&&(h.vbo_line_uvs=new Float32Array(h.vbo_line_uvs)),a)h.vbo_line_colors=new Float32Array(h.vbo_line_colors)}else h.vbo_line_elements=x?new Uint32Array(h.vbo_line_elements):new Uint16Array(h.vbo_line_elements)}if(y){console.log("Mesh "+(this.name?this.name+" ":"")+"exceeded element index limit and OES_element_index_uint not supported -- unrolling "+w+" triangles..");var v,C,E,z;d&&
(v=new Float32Array(9*w));b&&(C=new Float32Array(9*w));n&&(E=new Float32Array(6*w));a&&(z=new Float32Array(9*w));var J,I;g&&(J=new Uint32Array(6*w),I=new Uint32Array(3*w));s=0;for(r=w;s<r;s++)if(q=9*s,x=3*t[3*s],y=3*t[3*s+1],c=3*t[3*s+2],g&&(w=3*s,e=2*w,J[e]=u.face_points[2*t[w]],J[e+1]=u.face_points[2*t[w]+1],J[e+2]=u.face_points[2*t[w+1]],J[e+3]=u.face_points[2*t[w+1]+1],J[e+4]=u.face_points[2*t[w+2]],J[e+5]=u.face_points[2*t[w+2]+1],I[w]=u.points[t[w]],I[w+1]=u.points[t[w+1]],I[w+2]=u.points[t[w+
2]]),d&&(v[q]=h.vbo_points[x],v[q+1]=h.vbo_points[x+1],v[q+2]=h.vbo_points[x+2],v[q+3]=h.vbo_points[y],v[q+4]=h.vbo_points[y+1],v[q+5]=h.vbo_points[y+2],v[q+6]=h.vbo_points[c],v[q+7]=h.vbo_points[c+1],v[q+8]=h.vbo_points[c+2]),b&&(C[q]=h.vbo_normals[x],C[q+1]=h.vbo_normals[x+1],C[q+2]=h.vbo_normals[x+2],C[q+3]=h.vbo_normals[y],C[q+4]=h.vbo_normals[y+1],C[q+5]=h.vbo_normals[y+2],C[q+6]=h.vbo_normals[c],C[q+7]=h.vbo_normals[c+1],C[q+8]=h.vbo_normals[c+2]),n&&(w=2*t[3*s],e=2*t[3*s+1],m=2*t[3*s+2],E[6*
s]=h.vbo_uvs[w],E[6*s+1]=h.vbo_uvs[w+1],E[6*s+2]=h.vbo_uvs[e],E[6*s+3]=h.vbo_uvs[e+1],E[6*s+4]=h.vbo_uvs[m],E[6*s+5]=h.vbo_uvs[m+1]),a)z[q]=h.vbo_colors[x],z[q+1]=h.vbo_colors[x+1],z[q+2]=h.vbo_colors[x+2],z[q+3]=h.vbo_colors[y],z[q+4]=h.vbo_colors[y+1],z[q+5]=h.vbo_colors[y+2],z[q+6]=h.vbo_colors[c],z[q+7]=h.vbo_colors[c+1],z[q+8]=h.vbo_colors[c+2];d&&(h.vbo_points=v);b&&(h.vbo_normals=C);n&&(h.vbo_uvs=E);a&&(h.vbo_colors=z);g&&(delete u.points,delete u.face_points,u.points=I,u.face_points=J);h.unrolled=
!0}else h.unrolled=!1;if(g&&1<f.segments.length){f=[];m=u.points;s=0;for(r=m.length;s<r;s++)d=this.faces[u.face_points[2*s]].segment||0,f[d]===l&&(f[d]=[]),f[d].push(s);h.dynamicMap.segmentMap=f}return h},updateVBO:function(f,e){if(!f.dynamic)return!1;var d,b,n=f.dynamicMap,a=e.points&&!!f.vbo_points,c=e.normals&&!!f.vbo_normals,g=e.uvs&&!!f.vbo_uvs,h=e.colors&&!!f.vbo_colors;b=e.segments;var t,o,m;if(e.segments!==l)for(var s=0,q=b.length;s<q;s++)for(var r=n.segmentMap[b[s]],H=0,B=r.length;H<B;H++){if(d=
r[H],o=this.faces[n.face_points[2*d]],m=n.face_points[2*d+1],a&&(t=this.points[n.points[d]],f.vbo_points[3*d]=t[0],f.vbo_points[3*d+1]=t[1],f.vbo_points[3*d+2]=t[2]),c&&(t=o.point_normals[m],f.vbo_normals[3*d]=t[0],f.vbo_normals[3*d+1]=t[1],f.vbo_normals[3*d+2]=t[2]),h&&(t=o.point_colors[m],f.vbo_colors[3*d]=t[0],f.vbo_colors[3*d+1]=t[1],f.vbo_colors[3*d+2]=t[2]),g)t=o.uvs[m],f.vbo_uvs[2*d]=t[0],f.vbo_uvs[2*d+1]=t[1]}else{d=0;for(b=n.points.length;d<b;d++){o=this.faces[n.face_points[2*d]];m=n.face_points[2*
d+1];if(!o){console.log(n.face_points[2*d]);return}a&&(t=this.points[n.points[d]],f.vbo_points[3*d]=t[0],f.vbo_points[3*d+1]=t[1],f.vbo_points[3*d+2]=t[2]);c&&(t=o.point_normals[m],f.vbo_normals[3*d]=t[0],f.vbo_normals[3*d+1]=t[1],f.vbo_normals[3*d+2]=t[2]);h&&(t=o.point_colors[m],f.vbo_colors[3*d]=t[0],f.vbo_colors[3*d+1]=t[1],f.vbo_colors[3*d+2]=t[2]);g&&(t=o.uvs[m],f.vbo_uvs[2*d]=t[0],f.vbo_uvs[2*d+1]=t[1])}}return this},rebufferVBO:function(f,e,d){var b=o.gl;d.points&&(b.bindBuffer(b.ARRAY_BUFFER,
e.gl_points),b.bufferData(b.ARRAY_BUFFER,f.vbo_points,b.DYNAMIC_DRAW));d.normals&&f.vbo_normals&&(b.bindBuffer(b.ARRAY_BUFFER,e.gl_normals),b.bufferData(b.ARRAY_BUFFER,f.vbo_normals,b.DYNAMIC_DRAW));d.uvs&&f.vbo_uvs&&(b.bindBuffer(b.ARRAY_BUFFER,e.gl_uvs),b.bufferData(b.ARRAY_BUFFER,f.vbo_uvs,b.DYNAMIC_DRAW));d.colors&&f.vbo_colors&&(b.bindBuffer(b.ARRAY_BUFFER,e.gl_colors),b.bufferData(b.ARRAY_BUFFER,f.vbo_colors,b.DYNAMIC_DRAW));b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,null);return this},bufferVBO:function(f,
e){var d=o.gl,b={};e===l&&(e={});b.gl_points=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,b.gl_points);d.bufferData(d.ARRAY_BUFFER,f.vbo_points,d.STATIC_DRAW);f.vbo_normals?(b.gl_normals=d.createBuffer(),d.bindBuffer(d.ARRAY_BUFFER,b.gl_normals),d.bufferData(d.ARRAY_BUFFER,f.vbo_normals,d.STATIC_DRAW)):b.gl_normals=e.gl_normals?e.gl_normals:null;f.vbo_uvs?(b.gl_uvs=d.createBuffer(),d.bindBuffer(d.ARRAY_BUFFER,b.gl_uvs),d.bufferData(d.ARRAY_BUFFER,f.vbo_uvs,d.STATIC_DRAW)):b.gl_uvs=e.gl_uvs?e.gl_uvs:
null;f.vbo_colors?(b.gl_colors=d.createBuffer(),d.bindBuffer(d.ARRAY_BUFFER,b.gl_colors),d.bufferData(d.ARRAY_BUFFER,f.vbo_colors,d.STATIC_DRAW)):b.gl_colors=e.gl_colors?e.gl_colors:null;!f.vbo_elements&&e.gl_elements?(b.gl_elements=e.gl_elements,b.elements_ref=e.elements_ref):(f.vbo_elements.length&&(b.gl_elements=d.createBuffer(),d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,b.gl_elements),d.bufferData(d.ELEMENT_ARRAY_BUFFER,f.vbo_elements,d.STATIC_DRAW)),b.elements_ref=f.elements_ref);!f.vbo_line_elements&&
e.gl_line_elements?(b.gl_line_elements=e.gl_line_elements,b.line_elements_ref=e.line_elements_ref):f.vbo_line_elements&&(b.gl_line_elements=d.createBuffer(),d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,b.gl_line_elements),d.bufferData(d.ELEMENT_ARRAY_BUFFER,f.vbo_line_elements,d.STATIC_DRAW),b.line_elements_ref=f.line_elements_ref);!f.vbo_lines&&e.gl_lines?b.gl_lines=e.gl_lines:f.vbo_lines?(b.gl_lines=d.createBuffer(),d.bindBuffer(d.ARRAY_BUFFER,b.gl_lines),d.bufferData(d.ARRAY_BUFFER,f.vbo_lines,d.STATIC_DRAW),
b.line_elements_ref=f.line_elements_ref):b.gl_lines=null;!f.vbo_line_colors&&e.gl_line_colors?b.gl_line_colors=e.gl_line_colors:f.vbo_line_colors?(b.gl_line_colors=d.createBuffer(),d.bindBuffer(d.ARRAY_BUFFER,b.gl_line_colors),d.bufferData(d.ARRAY_BUFFER,f.vbo_line_colors,d.STATIC_DRAW)):b.gl_line_colors=null;!f.vbo_line_uvs&&e.gl_line_uvs?b.gl_line_uvs=e.gl_line_uvs:f.vbo_line_uvs?(b.gl_line_uvs=d.createBuffer(),d.bindBuffer(d.ARRAY_BUFFER,b.gl_line_uvs),d.bufferData(d.ARRAY_BUFFER,f.vbo_line_uvs,
d.STATIC_DRAW)):b.gl_line_uvs=null;!f.vbo_line_normals&&e.gl_line_normals?b.gl_line_normals=e.gl_line_normals:f.vbo_line_normals?(b.gl_line_normals=d.createBuffer(),d.bindBuffer(d.ARRAY_BUFFER,b.gl_line_normals),d.bufferData(d.ARRAY_BUFFER,f.vbo_line_normals,d.STATIC_DRAW)):b.gl_line_normals=null;b.segments=f.segments;b.bounds=f.bounds;b.unrolled=f.unrolled;b.element_type=f.element_type;d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null);return b},update:function(f){var f=f||{},e=!0;f.points!==l&&(e=f.points);
var d=f.uvs||f.uv||f.texture||f.all||!1,b=!0;f.normals!==l&&(b=f.normals);var n=f.colors||f.color||f.all||!1,f=f.segments||f.segment;f!==l&&f.length===l&&(f=[f]);if(!this.dynamic)return q("Mesh not defined as dynamic, cannot update."),!1;b&&this.normalMapRef&&this.recalcNormals(l,{segments:f});e={points:e,uvs:d,normals:b,colors:n,segments:f};this.updateVBO(this.dynamicData.VBO,e);this.rebufferVBO(this.dynamicData.VBO,this.dynamicData.buffer,e)},bindBuffer:function(f){null===this.originBuffer&&(this.originBuffer=
f);this.compiled=f;this.segment_state=[];for(var e=0,d=f.segments.length;e<d;e++)this.segment_state[f.segments[e]]=!0;this.bb=f.bounds},compile:function(f){if(0<this.faces.length&&0<this.points.length){var f=this.compileVBO(this.compileMap(f)),e=this.bufferVBO(f);this.bindBuffer(e);if(this.dynamic){this.sourcePoints=[];for(var d=0,b=this.points.length;d<b;d++)this.sourcePoints[d]=this.points[d].slice(0);this.dynamicData={VBO:f,buffer:e}}}return this},addMorphTarget:function(f){null===this.morphTargets&&
(this.morphTargets=[]);this.morphTargets.push(f)},setMorphSource:function(f){this.morphSourceIndex!==f&&(this.morphSourceIndex=f,this.bindBuffer(this.morphTargets[f]))},setMorphTarget:function(f){this.morphTargetIndex!==f&&(this.morphTargetIndex=f,this.morphTarget=this.morphTargets[f])},setMorphWeight:function(f){this.morphWeight=f},morphTargetCount:function(){return null!==this.morphTargets?this.morphTargets.length:0}};r.prototype.triangulateQuads=r.prototype.triangulate;return{Mesh:r,Face:v}});
CubicVR.RegisterModule("UVMapper",function(m){function v(d){d=m.get(d)||{};this.rotation=d.rotation===r?[0,0,0]:d.rotation;this.scale=d.scale===r?[1,1,1]:d.scale;this.center=d.center===r?[0,0,0]:d.center;this.projection_mode=d.projectionMode===r?l.uv.projection.PLANAR:m.parseEnum(l.uv.projection,d.projectionMode);this.projection_axis=d.projectionAxis===r?l.uv.axis.X:m.parseEnum(l.uv.axis,d.projectionAxis);this.wrap_w_count=d.wrapW===r?1:d.wrapW;this.wrap_h_count=d.wrapH===r?1:d.wrapH}var r=m.undef,
l=m.enums,o=2*Math.PI,q=Math.PI/2;l.uv={axis:{X:0,Y:1,Z:2},projection:{UV:0,PLANAR:1,CYLINDRICAL:2,SPHERICAL:3,CUBIC:4,SKY:5}};var f=function(d,b,e){return 0===d&&0===e?0:0===e?0>d?q:-q:0>e?-Math.atan(d/e)+Math.PI:-Math.atan(d/e)},e=function(d,b,e){var a;0===d&&0===e?(a=0,d=0!==b?0>b?-q:q:0):(a=0===e?0>d?q:-q:0>e?-Math.atan(d/e)+Math.PI:-Math.atan(d/e),d=Math.sqrt(d*d+e*e),d=0===d?0>b?-q:q:Math.atan(b/d));return[a,d]};v.prototype={setRotation:function(d){this.rotation=d},setScale:function(d){this.scale=
d},setCenter:function(d){this.center=d},setProjectionAxis:function(d){this.projection_axis=d},setProjectionMode:function(d){this.projection_mode=d},setWrapW:function(d){this.wrap_w_count=d},setWrapH:function(d){this.wrap_h_count=d},apply:function(d,b,n,a,c){var g=m.mat4,h,t,F,w,s,G=new m.Transform,A=!1,H=null;if(this.center[0]||this.center[1]||this.center[2])G.translate(-this.center[0],-this.center[1],-this.center[2]),A=!0;if(this.rotation[0]||this.rotation[1]||this.rotation[2])this.rotation[0]&&
G.rotate(this.rotation[2],0,0,1),this.rotation[1]&&G.rotate(this.rotation[1],0,1,0),this.rotation[2]&&G.rotate(this.rotation[0],1,0,0),A=!0;A&&(H=G.getResult());"object"===typeof b&&(b=d.materials.indexOf(b));var G=0,B=d.faces.length;a&&(G=a);for(c&&(B=c+1);G<B;G++)if(d.faces[G].material===b&&!(n!==r&&d.faces[G].segment!==n)){var u,x,y;if(this.projection_mode===l.uv.projection.CUBIC||this.projection_mode===l.uv.projection.SKY)u=Math.abs(d.faces[G].normal[0]),x=Math.abs(d.faces[G].normal[1]),y=Math.abs(d.faces[G].normal[2]);
for(var a=[],c=0,v=d.faces[G].points.length;c<v;c++){t=d.faces[G].points[c];var C=d.faces[G].points[(c+1)%3],E=d.faces[G].points[(c+2)%3];h=d.points[t];var z=d.points[C],J=d.points[E],I;A&&(h=g.vec3_multiply(h,H));I=this.projection_mode;if(I===l.uv.projection.SKY)t=d.sky_mapping,u>=x&&u>=y&&(F=h[2]/this.scale[2]+this.scale[2]/2,w=-h[1]/this.scale[1]+this.scale[1]/2,0>d.faces[G].normal[0]?(F=(t[2][2]-t[2][0])*(1-F),w=1-(t[2][3]-t[2][1])*w,F+=t[2][0],w+=t[2][1]):(F*=t[3][2]-t[3][0],w=1-(t[3][3]-t[3][1])*
w,F+=t[3][0],w+=t[3][1])),x>=u&&x>=y&&(F=h[0]/this.scale[0]+this.scale[0]/2,w=-h[2]/this.scale[2]+this.scale[2]/2,0>d.faces[G].normal[1]?(F*=t[1][2]-t[1][0],w=1-(t[1][3]-t[1][1])*w,F+=t[1][0],w-=t[1][1]):(F*=t[0][2]-t[0][0],w=1-(t[0][3]-t[0][1])*w,F+=t[0][0],w-=t[0][1])),y>=u&&y>=x&&(F=h[0]/this.scale[0]+this.scale[0]/2,w=h[1]/this.scale[1]+this.scale[1]/2,0>d.faces[G].normal[2]?(F*=t[4][2]-t[4][0],w=1-(t[4][3]-t[4][1])*(1-w),F+=t[4][0],w-=t[4][1]):(F=(t[5][2]-t[5][0])*(1-F),w=1-(t[5][3]-t[5][1])*
(1-w),F+=t[5][0],w+=t[5][1])),d.faces[G].setUV([F,w],c);else if(I===l.uv.projection.CUBIC)u>=x&&u>=y&&(F=h[2]/this.scale[2]+0.5,w=h[1]/this.scale[1]+0.5),x>=u&&x>=y&&(F=-h[0]/this.scale[0]+0.5,w=h[2]/this.scale[2]+0.5),y>=u&&y>=x&&(F=-h[0]/this.scale[0]+0.5,w=h[1]/this.scale[1]+0.5),0<d.faces[G].normal[0]&&(F=-F),0>d.faces[G].normal[1]&&(F=-F),0<d.faces[G].normal[2]&&(F=-F),d.faces[G].setUV([F,w],c);else if(I===l.uv.projection.PLANAR)F=this.projection_axis===l.uv.axis.X?h[2]/this.scale[2]+0.5:-h[0]/
this.scale[0]+0.5,w=this.projection_axis===l.uv.axis.Y?h[2]/this.scale[2]+0.5:h[1]/this.scale[1]+0.5,d.faces[G].setUV([F,w],c);else{if(I===l.uv.projection.CYLINDRICAL)I=this.projection_axis,I===l.uv.axis.X?(s=f(h[2],h[0],-h[1]),w=-h[0]/this.scale[0]+0.5):I===l.uv.axis.Y?(s=f(-h[0],h[1],h[2]),w=-h[1]/this.scale[1]+0.5):I===l.uv.axis.Z&&(s=f(-h[0],h[2],-h[1]),w=-h[2]/this.scale[2]+0.5),s=1-s/o,1!==this.wrap_w_count&&(s*=this.wrap_w_count),h=s,t=w;else if(I===l.uv.projection.SPHERICAL){var L,K,M;I=this.projection_axis;
I===l.uv.axis.X?(L=a[t]?a[t]:e(h[2],h[0],-h[1]),a[t]||(a[t]=L),K=a[C]?a[C]:e(z[2],z[0],-z[1]),a[C]||(a[C]=K),M=a[E]?a[E]:e(J[2],J[0],-J[1]),a[E]||(a[E]=M)):I===l.uv.axis.Y?(L=a[t]?a[t]:e(h[0],-h[1],h[2]),a[t]||(a[t]=L),K=a[C]?a[C]:e(z[0],-z[1],z[2]),a[C]||(a[C]=K),M=a[E]?a[E]:e(J[0],-J[1],J[2]),a[E]||(a[E]=M)):I===l.uv.axis.Z&&(L=a[t]?a[t]:e(-h[0],h[2],-h[1]),a[t]||(a[t]=L),K=a[C]?a[C]:e(-z[0],z[2],-z[1]),a[C]||(a[C]=K),M=a[E]?a[E]:e(-J[0],J[2],-J[1]),a[E]||(a[E]=M));Math.abs(L[0]-K[0])>q&&Math.abs(L[0]-
M[0])>q&&(L[0]=L[0]>K[0]&&L[0]>M[0]?L[0]-o:L[0]+o);Math.abs(L[1]-K[1])>q&&Math.abs(L[1]-M[1])>q&&(L[1]=L[1]>K[1]&&L[1]>M[1]?L[1]-o:L[1]+o);s=1-L[0]/o;t=0.5-L[1]/Math.PI;1!==this.wrap_w_count&&(s*=this.wrap_w_count);1!==this.wrap_h_count&&(t*=this.wrap_h_count);h=s}else t=h=0;d.faces[G].setUV([h,t],c)}}}return this}};return{UVMapper:v}});
CubicVR.RegisterModule("Renderer",function(m){var v=m.undef;return{renderObject:function(r,l,o,q,f,e,d,b){var n=!1,f=f||!1,e=e||!1;if(null!==r.compiled){var a=0,c=m.GLCore.gl,g,h=q===v?0:q.length,t,F=0,w,s=null,G=r.instanceMaterials||r.materials,d=(r.wireframe||d)&&r.compiled.line_elements_ref,b=(r.pointMode||b)&&r.compiled.line_elements_ref,A=c.TRIANGLES;d?A=c.LINES:b&&(A=c.POINTS);var H=d||b?r.compiled.line_elements_ref:r.compiled.elements_ref,B=!1,u,x,y;c.depthFunc(c.LEQUAL);o===v&&(o=cubicvr_identity);
for(var D=0,C=H.length;D<C;D++){var s=d&&r.wireframeMaterial?r.wireframeMaterial:b&&r.pointModeMaterial?r.pointModeMaterial:G[D],E=0,F=!1;if(1>s.opacity&&f)n=!0;else if(e&&1<=s.opacity)for(var z=0,J=H[D].length;z<J;z++)a+=2*H[D][z][1];else{1!==s.opacity?(c.enable(c.BLEND),c.depthMask(0),c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA)):(c.depthMask(1),c.disable(c.BLEND),c.blendFunc(c.ONE,c.ONE));z=0;for(J=H[D].length;z<J;z++)if(w=H[D][z][0],F=!1,g=H[D][z][1],E+=g,s.visible){if(!r.segment_state[w])if(E>
g){a+=2*g;E-=g;if(h){x=!1;for(u=0;u<h;){g=h-u;g>m.MAX_LIGHTS&&(g=m.MAX_LIGHTS);0<u&&!x&&(c.enable(c.BLEND),c.blendFunc(c.ONE,c.ONE),c.depthFunc(c.EQUAL),x=!0);t=q[u];y=t.light_type;for(F=0;F<g;F++)if(q[F+u].light_type!=y){g=F;break}s.use(t.light_type,g);t=s.shader[t.light_type][g];0<u&&t.lightAmbient&&c.uniform3fv(t.lightAmbient,[0,0,0]);c.uniformMatrix4fv(t.matrixModelView,!1,l.mvMatrix);c.uniformMatrix4fv(t.matrixProjection,!1,l.pMatrix);c.uniformMatrix4fv(t.matrixObject,!1,o);c.uniformMatrix3fv(t.matrixNormal,
!1,l.nMatrix);B||(s.bindObject(r,t),B=-1!=t.vertexTexCoord,(d||b)&&s.bindLines(r,t));for(F=0;F<g;F++)q[F+u].setupShader(t,F);r.compiled.unrolled?c.drawArrays(A,a,E):c.drawElements(A,E,r.compiled.element_type,a);u+=g}x&&(c.disable(c.BLEND),c.depthFunc(c.LEQUAL))}else s.use(0,0),c.uniformMatrix4fv(s.shader[0][0].matrixModelView,!1,l.mvMatrix),c.uniformMatrix4fv(s.shader[0][0].matrixProjection,!1,l.pMatrix),c.uniformMatrix4fv(s.shader[0][0].matrixObject,!1,o),c.uniformMatrix3fv(s.shader[0][0].matrixNormal,
!1,l.nMatrix),B||(s.bindObject(r,s.shader[0][0]),B=-1!=s.shader[0][0].vertexTexCoord,(d||b)&&s.bindLines(r,s.shader[0][0])),r.compiled.unrolled?c.drawArrays(A,a,E):c.drawElements(A,E,r.compiled.element_type,a);a+=2*E;E=0;F=!0}else a+=2*E,E=0}else a+=2*g,E-=g;if(!F&&r.segment_state[w]&&s.visible){if(h){x=!1;for(u=0;u<h;){g=h-u;g>m.MAX_LIGHTS&&(g=m.MAX_LIGHTS);0<u&&!x&&(c.enable(c.BLEND),c.blendFunc(c.ONE,c.ONE),c.depthFunc(c.EQUAL),x=!0);t=q[u];y=t.light_type;for(F=0;F<g;F++)if(q[F+u].light_type!=
y){g=F;break}s.use(t.light_type,g);t=s.shader[t.light_type][g];0<u&&t.lightAmbient&&c.uniform3fv(t.lightAmbient,[0,0,0]);c.uniformMatrix4fv(t.matrixModelView,!1,l.mvMatrix);c.uniformMatrix4fv(t.matrixProjection,!1,l.pMatrix);c.uniformMatrix4fv(t.matrixObject,!1,o);c.uniformMatrix3fv(t.matrixNormal,!1,l.nMatrix);B||(s.bindObject(r,t),B=-1!=t.vertexTexCoord,(d||b)&&s.bindLines(r,t));for(F=0;F<g;F++)q[F+u].setupShader(t,F);r.compiled.unrolled?c.drawArrays(A,a,E):c.drawElements(A,E,r.compiled.element_type,
a);u+=g}x&&(c.disable(c.BLEND),c.depthFunc(c.LEQUAL))}else s.use(0,0),c.uniformMatrix4fv(s.shader[0][0].matrixModelView,!1,l.mvMatrix),c.uniformMatrix4fv(s.shader[0][0].matrixProjection,!1,l.pMatrix),c.uniformMatrix4fv(s.shader[0][0].matrixObject,!1,o),c.uniformMatrix3fv(s.shader[0][0].matrixNormal,!1,l.nMatrix),B||(s.bindObject(r,s.shader[0][0]),B=-1!=s.shader[0][0].vertexTexCoord,(d||b)&&s.bindLines(r,s.shader[0][0])),r.compiled.unrolled?c.drawArrays(A,a,E):c.drawElements(A,E,r.compiled.element_type,
a);a+=2*E}}}s&&t?s.clearObject(r,t):s.clearObject(r,null);c.depthMask(1);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,null);return n}}}});
CubicVR.RegisterModule("Light",function(m){function v(f){f=m.get(f)||{};f===o&&(f=l.light.type.POINT);"object"==typeof f?(this.light_type=f.type!==o?m.parseEnum(l.light.type,f.type):l.light.type.POINT,this.diffuse=f.diffuse!==o?f.diffuse:[1,1,1],this.specular=f.specular!==o?f.specular:[1,1,1],this.intensity=f.intensity!==o?f.intensity:1,this.position=f.position!==o?f.position:[0,0,0],this.direction=f.direction!==o?f.direction:[0,0,0],this.distance=f.distance!==o?f.distance:this.light_type===l.light.type.AREA?
30:10,this.cutoff=f.cutoff!==o?f.cutoff:60,this.map_res=f.map_res!==o?f.map_res:this.light_type===l.light.type.AREA?2048:512,this.map_res=f.mapRes!==o?f.mapRes:this.map_res,this.areaCam=f.areaCam!==o?f.areaCam:null,this.areaCeiling=f.areaCeiling!==o?f.areaCeiling:40,this.areaFloor=f.areaFloor!==o?f.areaFloor:-40,this.areaAxis=f.areaAxis!==o?f.areaAxis:[1,1,0],this.projectorTex=f.projector!==o?f.projector:null,this.target=f.target||null,this.static=f.static||!1):(this.light_type=m.parseEnum(l.light.type,
f),this.diffuse=[1,1,1],this.specular=[1,1,1],this.intensity=1,this.position=[0,0,0],this.direction=[0,0,0],this.distance=this.light_type===l.light.type.AREA?30:10,this.cutoff=60,this.map_res=this.light_type===l.light.type.AREA?2048:512,this.areaCam=null,this.areaCeiling=40,this.areaFloor=-40,this.areaAxis=[1,1,0],this.projectorTex=null,this.target=f.target||null);this.projectorTex&&"string"===typeof this.projectorTex&&(f=this.projectorTex,this.projectorTex=m.Textures_ref[f]!==o?m.Textures_obj[m.Textures_ref[f]]:
new m.Texture(f));this.setType(this.light_type);this.dirty=!0;this.motion=null;this.rotation=[0,0,0];this.lposition=[0,0,0];this.lrotation=[0,0,0];this.ldist=0;this.renderTag=-1;(this.light_type===l.light.type.SPOT_SHADOW||this.light_type===l.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===l.light.type.AREA&&m.features.lightShadows)&&this.setShadow(this.map_res);this.lDir=[0,0,0];this.lPos=[0,0,0];this.parent=null}var r=m.GLCore,l=m.enums,o=m.undef,q=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];l.light=
{type:{NULL:0,POINT:1,DIRECTIONAL:2,SPOT:3,AREA:4,DEPTH_PACK:5,SPOT_SHADOW:6,SPOT_SHADOW_PROJECTOR:7,MAX:8},method:{GLOBAL:0,STATIC:1,DYNAMIC:2}};v.prototype={get x(){return this.position[0]},set x(f){this.position[0]=f},get y(){return this.position[1]},set y(f){this.position[1]=f},get z(){return this.position[2]},set z(f){this.position[2]=f},get rotX(){return this.rotation[0]},set rotX(f){this.rotation[0]=f},get rotY(){return this.rotation[1]},set rotY(f){this.rotation[1]=f},get rotZ(){return this.rotation[2]},
set rotZ(f){this.rotation[2]=f},get dirX(){return this.direction[0]},set dirX(f){this.direction[0]=f},get dirY(){return this.direction[1]},set dirY(f){this.direction[1]=f},get dirZ(){return this.direction[2]},set dirZ(f){this.direction[2]=f},get pos(){return this.position.slice(0)},set pos(f){this.position=f.slice(0)},get rot(){return this.rotation.slice(0)},set rot(f){this.rotation=f.slice(0)},get dir(){return this.direction.slice(0)},set dir(f){this.direction=m.vec3.normalize(f.slice(0))},setType:function(f){if(f===
l.light.type.AREA&&!m.features.lightShadows)this.dummyCam=new m.Camera,this.areaCam=new m.Camera,this.updateAreaLight(),this.areaCam=this.dummyCam=null,f=l.light.type.DIRECTIONAL;else if((f===l.light.type.SPOT_SHADOW||f===l.light.type.SPOT_SHADOW_PROJECTOR)&&!m.features.lightShadows)f=l.light.type.SPOT;this.light_type=f},doTransform:function(){if(this.distance!=this.ldistance||!m.vec3.equal(this.position,this.lposition)||!m.vec3.equal(this.rotation,this.lrotation))this.lposition=this.rotation.slice(0),
this.lrotation=this.position.slice(0),this.ldist=this.distance,this.dirty=!0},setParent:function(f){this.parent=f},setMethod:function(f){this.method=f},setDiffuse:function(f){this.diffuse=f},setSpecular:function(f){this.specular=f},setIntensity:function(f){this.intensity=f},setPosition:function(f){this.position=f},setDistance:function(f){this.distance=f},setCutoff:function(f){this.cutoff=f},setTarget:function(f){this.target=f.slice(0)},prepare:function(f){var e=m.mat4,d=m.mat3,b=this.light_type;this.target&&
this.lookat(this.target);this.parent?b===l.light.type.SPOT||b===l.light.type.SPOT_SHADOW||b===l.light.type.SPOT_SHADOW_PROJECTOR?(b=e.inverse_mat3(this.parent.tMatrix),d.transpose_inline(b),this.lDir=d.vec3_multiply(this.direction,b),this.lDir=d.vec3_multiply(this.lDir,f.nMatrix),this.lPos=e.vec3_multiply(this.position,e.multiply(f.mvMatrix,this.parent.tMatrix))):b===l.light.type.POINT&&(this.lPos=e.vec3_multiply(this.position,e.multiply(f.mvMatrix,this.parent.tMatrix))):b===l.light.type.DIRECTIONAL?
this.lDir=d.vec3_multiply(this.direction,f.nMatrix):b===l.light.type.SPOT||b===l.light.type.SPOT_SHADOW||b===l.light.type.SPOT_SHADOW_PROJECTOR?(this.lDir=d.vec3_multiply(this.direction,f.nMatrix),this.lPos=e.vec3_multiply(this.position,f.mvMatrix)):b===l.light.type.POINT?this.lPos=e.vec3_multiply(this.position,f.mvMatrix):b===l.light.type.AREA&&(this.lDir=d.vec3_multiply(this.direction,f.nMatrix))},control:function(f,e,d){f===l.motion.POS?this.position[e]=d:f===l.motion.INTENSITY&&(this.intensity=
d)},getAABB:function(){if(this.dirty){var f=m.vec3,e=m.aabb,d;if(this.light_type==l.light.type.POINT)d=[[0,0,0],[0,0,0]],e.engulf(d,[this.distance,this.distance,this.distance]),e.engulf(d,[-this.distance,-this.distance,-this.distance]),d[0]=f.add(d[0],this.position),d[1]=f.add(d[1],this.position);else if(this.light_type==l.light.type.SPOT||l.light.type.SPOT_SHADOW||SPOT_SHADOW_PROJECTOR)d=this.position.slice(0),d=[d,d],f=new m.Camera({position:this.position.slice(0),width:10,height:10,nearClip:0.01,
farClip:this.distance,fov:this.cutoff,target:m.vec3.add(this.position,m.vec3.multiply(this.direction,10)),targeted:!0}),f.calcProjection(),d.engulf(d,f.unProject(0,0,this.distance)),d.engulf(d,f.unProject(0,10,this.distance)),d.engulf(d,f.unProject(10,10,this.distance)),d.engulf(d,f.unProject(10,0,this.distance));this.dirty=!1;this.aabb=d||this.aabb}return this.aabb},setDirection:function(f,e,d){var b=m.vec3;if("object"===typeof f)this.setDirection(f[0],f[1],f[2]);else return this.direction=b.normalize([f,
e,d]),this.target=null,this},lookat:function(f,e,d){var b=m.vec3;if("object"===typeof f)this.lookat(f[0],f[1],f[2]);else return this.direction=b.normalize(b.subtract([f,e,d],this.position)),this.target=[f,e,d],this},setRotation:function(f,e,d){var b=m.mat4,n=m.vec3;if("object"===typeof f)this.setRotation(f[0],f[1],f[2]);else{var a=new m.Transform;a.rotate([-f,-e,-d]);a.pushMatrix();this.direction=n.normalize(b.vec3_multiply([1,0,0],a.getResult()));this.rotation=[f,e,d];return this}},setupShader:function(f,
e){var d=r.gl;d.uniform3fv(f.lightDiffuse[e],this.diffuse);d.uniform3fv(f.lightSpecular[e],this.specular);this.lPos&&d.uniform3fv(f.lightPosition[e],this.lPos);this.lDir&&d.uniform3fv(f.lightDirection[e],this.lDir);d.uniform1f(f.lightIntensity[e],this.intensity);d.uniform1f(f.lightDistance[e],this.distance);(this.light_type===l.light.type.SPOT_SHADOW||this.light_type===l.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===l.light.type.SPOT)&&d.uniform1f(f.lightCutOffAngle[e],this.cutoff);if(this.light_type===
l.light.type.SPOT_SHADOW||this.light_type===l.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===l.light.type.AREA)this.light_type===l.light.type.SPOT_SHADOW_PROJECTOR?(this.shadowMapTex.texture.use(r.gl.TEXTURE0+2*e),d.uniform1i(f.lightShadowMap[e],2*e),this.projectorTex.use(r.gl.TEXTURE0+2*e+1),d.uniform1i(f.lightProjectionMap[e],2*e+1)):(this.shadowMapTex.texture.use(r.gl.TEXTURE0+e),d.uniform1i(f.lightShadowMap[e],e)),d.uniform3fv(f.lightDepthClip[e],[this.dummyCam.nearclip,this.dummyCam.farclip,
1/this.map_res]),d.uniformMatrix4fv(f.lightShadowMatrix[e],!1,this.spMatrix)},setShadow:function(f){m.features.lightShadows&&(this.map_res=f,this.shadowMapTex=new m.RenderBuffer(this.map_res,this.map_res,!0),this.shadowMapTex.texture.setFilter(l.texture.filter.NEAREST),this.dummyCam=new m.Camera(this.map_res,this.map_res,80,0.1,this.distance),this.dummyCam.calc_nmatrix=!1,this.dummyCam.setTargeted(!0),this.has_shadow=!0)},hasShadow:function(){return has_shadow},setProjector:function(f){this.projectorTex=
f},hasProjector:function(){return null!==this.projectorTex?!0:!1},shadowBegin:function(){var f=r.gl,e=m.mat4,d=m.mat3;this.shadowMapTex.use();f.viewport(0,0,this.map_res,this.map_res);f.clear(f.DEPTH_BUFFER_BIT|f.COLOR_BUFFER_BIT);this.light_type!==l.light.type.AREA?(this.dummyCam.setClip(0.1,this.distance),this.dummyCam.setFOV(this.cutoff)):this.dummyCam.calcProjection();if(this.parent){var b=e.inverse_mat3(this.parent.tMatrix);d.transpose_inline(b);d.vec3_multiply(this.direction,b);e.vec3_multiply(this.position,
this.parent.tMatrix);this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+10*this.direction[0],this.position[1]+10*this.direction[1],this.position[2]+10*this.direction[2],0,1,0);e.multiply(this.dummyCam.mvMatrix.slice(0),e.inverse(this.parent.tMatrix),this.dummyCam.mvMatrix)}else this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+10*this.direction[0],this.position[1]+10*this.direction[1],this.position[2]+10*this.direction[2],
0,1,0);f.cullFace(f.FRONT)},shadowEnd:function(){var f=r.gl;f.bindFramebuffer(f.FRAMEBUFFER,null);f.cullFace(f.BACK);this.setupTexGen()},setupTexGen:function(){var f=m.mat4;this.spMatrix=f.multiply(q,[0.5,0,0,0,0,0.5,0,0,0,0,0.5,0,0.5,0.5,0.5,1]);this.spMatrix=f.multiply(this.spMatrix,this.dummyCam.pMatrix);this.spMatrix=f.multiply(this.spMatrix,this.dummyCam.mvMatrix)},setAreaAxis:function(f){this.areaAxis=f},updateAreaLight:function(){var f=m.vec3,e=this.areaCeiling-this.areaFloor;this.dummyCam.ortho=
!0;this.dummyCam.setClip(0.01,1);var d=0,d=Math.tan(this.areaCam.fov/2*(Math.PI/180)),b=f.subtract(this.areaCam.target,this.areaCam.position);b[1]=0;b=f.normalize(b);f.normalize(f.cross(b,[0,1,0]));var n=-Math.atan2(b[2],b[0]),d=this.distance/2*Math.abs(d)-this.distance/2;d<this.distance/3/2&&(d=this.distance/3/2);var b=f.multiply(b,d),d=this.areaAxis[1]*(Math.PI/180),a=Math.tan(this.areaAxis[0]*(Math.PI/180)),d=[Math.tan(d),0,a],n=n-Math.atan2(d[0],d[2]);this.position=f.add(f.add(this.areaCam.position,
b),f.multiply(d,e));this.position[1]=this.areaCeiling;this.target=f.add(f.add(this.areaCam.position,b),f.multiply(d,-e));this.target[1]=this.areaFloor;this.direction=f.normalize(f.subtract(this.target,this.position));this.dummyCam.rotation[2]=n*(180/Math.PI);f=this.dummyCam.farclip*Math.abs(this.direction[1])*e;e=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.nearclip);e[0][1]<this.areaCeiling&&Math.abs(this.direction[1]);e=this.orthoBounds(this.position,
this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.farclip);e[1][1]>this.areaFloor&&(e=e[1][1]-this.areaFloor,f+=e/Math.abs(this.direction[1]));this.dummyCam.nearclip=0.01;this.dummyCam.farclip=f;this.dummyCam.setOrtho(-this.distance/2,this.distance/2,-this.distance/2,this.distance/2)},orthoBounds:function(f,e,d,b,n,a){var b=m.vec3,c=b.normalize([n[0],n[4],n[8]]),g=b.normalize([n[1],n[5],n[9]]),n=b.normalize(b.cross(g,c)),h;h=d/2;d=[];e=b.multiply(c,e/2);c=b.multiply(g,
h);a=b.multiply(n,a);d[0]=b.add(b.subtract(f,e),b.add(c,a));d[1]=b.add(b.add(f,e),b.add(c,a));d[2]=b.subtract(b.subtract(f,e),b.add(c,a));d[3]=b.subtract(b.add(f,e),b.add(c,a));aabb1=d[0];aabb2=d[0];for(f=1;4>f;f++)aabb1[0]>d[f][0]&&(aabb1[0]=d[f][0]),aabb1[1]>d[f][1]&&(aabb1[1]=d[f][1]),aabb1[2]>d[f][2]&&(aabb1[2]=d[f][2]),aabb2[0]<d[f][0]&&(aabb2[0]=d[f][0]),aabb2[1]<d[f][1]&&(aabb2[1]=d[f][1]),aabb2[2]<d[f][2]&&(aabb2[2]=d[f][2]);return[aabb1,aabb2]}};return{Light:v}});
CubicVR.RegisterModule("Camera",function(m){function v(d,b,n,a,c){var g=m.mat4;this.frustum=new m.Frustum;this.classType=m.enums.classType.CAMERA;"object"==typeof d?(this.position=d.position||[0,0,-1],this.rotation=d.rotation||[0,0,0],this.target=d.target||[0,0,0],this.fov=d.fov||60,this.nearclip=d.nearclip||d.nearClip||d.near||0.1,this.farclip=d.farclip||d.farClip||d.far||400,this.targeted=d.targeted!==o?d.targeted:!0,this.calc_nmatrix=d.calcNormalMatrix!==o?d.calcNormalMatrix:!0,this.name=d.name||
"camera"+e,b=d.height?d.height:o,d=d.width?d.width:o):(this.position=[0,0,0],this.rotation=[0,0,0],this.target=[0,0,0],this.fov=n!==o?n:60,this.nearclip=a!==o?a:0.1,this.farclip=c!==o?c:400,this.calc_nmatrix=this.targeted=!0,this.name="camera"+e);this.motion=this.targetSceneObject=null;this.transform=new m.Transform;this.manual=!1;this.setDimensions(d!==o?d:512,b!==o?b:512);this.mvMatrix=g.identity();this.pMatrix=null;this.calcProjection();this.ortho=!1;this.ortho_view={left:-1,right:1,bottom:-1,
top:1};this.parent=null;++e}function r(d){this.position=d!==o?d:[0,0,0]}function l(d,b,e){this.camPath=new m.Motion;this.targetPath=new m.Motion;this.start_position=d!==o?d:[8,8,8];this.target=b!==o?b:[0,0,0];this.bounds=e!==o?e:[[-15,3,-15],[15,20,15]];this.safe_bb=[];this.avoid_sphere=[];this.segment_time=3;this.buffer_time=20;this.path_length=this.path_time=this.current_time=this.start_time=0;this.min_distance=2;this.angle_min=this.max_distance=40;this.angle_max=180}var o=m.undef,q=m.enums,f=[1,
0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],e=0;v.prototype={get x(){return this.position[0]},set x(d){this.position[0]=d},get y(){return this.position[1]},set y(d){this.position[1]=d},get z(){return this.position[2]},set z(d){this.position[2]=d},get rotX(){return this.rotation[0]},set rotX(d){this.rotation[0]=d},get rotY(){return this.rotation[1]},set rotY(d){this.rotation[1]=d},get rotZ(){return this.rotation[2]},set rotZ(d){this.rotation[2]=d},get targetX(){return this.target[0]},set targetX(d){this.target[0]=
d},get targetY(){return this.target[1]},set targetY(d){this.target[1]=d},get targetZ(){return this.target[2]},set targetZ(d){this.target[2]=d},get pos(){return this.position.slice(0)},set pos(d){this.position=d.slice(0)},get rot(){return this.rotation.slice(0)},set rot(d){this.rotation=d.slice(0)},trackTarget:function(d,b,e){this.position=m.vec3.trackTarget(this.position,d,b,e)},setParent:function(d){this.parent=d},hasParent:function(){return!!this.parent},getParent:function(){return this.parent},
getParentedPosition:function(){return null!==this.parent&&this.mvMatrix&&this.parent.tMatrix?m.mat4.vec3_multiply(this.position,this.parent.tMatrix):this.position},setOrtho:function(d,b,e,a){this.ortho=!0;this.ortho_view.left=d;this.ortho_view.right=b;this.ortho_view.bottom=e;this.ortho_view.top=a},control:function(d,b,e){d===q.motion.ROT?this.rotation[b]=e:d===q.motion.POS?this.position[b]=e:d===q.motion.FOV?this.setFOV(e):d===q.motion.LENS?this.setLENS(e):d===q.motion.NEARCLIP?this.setClip(e,this.farclip):
d===q.motion.FARCLIP&&this.setClip(this.nearclip,e)},makeFrustum:function(d,b,e,a,c,g){return[2*c/(b-d),0,0,0,0,2*c/(a-e),0,0,(b+d)/(b-d),(a+e)/(a-e),-(g+c)/(g-c),-1,0,0,-2*g*c/(g-c),0]},setTargeted:function(d){this.targeted=d},calcProjection:function(){var d=m.mat4,b=m.mat3;this.pMatrix=this.ortho?d.ortho(this.ortho_view.left,this.ortho_view.right,this.ortho_view.bottom,this.ortho_view.top,this.nearclip,this.farclip):d.perspective(this.fov,this.aspect,this.nearclip,this.farclip);!this.targeted&&
this.mvMatrix&&(d.identity(this.mvMatrix),d.rotate(-this.rotation[0],-this.rotation[1],-this.rotation[2],this.mvMatrix),d.translate(-this.position[0],-this.position[1],-this.position[2],this.mvMatrix),this.parent&&d.multiply(this.mvMatrix.slice(0),d.inverse(this.parent.tMatrix),this.mvMatrix),this.calc_nmatrix?(this.nMatrix=d.inverse_mat3(this.mvMatrix),b.transpose_inline(this.nMatrix)):d.identity(this.nMatrix));this.frustum.extract(this,this.mvMatrix,this.pMatrix)},setClip:function(d,b){this.nearclip=
d;this.farclip=b;this.calcProjection()},setDimensions:function(d,b){this.width=d;this.height=b;this.aspect=d/b;this.calcProjection()},setAspect:function(d){this.aspect=d;this.calcProjection()},resize:function(d,b){this.setDimensions(d,b)},setFOV:function(d){this.fov=d;this.ortho=!1;this.calcProjection()},setLENS:function(d){this.setFOV(2*Math.atan(16/d)*(180/Math.PI))},lookat:function(d,b,e,a,c,g,h,t,l){var o=m.mat4,s=m.mat3;"object"==typeof d?this.lookat(this.position[0],this.position[1],this.position[2],
d[0],d[1],d[2],0,1,0):(this.mvMatrix=o.lookat(d,b,e,a,c,g,h,t,l),this.rotation[2]&&(this.transform.clearStack(),this.transform.rotate(-this.rotation[2],0,0,1),this.transform.pushMatrix(this.mvMatrix),this.mvMatrix=this.transform.getResult()),null!==this.parent&&o.multiply(this.mvMatrix.slice(0),o.inverse(this.parent.tMatrix),this.mvMatrix),this.calc_nmatrix?(this.nMatrix=o.inverse_mat3(this.mvMatrix),s.transpose_inline(this.nMatrix)):this.nMatrix=f,this.frustum.extract(this,this.mvMatrix,this.pMatrix))},
unProject:function(d,b,e){var a=m.mat4,c=m.vec3,g=[0,0,this.width,this.height],d=a.vec4_multiply(a.vec4_multiply([2*((d-g[0])/g[2])-1,-(2*((b-g[1])/g[3])-1),1,1],a.inverse(this.pMatrix)),a.inverse(this.mvMatrix)),d=[d[0]/d[3],d[1]/d[3],d[2]/d[3]];return e!==o?(b=this.getParentedPosition(),c.add(b,c.multiply(c.normalize(c.subtract(d,b)),e))):d},project:function(d,b,e){var a=m.mat4,a=a.vec4_multiply(a.vec4_multiply([d,b,e,1],this.mvMatrix),this.pMatrix);a[2]=m.vec3.length(m.vec3.subtract([d,b,e],this.position));
return[(a[0]/a[3]+1)/2*this.width,(-a[1]/a[3]+1)/2*this.height,a[2]]}};r.prototype={control:function(d,b,e){d===q.motion.POS&&(this.position[b]=e)}};l.prototype={inBounds:function(d){var b=m.vec3;if(!(d[0]>this.bounds[0][0]&&d[1]>this.bounds[0][1]&&d[2]>this.bounds[0][2]&&d[0]<this.bounds[1][0]&&d[1]<this.bounds[1][1]&&d[2]<this.bounds[1][2]))return!1;for(var e=0,a=this.avoid_sphere.length;e<a;e++)if(b.length(d,this.avoid_sphere[e][0])<this.avoid_sphere[e][1])return!1;return!0},findNextNode:function(d,
b){var e=m.vec3,a=[0,0,0],c=[0,0,0],g=a=0,h=!1;do if(c[0]=Math.random()-0.5,c[1]=Math.random()-0.5,c[2]=Math.random()-0.5,c=e.normalize(c),a=Math.random()*(this.max_distance-this.min_distance)+this.min_distance,a=e.add(b.position,e.multiply(c,a)),h=this.inBounds(a),g++,30<g){a=b.position;break}while(!h);return a},run:function(d){this.current_time=d;0===this.path_time&&(this.path_time=this.current_time,this.camPath.setKey(q.motion.POS,q.motion.X,this.path_time,this.start_position[0]),this.camPath.setKey(q.motion.POS,
q.motion.Y,this.path_time,this.start_position[1]),this.camPath.setKey(q.motion.POS,q.motion.Z,this.path_time,this.start_position[2]));for(;this.path_time<this.current_time+this.buffer_time;){this.path_time+=this.segment_time;var b=new r,e=new r;this.path_length&&this.camPath.apply(this.path_time-2*this.segment_time,b);this.camPath.apply(this.path_time-this.segment_time,e);b=this.findNextNode(b,e);this.camPath.setKey(q.motion.POS,q.motion.X,this.path_time,b[0]);this.camPath.setKey(q.motion.POS,q.motion.Y,
this.path_time,b[1]);this.camPath.setKey(q.motion.POS,q.motion.Z,this.path_time,b[2]);this.path_length++}b=new r;this.camPath.apply(d,b);return b.position},addSafeBound:function(d,b){this.safe_bb.push([d,b])},addAvoidSphere:function(d,b){this.avoid_sphere.push([d,b])}};return{Camera:v,AutoCamera:l}});
CubicVR.RegisterModule("StereoCameraRig",function(m){var v=m.enums;v.stereo={mode:{STEREO:1,RIFT:2,TWOCOLOR:3,INTERLACE:4}};var r=function(l){l=l||{};camera=l.camera||null;var o=m.getCanvas();this.eyeSpacing=l.eyeSpacing||0.6;this.mode=m.parseEnum(v.stereo.mode,l.mode||1);this.doubleBuffer=!1;this.leftColor=[0,0,1];this.rightColor=[1,0,0];this.eyeWarpEnabled=l.eyeWarp;if(!camera||!(camera instanceof m.Camera))throw"StereoCameraRig Error: camera not provided?";this.fov=l.fov||camera.fov;this.camLeft=
new m.Camera({fov:this.fov,aspect:this.aspect,targeted:camera.targeted});this.camRight=new m.Camera({fov:this.fov,aspect:this.aspect,targeted:camera.targeted});camera.parent&&(this.camLeft.setParent(camera.parent),this.camRight.setParent(camera.parent));this.camera=camera;this.fxChain=l.fxChain||l.fxChainA||new m.PostProcessChain(o.width,o.height,!1);this.fxChainB=l.fxChainB||null;m.addResizeable(this.fxChain);this.fxChainB&&m.addResizeable(this.fxChainB);this.shaderEyeWarp=new m.PostProcessShader({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",
shader_fragment:"#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nvoid main()\n{\nvec2 uv = vTex;\nuv.x *= 2.0;\nif (uv.x>1.0) {\nuv.x -= 1.0;\n}\nvec2 cen = vec2(0.5,0.5) - uv.xy;\nif (length(cen)>0.5) discard;\nvec2 mcen = -0.02*tan(length(cen)*3.14)*(cen);\nuv += mcen;\nif (uv.x>1.0||uv.x<0.0||uv.y>1.0||uv.y<0.0) discard;\nuv.x /= 2.0;\nif (vTex.x > 0.5) {\nuv.x+=0.5;\n}\ngl_FragColor = texture2D(srcTex, uv);\n}",outputMode:"replace",enabled:!1});this.shaderTwoColor=
new m.PostProcessShader({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform sampler2D srcTex;\nuniform sampler2D rightTex;\nvarying vec2 vTex;\nuniform vec3 leftColor;\nuniform vec3 rightColor;\nvoid main()\n{\nvec3 leftSample = texture2D(srcTex, vTex).rgb;\nvec3 rightSample = texture2D(rightTex, vTex).rgb;\nleftSample.rgb = vec3((leftSample.r+leftSample.g+leftSample.b)/3.0);\nrightSample.rgb = vec3((rightSample.r+rightSample.g+rightSample.b)/3.0);\ngl_FragColor = vec4(leftSample.rgb*leftColor+rightSample.rgb*rightColor,1.0);\n}",
outputMode:"replace",enabled:!1,init:function(l){l.addInt("rightTex",2);l.addVector("leftColor",this.leftColor);l.addVector("rightColor",this.rightColor)}});this.shaderInterlace=new m.PostProcessShader({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform vec3 texel;\nvoid main()\n{\nvec2 uv = vTex;\nuv.y *= 0.5;\nif (mod(floor(vTex.y/texel.y),2.0)==0.0) {\nuv.y+=0.5;\n}\ngl_FragColor = texture2D(srcTex, uv);\n}",
outputMode:"replace",enabled:!1});this.fxChain.addShader(this.shaderEyeWarp);this.fxChain.addShader(this.shaderTwoColor);this.fxChain.addShader(this.shaderInterlace);this.aspect=l.aspect;this.aspect||(this.aspect=this.mode==v.stereo.mode.STEREO?o.width/2/o.height:o.width/o.height);this.setMode({mode:this.mode})};r.prototype={setMode:function(l){l=l||{mode:1};this.mode=m.parseEnum(v.stereo.mode,l.mode);fov=l.fov||this.fov;aspect=l.aspect||this.aspect;this.leftColor=l.leftColor||this.leftColor;this.rightColor=
l.rightColor||this.rightColor;switch(this.mode){case v.stereo.mode.STEREO:this.setDoubleBuffer(!1);this.setEyeWarp(!1);this.setInterlace(!1);this.setTwoColor(!1);break;case v.stereo.mode.RIFT:aspect=110/90;fov=110;this.setDoubleBuffer(!1);this.setEyeWarp(!0);this.setInterlace(!1);this.setTwoColor(!1);break;case v.stereo.mode.TWOCOLOR:this.setDoubleBuffer(!0);this.setEyeWarp(!1);this.setInterlace(!1);this.setTwoColor(!0);this.shaderTwoColor.shader.use();this.shaderTwoColor.shader.setVector("leftColor",
this.leftColor);this.shaderTwoColor.shader.setVector("rightColor",this.rightColor);break;case v.stereo.mode.INTERLACE:this.setDoubleBuffer(!1),this.setEyeWarp(!1),this.setInterlace(!0),this.setTwoColor(!1)}this.camLeft.setAspect(aspect);this.camLeft.setFOV(fov);this.camLeft.setTargeted(this.camera.targeted);this.camRight.setAspect(aspect);this.camRight.setFOV(fov);this.camRight.setTargeted(this.camera.targeted)},getMode:function(){return this.mode},setupCameras:function(){var l=this.camera;this.camLeft.rot=
l.rot;this.camRight.rot=l.rot;l.unProject(l.farclip);this.camLeft.pos=l.pos;this.camRight.pos=l.pos;this.camera.targeted?(this.camLeft.position=m.vec3.moveViewRelative(this.camera.position,this.camera.target,-this.eyeSpacing/2,0),this.camRight.position=m.vec3.moveViewRelative(this.camera.position,this.camera.target,this.eyeSpacing/2,0),this.camLeft.target=m.vec3.moveViewRelative(this.camera.position,this.camera.target,-this.eyeSpacing/2,0,this.camera.target),this.camRight.target=m.vec3.moveViewRelative(this.camera.position,
this.camera.target,this.eyeSpacing/2,0,this.camera.target)):(this.camLeft.position[0]-=this.eyeSpacing/2,this.camRight.position[0]+=this.eyeSpacing/2);!this.camera.parent&&!this.camera.targeted&&(l=m.mat4.transform(m.vec3.subtract([0,0,0],this.camera.position),this.camera.rotation),this.camLeft.parent={tMatrix:l},this.camRight.parent={tMatrix:l})},renderScene:function(l){this.setupCameras();var o=m.getCanvas(),q=this.fxChain,f=this.fxChainB,e=m.GLCore.gl,d=o.width/2,b=o.height/2,n=o.height,o=o.width;
this.shaderEyeWarp.enabled=this.eyeWarpEnabled;this.shaderTwoColor.enabled=this.twoColorEnabled;this.shaderInterlace.enabled=this.interlaceEnabled;this.twoColorEnabled&&f?(q.begin(),e.viewport(0,0,o,n),e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT),l.render({camera:this.swapEyes?this.camRight:this.camLeft}),q.end(),f.begin(),e.viewport(0,0,o,n),e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT),l.render({camera:this.swapEyes?this.camLeft:this.camRight}),f.end(),e.viewport(0,0,o,n),f.captureBuffer.texture.use(e.TEXTURE2)):
(q.begin(),e.viewport(0,0,o,n),e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT),this.interlaceEnabled?e.viewport(0,0,o,b):e.viewport(0,0,d,n),l.render({camera:this.swapEyes?this.camRight:this.camLeft}),this.interlaceEnabled?e.viewport(0,b,o,b):e.viewport(d,0,d,n),l.render({camera:this.swapEyes?this.camLeft:this.camRight}),q.end(),e.viewport(0,0,o,n));q.render()},setEyeWarp:function(l){this.eyeWarpEnabled=l},getEyeWarp:function(){return this.eyeWarpEnabled},setSwapEyes:function(l){this.swapEyes=l},getSwapEyes:function(){return this.swapEyes},
setDoubleBuffer:function(l){if(!this.fxChainB){var o=m.getCanvas();this.fxChainB=new m.PostProcessChain(o.width,o.height,!1);m.addResizeable(this.fxChainB)}this.doubleBuffer=l},getDoubleBuffer:function(){return this.doubleBuffer},setTwoColor:function(l){this.twoColorEnabled=l},getTwoColor:function(){return this.twoColorEnabled},setInterlace:function(l){this.interlaceEnabled=l},getInterlace:function(){return this.interlaceEnabled},addUI:function(){var l=document.createElement("div");l.style.position=
"absolute";l.style.top="10px";l.style.left="10px";l.style.color="white";l.style.zIndex=1E3;l.appendChild(document.createTextNode("Mode:"));var o=document.createElement("select");o.options[0]=new Option("Oculus Rift Untested","rift");o.options[1]=new Option("Split Stereo","stereo");o.options[2]=new Option("Red/Blue Stereo","redblue");o.options[3]=new Option("Red/Green Stereo","redgreen");o.options[4]=new Option("Interlaced","interlace");o.selectedIndex=0;l.appendChild(o);l.appendChild(document.createTextNode(" Swap Eyes:"));
var q=document.createElement("input");q.type="checkbox";q.value="1";l.appendChild(q);document.body.appendChild(l);o.selectedIndex=0;var f=this;q.addEventListener("change",function(){f.setSwapEyes(this.checked)},!0);o.addEventListener("change",function(){var e=this.options[this.selectedIndex].value,d=m.getCanvas();switch(e){case "rift":f.setMode({mode:"rift"});break;case "stereo":f.setMode({mode:"stereo",fov:60,aspect:d.width/2/d.height});break;case "redblue":f.setMode({mode:"twocolor",leftColor:[0,
0,1],rightColor:[1,0,0],fov:60,aspect:d.width/d.height});break;case "redgreen":f.setMode({mode:"twocolor",leftColor:[0,1,0],rightColor:[1,0,0],fov:60,aspect:d.width/d.height});break;case "interlace":f.setMode({mode:"interlace",leftColor:[0,1,0],rightColor:[1,0,0],fov:60,aspect:d.width/d.height})}},!0)}};return{StereoCameraRig:r}});
CubicVR.RegisterModule("Motion",function(m){function v(){this.time=this.value=0;this.shape=q.envelope.shape.TCB;this.bias=this.continuity=this.tension=0;this.next=this.prev=null;this.param=[0,0,0,0]}function r(a){this.nKeys=0;this.lastKey=this.firstKey=this.keys=null;a?(this.in_behavior=m.parseEnum(q.envelope.behavior,a.in_behavior||a.inBehavior||a.behavior)||q.envelope.behavior.CONSTANT,this.out_behavior=m.parseEnum(q.envelope.behavior,a.out_behavior||a.outBehavior||a.behavior)||q.envelope.behavior.CONSTANT):
this.out_behavior=this.in_behavior=q.envelope.behavior.CONSTANT}function l(a,c){this.controllers=[];this.yzflip=!1;this.classType=m.enums.classType.MOTION;if("object"===typeof a){var b=m.get(a);this.env_init=m.get(b.envelope);this.key_init=m.get(b.key);for(var d in b)if(b.hasOwnProperty(d)&&!("envelope"===d||"key"===d)){var e=b[d],n=m.get(e.envelope),f;for(f in e)if(e.hasOwnProperty(f)&&!("envelope"===f||"key"===f)){var s=e[f];if("object"===typeof s)for(var l in s)this.setKey(d,l,f,s[l]),n&&this.setBehavior(d,
l,n)}}}else this.env_init=a,this.key_init=c}var o=m.undef,q=m.enums;q.motion={POS:0,ROT:1,SCL:2,POSITION:0,ROTATION:1,SCALE:2,FOV:3,LENS:4,NEARCLIP:5,FARCLIP:6,INTENSITY:7,X:0,Y:1,Z:2,V:3};q.envelope={shape:{TCB:0,HERM:1,BEZI:2,LINE:3,STEP:4,BEZ2:5},behavior:{RESET:0,CONSTANT:1,REPEAT:2,OSCILLATE:3,OFFSET:4,LINEAR:5}};var f=function(a,c,b){var d=0,d=b-c;if(0===d)return[c,0];c=a-d*Math.floor((a-c)/d);d=-parseInt((c-a)/d+(c>a?0.5:-0.5),10);return[c,d]},e=function(a,c,b,d,e){var n,f;f=e*e;n=3*(c-a);
c=3*(b-c)-n;return(d-a-n-c)*f*e+c*f+n*e+a},d=function(a,c,b,h,n,f,l){var s,o;o=f+0.5*(l-f);s=e(a,c,b,h,o);return 1.0E-4<Math.abs(n-s)?(s>n?l=o:f=o,d(a,c,b,h,n,f,l)):o},b=function(a,c){var b,d,e,n;a.shape===q.envelope.shape.TCB?(b=(1-a.tension)*(1+a.continuity)*(1+a.bias),d=(1-a.tension)*(1-a.continuity)*(1-a.bias),e=c.value-a.value,a.prev?(n=(c.time-a.time)/(c.time-a.prev.time),b=n*(b*(a.value-a.prev.value)+d*e)):b=d*e):a.shape===q.envelope.shape.LINE?(e=c.value-a.value,a.prev?(n=(c.time-a.time)/
(c.time-a.prev.time),b=n*(a.value-a.prev.value+e)):b=e):a.shape===q.envelope.shape.BEZI||a.shape===q.envelope.shape.HERM?(b=a.param[1],a.prev&&(b*=(c.time-a.time)/(c.time-a.prev.time))):a.shape===q.envelope.shape.BEZ2?(b=a.param[3]*(c.time-a.time),b=1.0E-5<Math.abs(a.param[2])?b/a.param[2]:1E5*b):b=0;return b},n=function(a,c){var b,d,e,n;c.shape===q.envelope.shape.LINE?(e=c.value-a.value,c.next?(n=(c.time-a.time)/(c.next.time-a.time),b=n*(c.next.value-c.value+e)):b=e):c.shape===q.envelope.shape.TCB?
(b=(1-c.tension)*(1-c.continuity)*(1+c.bias),d=(1-c.tension)*(1+c.continuity)*(1-c.bias),e=c.value-a.value,c.next?(n=(c.time-a.time)/(c.next.time-a.time),b=n*(d*(c.next.value-c.value)+b*e)):b*=e):c.shape===q.envelope.shape.HERM||c.shape===q.envelope.shape.BEZI?(b=c.param[0],c.next&&(b*=(c.time-a.time)/(c.next.time-a.time))):c.shape===q.envelope.shape.BEZ2?(b=c.param[1]*(c.time-a.time),b=1.0E-5<Math.abs(c.param[0])?b/c.param[0]:1E5*b):b=0;return b};r.prototype={setBehavior:function(a,c){this.in_behavior=
m.parseEnum(q.envelope.behavior,a);this.out_behavior=m.parseEnum(q.envelope.behavior,c)},empty:function(){return 0===this.nKeys},addKey:function(a,c,b){var d="object"==typeof a?a:b;c||(c=0);a||(a=0);d?(d=a,a=d.time,b=this.insertKey(a),b.value=d.value?d.value:c,b.time=d.time?d.time:a,b.shape=m.parseEnum(q.envelope.shape,d.shape)||q.envelope.shape.TCB,b.tension=d.tension?d.tension:0,b.continuity=d.continuity?d.continuity:0,b.bias=d.bias?d.bias:0,b.param=d.param?d.param:[0,0,0,0]):(b=this.insertKey(a),
b.value=c);return b},insertKey:function(a){var c=new v;c.time=a;if(!this.nKeys)return this.lastKey=this.firstKey=this.keys=c,this.nKeys++,c;for(var b=this.keys;b;){this.firstKey.time>a?this.firstKey=c:this.lastKey.time<a&&(this.lastKey=c);if(b.time>c.time)return c.prev=b.prev,c.prev&&(c.prev.next=c),c.next=b,c.next.prev=c,this.nKeys++,c;if(!b.next)return c.prev=b,b.next=c,this.nKeys++,c;b=b.next}return null},evaluate:function(a){var c,g,h,t,l,o=0;if(0===this.nKeys)return 0;if(1===this.nKeys)return this.keys.value;
g=this.firstKey;c=this.lastKey;if(a<g.time){t=this.in_behavior;if(t===q.envelope.behavior.RESET)return 0;if(t===q.envelope.behavior.CONSTANT)return g.value;if(t===q.envelope.behavior.REPEAT)t=f(a,g.time,c.time),a=t[0];else if(t===q.envelope.behavior.OCILLATE)t=f(a,g.time,c.time),a=t[0],t=t[1],t%2&&(a=c.time-g.time-a);else if(t===q.envelope.behavior.OFFSET)t=f(a,g.time,c.time),a=t[0],t=t[1],o=t*(c.value-g.value);else if(t===q.envelope.behavior.LINEAR)return l=b(g,g.next)/(g.next.time-g.time),l*(a-
g.time)+g.value}else if(a>c.time){t=this.out_behavior;if(t===q.envelope.behavior.RESET)return 0;if(t===q.envelope.behavior.CONSTANT)return c.value;if(t===q.envelope.behavior.REPEAT)t=f(a,g.time,c.time),a=t[0];else if(t===q.envelope.behavior.OCILLATE)t=f(a,g.time,c.time),a=t[0],t=t[1],t%2&&(a=c.time-g.time-a);else if(t===q.envelope.behavior.OFFSET)t=f(a,g.time,c.time),a=t[0],t=t[1],o=t*(c.value-g.value);else if(t===q.envelope.behavior.LINEAR)return t=n(c.prev,c)/(c.time-c.prev.time),t*(a-c.time)+c.value}if(this.lastKey0)if(a>
this.lastKey0.time)c=this.lastKey0;else if(a<this.lastKey0.time)for(c=this.lastKey;a<c.time&&c.prev;)c=c.prev;else c=this.keys;else c=this.keys;for(;a>c.next.time;)c=c.next;g=c.next;this.lastKey0=c;if(a===c.time)return c.value+o;if(a===g.time)return g.value+o;h=(a-c.time)/(g.time-c.time);t=g.shape;if(t===q.envelope.shape.TCB||t===q.envelope.shape.BEZI||t===q.envelope.shape.HERM){l=b(c,g);t=n(c,g);var s,m;m=h*h;s=h*m;a=3*m-s-s;s-=m;a=[1-a,a,s-m+h,s];return a[0]*c.value+a[1]*g.value+a[2]*l+a[3]*t+o}return t===
q.envelope.shape.BEZ2?(a=d(c.time,c.shape===q.envelope.shape.BEZ2?c.time+c.param[2]:c.time+(g.time-c.time)/3,g.time+g.param[0],g.time,a,0,1),e(c.value,c.shape===q.envelope.shape.BEZ2?c.value+c.param[3]:c.value+c.param[1]/3,g.param[1]+g.value,g.value,a)+o):t===q.envelope.shape.LINE?c.value+h*(g.value-c.value)+o:t===q.envelope.shape.STEP?c.value+o:o}};l.prototype={clone:function(){var a=new m.Motion(this.env_init,this.key_init),c;for(c in this.controllers)if(this.controllers.hasOwnProperty(c)){a.controllers[c]===
o&&(a.controllers[c]=[]);for(var b in this.controllers[c])if(this.controllers[c].hasOwnProperty(b)){var d=this.controllers[c][b],e=a.controllers[c][b]=new r({in_behavior:d.in_behavior,out_behavior:d.out_behavior});e.nKeys=d.nKeys;e.keys=d.keys;e.firstKey=d.firstKey;e.lastKey=d.lastKey}}return a},envelope:function(a,c){c=m.parseEnum(q.motion,c)||0;a=m.parseEnum(q.motion,a)||0;this.controllers[a]===o&&(this.controllers[a]=[]);this.controllers[a][c]===o&&(this.controllers[a][c]=new r(this.env_init));
return this.controllers[a][c]},evaluate:function(a){var c=[],b;for(b in this.controllers)if(this.controllers.hasOwnProperty(b)){c[b]=[];for(var d in this.controllers[b])this.controllers[b].hasOwnProperty(d)&&(c[b][d]=this.controllers[b][d].evaluate(a))}return c},apply:function(a,c){for(var b in this.controllers)if(this.controllers.hasOwnProperty(b)){var d=parseInt(b,10);if(this.yzflip&&d===q.motion.ROT){this.q||(this.q=new m.Quaternion);var e=this.q,n=this.controllers[b][0].evaluate(a),f=this.controllers[b][1].evaluate(a),
s=this.controllers[b][2].evaluate(a);e.fromEuler(n,s,-f);e=e.toEuler();c.control(d,0,e[0]);c.control(d,1,e[1]);c.control(d,2,e[2])}else for(var l in this.controllers[b])this.controllers[b].hasOwnProperty(l)&&c.control(d,parseInt(l,10),this.controllers[b][l].evaluate(a))}},setKey:function(a,c,b,d,e){c=m.parseEnum(q.motion,c)||0;a=m.parseEnum(q.motion,a)||0;return this.envelope(a,c).addKey(b,d,e?e:this.key_init)},setArray:function(a,c,b,d){var e=[],a=m.parseEnum(q.motion,a)||0,n;for(n in b)if(b.hasOwnProperty(n)){var f=
this.envelope(a,m.parseEnum(q.motion,n));e[n]=f.addKey(c,b[n],d?d:this.key_init)}return e},setBehavior:function(a,c,b,d){var e=this.envelope(a,c);"object"===typeof b&&(d=b,b=d.in_behavior||d.inBehavior||d.behavior,d=d.out_behavior||d.outBehavior||d.behavior);m.parseEnum(q.motion,c);m.parseEnum(q.motion,a);e.setBehavior(b,d)},setBehaviorArray:function(a,c,b){var a=m.parseEnum(q.motion,a)||0,d=this.controllers[a],e;for(e in d)d.hasOwnProperty(e)&&this.envelope(a,m.parseEnum(q.motion,e)||0).setBehavior(c,
b)}};return{Motion:l,Envelope:r,EnvelopeKey:v}});
CubicVR.RegisterModule("EventHandler",function(m){function v(e){e=CubicVR.parseEnum(q.event,e);return e===o?(f("For custom events use CubicVR.registerEvent('event_name'); and use the resulting CubicVR.enums.event.EVENT_NAME for type checks and 'event_name' for construction."),!1):!isNaN(parseInt(e,10))&&(e>=q.event.EVENT_MAX||0>e)?(f("Unknown event ID passed: "+e),!1):e}function r(e){e=e||{};this.name=e.name;this.classType=m.enums.classType.EVENT;e.id=v(e.id)||q.event.TICK;this.id=e.id;this.interval=
e.interval||0;this.enabled=e.enabled||!0;this.action=e.action||null;this.properties=e.properties||{};this.event_properties=e.event_properties||{};this.buffered=e.buffered||!1;this.weight=e.weight===o?-1:e.weight;this.subject=null;this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0;this.break_chain=!1}function l(){this.events=[];this.eventProperties=[];this.eventPropertyCount=[];this.eventHandled=[];this.listeners=[];this.listenerNames=
[];this.eventParameters=[]}var o=m.undef,q=CubicVR.enums,f=m.log;q.event={TICK:0,MOVE:1,MATRIX_UPDATE:2,OCTREE_ADJUST:3,COLLIDE:4,CONTACT:5,CONTACT_ADD:6,CONTACT_REMOVE:7,CONTACT_GHOST:8,RIGID_REST:9,RIGID_AWAKE:10,ENUM_MAX:11};r.prototype={getName:function(){return this.name},setName:function(e){this.name=e},getSubject:function(){return this.subject},setSubject:function(e){this.subject=e},getId:function(){return this.id},setId:function(e){this.id=e},isEnabled:function(){return this.enabled},disable:function(){this.setEnabled(!1)},
enable:function(){this.setEnabled(!0)},setEnabled:function(e){e&&!this.enabled&&(this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0,this.break_chain=!1);this.enabled=e},isBuffered:function(){return this.buffered},setBuffered:function(e){this.buffered=e},setInterval:function(e){this.interval=e},getInterval:function(){return this.interval},setAction:function(e){this.action=e},getAction:function(){return this.action},getProperties:function(){return this.properties},
setProperties:function(e){this.properties=e},getProperty:function(e){return this.properties[e]},setProperty:function(e,d){this.properties[e]=d},setEventProperties:function(e){this.event_properties=e},getEventProperties:function(){return this.event_properties},getEventProperty:function(e){return this.event_properties[e]},setEventProperty:function(e,d){this.properties[e]=d},getTimeSleeping:function(){return this.t_sleep},getTimeActive:function(){return this.t_active},getTimeUpdated:function(){return this.t_update},
getSeconds:function(){return this.getTimeUpdated()},getRestInterval:function(){return this.t_rest},getLastUpdateSeconds:function(){return this.t_last},setRestInterval:function(e){this.t_rest=e},getUpdateCount:function(){return this.n_updates},breakChain:function(){this.break_chain=!0},isChainBroken:function(){return this.break_chain},rest:function(e){this.setRestInterval(e||0)},awake:function(){this.t_rest=0},update:function(e,d){if(!this.enabled)return!1;var b=0,n=!0;0===this.n_updates?(this.t_updatecall=
this.t_update=e,b=1/60):e!==this.t_update?(this.t_rest||(this.t_last=e-this.t_update,this.t_update=e),b=e-this.t_updatecall,this.t_updatecall=e):n=!1;if(0<this.t_rest)n&&(this.t_resting+=b,this.t_rest-=b,0>this.t_rest&&(this.t_rest=0));else return n&&(this.t_active+=this.t_last,!this.t_rest&&this.interval&&(this.t_rest=this.interval),this.n_updates++),this.callEvent(d),!0;n&&this.n_updates++;return!1},callEvent:function(e){return!this.action?!1:this.action(this,e)}};l.prototype={addEvent:function(e){e.callEvent||
(e=new r(e));var d=e.getId();this.eventProperties[d]||(this.eventProperties[d]={});this.listeners[d]=this.listeners[d]||0;this.listeners[d]++;this.events.push(e);-1===this.listenerNames.indexOf(d)&&this.listenerNames.push(d);return e},removeEvent:function(e){if(this.lockState)this.lockRemovals||(this.lockRemovals=[]),-1==this.lockRemovals.indexOf(e)&&this.lockRemovals.push(e);else{var d=this.events.indexOf(e);-1!==d&&(e=e.getId(),this.events.splice(d,1),this.listeners[e]--,this.listeners[e]||(this.eventHandled[e]=
!0,this.eventParameters[e]={},this.eventProperties[e]=[],this.eventPropertyCount[e]=0,d=this.listenerNames.indexOf(e),0<=d&&this.listenerNames.splice(d,1)))}},getProperties:function(e){this.eventParameters[e]=this.eventParameters[e]||{};return this.eventParameters[e]},setProperties:function(e,d){this.eventParameters[e]=d},getProperty:function(e,d){return this.getProperties(e)[d]},setProperty:function(e,d,b){this.getProperties(e)[d]=b},hasEvent:function(e){return!!this.listeners[e]},triggerEvent:function(e,
d){if(!this.listeners[e])return null;this.eventProperties[e]==o&&(this.eventProperties[e]=[]);var b=this.eventProperties[e];this.eventPropertyCount[e]===o&&(this.eventPropertyCount[e]=0);var n=this.eventPropertyCount[e];20<n&&console.log("Warning, event "+e+" count > 20: "+n);b[n]=d&&b?d:b[n]||{};this.eventPropertyCount[e]++;this.eventHandled[e]=!1;return b[n]},update:function(e){var d,b,n,a,c,g;if(this.hasEvent(q.event.TICK)&&0===this.eventPropertyCount[q.event.TICK]&&(d=this.triggerEvent(q.event.TICK)))d.time=
e,d.handler=this;this.lockState=!0;d=0;for(b=this.events.length;d<b;d++){c=this.events[d];g=c.getId();a=this.eventPropertyCount[g];var f=!1;n=!1;if(a){var l=this.eventProperties[g];if(c.isEnabled()){if(c.isBuffered()){if(l.length=a,c.setEventProperties(l),f=f||c.update(e,this),c.isChainBroken()){c.breakChain(!1);break}}else for(n=0;n<a;n++)if(c.setEventProperties(l[d]),f=f||c.update(e,this),c.isChainBroken()){c.breakChain(!1);break}n=!0}}if(f||!n)this.eventHandled[g]=!0}d=0;for(b=this.listenerNames.length;d<
b;d++)g=this.listenerNames[d],this.eventHandled[g]&&(this.eventPropertyCount[g]=0);this.lockState=!1;if(this.lockRemovals&&this.lockRemovals.length){d=0;for(b=this.lockRemovals.length;d<b;d++)this.removeEvent(this.lockRemovals[d]);this.lockRemovals.length=0}}};return{Event:r,EventHandler:l,registerEvent:function(e){e=e.toUpperCase();q.event[e]!==o?f("Error, event '"+e+"' is already registered."):(q.event[e]=q.event.ENUM_MAX,q.event.ENUM_MAX++)},validateEvent:v}});
CubicVR.RegisterModule("Scene",function(m){function v(b,a){return b.light_type-a.light_type}function r(b,a){var c=null,e,f;b!==q&&null!==b?b.compile?c={}:(c=m.get(b)||{},b=null):c={};this.morphWeight=c.morphWeight||0;this.morphSource=c.morphSource||-1;this.morphTarget=c.morphTarget||-1;this.position=c.position===q?[0,0,0]:c.position;this.rotation=c.rotation===q?[0,0,0]:c.rotation;this.scale=c.scale===q?[1,1,1]:c.scale;this.shadowCast=c.shadowCast===q?!0:c.shadowCast;this.wireframe=c.wireframe||!1;
this.pointMode=c.pointMode||!1;this.motion=c.motion===q?null:m.get(c.motion,m.Motion)||null;this.obj=!c.mesh?b?m.get(b,m.Mesh):null:m.get(c.mesh,m.Mesh);this.name=c.name===q?a!==q?a:null:c.name;this.properties=m.get(c.properties)||{};this.parent=this.children=null;var l=c.children||c.child||c.sceneObject||c.sceneObjects;if(l){if(l&&!l.length||"string"===typeof l)l=[l];if(l.length){e=0;for(f=l.length;e<f;e++)this.bindChild(m.get(l[e],m.SceneObject))}}this.lposition=[0,0,0];this.lrotation=[0,0,0];this.lscale=
[0,0,0];this.lMatrix=d.identity();this.tMatrix=d.identity();this.dirty=!0;this.aabb=[];this.static=c.static||!1;this.octreeNode=this.static_lights=null;this.visible=!0;this.matrixLock=!1;this.eventHandler=this.instanceMaterials=null;this.duplicateCount=0;this.independentMotion=!1;this.classType=m.enums.classType.SCENEOBJECT}function l(d,a,c,e,f,l){this.frames=0;this.classType=m.enums.classType.SCENE;this.sceneObjects=[];this.sceneObjectsStatic=[];this.sceneObjectsDynamic=[];this.sceneObjectsByName=
[];this.sceneObjectsById=[];this.lights=[];this.lightsStatic=[];this.lightsDynamic=[];this.lightsGlobal=[];this.pickables=[];this.stats=[];this.cameras=[];this.camerasByName=[];this.shadows_updated=!1;if("object"===typeof d||"string"===typeof d){d=m.get(d);this.octree=d.octree;this.skybox=d.skybox||null;this.name=d.name||"scene"+b;this.wireframe=d.wireframe||!1;this.pointMode=d.pointMode||!1;this.destroy=d.destroy||function(){};this.update=d.update||function(){};this.enable=d.enable||function(){};
this.disable=d.disable||function(){};a=d.setup&&d.setup(this)||{};this.update=a.update||this.update;this.enable=a.enable||this.enable;this.disable=a.disable||this.disable;this.destroy=a.destroy||this.destroy;if((e=d.sceneObjects||d.sceneObject||d.objects)&&!e.length||"string"===typeof e)e=CubicVR.get(e),"object"==typeof e&&!e.length&&(e=[e]);if(e&&e.length){a=0;for(c=e.length;a<c;a++)this.bindSceneObject(m.get(e[a],m.SceneObject))}if((e=d.lights||d.light)&&!e.length||"string"===typeof e)e=CubicVR.get(e),
"object"==typeof e&&!e.length&&(e=[e]);if(e&&e.length){a=0;for(c=e.length;a<c;a++)this.bindLight(m.get(e[a],m.Light))}if((e=d.cameras||d.camera)&&!e.length||"string"===typeof e)e=[e],e=CubicVR.get(e),"object"==typeof e&&!e.length&&(e=[e]);if(e&&e.length){a=0;for(c=e.length;a<c;a++)this.bindCamera(m.get(e[a],m.Camera));this.camera=this.cameras[0]}e||(this.camera=new m.Camera(d.width,d.height,d.fov,d.nearclip,d.farclip));this.octree&&(this.octreeStatic=new CubicVR.Octree({size:this.octree.size,depth:this.octree.depth}),
this.lightingOctree=new CubicVR.Octree({size:this.octree.size,depth:this.octree.depth}),this.lightingOctreeStatic=new CubicVR.Octree({size:this.octree.size,depth:this.octree.depth}))}else this.skybox=null,this.octree=l,this.name="scene"+b,this.camera=new m.Camera(d,a,c,e,f),this.wireframe=!1;this.paused=!1;++b}function o(){this.meshBin={};this.imageBin={};this.meshMap={};this.imageMap={};this.imageBinPtr={};this.meshBinPtr={}}var q=m.undef,f=m.enums,e=m.GLCore,d=m.mat4;r.prototype={get x(){return this.position[0]},
set x(b){this.position[0]=b},get y(){return this.position[1]},set y(b){this.position[1]=b},get z(){return this.position[2]},set z(b){this.position[2]=b},get rotX(){return this.rotation[0]},set rotX(b){this.rotation[0]=b},get rotY(){return this.rotation[1]},set rotY(b){this.rotation[1]=b},get rotZ(){return this.rotation[2]},set rotZ(b){this.rotation[2]=b},get pos(){return this.position.slice(0)},set pos(b){this.position=b.slice(0)},get rot(){return this.rotation.slice(0)},set rot(b){this.rotation=
b.slice(0)},get sclX(){return this.scale[0]},set sclX(b){this.scale[0]=b},get sclY(){return this.scale[1]},set sclY(b){this.scale[1]=b},get sclZ(){return this.scale[2]},set sclZ(b){this.scale[2]=b},get scl(){return this.scale.slice(0)},set scl(b){this.scale=b.slice(0)},clone:function(){var b,a;b=this.name?this.name+"_"+this.duplicateCount:null;this.duplicateCount++;var c=new m.SceneObject({name:b,mesh:this.obj,position:this.position.slice(0),rotation:this.rotation.slice(0),scale:this.scale.slice(0),
morphWeight:this.morphWeight,morphSource:this.morphSource,morphTarget:this.morphTarget,shadowCast:this.shadowCast,wireframe:this.wireframe,pointMode:this.pointMode,motion:this.motion?this.motion.clone():null});if(null!==this.instanceMaterials){c.instanceMaterials=[];b=0;for(a=this.instanceMaterials.length;b<a;b++)c.instanceMaterials[b]=this.instanceMaterials[b].clone()}if(null!==this.children){b=0;for(a=this.children.length;b<a;b++)c.bindChild(this.children[b].clone())}return c},evaluate:function(b){var a,
c;this.independentMotion=!0;this.motion&&this.motion.apply(b,this);if(null!==this.children){a=0;for(c=this.children.length;a<c;a++)this.children[a].evaluate(b)}},isWireframe:function(){return this.wireframe},setWireframe:function(b){this.wireframe=b},setPointMode:function(b){this.pointMode=b},isPointMode:function(){return this.pointMode},addEvent:function(b){this.eventHandler||(this.eventHandler=new m.EventHandler);b=this.eventHandler.addEvent(b);b.setSubject(this);return b},removeEvent:function(b){this.eventHandler&&
this.eventHandler.removeEvent(b)},hasEvents:function(){return!!this.eventHandler},getEventHandler:function(){return this.eventHandler},setMesh:function(b){this.obj=b},getMesh:function(){return this.obj},getProperties:function(){return this.properties},setProperties:function(b){this.properties=b},getProperty:function(b){return this.properties[b]},setProperty:function(b,a){this.properties[b]=a},getInstanceMaterials:function(){if(!this.obj)return null;if(this.instanceMaterials)return this.instanceMaterials;
this.instanceMaterials=[];for(var b=0,a=this.obj.materials.length;b<a;b++)this.instanceMaterials[b]=this.obj.materials[b].clone();return this.instanceMaterials},getInstanceMaterial:function(b){for(var a=this.getInstanceMaterials(),c=0,d=a.length;c<d;c++)if(a[c].name==b)return a[c];return null},setMorphSource:function(b){this.morphSource=b},setMorphTarget:function(b){this.morphTarget=b},getMorphSource:function(){return this.morphSource},getMorphTarget:function(){return this.morphTarget},setMorphWeight:function(b){this.morphWeight=
b},morphTargetCount:function(){return null!==this.obj.morphTargets?this.obj.morphTargets.length:0},setMatrixLock:function(b){this.matrixLock=b},getMatrixLock:function(){return this.matrixLock},setMatrix:function(b){b?(this.tMatrix=b.slice(0),this.matrixLock=!0,this.hasEvents()&&(b=this.getEventHandler(),b.hasEvent(f.event.MATRIX_UPDATE)&&(b.triggerEvent(f.event.MATRIX_UPDATE).matrix=this.tMatrix))):this.matrixLock=!1},doTransform:function(b){var a=m.vec3;if(!this.matrixLock&&(!a.equal(this.lposition,
this.position)||!a.equal(this.lrotation,this.rotation)||!a.equal(this.lscale,this.scale)||b!==q))b!==q?this.tMatrix=b.slice(0):d.identity(this.tMatrix),d.identity(this.lMatrix),d.translate(this.position[0],this.position[1],this.position[2],this.lMatrix),d.rotate(this.rotation[0],this.rotation[1],this.rotation[2],this.lMatrix),1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2]||d.scale(this.scale[0],this.scale[1],this.scale[2],this.lMatrix),d.multiply(this.tMatrix.slice(0),this.lMatrix,this.tMatrix),
this.lposition[0]=this.position[0],this.lposition[1]=this.position[1],this.lposition[2]=this.position[2],this.lrotation[0]=this.rotation[0],this.lrotation[1]=this.rotation[1],this.lrotation[2]=this.rotation[2],this.lscale[0]=this.scale[0],this.lscale[1]=this.scale[1],this.lscale[2]=this.scale[2],this.dirty=!0,this.hasEvents()&&(b=this.getEventHandler(),b.hasEvent(f.event.MOVE)&&(b=b.triggerEvent(f.event.MOVE),b.oldPosition=this.lposition,b.position=this.position,b.oldRotation=this.lrotation,b.rotation=
this.rotation,b.oldScale=this.lscale,b.scale=this.scale))},bindChild:function(b){null===this.children&&(this.children=[]);b.parent=this;this.children.push(b)},control:function(b,a,c){b===f.motion.POS?this.position[a]=c:b===f.motion.SCL?this.scale[a]=c:b===f.motion.ROT&&(this.rotation[a]=c)},getAABB:function(){var b=m.mat4,a=m.vec3;if(this.dirty){var c=Array(8);this.doTransform();var d,e;if(this.obj){if(!this.obj.bb)return this.aabb=[a.add([-1,-1,-1],this.position),a.add([1,1,1],this.position)];d=
this.obj.bb[0];e=this.obj.bb[1]}if(!this.obj||d===q||e===q)return this.aabb=[a.add([-1,-1,-1],this.position),a.add([1,1,1],this.position)];var f=d;d=a.subtract(e,d);c[0]=[f[0],f[1],f[2]];c[1]=[f[0],f[1],f[2]+d[2]];c[2]=[f[0]+d[0],f[1],f[2]];c[3]=[f[0]+d[0],f[1],f[2]+d[2]];c[4]=[f[0],f[1]+d[1],f[2]];c[5]=[f[0],f[1]+d[1],f[2]+d[2]];c[6]=[f[0]+d[0],f[1]+d[1],f[2]];c[7]=[f[0]+d[0],f[1]+d[1],f[2]+d[2]];f=b.vec3_multiply(c[0],this.tMatrix);d=[f[0],f[1],f[2]];e=[f[0],f[1],f[2]];for(a=1;8>a;++a)f=b.vec3_multiply(c[a],
this.tMatrix),d[0]>f[0]&&(d[0]=f[0]),d[1]>f[1]&&(d[1]=f[1]),d[2]>f[2]&&(d[2]=f[2]),e[0]<f[0]&&(e[0]=f[0]),e[1]<f[1]&&(e[1]=f[1]),e[2]<f[2]&&(e[2]=f[2]);this.aabb[0]=d;this.aabb[1]=e;this.dirty=!1}return this.aabb}};var b=0;l.prototype={isWireframe:function(){return this.wireframe},setWireframe:function(b){this.wireframe=b},setPointMode:function(b){this.pointMode=b},isPointMode:function(){return this.pointMode},setSkyBox:function(b){this.skybox=b},getSceneObject:function(b){return this.sceneObjectsByName[b]},
bindSceneObject:function(b,a,c){if(-1==this.sceneObjects.indexOf(b)){this.sceneObjects.push(b);a!==q&&a&&this.pickables.push(b);null!==b.name&&(this.sceneObjectsByName[b.name]=b);if(this.octree){var d=b.static?this.octreeStatic:this.octree;(b.static?this.sceneObjectsStatic:this.sceneObjectsDynamic).push(b);var e=new CubicVR.Octree.Node({object:b,aabb:b.getAABB()});b.octreeNode=e;d.insert(e)}if(b.children){d=0;for(e=b.children.length;d<e;d++)this.bindSceneObject(b.children[d],a,c)}return b}},removeLight:function(b){var a=
this.lights.indexOf(b);0<=a&&this.lights.splice(a,1);if(this.octree){var c=b.static?this.lightsStatic:this.lightDynamic,d=b.octreeNode,a=c.indexOf(b);0<=a&&c.splice(a,1);d&&d.removeSelf();b.octreeNode=null}},removeSceneObject:function(b){var a;if(this.lockState)this.lockRemovals||(this.lockRemovals=[]),-1==this.lockRemovals.indexOf(b)&&this.lockRemovals.push(b);else{a=this.sceneObjects.indexOf(b);0<=a&&this.sceneObjects.splice(a,1);a=this.pickables.indexOf(b);0<=a&&this.pickables.splice(a,1);null!==
b.name&&this.sceneObjectsByName[b.name]!==q&&delete this.sceneObjectsByName[b.name];if(b.children){a=0;for(var c=b.children.length;a<c;a++)this.removeSceneObject(b.children[a])}this.octree&&(b.octreeNode&&(b.octreeNode.removeSelf(),b.octreeNode=null),c=b.static?this.sceneObjectsStatic:this.sceneObjectsDynamic,a=c.indexOf(b),0<=a&&c.splice(a,1))}},bindLight:function(b){this.lights.push(b);if(this.octree){var a=b.static?this.lightingOctreeStatic:this.lightingOctree,c=b.static?this.lightsStatic:this.lightDynamic,
d=new CubicVR.Octree.Node({object:b,aabb:b.getAABB()});b.octreeNode=d;a.insert(d);c.push(b)}this.lights=this.lights.sort(v)},bindCamera:function(b){-1===this.cameras.indexOf(b)&&(this.cameras.push(b),this.camerasByName[b.name]=b);this.camera=b},removeCamera:function(b){"object"!==typeof b&&(b=this.getCamera(camName));-1===this.cameras.indexOf(b)&&(this.cameras.push(b),this.camerasByName[b.name]=b);return b},bind:function(b,a){b instanceof m.Light?this.bindLight(b):b instanceof m.SceneObject?this.bindSceneObject(b,
a):b instanceof m.Camera?this.bindCamera(b):b instanceof m.Vehicle?b.bindToScene(this):b instanceof m.RigidBody&&this.bindSceneObject(b.getSceneObject())},remove:function(b){b instanceof m.Light?this.removeLight(b):b instanceof m.SceneObject?this.removeSceneObject(b):b instanceof m.Camera?this.removeCamera(b):b instanceof bsae.RigidBody&&this.removeSceneObject(b.getSceneObject())},setCamera:function(b){b&&("object"!==typeof b&&(b=this.getCamera(b)),this.camera=b)},getCamera:function(b){return b===
q?this.camera:this.camerasByName[b]},evaluate:function(b){var a,c;a=0;for(c=this.sceneObjects.length;a<c;a++)this.sceneObjects[a].motion&&!this.sceneObjects[a].independentMotion&&this.sceneObjects[a].motion.apply(b,this.sceneObjects[a]);null!==this.camera.motion&&(null!==this.camera.targetSceneObject&&(this.camera.target=this.camera.targetSceneObject.position),this.camera.motion.apply(b,this.camera));a=0;for(c=this.lights.length;a<c;a++){var d=this.lights[a];null!==d.motion&&d.motion.apply(b,d)}},
prepareTransforms:function(b){var a,c;if(b){if(b.doTransform(),b.children){a=0;for(c=b.children.length;a<c;a++)b.children[a].doTransform(b.tMatrix),this.prepareTransforms(b.children[a])}}else if(0!==this.sceneObjects.length){a=0;for(c=this.sceneObjects.length;a<c;++a)this.prepareTransforms(this.sceneObjects[a])}},updateShadows:function(b,a){var c=e.gl,a=a||this.camera;if(this.shadows_updated)return!1;b||this.doTransform();this.shadows_updated=!0;if(m.features.lightShadows){for(var d=c.getParameter(c.FRAMEBUFFER_BINDING),
h=!1,l=c.getParameter(c.VIEWPORT),o=0,w=this.lights.length;o<w;o++){var s=this.lights[o];if(s.light_type==f.light.type.SPOT_SHADOW||s.light_type==f.light.type.SPOT_SHADOW_PROJECTOR||s.light_type==f.light.type.AREA){var h=!0,q=[new m.Light(f.light.type.DEPTH_PACK)];s.light_type===f.light.type.AREA&&(s.areaCam=a,s.updateAreaLight());e.shadow_near=s.dummyCam.nearclip;e.shadow_far=s.dummyCam.farclip;s.shadowBegin();for(var r=0,H=this.sceneObjects.length;r<H;r++){var B=this.sceneObjects[r];B.parent||!1===
B.visible||!1===B.shadowCast||this.renderSceneObject(B,s.dummyCam,q,!0,!0)}s.shadowEnd();d&&c.bindFramebuffer(c.FRAMEBUFFER,d)}}h&&c.viewport(l[0],l[1],l[2],l[3])}},updateCamera:function(b){b=b||this.camera;!1===b.manual&&(b.targeted?b.lookat(b.position[0],b.position[1],b.position[2],b.target[0],b.target[1],b.target[2],0,1,0):b.calcProjection());e.depth_alpha_near=b.nearclip;e.depth_alpha_far=b.farclip},resize:function(b,a){this.camera&&this.camera.setDimensions(b,a)},doTransform:function(b){for(var b=
b||this.sceneObjects,a=0,c=b.length;a<c;a++){var d=b[a];null===d.parent&&this.prepareTransforms(d)}},renderSceneObject:function(b,a,c,d,f,l,o){var w=!1,s=e.gl,d=d!==q&&d,f=f||!1,l=l||!1;if(b.visible&&b.obj){0>b.scale[0]&&(w=!w);0>b.scale[1]&&(w=!w);0>b.scale[2]&&(w=!w);w&&s.cullFace(s.FRONT);var r=b.obj;null!==r.morphTargets&&(-1!==b.morphSource&&r.setMorphSource(b.morphSource),-1!==b.morphTarget&&r.setMorphTarget(b.morphTarget),null!==b.morphWeight&&(r.morphWeight=b.morphWeight));b.instanceMaterials&&
r.bindInstanceMaterials(b.instanceMaterials);m.renderObject(r,a,b.tMatrix,c,f,l,this.isWireframe()||b.isWireframe(),this.isPointMode()||b.isPointMode())&&o&&o.push(b);b.instanceMaterials&&r.bindInstanceMaterials(null);w&&s.cullFace(s.BACK)}b=b.children;if(d&&b){d=0;for(w=b.length;d<w;d++)this.renderSceneObject(b[d],a,c,!0,f,l,o)}},runEvents:function(b){var a,c;this.lockState=!0;b.getSeconds&&(b=b.getSeconds());a=0;for(c=this.sceneObjects.length;a<c;a++){var d=this.sceneObjects[a];d.hasEvents()&&d.getEventHandler().update(b)}this.lockState=
!1;if(this.lockRemovals){a=0;for(c=this.lockRemovals.length;a<c;a++)this.removeSceneObject(this.lockRemovals[a])}this.lockRemovals=null},doAdjustments:function(b){var a,c;a=0;for(c=b.length;a<c;a++){var d=b[a];if(d.dirty){var e=d.octreeNode;e.aabb=d.getAABB();e.adjust()}}},octreeAdd:function(){},render:function(b){++this.frames;b=b||{};b.postProcess&&b.postProcess.begin(!b.postBuffer);var a,c,f=e.gl,h=b.camera||this.camera;this.lights_rendered=0;this.octree?(this.doTransform(this.sceneObjectsDynamic),
this.doAdjustments(this.sceneObjectsDynamic)):this.doTransform(this.sceneObjects);var l=b.sceneObjects||this.sceneObjects;this.octree&&!b.sceneObjects&&(l=this.octree.get_frustum_hits(h).concat(this.octreeStatic.get_frustum_hits(h)));this.updateCamera(h);this.updateShadows(!0);this.shadows_updated=!1;var o=b.lights||this.lights;a=0;for(c=o.length;a<c;a++){var q=o[a];q.prepare(h);if(this.octree&&q.dirty){var s=q.octreeNode;s.aabb=q.getAABB();s.adjust()}}q=[];a=0;for(c=l.length;a<c;a++)if(s=l[a],!(!1===
s.visible||null!==s.parent)){if(this.octree&&!b.sceneObjects){if(null==s.static_lights||!s.static)s.static_lights=this.lightingOctreeStatic.get_aabb_hits(s.getAABB());s.dynamic_lights=this.lightingOctree.get_aabb_hits(s.getAABB());o=s.static_lights.concat(s.dynamic_lights);0==o.length&&(o=[e.emptyLight])}this.renderSceneObject(s,h,o,!0,!0,!1,q)}if(this.octree){a=0;for(c=q.length;a<c;a++)l=q[a],o=l.static_lights.concat(l.dynamic_lights),0==o.length&&(o=[e.emptyLight]),this.renderSceneObject(l,h,o,
!1,!1,!0)}else{a=0;for(c=q.length;a<c;a++)this.renderSceneObject(q[a],h,o,!1,!1,!0)}null!==this.skybox&&!0===this.skybox.ready&&(f.cullFace(f.FRONT),a=2*h.farclip/Math.sqrt(3),this.skybox.scene_object.position=h.parent?d.vec3_multiply(h.position,h.parent.tMatrix):[h.position[0],h.position[1],h.position[2]],this.skybox.scene_object.scale=[a,a,a],this.skybox.scene_object.doTransform(),m.renderObject(this.skybox.scene_object.obj,h,this.skybox.scene_object.tMatrix,[]),f.cullFace(f.BACK));b.postProcess&&
(b.postProcess.end(),b.postBuffer||b.postProcess.render())},bbRayTest:function(b,a,c,d){var e=m.vec3,f=[],d=d||this.camera,a=2===a.length?d.unProject(a[0],a[1]):e.add(b,a),l;for(l in this.pickables)if(this.pickables.hasOwnProperty(l)&&(d=this.pickables[l],!0===d.visible)){var o,s;s=d.getAABB();o=s[0];s=s[1];0.2>s[0]-o[0]&&(o[0]-=0.1,s[0]+=0.1);0.2>s[1]-o[1]&&(o[1]-=0.1,s[1]+=0.1);0.2>s[2]-o[2]&&(o[2]-=0.1,s[2]+=0.1);var q=e.multiply(e.add(o,s),0.5),r=e.getClosestTo(b,a,q),q=e.length(e.subtract(r,
q));(r[0]>=o[0]&&r[0]<=s[0]?1:0)+(r[1]>=o[1]&&r[1]<=s[1]?1:0)+(r[2]>=o[2]&&r[2]<=s[2]?1:0)>=c&&f.push({dist:q,obj:d})}f.length&&f.sort(function(a,b){return a.dist==b.dist?0:a.dist<b.dist?-1:1});return f}};o.prototype={addMesh:function(b,a,c){this.meshBin[b]===q&&(this.meshBin[b]=[],this.meshBinPtr[b]===q&&(this.meshBinPtr[b]=0));this.meshMap[a]===q&&(this.meshMap[a]=c,this.meshBin[b].push(c))},addImage:function(b,a,c){this.imageBin[b]===q&&(this.imageBin[b]=[],this.imageBinPtr[b]===q&&(this.imageBinPtr[b]=
0));this.imageMap[a]===q&&(this.imageMap[a]=c,this.imageBin[b].push(c))},getMeshes:function(b){return this.meshBin[b]},getImages:function(b){return this.imageBin[b]},rewindMeshes:function(b){this.meshBinPtr[b]=0},rewindImages:function(b){this.imageBinPtr[b]=0},getNextMesh:function(b){var a=this.meshBinPtr[b];return a<this.meshBin[b].length?(this.meshBinPtr[b]++,this.meshBin[b][a]):null},loadNextMesh:function(b){b=this.getNextMesh(b);return null!==b?(null===b.compiled&&(b.triangulateQuads(),b.compile(),
b.clean()),!0):!1},isMeshBinEmpty:function(b){return this.meshBinPtr[b]===this.meshBin[b].length},loadNextImage:function(b){b=this.getNextImage(b);null!==b&&(b.src=b.deferredSrc)},getNextImage:function(b){var a=this.imageBinPtr[b];return a<this.imageBin[b].length?(this.imageBinPtr[b]++,this.imageBin[b][a]):null},isImageBinEmpty:function(b){return this.imageBinPtr[b]===this.imageBin[b].length}};return{Scene:l,SceneObject:r,SkyBox:function(b){var a=b.texture,b=b.mapping,c=this;this.mapping=null;this.ready=
!1;this.texture=null;this.onready=function(){a.onready=null;var b=1/m.Images[c.texture.tex_id].width;null===c.mapping&&(c.mapping=[[1/3,0.5,2/3-b,1],[0,0.5,1/3,1],[0,0,1/3-b,0.5],[2/3,0,1,0.5],[2/3+b,0.5,1,1],[1/3,0,2/3,0.5]]);var b=new m.Material({name:"skybox",textures:{color:a},noFog:!0}),d=new m.Mesh;d.sky_mapping=c.mapping;m.primitives.box({mesh:d,size:1,material:b,uvmapper:{projectionMode:m.enums.uv.projection.SKY,scale:[1,1,1]}});d.prepare();c.scene_object=new m.SceneObject(d);c.ready=!0};
if(a&&("string"===typeof a?a=new m.Texture(a,null,null,null,this.onready):a.loaded||(a.onready=this.onready),this.texture=a,b))this.mapping=b,this.onready()},DeferredBin:o}});
CubicVR.RegisterModule("PostProcess",function(m){function v(b){if(b.shader_vertex===o||b.shader_fragment===o)return null;this.outputMode=b.outputMode===o?f.post.output.REPLACE:CubicVR.parseEnum(CubicVR.enums.post.output,b.outputMode);this.onresize=b.onresize===o?null:b.onresize;this.onupdate=b.onupdate===o?null:b.onupdate;this.init=b.init===o?null:b.init;this.enabled=b.enabled===o?!0:b.enabled;this.outputDivisor=b.outputDivisor===o?1:b.outputDivisor;this.shader=new CubicVR.Shader(b.shader_vertex,
b.shader_fragment);this.shader.use();this.shader.addUVArray("aTex");this.shader.addVertexArray("aVertex");this.shader.addInt("srcTex",0);this.shader.addInt("captureTex",1);this.shader.addVector("texel");null!==this.init&&this.init(this.shader)}function r(b,d,a){var c=q.gl;this.width=b;this.height=d;this.accum=a===o?!1:!0;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer=new CubicVR.RenderBuffer(b,d,!0);this.bufferA=new CubicVR.RenderBuffer(b,d,!1);this.bufferB=new CubicVR.RenderBuffer(b,
d,!1);this.bufferC=new CubicVR.RenderBuffer(b,d,!1);this.accumOpacity=1;this.accumIntensity=0.3;this.accum&&(this.accumBuffer=new CubicVR.RenderBuffer(b,d,!1),this.accumBuffer.use(),c.clearColor(0,0,0,1),c.clear(c.COLOR_BUFFER_BIT),this.blur_shader=new v({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform float opacity;\nvoid main(void)\n{ gl_FragColor = vec4(texture2D(srcTex, vTex).rgb, opacity);\n}",
init:function(a){a.addFloat("opacity");a.setFloat("opacity",1)}}));this.bufferA.use();c.clearColor(0,0,0,1);c.clear(c.COLOR_BUFFER_BIT);this.bufferB.use();c.clearColor(0,0,0,1);c.clear(c.COLOR_BUFFER_BIT);this.end();this.fsQuad=this.makeFSQuad(this.width,this.height);this.shaders=[];this.copy_shader=new v({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nvoid main(void) {\ngl_FragColor = texture2D(srcTex, vTex);\n}"});
this.resize(b,d)}function l(b,d,a){this.createBuffer(b,d,a)}var o=m.undef,q=m.GLCore,f=CubicVR.enums;f.post={output:{REPLACE:0,BLEND:1,ADD:2,ALPHACUT:3}};var e=[],d=[];r.prototype={setBlurOpacity:function(b){this.accumOpacity=b},setBlurIntensity:function(b){this.accumIntensity=b},makeFSQuad:function(b,d){var a=q.gl,c={},e=b/b,f=d/d;c.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);c.vbo_uvs=new Float32Array([0,0,e,0,e,f,0,f,0,0,e,f]);c.gl_points=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,
c.gl_points);a.bufferData(a.ARRAY_BUFFER,c.vbo_points,a.STATIC_DRAW);c.gl_uvs=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,c.gl_uvs);a.bufferData(a.ARRAY_BUFFER,c.vbo_uvs,a.STATIC_DRAW);return c},destroyFSQuad:function(b){var d=q.gl;d.deleteBuffer(b.gl_points);d.deleteBuffer(b.gl_uvs)},renderFSQuad:function(b,d){var a=q.gl;b.use();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null);a.bindBuffer(a.ARRAY_BUFFER,d.gl_points);a.vertexAttribPointer(b.aVertex,3,a.FLOAT,!1,0,0);a.enableVertexAttribArray(b.aVertex);
a.bindBuffer(a.ARRAY_BUFFER,d.gl_uvs);a.vertexAttribPointer(b.aTex,2,a.FLOAT,!1,0,0);a.enableVertexAttribArray(b.aTex);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null);a.drawArrays(a.TRIANGLES,0,6)},addShader:function(b){this.shaders[this.shaders.length]=b;b.shader.use();b.shader.setVector("texel",this.vTexel);if(b.outputDivisor&&1!=b.outputDivisor&&e[b.outputDivisor]===o){var f=this.width/b.outputDivisor|0,a=this.height/b.outputDivisor|0;e[b.outputDivisor]=new CubicVR.RenderBuffer(f,a,!1);d[b.outputDivisor]=
this.makeFSQuad(f,a)}},resize:function(b,f){var a=q.gl;this.width=b;this.height=f;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer.destroyBuffer();this.captureBuffer.createBuffer(this.width,this.height,!0);this.bufferA.destroyBuffer();this.bufferA.createBuffer(this.width,this.height,!1);this.bufferB.destroyBuffer();this.bufferB.createBuffer(this.width,this.height,!1);this.bufferC.destroyBuffer();this.bufferC.createBuffer(this.width,this.height,!1);this.accum&&(this.accumBuffer.destroyBuffer(),
this.accumBuffer.createBuffer(this.width,this.height,!1),this.accumBuffer.use(),a.clearColor(0,0,0,1),a.clear(a.COLOR_BUFFER_BIT));for(var c in e){var a=this.width/c|0,g=this.height/c|0;e[c].destroyBuffer();e[c].createBuffer(a,g,!1);this.destroyFSQuad(d[c]);d[c]=this.makeFSQuad(a,g)}this.inputBuffer=this.bufferA;this.outputBuffer=this.bufferB;c=0;for(a=this.shaders.length;c<a;c++)if(this.shaders[c].shader.use(),this.shaders[c].shader.setVector("texel",this.vTexel),null!==this.shaders[c].onresize)this.shaders[c].onresize(this.shaders[c].shader,
this.width,this.height);this.destroyFSQuad(this.fsQuad);this.fsQuad=this.makeFSQuad(this.width,this.height)},swap:function(){var b=this.inputBuffer;this.inputBuffer=this.outputBuffer;this.outputBuffer=b},begin:function(b){var d=q.gl;this.captureBuffer.use();b&&(this.captureBuffer.depth?d.clear(d.DEPTH_BUFFER_BIT|d.COLOR_BUFFER_BIT):d.clear(d.COLOR_BUFFER_BIT))},end:function(){var b=q.gl;b.bindFramebuffer(b.FRAMEBUFFER,null)},render:function(){var b=q.gl;this.captureBuffer.texture.use(b.TEXTURE1);
this.outputBuffer.use();this.captureBuffer.texture.use(b.TEXTURE0);b.clearColor(0,0,0,1);b.clear(b.COLOR_BUFFER_BIT);this.renderFSQuad(this.copy_shader.shader,this.fsQuad);this.end();for(var n=0,a=0,c=this.shaders.length;a<c;a++){var g=this.shaders[a];if(g.enabled){this.swap();this.inputBuffer.texture.use(b.TEXTURE0);var h=g.outputMode;if(h===f.post.output.REPLACE)1!==g.outputDivisor?e[g.outputDivisor].use():this.outputBuffer.use(),b.clearColor(0,0,0,1),b.clear(b.COLOR_BUFFER_BIT);else if(h===f.post.output.ADD||
h===f.post.output.BLEND)1!==g.outputDivisor?e[g.outputDivisor].use():this.bufferC.use(),b.clearColor(0,0,0,1),b.clear(b.COLOR_BUFFER_BIT);null!==g.onupdate&&(g.shader.use(),g.onupdate(g.shader));1!==g.outputDivisor?(b.viewport(0,0,e[g.outputDivisor].width,e[g.outputDivisor].height),this.renderFSQuad(g.shader,d[g.outputDivisor]),g.outputMode===f.post.output.REPLACE?(this.outputBuffer.use(),e[g.outputDivisor].texture.use(b.TEXTURE0),b.viewport(0,0,this.width,this.height),this.renderFSQuad(this.copy_shader.shader,
this.fsQuad)):b.viewport(0,0,this.width,this.height)):this.renderFSQuad(g.shader,this.fsQuad);h===f.post.output.BLEND?(this.swap(),this.outputBuffer.use(),b.enable(b.BLEND),b.blendFunc(b.ONE,b.ONE_MINUS_SRC_ALPHA),this.inputBuffer.texture.use(b.TEXTURE0),1!==g.outputDivisor?e[g.outputDivisor].texture.use(b.TEXTURE0):this.bufferC.texture.use(b.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.disable(b.BLEND)):h===f.post.output.ADD&&(this.swap(),this.outputBuffer.use(),b.enable(b.BLEND),
b.blendFunc(b.ONE,b.ONE),1!==g.outputDivisor?e[g.outputDivisor].texture.use(b.TEXTURE0):this.bufferC.texture.use(b.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.disable(b.BLEND));this.end();n++}}0===n?this.captureBuffer.texture.use(b.TEXTURE0):this.outputBuffer.texture.use(b.TEXTURE0);this.accum&&1!==this.accumOpacity?(this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumOpacity),this.accumBuffer.use(),b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA),
this.renderFSQuad(this.blur_shader.shader,this.fsQuad),this.end(),b.disable(b.BLEND),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA),this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumIntensity),this.accumBuffer.texture.use(b.TEXTURE0),this.renderFSQuad(this.blur_shader.shader,this.fsQuad),b.disable(b.BLEND)):this.renderFSQuad(this.copy_shader.shader,this.fsQuad)}};l.prototype={createBuffer:function(b,
d,a){this.texture=this.depth=this.fbo=null;this.width=parseInt(b,10);this.height=parseInt(d,10);var b=this.sizeParam(b),d=this.sizeParam(d),c=q.gl;this.fbo=c.createFramebuffer();a&&(this.depth=c.createRenderbuffer());c.bindFramebuffer(c.FRAMEBUFFER,this.fbo);a&&(c.bindRenderbuffer(c.RENDERBUFFER,this.depth),-1!==navigator.appVersion.indexOf("Windows")?(c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_COMPONENT16,b,d),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,this.depth)):
(c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_STENCIL,b,d),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_STENCIL_ATTACHMENT,c.RENDERBUFFER,this.depth)));this.texture=new CubicVR.Texture;c.bindTexture(c.TEXTURE_2D,m.Textures[this.texture.tex_id]);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE);c.texImage2D(c.TEXTURE_2D,
0,c.RGBA,b,d,0,c.RGBA,c.UNSIGNED_BYTE,null);c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,m.Textures[this.texture.tex_id],0);c.bindFramebuffer(c.FRAMEBUFFER,null)},destroyBuffer:function(){var b=q.gl;b.bindFramebuffer(b.FRAMEBUFFER,null);b.deleteRenderbuffer(this.depth);b.deleteFramebuffer(this.fbo);b.deleteTexture(m.Textures[this.texture.tex_id]);m.Textures[this.texture.tex_id]=null},sizeParam:function(b){return b},use:function(){var b=q.gl;b.bindFramebuffer(b.FRAMEBUFFER,
this.fbo)}};return{RenderBuffer:l,PostProcessShader:v,PostProcessChain:r,fsQuad:{make:r.prototype.makeFSQuad,destroy:r.prototype.destroyFSQuad,render:r.prototype.renderFSQuad}}});
CubicVR.RegisterModule("Layout",function(){function m(m){this.texture=m.texture?m.texture:null;this.width=m.width?m.width:128;this.height=m.height?m.height:128;this.x=m.x?m.x:0;this.y=m.y?m.y:0;this.blend=m.blend?m.blend:!1;this.opacity="undefined"!==typeof m.opacity?m.opacity:1;this.tint=m.tint?m.tint:[1,1,1];this.type="view";this.superView=null;this.childViews=[];this.panel=null}function v(m){this.texture=m.texture?m.texture:null;this.width=m.width?m.width:128;this.height=m.height?m.height:128;
this.x=m.x?m.x:0;this.y=m.y?m.y:0;this.blend=m.blend?m.blend:!1;this.opacity="undefined"!==typeof m.opacity?m.opacity:1;this.tint=m.tint?m.tint:[1,1,1];this.type="root";this.superView=null;this.childViews=[];this.setupShader();this.panel=null;this.makePanel(this)}m.prototype={addSubview:function(m){this.childViews.push(m);m.superView=this},makePanel:function(m){return this.superView.makePanel(m)}};v.prototype={resize:function(m,l){this.width=m;this.height=l},setupShader:function(){this.shader=new CubicVR.PostProcessShader({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nuniform vec3 screen;\nuniform vec3 position;\nuniform vec3 size;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\nvPos.x *= size.x/screen.x;\nvPos.y *= size.y/screen.y;\nvPos.x += (size.x/screen.x);\nvPos.y -= (size.y/screen.y);\nvPos.x += (position.x/screen.x)*2.0 - 1.0;\nvPos.y -= (position.y/screen.y)*2.0 - 1.0;\ngl_Position = vPos;\n}",
shader_fragment:"#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform sampler2D srcTex;\nuniform vec3 tint;\nvarying vec2 vTex;\nvoid main(void) {\nvec4 color = texture2D(srcTex, vTex)*vec4(tint,1.0);\ngl_FragColor = color;\n}",init:function(m){m.setInt("srcTex",0);m.addVector("screen");m.addVector("position");m.addVector("tint");m.addVector("size")}})},addSubview:function(m){this.childViews.push(m);m.superView=this},removeSubview:function(m){m=this.childViews.indexOf(m);-1<m&&this.childViews.splice(m,
1)},makePanel:function(m){var l=CubicVR.GLCore.gl,o={};o.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);o.vbo_uvs=new Float32Array([0,0,1,0,1,1,0,1,0,0,1,1]);o.gl_points=l.createBuffer();l.bindBuffer(l.ARRAY_BUFFER,o.gl_points);l.bufferData(l.ARRAY_BUFFER,o.vbo_points,l.STATIC_DRAW);o.gl_uvs=l.createBuffer();l.bindBuffer(l.ARRAY_BUFFER,o.gl_uvs);l.bufferData(l.ARRAY_BUFFER,o.vbo_uvs,l.STATIC_DRAW);m.panel=o},renderPanel:function(m){if(!m.texture)return!1;m.texture.use(CubicVR.GLCore.gl.TEXTURE0)},
renderView:function(m){if(m.texture){var l=CubicVR.GLCore.gl,o=m.offsetLeft,q=m.offsetTop;o||(o=0);q||(q=0);var f=this.shader.shader;f.use();f.setVector("screen",[this.width,this.height,0]);f.setVector("position",[m.x+o,m.y+q,0]);f.setVector("size",[m.width,m.height,0]);f.setVector("tint",m.tint);m.blend&&(l.enable(l.BLEND),l.blendFunc(l.SRC_ALPHA,l.ONE_MINUS_SRC_ALPHA));m.texture.use(l.TEXTURE0);l.drawArrays(l.TRIANGLES,0,6);m.blend&&(l.disable(l.BLEND),l.blendFunc(l.ONE,l.ZERO))}},render:function(){var m=
CubicVR.GLCore.gl;m.disable(m.DEPTH_TEST);this.texture&&this.renderView(this);var l=[];this.offsetTop=this.offsetLeft=0;l.push(this);var o=this.shader.shader;o.use();m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null);m.bindBuffer(m.ARRAY_BUFFER,this.panel.gl_points);m.vertexAttribPointer(o.uniforms.aVertex,3,m.FLOAT,!1,0,0);m.enableVertexAttribArray(o.uniforms.aVertex);m.bindBuffer(m.ARRAY_BUFFER,this.panel.gl_uvs);m.vertexAttribPointer(o.uniforms.aTex,2,m.FLOAT,!1,0,0);m.enableVertexAttribArray(o.uniforms.aTex);
for(m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null);l.length;){var q=l.pop();this.renderView(q);if(q.childViews.length)for(var f=q.childViews.length-1;0<=f;f--)q.childViews[f].offsetLeft=q.x+q.offsetLeft,q.childViews[f].offsetTop=q.y+q.offsetTop,l.push(q.childViews[f])}m.disableVertexAttribArray(o.uniforms.aTex);m.enable(m.DEPTH_TEST)}};return{Layout:v,View:m}});
CubicVR.RegisterModule("Primitives",function(m){function v(b,d,e,f,g,n){var l=m.mat4,o=m.vec3,q=[],u,r=[0,1,0],y=[1,0,0],v=[0,0,0],C=b.points.length,E,z,J;for(E=u=0;E<c&&u!==e;E+=c/e){y=[Math.cos(E),0,Math.sin(E)];z=0;for(J=d.length;z<J;z++)v=o.add(o.multiply(y,d[z][0]),o.multiply(r,d[z][1])),q[u]===a&&(q[u]=[]),q[u].push(v);u++}J=null;g!==a&&(J=g.getResult!==a?g.getResult():g);for(z=0;z<e;z++){g=0;for(u=d.length;g<u;g++)J?b.addPoint(l.vec3_multiply(q[z][g],J)):b.addPoint(q[z][g])}"string"===typeof f&&
(f=new m.Material(f));b.setFaceMaterial(f);for(g=0;g<e;g++){z=0;for(J=d.length-1;z<J;z++)l=z+d.length*g,q=z+d.length*((g+1)%e),o.equal(b.points[C+l],b.points[C+q])?b.addFace([C+l+1,C+q+1,C+q]):o.equal(b.points[C+l+1],b.points[C+q+1])?b.addFace([C+l,C+l+1,C+q]):b.addFace([C+l,C+l+1,C+q+1,C+q])}n!==a&&(d=null,n.apply!==a?d=n:n&&(d=new m.UVMapper(n)),null!==d&&(b.calcFaceNormals(),d.apply(b,f)))}function r(b,c,d,e,f){var g=m.mat4,c=0.5*c,n=b.points.length;"string"===typeof d&&(d=new m.Material(d));b.setFaceMaterial(d);
e!==a?(e=e.getResult!==a?e.getResult():e,b.addPoint([g.vec3_multiply([c,-c,0],e),g.vec3_multiply([c,c,0],e),g.vec3_multiply([-c,c,0],e),g.vec3_multiply([-c,-c,0],e)])):b.addPoint([[c,-c,0],[c,c,0],[-c,c,0],[-c,-c,0]]);b.addFace([[n+0,n+1,n+2,n+3],[n+3,n+2,n+1,n+0]]);f!==a&&(g=null,f.apply!==a?g=f:f&&(g=new m.UVMapper(f)),null!==g&&(b.calcFaceNormals(),g.apply(b,d)))}function l(b,c,d,e,f){var g=m.mat4,n,l;"object"===typeof c?(n=c[0]/2,l=c[1]/2,c=c[2]/2):n=l=c/=2;var o=b.points.length;"string"===typeof d&&
(d=new m.Material(d));b.setFaceMaterial(d);e!==a?(e=e.getResult!==a?e.getResult():e,b.addPoint([g.vec3_multiply([n,-l,c],e),g.vec3_multiply([n,l,c],e),g.vec3_multiply([-n,l,c],e),g.vec3_multiply([-n,-l,c],e),g.vec3_multiply([n,-l,-c],e),g.vec3_multiply([n,l,-c],e),g.vec3_multiply([-n,l,-c],e),g.vec3_multiply([-n,-l,-c],e)])):b.addPoint([[n,-l,c],[n,l,c],[-n,l,c],[-n,-l,c],[n,-l,-c],[n,l,-c],[-n,l,-c],[-n,-l,-c]]);b.addFace([[o+0,o+1,o+2,o+3],[o+7,o+6,o+5,o+4],[o+4,o+5,o+1,o+0],[o+5,o+6,o+2,o+1],[o+
6,o+7,o+3,o+2],[o+7,o+4,o+0,o+3]]);f!==a&&(g=null,f.apply!==a?g=f:f&&(g=new m.UVMapper(f)),null!==g&&(b.calcFaceNormals(),g.apply(b,d)))}function o(a,b,d,e,f,g,n,l){for(var o=[],d=d-b,b=b+d/2,q=c/f,r=0,y=0;y<=f;y++)o.push([b+Math.cos(r)*d,Math.sin(r)*d,0]),r+=q;m.genLatheObject(a,o,e,g,n,l)}function q(a,b,c,d,e,f,g){m.genLatheObject(a,[[0,-c/2,0],[b/2,-c/2,0],[0,c/2,0]],d,e,f,g)}function f(a,b,c,d,e,f,g){m.genLatheObject(a,[[0,-c/2,0],[b,-c/2,0],[b,c/2,0],[0,c/2,0]],d,e,f,g)}function e(a,b,c,d,e,
f,n){for(var l=[],d=(d/=2)|0,c=c|0,o=Math.PI/d,q=-g,r=0;r<=d;r++)l.push([Math.cos(q)*b,Math.sin(q)*b,0]),q+=o;m.genLatheObject(a,l,c,e,f,n)}function d(b){"string"===typeof b&&(b=m.get(b,m.Material));return b===a?new m.Material:b.use?b:"object"===typeof b?new m.Material(b):new m.Material}function b(b){if(b===a)return a;if("array"===typeof b)return b;if("object"===typeof b)return b.getResult?b.getResult():b.position||b.rotation||b.scale?m.mat4.transform(b.position,b.rotation,b.scale):a}function n(b){"string"===
typeof b&&(b=m.get(b));return b===a?a:b.apply?b:"object"===typeof b?new m.UVMapper(b):a}var a=m.undef,c=2*Math.PI,g=Math.PI/2;return{genPlaneObject:r,genBoxObject:l,genLatheObject:v,genTorusObject:o,genConeObject:q,genCylinderObject:f,genSphereObject:e,primitives:{lathe:function(c){var e,f,g,l;if(c.points==a)return null;e=c.mesh!==a?c.mesh:new m.Mesh(c.name!==a?c.name:a);f=d(c.material);g=b(c.transform);l=n(c.uvmapper||c.uv);v(e,c.points,c.divisions!==a?c.divisions:24,f,g,l);return e},box:function(c){var e,
f,g,o;e=c.mesh!==a?c.mesh:new m.Mesh(c.name!==a?c.name:a);f=d(c.material);g=b(c.transform);o=n(c.uvmapper||c.uv);l(e,c.size!==a?c.size:1,f,g,o);return e},plane:function(c){var e,f,g,l;e=c.mesh!==a?c.mesh:new m.Mesh(c.name!==a?c.name:a);f=d(c.material);g=b(c.transform);l=n(c.uvmapper||c.uv);r(e,c.size!==a?c.size:1,f,g,l);return e},sphere:function(c){var f,g,l,o;f=c.mesh!==a?c.mesh:new m.Mesh(c.name!==a?c.name:a);g=d(c.material);l=b(c.transform);o=n(c.uvmapper||c.uv);e(f,c.radius!==a?c.radius:1,c.lon!==
a?c.lon:24,c.lat!==a?c.lat:24,g,l,o);return f},torus:function(c){var e,f,g,l;e=c.mesh!==a?c.mesh:new m.Mesh(c.name!==a?c.name:a);f=d(c.material);g=b(c.transform);l=n(c.uvmapper||c.uv);o(e,c.innerRadius!==a?c.innerRadius:0.75,c.outerRadius!==a?c.outerRadius:1,c.lon!==a?c.lon:24,c.lat!==a?c.lat:24,f,g,l);return e},cone:function(c){var e,f,g,l;e=c.mesh!==a?c.mesh:new m.Mesh(c.name!==a?c.name:a);f=d(c.material);g=b(c.transform);l=n(c.uvmapper||c.uv);q(e,c.base!==a?c.base:1,c.height!==a?c.height:1,c.lon!==
a?c.lon:24,f,g,l);return e},cylinder:function(c){var e,g,l,o;e=c.mesh!==a?c.mesh:new m.Mesh(c.name!==a?c.name:a);g=d(c.material);l=b(c.transform);o=n(c.uvmapper||c.uv);f(e,c.radius!==a?c.radius:1,c.height!==a?c.height:1,c.lon!==a?c.lon:24,g,l,o);return e}}}});
CubicVR.RegisterModule("COLLADA",function(m){function v(e,d){function b(b){return!b.color?!1:(b=b.color)?a.floatDelimArray(b.$.replace(/ {2}/g," ").replace(/^\s+|\s+$/,"")," "):!1}function n(a){return!a["float"]?!1:a=(a=a["float"])?parseFloat(a.$.replace(/ {2}/g," ").replace(/^\s+|\s+$/,"")):0}var a=m.util,c,g,h,o,F,w;w="object"==typeof e?e:-1!=e.indexOf(".js")?a.getJSON(e):m.util.xml2badgerfish(a.getXML(e));var s,G,A,v,B,u,x,y,D,C,E,z,J,I,L,K,M,X,fa,Q,Ca,O=w;w=null;if(!O.COLLADA)throw Error(e+" does not appear to be a valid COLLADA file.");
var O=O.COLLADA,N={up_axis:1,images:[],effects:[],materials:[],meshes:[],scenes:[],lights:[],cameras:[],animations:[]};if(O.asset){var qa=O.asset.up_axis.$;"X_UP"===qa?N.up_axis=0:"Y_UP"===qa?N.up_axis=1:"Z_UP"===qa&&(N.up_axis=2)}var fb=N.up_axis;if(O.library_images&&(O.library_images.image&&!O.library_images.image.length&&(O.library_images.image=[O.library_images.image]),O.library_images.image&&O.library_images.image.length))for(var gb=O.library_images.image,Ma=0,pb=gb.length;Ma<pb;Ma++){var Na=
gb[Ma],hb=Na["@id"],qb=Na["@name"],ac=Na.init_from;if(ac.$){var ra=ac.$;d!==r&&-1!==ra.lastIndexOf("/")&&(ra=ra.substr(ra.lastIndexOf("/")+1));d!==r&&-1!==ra.lastIndexOf("\\")&&(ra=ra.substr(ra.lastIndexOf("\\")+1));N.images[hb]={source:ra,id:hb,name:qb}}}var ib,rb,bc,U,Oa,ja,Pa,ca,P,V,S,Da,ga,Qa,Ra,Y,$;if(O.library_effects){var Sa=O.library_effects.effect;Sa&&!Sa.length&&(Sa=[Sa]);rb=0;for(bc=Sa.length;rb<bc;rb++){var Db=Sa[rb];ib=Db["@id"];var T={};T.id=ib;T.surfaces=[];T.samplers=[];(ca=Db.profile_COMMON.newparam)&&
!ca.length&&(ca=[ca]);if(ca){X=0;for(fa=ca.length;X<fa;X++){var sa=ca[X],Ta=sa["@sid"];if(sa.surface){T.surfaces[Ta]={};var cc=sa.surface.init_from.$;"object"===typeof N.images[cc]&&(T.surfaces[Ta].source=d+"/"+N.images[cc].source)}else if(sa.sampler2D&&(T.samplers[Ta]={},T.samplers[Ta].source=sa.sampler2D.source.$,sa.sampler2D.minfilter&&(T.samplers[Ta].minfilter=sa.sampler2D.minfilter.$),sa.sampler2D.magfilter))T.samplers[Ta].magfiter=sa.sampler2D.magfilter.$}}var ua=Db.profile_COMMON.technique;
ua&&!ua.length&&(ua=[ua]);T.material={textures_ref:[]};U=0;for(Oa=ua.length;U<Oa;U++){c=ua[U].blinn;c||(c=ua[U].phong);c||(c=ua[U].lambert);if(c)for(var ba in c){var sb=c[ba],ka=b(sb),dc=n(sb),Eb;Eb=sb.texture?sb.texture["@texture"]:!1;"transparent"==ba&&(!1!==ka&&3<ka.length)&&(T.material.opacity=1-ka[3]);!1!==ka&&3<ka.length&&ka.pop();"emission"==ba?!1!==ka&&(T.material.ambient=ka):"ambient"!=ba&&("diffuse"==ba?!1!==ka&&(T.material.color=ka):"specular"==ba?!1!==ka&&(T.material.specular=ka):"shininess"==
ba&&!1!==dc&&(T.material.shininess=dc));if(!1!==Eb){var Ua=T.surfaces[T.samplers[Eb].source].source;"emission"==ba?T.material.textures_ref.push({image:Ua,type:l.texture.map.AMBIENT}):"ambient"==ba?T.material.textures_ref.push({image:Ua,type:l.texture.map.AMBIENT}):"diffuse"==ba?T.material.textures_ref.push({image:Ua,type:l.texture.map.COLOR}):"specular"==ba?T.material.textures_ref.push({image:Ua,type:l.texture.map.SPECULAR}):"shininess"!=ba&&("reflective"==ba?T.material.textures_ref.push({image:Ua,
type:l.texture.map.REFLECT}):"reflectivity"!=ba&&"transparent"==ba&&T.material.textures_ref.push({image:Ua,type:l.texture.map.ALPHA}))}}N.effects[ib]=T}}}var Fb=f.getAllOf(O,"instance_geometry"),tb=[];if(Fb.length){u=0;for(y=Fb.length;u<y;u++){var ec=Fb[u],Gb=f.getAllOf(ec,"instance_material");if(Gb.length){Q=0;for(Ca=Gb.length;Q<Ca;Q++){var fc=Gb[Q],Ic=fc["@symbol"],Jc=fc["@target"].substr(1);tb[ec["@url"].substr(1)+":"+Ic]=Jc}}}}var Hb=O.library_materials;if(Hb&&Hb.material){var Va=Hb.material;
Va&&!Va.length&&(Va=[Va]);C=0;for(E=Va.length;C<E;C++){var Ib=Va[C],Kc=Ib["@id"],Lc=Ib["@name"],gc=Ib.instance_effect;gc&&(ib=gc["@url"].substr(1),N.materials.push({id:Kc,name:Lc,mat:N.effects[ib].material}))}}var hc=O.library_geometries,Wa;if(hc){var ta=hc.geometry;ta&&!ta.length&&(ta=[ta]);if(ta.length)for(var jb=0,Mc=ta.length;jb<Mc;jb++){var ma={id:r,points:[],parts:[]},Xa=ta[jb].mesh;if(Xa){Wa=ta[jb]["@id"];F=ta[jb]["@name"];var Ya=Xa.source;Ya&&!Ya.length&&(Ya=[Ya]);for(var R=[],Jb=0,Nc=Ya.length;Jb<
Nc;Jb++){var ub=Ya[Jb];g=ub["@id"];var Oc=ub["@name"],Kb=ub.float_array;Kb&&(R[g]={id:g,name:Oc,data:a.floatDelimArray(Kb.$?Kb.$:""," ")});var Lb=ub.technique_common.accessor;Lb&&(R[g].count=Lb["@count"]|0,R[g].stride=Lb["@stride"]|0,R[g].count&&(R[g].data=a.repackArray(R[g].data,R[g].stride,R[g].count)))}var Mb=Xa.vertices,kb=null,Nb=null,Ea=null,Fa=null,Ga=null;if(Mb&&(Nb=Mb["@id"],(P=Mb.input)&&!P.length&&(P=[P]),P)){ja=0;for(Pa=P.length;ja<Pa;ja++)V=P[ja],"POSITION"===V["@semantic"]&&(kb=V["@source"].substr(1))}var na=
Xa.triangles;na&&!na.length&&(na=[na]);if(na){U=0;for(Oa=na.length;U<Oa;U++){$={material:0,faces:[],normals:[],texcoords:[],colors:[]};var Pc=parseInt(na[U]["@count"],10);(P=na[U].input)&&!P.length&&(P=[P]);S=[];if(P.length){ja=0;for(Pa=P.length;ja<Pa;ja++)V=P[ja],Y=parseInt(V["@offset"],10),o=V["@source"].substr(1),"VERTEX"===V["@semantic"]?(o===Nb&&(o=kb),S[Y]=0):"NORMAL"===V["@semantic"]?(Ea=o,R[Ea].count&&(S[Y]=1)):"TEXCOORD"===V["@semantic"]?(Ga=o,R[Ga].count&&(S[Y]=2)):"COLOR"===V["@semantic"]?
(Fa=o,R[Fa].count&&(S[Y]=3)):S[Y]=4}v=S.length;h=Wa+":"+na[U]["@material"];null===h?$.material=0:tb[h]===r?(q("missing material ["+h+"]@"+Wa+"?"),$.material=0):$.material=tb[h];var ic=na[U].p,va=[];ic&&(va=a.intDelimArray(ic.$," "));if(va.length&&(B=va.length/S.length/3,B===Pc)){0===ma.points.length&&(ma.points=R[kb].data);u=Y=0;y=va.length;for(D=S.length;u<y;u+=3*D){s=[];G=[];A=[];ha=[];for(Q=0;Q<3*D;Q++){var vb=Q%D;0===S[vb]?G.push(va[u+Q]):1===S[vb]?s.push(va[u+Q]):2===S[vb]?A.push(va[u+Q]):3===
S[vb]&&ha.push(va[u+Q])}G.length&&($.faces.push(G),3===s.length&&$.normals.push([f.fixuaxis(N.up_axis,R[Ea].data[s[0]]),f.fixuaxis(N.up_axis,R[Ea].data[s[1]]),f.fixuaxis(N.up_axis,R[Ea].data[s[2]])]),3===A.length&&$.texcoords.push([R[Ga].data[A[0]],R[Ga].data[A[1]],R[Ga].data[A[2]]]),3===ha.length&&$.colors.push([R[Fa].data[ha[0]],R[Fa].data[ha[1]],R[Fa].data[ha[2]]]))}}ma.parts.push($)}}var ia=Xa.polylist;ia||(ia=Xa.polygons);ia&&!ia.length&&(ia=[ia]);if(ia){U=0;for(Oa=ia.length;U<Oa;U++){$={material:0,
faces:[],normals:[],texcoords:[],colors:[]};var jc=parseInt(ia[U]["@count"],10);(P=ia[U].input)&&!P.length&&(P=[P]);S=[];if(P.length){ja=0;for(Pa=P.length;ja<Pa;ja++){V=P[ja];var Ob=V["@offset"];null===Ob&&(Ob=V["@idx"]);Y=parseInt(Ob,10);o=V["@source"].substr(1);"VERTEX"===V["@semantic"]?(o===Nb&&(o=kb),S[Y]=0):"NORMAL"===V["@semantic"]?(Ea=o,S[Y]=1):"TEXCOORD"===V["@semantic"]?(Ga=o,S[Y]=2):"COLOR"===V["@semantic"]?(Fa=o,S[Y]=3):S[Y]=4}}var kc=ia[U].vcount,Za=[];kc&&(Za=a.intDelimArray(kc.$," "));
h=Wa+":"+ia[U]["@material"];$.material=h===r?0:tb[h];var lb=ia[U].p;v=S.length;var wa=[];if(1<lb.length&&!Za.length){X=0;for(fa=lb.length;X<fa;X++){var lc=a.intDelimArray(lb[X].$," ");Za[X]=parseInt(lc.length/v,10);wa=wa.concat(lc)}}else lb&&(wa=a.intDelimArray(lb.$," "));if(wa.length)if(B=Za.length,B!==jc)q("poly vcount data doesn't add up, skipping object load: "+B+" !== "+jc);else{0===ma.points.length&&(ma.points=R[kb].data);u=Y=0;for(y=Za.length;u<y;u++){s=[];G=[];A=[];ha=[];Q=0;for(Ca=Za[u]*
v;Q<Ca;Q++)0===S[Q%v]?G.push(wa[Y]):1===S[Q%v]?s.push(wa[Y]):2===S[Q%v]?A.push(wa[Y]):3===S[Q%v]&&ha.push(wa[Y]),Y++;var $a;if(G.length){$.faces.push(G);if(s.length){Z=[];z=0;for(J=s.length;z<J;z++)Z.push(f.fixuaxis(N.up_axis,R[Ea].data[s[z]]));$.normals.push(Z)}if(A.length){$a=[];z=0;for(J=A.length;z<J;z++)$a.push(R[Ga].data[A[z]]);$.texcoords.push($a)}if(ha.length){$a=[];z=0;for(J=ha.length;z<J;z++)$a.push(R[Fa].data[ha[z]]);$.colors.push($a)}}}}ma.parts.push($)}}if(1!==fb){u=0;for(y=ma.points.length;u<
y;u++)ma.points[u]=f.fixuaxis(N.up_axis,ma.points[u])}ma.id=Wa;N.meshes.push(ma)}}}var mc=O.library_cameras;if(mc){(Qa=mc.camera)&&!Qa.length&&(Qa=[Qa]);I=0;for(L=Qa.length;I<L;I++){ga=Qa[I];var Qc=ga["@id"],wb=0,xb=0,yb=0;ga.optics&&(ga.optics.technique_common&&ga.optics.technique_common.perspective)&&(wb=ga.optics.technique_common.perspective.yfov,xb=ga.optics.technique_common.perspective.znear,yb=ga.optics.technique_common.perspective.zfar);var Pb,Qb,Rb;if(!wb&&!xb&&!yb){(ca=ga.param)&&!ca.length&&
(ca=[ca]);u=0;for(y=ca.length;u<y;u++){var Sb=ca[u].$,Tb=ca[u]["@name"];"YFOV"==Tb?Pb=parseFloat(Sb):"ZNEAR"==Tb?Qb=parseFloat(Sb):"ZFAR"==Tb&&(Rb=parseFloat(Sb))}}else Pb=wb?parseFloat(wb.$):60,Qb=xb?parseFloat(xb.$):0.1,Rb=yb?parseFloat(yb.$):1E3;N.cameras.push({id:Qc,targeted:!1,fov:parseFloat(Pb),nearclip:parseFloat(Qb),farclip:parseFloat(Rb)})}}var nc=O.library_lights,Ha;if(nc){var Ia=nc.light;Ia&&!Ia.length&&(Ia=[Ia]);var oc={point:"point",directional:"directional",spot:"spot"};if(Ia)for(var Ub=
0,Rc=Ia.length;Ub<Rc;Ub++){Ha=Ia[Ub];var pc,mb,zb;for(zb in oc)if(Ha.technique_common[zb]){pc=zb;mb=Ha.technique_common[zb];break}if(mb){var Sc=oc[pc]||"point",qc=Ha["@id"],rc=mb.intensity,Tc=rc?parseFloat(rc.$):1,sc=mb.distance,Uc=sc?parseFloat(sc.$):10,tc=mb.color,ha=[1,1,1];tc&&(ha=a.floatDelimArray(tc.$," "));N.lights.push({id:qc,name:qc,type:Sc,method:l.light.method.STATIC,diffuse:ha,specular:[0,0,0],distance:Uc,intensity:Tc})}}}var uc=O.library_visual_scenes;if(uc){var ab=null;(ab=uc.visual_scene)&&
!ab.length&&(ab=[ab]);for(var Vb=0,Vc=ab.length;Vb<Vc;Vb++){Ra=ab[Vb];var xa={id:Ra["@id"],sceneObjects:[],cameras:[],lights:[],parentMap:[]},oa=[],bb=[],ya,Wb,la,aa,Z,vc=O.library_nodes;if(vc){var cb=vc.node;cb&&!cb.length&&(cb=[cb]);oa=[];u=0;for(y=cb.length;u<y;u++)Wb=cb[u],mnodeId=Wb["@id"],oa[la]=Wb;for(ya=[Ra];ya.length;){aa=ya.pop();if(aa.node&&((Z=aa.node)&&!Z.length&&(Z=[Z]),Z)){u=0;for(y=Z.length;u<y;u++)ya.push(Z[u])}if(aa.instance_node){var db=aa.instance_node;db&&!db.length&&(db=[db]);
u=0;for(y=db.length;u<y;u++){var Xb=db[u]["@url"].substr(1);oa[Xb]&&(aa.node&&aa.node.length&&(aa.node=[aa.node]),aa.node?aa.node.push(oa[Xb]):aa.node=[oa[Xb]])}}}}for(ya=[Ra];ya.length;)if(aa=ya.pop(),aa.node&&((Z=aa.node)&&!Z.length&&(Z=[Z]),Z)){u=0;for(y=Z.length;u<y;u++)Z[u].parentNode=aa,bb.push(Z[u]),ya.push(Z[u])}if(bb.length)for(var nb=0,Wc=bb.length;nb<Wc;nb++){var za=bb[nb],Aa=za.instance_geometry;Ha=bb[nb].instance_light;ga=bb[nb].instance_camera;la=za["@id"];var da=za["@name"],ea=f.cl_getInitalTransform(N.up_axis,
za);2===fb&&(ea.rotation=f.quaternionFilterZYYZ(ea.rotation,ga?[-90,0,0]:r));var ob=null,W=null,eb;if(Aa){Aa&&!Aa.length&&(Aa=[Aa]);u=0;for(y=Aa.length;u<y;u++)if(F=Aa[u]["@url"].substr(1),W={},W.name=(da?da:la)+(u?u:""),W.id=(la?la:da)+(u?u:""),W.meshId=Wa,W.meshName=F,ob||(W.position=ea.position,W.rotation=ea.rotation,W.scale=ea.scale,W.matrix=ea.matrix),xa.sceneObjects.push(W),oa[W.id]=!0,za.parentNode)(eb=za.parentNode["@id"])&&oa[eb]?xa.parentMap.push({parent:eb,child:W.id}):1<Aa.length&&(ob?
oa[ob.id]&&xa.parentMap.push({parent:ob.id,child:W.id}):(ob=W,W={}))}else if(ga){var Xc=ga["@url"].substr(1);xa.cameras.push({name:da?da:la,id:da?da:la,source:Xc,position:ea.position,rotation:ea.rotation})}else if(Ha){var Yc=Ha["@url"].substr(1);xa.lights.push({name:da?da:la,id:da?da:la,source:Yc,position:ea.position,rotation:ea.rotation||[0,0,0]})}else W={position:ea.position,rotation:ea.rotation,scale:ea.scale,matrix:ea.matrix},W.name=da?da:la,W.id=la?la:da,xa.sceneObjects.push(W),oa[W.id]=!0,za.parentNode&&
(eb=za.parentNode["@id"])&&oa[eb]&&xa.parentMap.push({parent:eb,child:W.id})}N.scenes.push(xa)}}var wc=O.library_animations,pa;if(wc){var Ja=wc.animation;Ja&&!Ja.length&&(Ja=[Ja]);if(Ja)for(var Yb=0,Zc=Ja.length;Yb<Zc;Yb++){var Ab=Ja[Yb];pa=Ab["@id"];N.animations[pa]={};N.animations[pa].sources=[];var Ka=Ab.source;Ka&&!Ka.length&&(Ka=[Ka]);if(Ka.length){K=0;for(M=Ka.length;K<M;K++){var Ba=Ka[K];g=Ba["@id"];var xc=Ba.technique_common,Bb=null,yc=null;Ba.name_array?Bb=a.textDelimArray(Ba.name_array.$,
" "):Ba.Name_array?Bb=a.textDelimArray(Ba.Name_array.$," "):Ba.float_array&&(yc=a.floatDelimArray(Ba.float_array.$," "));var Zb=0,zc="",Cb=1;if(xc){c=xc;var $b=c.accessor,Zb=parseInt($b["@count"],10),zc=$b["@source"].substr(1),Ac=$b["@stride"];Ac&&(Cb=parseInt(Ac,10))}N.animations[pa].sources[g]={data:Bb?Bb:yc,count:Zb,source:zc,stride:Cb};1!==Cb&&(N.animations[pa].sources[g].data=a.repackArray(N.animations[pa].sources[g].data,Cb,Zb))}}(Da=Ab.sampler)&&!Da.length&&(Da=[Da]);if(Da){N.animations[pa].samplers=
[];K=0;for(M=Da.length;K<M;K++){var Bc=Da[K],$c=Bc["@id"];(P=Bc.input)&&!P.length&&(P=[P]);if(P){var Cc=[];x=0;for(y=P.length;x<y;x++)V=P[x],Cc[V["@semantic"]]=V["@source"].substr(1);N.animations[pa].samplers[$c]=Cc}}}var La=Ab.channel;La&&!La.length&&(La=[La]);if(La){N.animations[pa].channels=[];I=0;for(L=La.length;I<L;I++){var Dc=La[I],ad=Dc["@source"].substr(1),Ec=Dc["@target"],Fc=Ec.split("/"),bd=Fc[0],Gc=Fc[1].split(".");N.animations[pa].channels.push({source:ad,target:Ec,targetName:bd,paramName:Gc[0],
typeName:Gc[1]})}}}}var Hc=O.scene;if(Hc&&(Ra=Hc.instance_visual_scene)){var cd=Ra["@url"].substr(1);N.scene=cd}return N}var r=m.undef,l=m.enums,o=m.GLCore,q=m.log,f={fixuaxis:function(e,d){if(0===e)return[d[1],d[0],d[2]];if(1===e)return d;if(2===e)return[d[0],d[2],-d[1]]},fixscaleaxis:function(e,d){if(0===e)return[d[1],d[0],d[2]];if(1===e)return d;if(2===e)return[d[0],d[2],d[1]]},fixukaxis:function(e,d,b,f){return d===l.motion.POS&&b===l.motion.Z&&e===l.motion.Z?-f:f},getAllOf:function(e,d){for(var b=
[e],f=[],a,c,g,h;b.length;)for(c in a=b.pop(),a)if(a.hasOwnProperty(c)){if(c===d)if(a[c].length){g=0;for(h=a[c].length;g<h;g++)f.push(a[c][g])}else f.push(a[c]);if("object"==typeof a[c])if(a[c].length){g=0;for(h=a[c].length;g<h;g++)b.push(a[c][g])}else b.push(a[c])}return f},quaternionFilterZYYZ:function(e,d){var b=m.vec3,f=e,a=new m.Quaternion;d!==r&&(f=b.add(e,d));a.fromEuler(f[0],f[2],-f[1]);return a.toEuler()},cl_getInitalTransform:function(e,d){var b=m.util,n={position:[0,0,0],rotation:[0,0,
0],scale:[1,1,1]},a=d.translate,c=d.rotate,g=d.scale;if(d.matrix&&!a&&!c&&!g)return n;a&&a.$&&(n.position=f.fixuaxis(e,b.floatDelimArray(a.$," ")));if(c)for(var a=0,h=c.length;a<h;a++){var l=c[a],o=l["@sid"],l=b.floatDelimArray(l.$," ");if("rotateX"==o||"rotationX"==o)n.rotation[0]=l[3];else if("rotateY"==o||"rotationY"==o)n.rotation[1]=l[3];else if("rotateZ"==o||"rotationZ"==o)n.rotation[2]=l[3]}g&&(n.scale=f.fixscaleaxis(e,b.floatDelimArray(g.$," ")));return n}};return{loadCollada:function(e,d,
b){var d=v(e,d,b),n=d.up_axis,a=[],c,g,h,t,q,w,s,G;g=0;for(h=d.materials.length;g<h;g++){q=d.materials[g];s=new m.Material(q.mat);s.name=q.name||null;w=0;for(t=q.mat.textures_ref.length;w<t;w++){G=q.mat.textures_ref[w];var A=null,A=void 0===m.Textures_ref[G.image]?new m.Texture(G.image,o.default_filter,b,e):m.Textures_obj[m.Textures_ref[G.image]];s.setTexture(A,G.type)}a[q.id]=s}w=[];g=0;for(h=d.meshes.length;g<h;g++){var A=d.meshes[g],H=new m.Mesh({name:A.id});H.points=A.points;var B=!1;s=0;for(G=
A.parts.length;s<G;s++){var u=A.parts[s];0!==u.material&&((t=a[u.material])||(t=new m.Material({name:u.material})),H.setFaceMaterial(t));var x=u.normals.length?!0:!1,y=u.texcoords.length?!0:!1,D=u.colors.length?!0:!1;D&&(a[u.material].color_map=!0);t=0;for(q=u.faces.length;t<q;t++){var C=H.addFace(u.faces[t]);x&&(H.faces[C].point_normals=u.normals[t]);y&&(H.faces[C].uvs=u.texcoords[t]);D&&(H.faces[C].point_colors=u.colors[t])}B|=x}H.faces.length&&(b?b.addMesh(e,e+":"+meshId,H):(B||H.calcNormals(),
H.triangulateQuads(),H.compile()),w[A.id]=H)}h=[];e=0;for(t=d.cameras.length;e<t;e++)h[d.cameras[e].id]=d.cameras[e];A=[];t=0;for(q=d.lights.length;t<q;t++)A[d.lights[t].id]=d.lights[t];b={};a={};g={};e={};s=0;for(G=d.scenes.length;s<G;s++){H=d.scenes[s];B=new m.Scene;t=0;for(q=H.sceneObjects.length;t<q;t++)u=H.sceneObjects[t],x=new m.SceneObject(u),x.obj=(w[u.meshName]?w[u.meshName]:w[u.meshId])||null,u.matrix&&x.setMatrix(u.matrix),b[u.id]=x,B.bindSceneObject(x);t=0;for(q=H.lights.length;t<q;t++)u=
H.lights[t],x=new m.Light(A[u.source]),x.position=u.position,x.rotation=u.rotation,a[u.id]=x,B.bindLight(x);H.cameras.length&&(t=H.cameras[0],q=new m.Camera(h[t.source]),q.position=t.position,q.rotation=t.rotation,g[t.id]=q,B.camera=q);t=0;for(q=H.parentMap.length;t<q;t++)u=H.parentMap[t],b[u.parent].bindChild(b[u.child]);e[H.id]=B}for(var E in d.animations)if(d.animations.hasOwnProperty(E)&&(w=d.animations[E],w.channels.length)){cCount=0;for(t=w.channels.length;cCount<t;cCount++){h=w.channels[cCount];
u=w.samplers[h.source];q=w.sources[u.INPUT];s=w.sources[u.OUTPUT];G=w.sources[u.INTERPOLATION];var A=w.sources[u.IN_TANGENT],H=w.sources[u.OUT_TANGENT],B=u.IN_TANGENT!==r,u=u.OUT_TANGENT!==r,x=null,D=b[h.targetName],y=g[h.targetName],z=a[h.targetName];D?(null===D.motion&&(D.motion=new m.Motion),x=D.motion):y?(null===y.motion&&(y.motion=new m.Motion),x=y.motion):z&&(null===z.motion&&(z.motion=new m.Motion),x=z.motion);if(null!==x){D=l.motion.POS;C=l.motion.X;2===n&&(x.yzflip=!0);c=h.paramName;if("rotateX"===
c||"rotationX"===c)D=l.motion.ROT,C=l.motion.X;else if("rotateY"===c||"rotationY"===c)D=l.motion.ROT,C=l.motion.Y;else if("rotateZ"===c||"rotationZ"===c)D=l.motion.ROT,C=l.motion.Z;else if("location"===c){if(D=l.motion.POS,"X"===h.typeName&&(C=l.motion.X),"Y"===h.typeName&&(C=l.motion.Y),"Z"===h.typeName)C=l.motion.Z}else if("translate"===c){if(D=l.motion.POS,"X"===h.typeName&&(C=l.motion.X),"Y"===h.typeName&&(C=l.motion.Y),"Z"===h.typeName)C=l.motion.Z}else if("LENS"===c)continue;else"FOV"===c?(D=
l.motion.FOV,C=3):"ZNEAR"===c?(D=l.motion.NEARCLIP,C=3):"ZFAR"===c?(D=l.motion.FARCLIP,C=3):"intensity"===c&&(D=l.motion.INTENSITY,C=3);z&&3>D&&(z.method=l.light.method.DYNAMIC);mCount=0;for(h=q.data.length;mCount<h;mCount++)if(k=null,"object"===typeof s.data[mCount]){i=0;for(iMax=s.data[mCount].length;i<iMax;i++)z=i,2===n&&2===i?z=1:2===n&&1===i&&(z=2),k=x.setKey(D,z,q.data[mCount],f.fixukaxis(d.up_axis,D,z,s.data[mCount][i])),G&&(c=G.data[mCount][i],"LINEAR"===c?k.shape=l.envelope.shape.LINE:"BEZIER"===
c&&(k.shape=!B&&!u?l.envelope.shape.LINEAR:l.envelope.shape.BEZI))}else if(z=C,ofs=0,y&&D===l.motion.ROT&&2===n&&0===z&&(ofs=-90),D===l.motion.ROT?k=x.setKey(D,z,q.data[mCount],s.data[mCount]+ofs):(2===n&&2===C?z=1:2===n&&1===C&&(z=2),k=x.setKey(D,z,q.data[mCount],f.fixukaxis(d.up_axis,D,z,s.data[mCount]))),G)if(c=G.data[mCount],"LINEAR"===c)k.shape=l.envelope.shape.LINE;else if("BEZIER"===c)if(!B&&!u)k.shape=l.envelope.shape.LINEAR,k.continutity=1;else{k.shape=l.envelope.shape.BEZ2;c=A.data[mCount][0];
var J,I=H.data[mCount][0];D===l.motion.ROT?(J=A.data[mCount][1],z=H.data[mCount][1],k.param[0]=c-k.time,k.param[1]=J-k.value+ofs,k.param[2]=I-k.time,k.param[3]=z-k.value+ofs):(J=f.fixukaxis(d.up_axis,D,z,A.data[mCount][1]),z=f.fixukaxis(d.up_axis,D,z,H.data[mCount][1]),k.param[0]=c-k.time,k.param[1]=J-k.value,k.param[2]=I-k.time,k.param[3]=z-k.value)}}}}E=null;return E=d.scene?e[d.scene]:e.pop()},parseCollada:v}});
CubicVR.RegisterModule("GML",function(m){function v(l){var o=CubicVR.util;this.strokes=[];this.bounds=[1,1,1];this.origin=[0,0,0];this.upvector=[0,1,0];this.viewvector=[0,0,1];this.manual_pos=0;if(l!==r){var l=o.getXML(l),m=l.getElementsByTagName("header");if(!m.length)return null;var f=m[0],m=l.getElementsByTagName("environment");if(!m.length)return null;this.name=null;f=f.getElementsByTagName("name");f.length&&(this.name=o.collectTextNode(f[0]));f=m[0].getElementsByTagName("screenBounds");f.length&&
(this.bounds=[parseFloat(o.collectTextNode(f[0].getElementsByTagName("x")[0])),parseFloat(o.collectTextNode(f[0].getElementsByTagName("y")[0])),parseFloat(o.collectTextNode(f[0].getElementsByTagName("z")[0]))]);f=m[0].getElementsByTagName("origin");f.length&&(this.origin=[parseFloat(o.collectTextNode(f[0].getElementsByTagName("x")[0])),parseFloat(o.collectTextNode(f[0].getElementsByTagName("y")[0])),parseFloat(o.collectTextNode(f[0].getElementsByTagName("z")[0]))]);m=m[0].getElementsByTagName("up");
m.length&&(this.upvector=[parseFloat(o.collectTextNode(m[0].getElementsByTagName("x")[0])),parseFloat(o.collectTextNode(m[0].getElementsByTagName("y")[0])),parseFloat(o.collectTextNode(m[0].getElementsByTagName("z")[0]))]);l=l.getElementsByTagName("drawing");m=0;for(f=l.length;m<f;m++)for(var e=l[m].getElementsByTagName("stroke"),d=0,b=0,n=0,a=0,c=0,g=e.length;c<g;c++){for(var h=e[c].getElementsByTagName("pt"),t=h.length,F=Array(t),w,s,G,A=0,v=t;A<v;A++)G=h[A],t=parseFloat(o.collectTextNode(G.getElementsByTagName("x")[0])),
w=parseFloat(o.collectTextNode(G.getElementsByTagName("y")[0])),s=parseFloat(o.collectTextNode(G.getElementsByTagName("z")[0])),G=parseFloat(o.collectTextNode(G.getElementsByTagName("time")[0])),1===this.upvector[0]?F[A]=[w!==w?0:w,t!==t?0:-t,s!==s?0:s,G]:1===this.upvector[1]?F[A]=[t!==t?0:t,w!==w?0:w,s!==s?0:s,G]:1===this.upvector[2]&&(F[A]=[t!==t?0:t,s!==s?0:-s,w!==w?0:w,G]),d<t&&(d=t),b<w&&(b=w),n<s&&(n=s),a<G&&(a=G);if(n>a){h=0;for(A=F.length;h<A;h++)t=F[h][3],F[h][3]=F[h][2],F[h][2]=t/this.bounds[2]}this.strokes[c]=
F}}}var r=m.undef;v.prototype={addStroke:function(l,o){var m=[];o===r&&(o=0.1);for(var f=0,e=l.length;f<e;f++){var d=[l[f][0],l[f][1],l[f][2]];this.manual_pos+=o;d.push(this.manual_pos);m.push(d)}this.strokes.push(m)},recenter:function(){var l=CubicVR.vec3,o=[0,0,0],m=[this.strokes[0][0][0],this.strokes[0][0][1],this.strokes[0][0][2]],f,e,d,b;d=0;for(b=this.strokes.length;d<b;d++){f=0;for(e=this.strokes[d].length;f<e;f++)o[0]>this.strokes[d][f][0]&&(o[0]=this.strokes[d][f][0]),o[1]>this.strokes[d][f][1]&&
(o[1]=this.strokes[d][f][1]),o[2]>this.strokes[d][f][2]&&(o[2]=this.strokes[d][f][2]),m[0]<this.strokes[d][f][0]&&(m[0]=this.strokes[d][f][0]),m[1]<this.strokes[d][f][1]&&(m[1]=this.strokes[d][f][1]),m[2]<this.strokes[d][f][2]&&(m[2]=this.strokes[d][f][2])}l=l.multiply(l.subtract(m,o),0.5);d=0;for(b=this.strokes.length;d<b;d++){f=0;for(e=this.strokes[d].length;f<e;f++)this.strokes[d][f][0]-=l[0],this.strokes[d][f][1]-=this.upvector[1]?l[1]:-l[1],this.strokes[d][f][2]-=l[2]}},generateObject:function(l,
o,m,f,e){var d=CubicVR.vec3;l===r&&(l=0);o===r&&(o=0);e===r&&(e=!1);f===r&&(f=0.02);m===r&&(m=0.015);for(var b=0!==o,n=0,a=0,c=new CubicVR.Mesh(this.name),g,h,t,F,w,s,G=0,A=this.strokes.length;G<A;G++){s=new CubicVR.Envelope;var v=new CubicVR.Envelope,B=new CubicVR.Envelope,u=this.strokes[G].length,x=[],y=[],D=0,C=this.strokes[G];for(w=0;w<u;w++){var E=C[w],z=s.addKey(E[3],E[0]),J=v.addKey(E[3],E[1]),I;I=e?B.addKey(E[3],E[2]):B.addKey(E[3],0);z.tension=0.5;J.tension=0.5;I.tension=0.5;0!==w?(g=E[0]-
g,h=E[1]-h,t=E[2]-t,F=E[3]-F,t=Math.sqrt(g*g+h*h+t*t),x[w-1]=t,y[w-1]=F):D=E[3];g=E[0];h=E[1];t=E[2];F=E[3]}u=c.points.length;for(w=0;w<x.length;w++){C=y[w];J=Math.ceil(3*(x[w]/f));E=D;z=D+C;for(J=C/J;E<z-J;E+=J){E===D&&(g=s.evaluate(E),h=v.evaluate(E),t=B.evaluate(E));var L,K;I=s.evaluate(E+J);L=v.evaluate(E+J);K=B.evaluate(E+J);var M=I-g,X=L-h,fa=K-t;Math.sqrt(M*M+X*X+fa*fa);M=d.multiply(d.normalize(d.cross(this.viewvector,d.normalize([M,X,fa]))),m/2);c.addPoint([g-M[0],-(h-M[1]),t-M[2]+(b?o/2:
0)]);c.addPoint([g+M[0],-(h+M[1]),t+M[2]+(b?o/2:0)]);g=I;h=L;t=K}D+=C}v=c.points.length;if(b){w=u;for(s=v;w<s;w++)c.addPoint([c.points[w][0],c.points[w][1],c.points[w][2]-(b?o/2:0)])}w=0;for(s=v-u;w<=s-4;w+=2){0===n%l&&a++;c.setSegment(a);B=[u+w,u+w+1,u+w+3,u+w+2];c.addFace(B);if(b&&(B=[B[3]+v-u,B[2]+v-u,B[1]+v-u,B[0]+v-u],c.addFace(B),B=[u+w,u+w+2,u+w+2+v-u,u+w+v-u],c.addFace(B),B=[u+w+1+v-u,u+w+3+v-u,u+w+3,u+w+1],c.addFace(B),0===w&&(B=[u+w+v-u,u+w+1+v-u,u+w+1,u+w],c.addFace(B)),w===s-4))B=[u+w+
2,u+w+3,u+w+3+v-u,u+w+2+v-u],c.addFace(B);n++}}c.calcFaceNormals();c.triangulateQuads();c.calcNormals();c.compile();return c}};return{GML:v}});
CubicVR.RegisterModule("PDF",function(){function m(m,r){var l=m;"string"===typeof m&&(l={url:m});var o=new XMLHttpRequest;o.open("GET",l.url);var q=l.headers;if(q)for(var f in q)"undefined"!==typeof q[f]&&o.setRequestHeader(f,l.headers[f]);o.mozResponseType=o.responseType="arraybuffer";q=l.url.substring(0,l.url.indexOf(":")+1);o.expected=-1<["http:","https:",""].indexOf(q)?200:0;"progress"in l&&(o.onprogress=l.progress||void 0);var e=!1;"error"in l&&(o.onerror=function(){if(!e){e=true;l.error()}});
o.onreadystatechange=function(d){if(o.readyState===4)if(o.status===o.expected)r(o.mozResponseArrayBuffer||o.mozResponse||o.responseArrayBuffer||o.response);else if(l.error&&!e){e=true;l.error(d)}};o.send(null)}return{PDF:function(v){if(!v.src)throw"PDF Error: you must specify a src url for a PDF.";var r=v.src,l=v.callback||function(){},o,q=[],f=[];this.__defineGetter__("pages",function(){return o?o.numPages:0});this.getPage=function(e){var d=o.numPages,e=1>e?1:e;return q[(e>d?d:e)-1]};this.getPageTexture=
function(e,d,b){var e=this.getPage(e),f=e.getViewport(1),d=d||f.width,b=b||f.height;return new CubicVR.PdfTexture(e,{width:d,height:b,viewport:f})};m({url:r,progress:function(){},error:function(){console.log("PDF Error: error loading pdf `"+r+"`")}},function(e){PDFJS.getDocument({data:e}).then(function(d){function b(){e++>=d.numPages?l():d.getPage(e).then(function(a){q.push(a);f.push(a);b()})}o=d;var e=0;b()},function(d,b){console.warn(d,b);l()})})}}});
CubicVR.RegisterModule("Particles",function(m){function v(l,m,f,e,d,b,n){l&&(this.last_particle=this.particles=null,this.pTex=f!==r?f:null,this.vWidth=e,this.vHeight=d,this.alpha=b!==r?b:!1,this.alphaCut=n!==r?n:0,this.pfunc=function(a,b){var d=b-a.start_time;if(0>d)return 0;if(d>a.life_time&&a.life_time)return-1;a.pos[0]=a.startpos[0]+d*a.velocity[0]+d*d*a.accel[0];a.pos[1]=a.startpos[1]+d*a.velocity[1]+d*d*a.accel[1];a.pos[2]=a.startpos[2]+d*a.velocity[2]+d*d*a.accel[2];null!==this.pgov&&this.pgov(a,
b);return 1},this.pgov=null,this.hasColor=m===r?!1:m,f=null!==this.pTex,this.vs=["#ifdef GL_ES\nprecision mediump float;\n#endif\nattribute vec3 aVertexPosition;",this.hasColor?"attribute vec3 aColor;":"","uniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nvarying vec4 color;\nvarying vec2 screenPos;",f?"varying float pSize;":"","void main(void) {\nvec4 position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);",f?"screenPos=vec2(position.x/position.w,position.y/position.w);":"","gl_Position = position;",
this.hasColor?"color = vec4(aColor.r,aColor.g,aColor.b,1.0);":"color = vec4(1.0,1.0,1.0,1.0);",f?"pSize=200.0/position.z;":"float pSize=200.0/position.z;","gl_PointSize = pSize;\n}"].join("\n"),this.fs=["#ifdef GL_ES\nprecision mediump float;\n#endif",f?"uniform sampler2D pMap;":"","varying vec4 color;",f?"varying vec2 screenPos;":"",f?"uniform vec3 screenDim;":"",f?"varying float pSize;":"","void main(void) {\nvec4 c = color;",f?"vec2 screen=vec2((gl_FragCoord.x/screenDim.x-0.5)*2.0,(gl_FragCoord.y/screenDim.y-0.5)*2.0);":
"",f?"vec2 pointCoord=vec2( ((screen.x-screenPos.x)/(pSize/screenDim.x))/2.0+0.5,((screen.y-screenPos.y)/(pSize/screenDim.y))/2.0+0.5);":"",f?"vec4 tc = texture2D(pMap,pointCoord); gl_FragColor = vec4(c.rgb*tc.rgb,1.0);":"gl_FragColor = c;","}"].join("\n"),this.maxPoints=l,this.numParticles=0,this.arPoints=new Float32Array(3*l),this.glPoints=null,m&&(this.arColor=new Float32Array(3*l),this.glColor=null),this.shader_particle=new CubicVR.Shader(this.vs,this.fs),this.shader_particle.use(),this.shader_particle.addVertexArray("aVertexPosition",
0),this.hasColor&&this.shader_particle.addVertexArray("aColor"),this.shader_particle.addMatrix("uMVMatrix"),this.shader_particle.addMatrix("uPMatrix"),null!==this.pTex&&(this.shader_particle.addInt("pMap",0),this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",[e,d,0])),this.genBuffer())}var r=m.undef,l=m.GLCore;v.prototype={resizeView:function(l,m){this.vWidth=l;this.vHeight=m;null!==this.pTex&&(this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",
[l,m,0]))},addParticle:function(l){null===this.last_particle?this.particles=l:this.last_particle.nextParticle=l;this.last_particle=l},genBuffer:function(){var o=l.gl;this.glPoints=o.createBuffer();o.bindBuffer(o.ARRAY_BUFFER,this.glPoints);o.bufferData(o.ARRAY_BUFFER,this.arPoints,o.DYNAMIC_DRAW);this.hasColor&&(this.glColor=o.createBuffer(),o.bindBuffer(o.ARRAY_BUFFER,this.glColor),o.bufferData(o.ARRAY_BUFFER,this.arColor,o.DYNAMIC_DRAW))},updatePoints:function(){var o=l.gl;o.bindBuffer(o.ARRAY_BUFFER,
this.glPoints);o.bufferData(o.ARRAY_BUFFER,this.arPoints,o.DYNAMIC_DRAW)},updateColors:function(){var o=l.gl;this.hasColor&&(o.bindBuffer(o.ARRAY_BUFFER,this.glColor),o.bufferData(o.ARRAY_BUFFER,this.arColor,o.DYNAMIC_DRAW))},draw:function(o,m,f){var e=l.gl;this.shader_particle.use();null!==this.pTex&&this.pTex.use(e.TEXTURE0);this.shader_particle.setMatrix("uMVMatrix",o);this.shader_particle.setMatrix("uPMatrix",m);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);e.bindBuffer(e.ARRAY_BUFFER,this.glPoints);
e.vertexAttribPointer(this.shader_particle.uniforms.aVertexPosition,3,e.FLOAT,!1,0,0);e.enableVertexAttribArray(this.shader_particle.uniforms.aVertexPosition);this.hasColor&&(e.bindBuffer(e.ARRAY_BUFFER,this.glColor),e.vertexAttribPointer(this.shader_particle.uniforms.aColor,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(this.shader_particle.uniforms.aColor));if(f!==r){this.numParticles=0;if(null===this.particles){e.disable(e.BLEND);return}for(var o=this.particles,m=null,d=0;null!==o;){var b=3*this.numParticles,
n=this.pfunc(o,f);if(1===n){if(this.arPoints[b]=o.pos[0],this.arPoints[b+1]=o.pos[1],this.arPoints[b+2]=o.pos[2],null!==o.color&&this.arColor!==r&&(this.arColor[b]=o.color[0],this.arColor[b+1]=o.color[1],this.arColor[b+2]=o.color[2]),this.numParticles++,d++,this.numParticles===this.maxPoints)break}else-1===n?null!==m&&(m.nextParticle=o.nextParticle):0===n&&d++;m=o;o=o.nextParticle}d||(this.last_particle=this.particles=null);this.updatePoints();this.hasColor&&this.updateColors()}this.alpha&&(e.enable(e.BLEND),
e.enable(e.DEPTH_TEST),e.depthMask(0),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_COLOR));e.drawArrays(e.POINTS,0,this.numParticles);this.alpha&&(e.disable(e.BLEND),e.depthMask(1),e.blendFunc(e.ONE,e.ONE));this.hasColor&&e.disableVertexAttribArray(this.shader_particle.uniforms.aColor)}};return{ParticleSystem:v,Particle:function(l,m,f,e,d){this.startpos=new Float32Array(l);this.pos=new Float32Array(l);this.velocity=new Float32Array(e!==r?e:[0,0,0]);this.accel=new Float32Array(d!==r?d:[0,0,0]);this.start_time=
m!==r?m:0;this.life_time=f!==r?f:0;this.nextParticle=this.color=null}}});
CubicVR.RegisterModule("Lines",function(m){function v(l){l=l||{};this.color=l.color||[1,1,1];this.maxPoints=l.maxPoints||1024;this.vs="#ifdef GL_ES\nprecision mediump float;\n#endif\nattribute vec3 aVertexPosition;\nuniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nvoid main(void) {\nvec4 position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);\ngl_Position = position;\n}";this.fs="#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform vec3 color;\nvoid main(void) {\nvec4 c = vec4(color,1.0);\ngl_FragColor = c;\n}";this.arLines=
new Float32Array(6*this.maxPoints);this.glLines=null;this.lineLength=0;this.shader_line=new CubicVR.Shader(this.vs,this.fs);this.shader_line.use();this.shader_line.addVertexArray("aVertexPosition",0);this.shader_line.addVector("color",this.color);this.shader_line.addMatrix("uMVMatrix");this.shader_line.addMatrix("uPMatrix");this.genBuffer();this.newSegment=!1}var r=m.GLCore;v.prototype={genBuffer:function(){var l=r.gl;this.glLines=l.createBuffer();l.bindBuffer(l.ARRAY_BUFFER,this.glLines);l.bufferData(l.ARRAY_BUFFER,
this.arLines,l.DYNAMIC_DRAW)},update:function(){var l=r.gl;l.bindBuffer(l.ARRAY_BUFFER,this.glLines);l.bufferData(l.ARRAY_BUFFER,this.arLines,l.DYNAMIC_DRAW)},addPoint:function(l){var m=this.lineLength;1<m&&(this.arLines[3*m]=this.arLines[3*(m-1)],this.arLines[3*m+1]=this.arLines[3*(m-1)+1],this.arLines[3*m+2]=this.arLines[3*(m-1)+2],this.lineLength++,m++);this.arLines[3*m]=l[0];this.arLines[3*m+1]=l[1];this.arLines[3*m+2]=l[2];this.lineLength++},addSegment:function(l){var m=this.lineLength;this.arLines[3*
m]=l[0];this.arLines[3*m+1]=l[1];this.arLines[3*m+2]=l[2];this.lineLength++},clear:function(){this.lineLength=0},render:function(l){var m=r.gl,q=l.mvMatrix,l=l.pMatrix;this.shader_line.use();this.shader_line.setMatrix("uMVMatrix",q);this.shader_line.setMatrix("uPMatrix",l);this.shader_line.setVector("color",this.color);m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null);m.bindBuffer(m.ARRAY_BUFFER,this.glLines);m.vertexAttribPointer(this.shader_line.uniforms.aVertexPosition,3,m.FLOAT,!1,0,0);m.enableVertexAttribArray(this.shader_line.uniforms.aVertexPosition);
m.drawArrays(m.LINES,0,this.lineLength)}};return{Lines:v}});
CubicVR.RegisterModule("HeightField",function(m){var v=m.undef,r=m.enums;r.heightfield={brush:{SINE:0,SQUARE:1},op:{ADD:0,REPLACE:1,SUBTRACT:2}};var l=function(f){f=f||{};this.operation=m.parseEnum(r.draw.op,f.operation||f.op)||r.draw.op.REPLACE;this.brushType=m.parseEnum(r.draw.brush,f.brushType)||r.draw.brush.SINE;this.brushSize=f.size||5;this.strength=f.strength||1};l.prototype={setOperation:function(f){this.operation=m.parseEnum(r.draw.op,f)},getOperation:function(){return this.operation},setBrushType:function(f){this.brushType=
m.parseEnum(r.draw.brush,f)||r.draw.brush.SINE},getBrushType:function(){return this.brushType},setSize:function(f){this.brushSize=f},getSize:function(){return this.brushSize},setStrength:function(f){this.strength=f},getStrength:function(){return this.strength}};var o=function(f){f=f||{};this.divX=f.divX||null;this.divZ=f.divZ||null;this.size=f.size||null;this.cellSize=this.sizeZ=this.sizeX=this.cellSize=this.hfFloatBuffer=this.hfUInt8Buffer=this.hfBuffer=null;this.ofsX=f.ofsX||-this.cellSize/2;this.ofsZ=
f.ofsZ||-this.cellSize/2;this.divX&&(this.divZ&&this.size)&&this.initBuffer(this.divX,this.divZ,this.size);this.areaBuffered=!1;this.drawArea={startX:0,startZ:0,endX:0,endZ:0}};o.prototype={initBuffer:function(f,e,d){this.hfBuffer=new ArrayBuffer(4*f*e);this.hfUInt8Buffer=new Uint8Array(this.hfBuffer);this.hfFloatBuffer=new Float32Array(this.hfBuffer);this.divX=f||null;this.divZ=e||null;this.size=d||null;this.divX>this.divZ?(this.sizeX=d,this.sizeZ=d/this.divX*this.divZ):(this.sizeX=this.divZ>this.divX?
d/this.divZ*this.divX:d,this.sizeZ=d);this.drawBuffer=[];this.cellSize=this.sizeX/this.divX;this.startX=-(this.sizeX/2)+this.ofsX;this.startZ=-(this.sizeZ/2)+this.ofsZ},setBrush:function(f){this.brush=f},getBrush:function(){return this.brush},draw:function(f,e,d){var b=this.brush||d,d=b.getOperation(),n=b.getSize(),a=b.getBrushType(),b=b.getStrength();if(this.areaBuffered){var c=f-n,g=e-n,h=f+n,l=e+n;c<this.drawArea.startX&&(this.drawArea.startX=c);g<this.drawArea.startZ&&(this.drawArea.startZ=g);
h>this.drawArea.endX&&(this.drawArea.endX=h);h>this.drawArea.endX&&(this.drawArea.endZ=l)}else this.drawArea={startX:f-n,startZ:e-n,endX:f+n,endZ:e+n},this.areaBuffered=!0;this.drawBuffer.push([f,e,d,n,a,b])},getDrawArea:function(){return!this.areaBuffered?!1:this.drawArea},clearDrawArea:function(){this.areaBuffered=!1},flush:function(){if(!this.drawBuffer.length)return!1;for(;this.drawBuffer.length;){var f=this.drawBuffer.pop();this.drawFunc(f[0],f[1],f[2],f[3],f[4],f[5])}return!0},needsFlush:function(){return 0!==
this.drawBuffer.length},drawFunc:function(f,e,d,b,n,a){for(var d=this.hfFloatBuffer,n=this.divX,c=this.divZ,b=b/this.cellSize,f=(f-this.startX)/this.cellSize,e=(e-this.startZ)/this.cellSize,g=parseInt(Math.floor(f-b),10),h=parseInt(Math.ceil(f+b),10);g<h;g++)for(var l=g-f,m=parseInt(Math.floor(e-b),10),o=parseInt(Math.ceil(e+b),10);m<o;m++)if(!(0>g||g>=n||0>m||m>=c)){var s=m-e,s=a*((1-Math.sqrt(l*l+s*s)/b)/2);0>s&&0<=a&&(s=0);0<s&&0>=a&&(s=0);d[m*n+g]+=s}},getUint8Buffer:function(){return this.hfUInt8Buffer},
getFloat32Buffer:function(){return this.hfFloatBuffer},getDivX:function(){return this.divX},getDivZ:function(){return this.divZ},getSizeX:function(){return this.sizeX},getSizeZ:function(){return this.sizeZ},getStartX:function(){return this.startX},getStartZ:function(){return this.startZ},getCellSize:function(){return this.cellSize},getSize:function(){return this.size},setRect:function(f){var f=f||{},e=f.value||0,d=f.src||f.func||null,b=f.startX||0,n=f.startZ||0,a=f.walkX,c=f.walkZ,f=this.hfFloatBuffer,
g,h=this.startX,l=this.startZ;if(b!==v&&n!==v&&a!==v&&c!==v){if(!(b>=this.divX)&&!(n>=this.divZ)&&(b+a>=this.divX&&(a=this.divX-1-b),n+c>=this.divZ&&(c=this.divZ-1-n),!(0>=a||0>=c))){g=b;for(b+=a;g<b;g++)for(var a=n,m=n+c;a<m;a++){var o=g+a*this.divX;f[o]=null===d?e:d(this.cellSize*g+h,this.cellSize*a+l,o)}}}else{g=0;for(b=this.hfFloatBuffer.length;g<b;g++)null===d?f[g]=e:(n=d(g%this.divX*this.cellSize+h,Math.floor(g/this.divX)*this.cellSize+l,g),f[g]=n)}},getIndicesAt:function(f,e){if("object"===
typeof f)return this.getIndicesAt(f[0],f[2]);var d=this.startX,b=this.startZ,n=Math.floor((f-d)/this.cellSize),a=Math.floor((e-b)/this.cellSize);if(0>n||n>=this.divX-1||0>a||a>=this.divZ-1)return-1;if(1<=Math.abs(e-((a+1)*this.cellSize+b))/Math.abs(f-(n*this.cellSize+d)))return d=[n+(a+1)*this.divX,n+1+a*this.divX,n+a*this.divX],[n,a,d,0];d=[n+(a+1)*this.divX,n+1+(a+1)*this.divX,n+1+a*this.divX];return[n,a,d,1]},getHeightValue:function(f,e){var d=m.triangle;if("object"===typeof f)return this.getHeightValue(f[0],
f[2]);var b=this.getIndicesAt(f,e);if(-1===b)return 0;var n=b[2],a=b[0]*this.cellSize+this.startX,c=b[1]*this.cellSize+this.startZ,g;g=0===b[3]?d.normal([a,this.hfFloatBuffer[n[0]],c+this.cellSize],[a+this.cellSize,this.hfFloatBuffer[n[1]],c],[a,this.hfFloatBuffer[n[2]],c]):d.normal([a,this.hfFloatBuffer[n[0]],c+this.cellSize],[a+this.cellSize,this.hfFloatBuffer[n[1]],c+this.cellSize],[a+this.cellSize,this.hfFloatBuffer[n[2]],c]);d=g[0];b=g[1];g=g[2];n=[a,this.hfFloatBuffer[n[0]],c+this.cellSize];
return(d*f+g*e+(-(d*n[0])-b*n[1]-g*n[2]))/-b},rayIntersect:function(f,e){var d=f.slice(0),b=this.startX,n=this.startZ,a=this.startX+this.sizeX,c=this.startZ+this.sizeZ,g=this.cellSize,h=m.vec2,l=m.vec3,o=l.normalize(e),q=[o[0],o[2]],s=[d[0],d[2]];if(d[0]<b||d[0]>a||d[2]<n||d[2]>c){var r=[[b,n],[a,n],[b,c],[a,c]],A=[];d[0]>=a&&A.push([r[1],r[3]]);d[0]<=b&&A.push([r[0],r[2]]);d[2]>=c&&A.push([r[2],r[3]]);d[2]<=n&&A.push([r[0],r[1]]);if(0!==A.length){d=[];a=0;for(c=A.length;a<c;a++)r=h.lineIntersect(s,
h.add(s,q),A[a][0],A[a][1]),!1!==r&&h.onLine(A[a][0],A[a][1],r)&&d.push(r);r=0;A=-1;a=0;for(c=d.length;a<c;a++){var v=h.length(d[a],s);0===a?(r=v,A=0):v<r&&(A=a,r=v)}if(-1!=A){if(u=r/h.length(q),d=[d[A][0],0,d[A][1]],d[1]=f[1]+o[1]*u,d[1]<=this.getHeightValue(d[0],d[2]))return!1}else return!1}s=[d[0],d[2]]}r=Math.floor((s[0]-b)/g);c=Math.floor((s[1]-n)/g);A=s[0]-(b+r*g);a=s[1]-(n+c*g);a=A<a?A/Math.abs(q[0]):a/Math.abs(q[1]);0===a?(A=s[0],a=s[1]):(A=s[0]+a*q[0],a=s[1]+a*q[1]);for(var r=A-(b+r*g),v=
a-(n+c*g),c=0<=q[0]?r:g-r,r=0<=q[1]?v:g-v,v=this.getFloat32Buffer(),B,u;;){var x=(g-c)/Math.abs(q[0]),y=(g-r)/Math.abs(q[1]),x=x<y?x:y;B=q[0]*x;var D=q[1]*x,c=c+Math.abs(B),r=r+Math.abs(D),x=(A+(A+B))/2,y=(a+(a+D))/2,A=A+B,a=a+D,x=Math.floor((x-b)/g),y=Math.floor((y-n)/g);if(c>=g)for(;c>=g;)c-=g;if(r>=g)for(;r>=g;)r-=g;u=h.length(s,[A,a])/h.length(q);B=h.length(s,[A-B,a-D])/h.length(q);u=d[1]+o[1]*u;B=d[1]+o[1]*B;if(x>this.divX||0>x||y>this.divZ||0>y)return!1;var D=v[y*this.divX+x],C=v[y*this.divX+
x+1],E=v[(y+1)*this.divX+x],z=v[(y+1)*this.divX+x+1];if(0>=u-D||0>=u-C||0>=u-E||0>=u-z||0>=B-D||0>=B-C||0>=B-E||0>=B-z){C=[x+(y+1)*this.divX,x+1+y*this.divX,x+y*this.divX];D=[x+(y+1)*this.divX,x+1+(y+1)*this.divX,x+1+y*this.divX];u=b+g*x;B=n+g*y;tmpNormA=m.triangle.normal([u,v[C[0]],B+g],[u+g,v[C[1]],B],[u,v[C[2]],B]);tmpNormB=m.triangle.normal([u,v[D[0]],B+g],[u+g,v[D[1]],B+g],[u+g,v[D[2]],B]);C=l.linePlaneIntersect(tmpNormA,[u,v[C[0]],B+g],d,l.add(d,o));x=Math.abs(n+(y+1)*g-C[0])/Math.abs(b+x*g-
C[2]);if(1<=x&&C[0]>=u-1.0E-8&&C[0]<=u+g+1.0E-8&&C[2]>=B-1.0E-8&&C[2]<=B+1.0E-8+g)return C;y=l.linePlaneIntersect(tmpNormB,[u,v[D[0]],B+g],d,l.add(d,o));if(1>x&&y[0]>=u-1.0E-8&&y[0]<=u+g+1.0E-8&&y[2]>=B-1.0E-8&&y[2]<=B+g+1.0E-8)return y}}}};var q=m.extendClassGeneral(m.Mesh,function(f){f=f||{};f.dynamic=!0;f.buildWireframe=!0;this.material=f.material;this._update=m.Mesh.prototype.update;m.Mesh.apply(this,[f]);this.hField=f.hField||null;this.divX=f.divX||null;this.divZ=f.divZ||null;this.viewX=f.viewX||
0;this.viewZ=f.viewZ||0;this.ofsX=f.ofsX||0;this.ofsZ=f.ofsZ||0;this.edgeX=f.edgeX||0;this.edgeZ=f.edgeZ||0;this.normalBuffer=[];this.genHeightfieldMesh()},{setIndexedHeight:function(f,e,d){this.points[f+e*this.divX][1]=d},genHeightfieldMesh:function(){var f,e,d=this.divX+this.edgeX,b=this.divZ+this.edgeZ,n=this.hField.getCellSize(),a=n*this.divX;f=n*this.divZ;0!==this.points.length&&this.clean();var c=-(f/2);for(e=0;e<b;e++){var g=-(a/2);for(f=0;f<d;f++)this.addPoint([g+this.ofsX,0,c+this.ofsZ]),
g+=n;c+=n}this.setFaceMaterial(this.material);f=-1/(d-1);e=1/(b-1);for(a=c=0;a<b-1;a++){g=1;for(n=0;n<d-1;n++)f1=this.addFace([n+(a+1)*d,n+1+a*d,n+a*d]),f2=this.addFace([n+(a+1)*d,n+1+(a+1)*d,n+1+a*d]),this.faces[f1].uvs=[[g,c+e],[g+f,c],[g,c]],this.faces[f2].uvs=[[g,c+e],[g+f,c+e],[g+f,c]],g+=f;c+=e}},recalcNormals:function(f){var e;if(f=f||this.normalMapRef){var f=this.divX+this.edgeX,d=this.divZ+this.edgeZ;if(!this.normalBuffer.length){for(e=0;e<this.points.length;e++)this.normalBuffer.push([0,
1,0]);var b=0;for(e=0;e<d-1;e++)for(k=0;k<f-1;k++)this.faces[b++].point_normals=[this.normalBuffer[k+(e+1)*f],this.normalBuffer[k+1+e*f],this.normalBuffer[k+e*f]],this.faces[b++].point_normals=[this.normalBuffer[k+(e+1)*f],this.normalBuffer[k+1+(e+1)*f],this.normalBuffer[k+1+e*f]]}d=this.hField;b=d.getFloat32Buffer();e=this.viewX||0;var n=(this.viewZ||0)*d.getDivX()+e;for(e=0;e<this.points.length;e++){var a=e%f,c=Math.floor(e/f),g=n+a+(c-1)*d.getDivX(),h=n+a+(c+1)*d.getDivX(),l=n+(a+1)+c*d.getDivX(),
o=n+(a-1)+c*d.getDivX(),a=n+a+c*d.getDivX(),g=b[g],h=b[h],l=b[l],o=b[o],a=b[a];g===v&&(g=a);h===v&&(h=a);l===v&&(l=a);o===v&&(o=a);o=m.vec3.normalize([(l-a+(a-o))/2,2,(g-a+(a-h))/2]);this.normalBuffer[e][0]=o[0];this.normalBuffer[e][1]=o[1];this.normalBuffer[e][2]=o[2]}return this}},update:function(){var f=this.viewX||0,e=this.viewZ||0,d=this.divX+this.edgeX,b=this.divZ+this.edgeZ,n=this.hField.getDivX();this.hField.getDivZ();for(var a=this.hField.getFloat32Buffer(),c=e,b=e+b;c<b;c++)for(var g=f,
h=f+d;g<h;g++)this.points[(c-e)*d+(g-f)][1]=a[c*n+g];this._update()}});return{HeightField:o,HeightFieldBrush:l,HeightFieldMesh:q}});
CubicVR.RegisterModule("Landscape",function(m){var v=m.undef,r=Math.PI/2;return{Landscape:m.extendClassGeneral(m.SceneObject,function(){if(1<arguments.length)this.hField=new m.HeightField({size:arguments[0],divX:arguments[1],divZ:arguments[2]}),this.hfMesh=new m.HeightFieldMesh({hField:this.hField,size:arguments[0],divX:arguments[1],divZ:arguments[2],material:arguments[3],ofsX:this.hField.getCellSize()/2,ofsZ:this.hField.getCellSize()/2}),this.hfMesh.prepare(),m.SceneObject.apply(this,[{mesh:this.hfMesh,
shadowCast:!1}]);else{var l=arguments[0]||{};this.size=l.size||128;this.divX=l.divX||128;this.divZ=l.divZ||128;this.tiles=[];this.tileMeshes=[];this.tileMaterials=[];this.tileSpats=[];this.tileX=l.tileX||this.divX;this.tileZ=l.tileZ||this.divZ;this.tileChanged=[];this.tileSpatChanged=[];this.hField=new m.HeightField({size:this.size,divX:this.divX,divZ:this.divZ});this.divX>this.divZ?(this.sizeX=this.size,this.sizeZ=this.size/this.divX*this.divZ):(this.sizeX=this.divZ>this.divX?this.size/this.divZ*
this.divX:this.size,this.sizeZ=this.size);this.cellSize=this.sizeX/this.divX;this.tileSize=this.cellSize*this.tileX;this.spatResolution=l.spatResolution||256;this.spats=l.spats||[];this.sourceSpats=this.spats.slice(0);m.SceneObject.apply(this,[{mesh:null,shadowCast:!1}]);for(var o=0,q=0,f=0;f<this.divZ;f+=this.tileZ){for(var e=o=0;e<this.divX;e+=this.tileX){var d=new m.DrawBufferTexture({width:this.spatResolution,height:this.spatResolution}),b=e+1!=this.tileX?1:0,n=f+1!=this.tileZ?1:0,a=new m.SpatMaterial({color:[1,
1,1],specular:[0.05,0.05,0.05],spats:this.sourceSpats,sourceTexture:d,spatResolution:this.spatResolution,spatOffset:[this.divX/(this.divX+b),this.divZ/(this.divZ+n),1]}),b=new m.HeightFieldMesh({hField:this.hField,size:this.tileSize,divX:this.tileX,divZ:this.tileZ,viewX:e,viewZ:f,edgeX:b,edgeZ:n,material:a});b.prepare();var n=new m.SceneObject({mesh:b}),c=this.hField.getStartX(),g=this.hField.getStartZ();n.position[0]=c+this.tileSize*o+this.tileSize/2;n.position[2]=g+this.tileSize*q+this.tileSize/
2;this.bindChild(n);this.tiles.push(n);this.tileMeshes.push(b);this.tileMaterials.push(a);this.tileSpats.push(d);this.tileChanged.push(!1);this.tileSpatChanged.push(!1);o++}q++}l.jsonData&&this.loadFromJSON(l,l.compress||!1)}},{loadFile:function(l){var m=new FileReader;m.onload=function(l){return function(f){f=JSON.parse(f.target.result);l.loadFromJSON(f,f.compress)}}(this);m.readAsText(l)},loadFromJSON:function(l,m){var m=m||l.compress,q=this.tileSpats,f=l.jsonData.tiles;if(m){l.jsonData.heightfield=
Iuppiter.decompress(Iuppiter.Base64.decode(Iuppiter.toByteArray(l.jsonData.heightfield),!0)).split(",");i=0;for(iMax=f.length;i<iMax;i++)f[i]=Iuppiter.decompress(Iuppiter.Base64.decode(Iuppiter.toByteArray(f[i]),!0)).split(",")}var e=this.hField.getUint8Buffer(),d=l.jsonData.heightfield;i=0;for(iMax=e.length;i<iMax;i++)e[i]=parseInt(d[i],10);i=0;for(iMax=f.length;i<iMax;i++){for(var e=f[i],d=q[i].getUint8Buffer(),b=0,n=e.length;b<n;b++)d[b]=parseInt(e[b],10);this.tileChanged[i]=!0;this.tileSpatChanged[i]=
!0}this.update()},saveToJSON:function(l,m){var l=l!==v?l:!0,m=m!==v?m:!1,q,f,e={divX:this.divX,divZ:this.divZ,tileX:this.tileX,tileZ:this.tileZ,spats:this.spats,spatResolution:this.spatResolution,compress:l,size:this.size,jsonData:{heightfield:[],tiles:[]}},d=this.hField.getUint8Buffer(),b=e.jsonData.heightfield;q=0;for(f=d.length;q<f;q++)b[q]=d[q];d=this.tileSpats;b=e.jsonData.tiles;q=0;for(f=d.length;q<f;q++){b[q]=[];for(var n=b[q],a=d[q].getUint8Buffer(),c=0,g=a.length;c<g;c++)n[c]=a[c]}if(l){e.jsonData.heightfield=
Iuppiter.Base64.encode(Iuppiter.compress(e.jsonData.heightfield.join(",")),!0);q=0;for(f=b.length;q<f;q++)e.jsonData.tiles[q]=Iuppiter.Base64.encode(Iuppiter.compress(b[q].join(",")),!0)}q=JSON.stringify(e);if(m)uriContent="data:text/x-download;charset=utf-8,"+encodeURIComponent(q),window.location.href=uriContent;else return q},update:function(){var l,m;this.hField.needsFlush()&&this.hField.flush();l=this.hField.getDrawArea();if(!1!==l){var q=this.getTileAt(l.startX-this.cellSize,l.startZ-this.cellSize,
l.endX-l.startX+this.cellSize,l.endZ-l.startZ,this.cellSize);!1!==q&&q.length===v&&(q=[q]);l=0;for(m=q.length;l<m;l++)this.tileChanged[q[l]]=!0;this.hField.clearDrawArea()}l=0;for(m=this.tiles.length;l<m;l++)if(this.tileChanged[l]&&(this.tileMeshes[l].update(),this.tileChanged[l]=!1),this.tileSpatChanged[l])this.tileSpats[l].update(),this.tileSpatChanged[l]=!1},getHeightField:function(){return this.hField},mapGen:function(l,m,q,f,e){this.hField.setRect({src:l,startX:m,startZ:q,walkX:f,walkZ:e});this.hfMesh.update()},
getFaceAt:function(l,m){return this.hField.getFaceAt([l,0,m])},getHeightValue:function(l,m){return this.hField.getHeightValue([l,0,m])},orient:function(l,m,q,f,e,d){d===v&&(d=0);var b,n,a=[];b=q/2;var c=f/2;n=Math.sqrt(c*c+b*b);c=Math.atan2(c,b);e*=Math.PI/180;b=l+Math.sin(e)*d;d=m+Math.cos(e)*d;a[0]=this.getHeightValue([b+n*Math.cos(-c-r+e),0,d+n*-Math.sin(-c-r+e)]);a[1]=this.getHeightValue([b+n*Math.cos(c-r+e),0,d+n*-Math.sin(c-r+e)]);a[2]=this.getHeightValue([b+n*Math.cos(-c+r+e),0,d+n*-Math.sin(-c+
r+e)]);a[3]=this.getHeightValue([b+n*Math.cos(c+r+e),0,d+n*-Math.sin(c+r+e)]);n=-Math.atan2(a[1]-a[2],q);d=-Math.atan2(a[0]-a[1],f);n+=-Math.atan2(a[0]-a[3],q);d+=-Math.atan2(a[3]-a[2],f);return[[l,(a[2]+a[3]+a[1]+a[0])/4,m],[n/2*(180/Math.PI),e,d/2*(180/Math.PI)]]},getTileAt:function(l,m,q,f){var q=q||0,f=f||0,e=this.hField.getStartX(),d=this.hField.getStartZ(),b=Math.floor(this.divX/this.tileX),n=Math.floor((l-e)/(this.tileX*this.tileSize)*this.tileX),a=Math.floor((m-d)/(this.tileZ*this.tileSize)*
this.tileZ),c=0;if(0===q&&0===f)return c=parseInt(n+a*b,10);l=Math.floor((l+q-e)/(this.tileX*this.tileSize)*this.tileX);m=Math.floor((m+f-d)/(this.tileZ*this.tileSize)*this.tileZ);for(f=[];a<=m;a++)for(d=n;d<=l;d++)c=a*(this.divX/this.tileX)+d,0<=c&&c<this.tiles.length&&f.push(c);return f},getSpatLocation:function(l,m,q){if(q===v)l=(1-(l/this.getHeightField().getSize()+0.5))*this.spatResolution*(this.divX/this.tileX)%this.spatResolution,m=(1-(m/this.getHeightField().getSize()+0.5))*this.spatResolution*
(this.divZ/this.tileZ)%this.spatResolution;else var f=this.divX/this.tileX,e=q%f,f=Math.floor(q/f),q=this.hField.getStartX(),f=this.hField.getStartZ()+f*this.tileSize,l=(1-(l-(q+e*this.tileSize))/this.tileSize)*this.spatResolution,m=(1-(m-f)/this.tileSize)*this.spatResolution;return{x:l,z:m}},drawSpat:function(l,m,q){var f=q.getSize()*(this.size/this.spatResolution),e=l-f/2,d=m-f/2,f=this.getTileAt(e,d,l+f/2-e,m+f/2-d);!1!==f&&f.length===v&&(f=[f]);if(!1!==f){e=0;for(d=f.length;e<d;e++){var b=f[e],
n=this.getSpatLocation(l,m,b);0<=b&&b<this.tileSpats.length&&(this.tileSpats[b].draw(n.x,n.z,q),this.tileSpatChanged[b]=!0)}}}})}});
CubicVR.RegisterModule("SpatMaterial",function(m){var v=m.undef,r;return{SpatMaterial:m.extendClassGeneral(m.Material,function(l){l=l||{};r||(r=new m.Texture);this.spats=l.spats||[r,r,r,r,r];this.sourceTex=l.sourceTexture||r;this.spatResolution=l.spatResolution||256;this.spatTexel=1/this.spatResolution;var o=this.spats,q;for(q in o){var f=o[q];"string"===typeof f&&(o[q]=m.Textures_ref[f]!==v?m.Textures_obj[m.Textures_ref[f]]:new m.Texture(f))}this.spatOffset=l.spatOffset||[1,1,1];this.spatShader=
new m.CustomShader({vertex:"void main(void) {\n  vertexTexCoordOut = cubicvr_texCoord();\n  gl_Position =  matrixProjection * matrixModelView * cubicvr_transform();\n  #if !LIGHT_DEPTH_PASS  // not needed if shadowing \n    vertexNormalOut = matrixNormal * cubicvr_normal();\n    cubicvr_lighting();\n  #endif // !LIGHT_DEPTH_PASS \n}",fragment:"uniform sampler2D spatImage;\nuniform sampler2D spat0;\nuniform sampler2D spat1;\nuniform sampler2D spat2;\nuniform sampler2D spat3;\nuniform sampler2D spat4;\nuniform vec3 spatOffset;\nuniform float spatTexel;\nvoid main(void) \n{  \nvec2 texCoord = cubicvr_texCoord();\nvec2 spatTexCoord = texCoord*30.0;\nvec4 color = texture2D(spat0,spatTexCoord);\nvec2 spatSourceCoord = vec2(texCoord.x*spatOffset.x,texCoord.y*spatOffset.y);\nif (spatSourceCoord.s<=spatTexel/2.0) {\n   spatSourceCoord.s=spatTexel/2.0;\n}\nif (spatSourceCoord.s>=1.0-spatTexel/2.0) {\n   spatSourceCoord.s=1.0-spatTexel/2.0;\n}\nif (spatSourceCoord.t<=spatTexel/2.0) {\n   spatSourceCoord.t=spatTexel/2.0;\n}\nif (spatSourceCoord.t>=1.0-spatTexel/2.0) {\n   spatSourceCoord.t=1.0-spatTexel/2.0;\n}\nvec4 spatSource = texture2D(spatImage,spatSourceCoord);\ncolor = mix(color,texture2D(spat1,spatTexCoord),spatSource.r);\ncolor = mix(color,texture2D(spat2,spatTexCoord),spatSource.g);\ncolor = mix(color,texture2D(spat3,spatTexCoord),spatSource.b);\ncolor = mix(color,texture2D(spat4,spatTexCoord),spatSource.a);\nvec3 normal = cubicvr_normal(texCoord);\ncolor = cubicvr_environment(color,normal,texCoord);\ncolor = cubicvr_lighting(color,normal,texCoord);\ngl_FragColor = clamp(color,0.0,1.0);\n}",
init:function(){},update:function(e){return function(d,b){var f=b.textureIndex;d.spatImage.set(f++,e.sourceTex);d.spatOffset.set(e.spatOffset);d.spatTexel.set(e.spatTexel);o[0]&&d.spat0.set(f++,o[0]);o[1]&&d.spat1.set(f++,o[1]);o[2]&&d.spat2.set(f++,o[2]);o[3]&&d.spat3.set(f++,o[3]);o[4]&&d.spat4.set(f++,o[4])}}(this)});l.shader=this.spatShader;m.Material.apply(this,[l])},{setSpats:function(l){this.spats=l},getSpats:function(){return this.spats},setSource:function(l){this.sourceTexture=l}})}});
CubicVR.RegisterModule("Octree",function(m){function v(f,e){return f[0]*e[0]+f[1]*e[1]+f[2]*e[2]}m=m.enums;m.octree={T_NW:0,T_NE:1,T_SE:2,T_SW:3,B_NW:4,B_NE:5,B_SE:6,B_SW:7};var r=[[1,0,0],[0,1,0],[0,0,1]],l={engulf:function(f,e){f[0][0]>e[0]&&(f[0][0]=e[0]);f[0][1]>e[1]&&(f[0][1]=e[1]);f[0][2]>e[2]&&(f[0][2]=e[2]);f[1][0]<e[0]&&(f[1][0]=e[0]);f[1][1]<e[1]&&(f[1][1]=e[1]);f[1][2]<e[2]&&(f[1][2]=e[2])},reset:function(f,e){void 0===e&&(e=[0,0,0]);f[0][0]=e[0];f[0][1]=e[1];f[0][2]=e[2];f[1][0]=e[0];
f[1][1]=e[1];f[1][2]=e[2]},size:function(f){return[f[0][0]<f[1][0]?f[1][0]-f[0][0]:f[0][0]-f[1][0],f[0][1]<f[1][1]?f[1][1]-f[0][1]:f[0][1]-f[1][1],f[0][2]<f[1][2]?f[1][2]-f[0][2]:f[0][2]-f[1][2]]},containsPoint:function(f,e){return e[0]<=f[1][0]&&e[1]<=f[1][1]&&e[2]<=f[1][2]&&e[0]>=f[0][0]&&e[1]>=f[0][1]&&e[2]>=f[0][2]},overlaps:function(f,e){for(var d=0;3>d;++d){var b=v(f[0],r[d]),n=1E18,a=-1E15,b=v([e[0][0],e[0][1],e[0][2]],r[d]),n=b<n?b:n,a=b>a?b:a,b=v([e[1][0],e[0][1],e[0][2]],r[d]),n=b<n?b:n,
a=b>a?b:a,b=v([e[0][0],e[1][1],e[0][2]],r[d]),n=b<n?b:n,a=b>a?b:a,b=v([e[1][0],e[1][1],e[0][2]],r[d]),n=b<n?b:n,a=b>a?b:a,b=v([e[0][0],e[0][1],e[1][2]],r[d]),n=b<n?b:n,a=b>a?b:a,b=v([e[1][0],e[0][1],e[1][2]],r[d]),n=b<n?b:n,a=b>a?b:a,b=v([e[0][0],e[1][1],e[1][2]],r[d]),n=b<n?b:n,a=b>a?b:a,b=v([e[1][0],e[1][1],e[1][2]],r[d]),n=b<n?b:n,a=b>a?b:a,b=v(f[0],r[d]),c=v(f[1],r[d]);if(n>c||a<b)return!1}return!0},intersectsAABB:function(f,e){return l.containsPoint(f,e[0])||l.containsPoint(f,e[1])?!0:l.overlaps(f,
e)||l.overlaps(e,f)}},o=function(f){f=f||{};this.position=f.position||[0,0,0];this.size=f.size||0;this.depth=f.depth||0;this.nodes=[];this.children=[];this.root=f.root;this.hSize=this.size/2;this.aabb=[[this.position[0]-this.hSize,this.position[1]-this.hSize,this.position[2]-this.hSize],[this.position[0]+this.hSize,this.position[1]+this.hSize,this.position[2]+this.hSize]];this.dirty=!1;this.sphere=this.position.slice().concat(Math.sqrt(3*this.size/2*this.size/2));this.that=this};o.prototype={numChildren:function(){for(var f=
0,e=0;8>e;++e)f+=this.children[e]?1:0;return f},$insertNode:function(f,e){this.nodes.push(f);f.addLeaf(this.that);f.rootTree=e;f.inserted(e)},remove:function(f){f=this.nodes.indexOf(f);-1<f&&this.nodes.splice(f,1)},insert:function(f){if(0===this.depth)this.$insertNode(f,this.that);else{var e=this.position,d=f.aabb,b=d[0],n=d[1],d=b[0]<e[0]&&b[1]<e[1]&&b[2]<e[2],a=n[0]>e[0]&&b[1]<e[1]&&b[2]<e[2],c=b[0]<e[0]&&n[1]>e[1]&&b[2]<e[2],g=n[0]>e[0]&&n[1]>e[1]&&b[2]<e[2],h=b[0]<e[0]&&b[1]<e[1]&&n[2]>e[2],l=
n[0]>e[0]&&b[1]<e[1]&&n[2]>e[2],m=b[0]<e[0]&&n[1]>e[1]&&n[2]>e[2],q=n[0]>e[0]&&n[1]>e[1]&&n[2]>e[2],b=0;if(d&&a&&c&&g&&h&&l&&m&&q)this.$insertNode(f,this.that);else{for(var n=this.size/2,s=this.size/4,r=e[0],A=e[1],e=e[2],e=[[d,0,[r-s,A-s,e-s]],[a,1,[r+s,A-s,e-s]],[c,4,[r-s,A+s,e-s]],[g,5,[r+s,A+s,e-s]],[h,3,[r-s,A-s,e+s]],[l,2,[r+s,A-s,e+s]],[m,7,[r-s,A+s,e+s]],[q,6,[r+s,A+s,e+s]]],d=0;8>d;++d)e[d][0]&&(this.children[e[d][1]]||(this.children[e[d][1]]=new o({size:n,depth:this.depth-1,root:this.that,
position:e[d][2]})),this.children[e[d][1]].insert(f),++b);if(1<b||!f.rootTree)f.rootTree=this.that}}},clean:function(){for(var f=0,e=0;8>e;++e)this.children[e]&&(this.children[e].clean()?this.children[e]=void 0:++f);return 0===this.nodes.length&&0===f?!0:!1}};var q=function(f){f=f||{};this.size=f.size||0;this.depth=f.depth||0;if(0>=this.size)throw Error("Octree needs a size > 0");if(0>=this.depth)throw Error("Octree needs a depth > 0");this.root=new o({size:this.size,depth:this.depth});this.hitTagCounter=
0};q.prototype={get_frustum_hits:function(f){var e=[],d=this.hitTagCounter++,b=[],n,a;for(b.push(this.root);b.length;){var c=b.pop();if(c&&(-1!=f.frustum.contains_box(c.aabb)||l.containsPoint(c.aabb,f.position))){var g=c.nodes;if(g&&g.length){n=0;for(a=g.length;n<a;n++){var h=g[n],m=h.object;h.hitTag!=d&&(-1!=f.frustum.contains_box(m.getAABB())&&e.push(m),h.hitTag=d)}}n=0;for(a=c.children.length;n<a;n++)b.push(c.children[n])}}return e},get_aabb_hits:function(f){var e=[],d=this.hitTagCounter++,b=[],
n,a;for(b.push(this.root);b.length;){var c=b.pop();if(c&&l.overlaps(c.aabb,f)){var g=c.nodes;if(g&&g.length){n=0;for(a=g.length;n<a;n++){var h=g[n],m=h.object;h.hitTag!=d&&(l.overlaps(m.getAABB(),f)&&e.push(m),h.hitTag=d)}}n=0;for(a=c.children.length;n<a;n++)b.push(c.children[n])}}return e},insert:function(f){this.root.insert(f)},clean:function(){this.root.clean()}};q.Node=function(f){var f=f||{},e=[],d=this,b,n=!0,a;this.type=f.type;this.object=f.object;this.rootTree=void 0;this.hitTag=0;this.inserted=
function(a){n=!1;f.inserted&&f.inserted(a)};Object.defineProperty(this,"aabb",{get:function(){return b},set:function(c){n=!0;b=c;a=[b[0][0]+(b[1][0]-b[0][0])/2,b[0][1]+(b[1][0]-b[0][1])/2,b[0][2]+(b[1][0]-b[0][2])/2]}});d.aabb=f.aabb||[[0,0,0],[0,0,0]];var c=a.slice();Object.defineProperty(this,"leaves",{get:function(){return e},set:function(){}});this.addLeaf=function(a){-1===e.indexOf(a)&&(e.push(a),a=a.aabb,l.engulf(c,a[0]),l.engulf(c,a[1]))};this.removeLeaf=function(a){a=e.indexOf(a);-1<a&&e.splice(a,
1)};this.destroy=function(){e=[];d.rootTree=void 0};this.removeSelf=function(){var a=this.aabb,b=this.rootTree.aabb,c=a[0],a=a[1],f=b[0],b=b[1];if(0<e.length&&(c[0]<f[0]||c[1]<f[1]||c[2]<f[2]||a[0]>b[0]||a[1]>b[1]||a[2]>b[2])){c=0;for(b=e.length;c<b;++c)e[c].remove(d)}};this.adjust=function(){if(n){var b=this.aabb,f=this.rootTree.aabb,m=b[0],o=b[1],q=f[0],f=f[1];if(0<e.length&&(m[0]<q[0]||m[1]<q[1]||m[2]<q[2]||o[0]>f[0]||o[1]>f[1]||o[2]>f[2])){m=0;for(o=e.length;m<o;++m)e[m].remove(d);e=[];m=d.rootTree;
d.rootTree=void 0;if(m){for(;;)if(o=m.aabb,!l.containsPoint(o[0],b)||!l.containsPoint(o[1],b))if(void 0!==m.root)m=m.root;else break;else break;l.reset(c,a);m.insert(d)}}}}};q.enums=m;return{Octree:q}});
CubicVR.RegisterModule("CVRXML",function(m){function v(d,a,c,e){var f=CubicVR.util,l=null,m=null;e.triangles&&(m=f.intDelimArray(b.getTextNode(e,"triangles")," "));if(m&&(e.segments&&(l=f.intDelimArray(b.getTextNode(e,"segments")," ")),null===l&&(l=[0,parseInt(m.length/3,10)]),e=0,d.setFaceMaterial(a),m.length)){p=0;for(pMax=l.length;p<pMax;p+=2){a=3*l[p+1];d.setSegment(l[p]);j=e;for(jMax=e+a;j<jMax;j+=3)f=d.addFace([m[j],m[j+1],m[j+2]]),c&&d.faces[f].setUV([c[j],c[j+1],c[j+2]]);e+=a}}}function r(d){var a=
CubicVR.util,c=new CubicVR.UVMapper,f=null,h=null;if(d.type)switch(f=b.getTextNode(d,"type"),f){case "planar":c.projection_mode=e.uv.projection.PLANAR;break;case "cylindrical":c.projection_mode=e.uv.projection.CYLINDRICAL;break;case "spherical":c.projection_mode=e.uv.projection.SPHERICAL;break;case "cubic":c.projection_mode=e.uv.projection.CUBIC}if(!f)return null;"uv"===f&&d.uv&&(h=b.getPoints(d,"uv"));if(d.axis)switch(b.getTextNode(d,"axis")){case "x":c.projection_axis=e.uv.axis.X;break;case "y":c.projection_axis=
e.uv.axis.Y;break;case "z":c.projection_axis=e.uv.axis.Z}d.center&&(c.center=a.floatDelimArray(b.getTextNode(d,"center")));d.rotation&&(c.rotation=a.floatDelimArray(b.getTextNode(d,"rotation")));d.scale&&(c.scale=a.floatDelimArray(b.getTextNode(d,"scale")));d.wrap_w&&(c.wrap_w_count=parseFloat(b.getTextNode(d,"wrap_w")));d.wrap_h&&(c.wrap_h_count=parseFloat(b.getTextNode(d,"wrap_h")));return""!==f&&"uv"!==f?c:h}function l(n,a){if(d[n]!==f)return d[n];var c=CubicVR.util,g,h,l,o;g=null;g="object"==
typeof n?n:-1!=n.indexOf(".js")?c.getJSON(n):CubicVR.util.xml2badgerfish(c.getXML(n));g.root&&(g=g.root);g.properties&&(g=g.properties);c=new CubicVR.Mesh;g.points&&(l=b.getPoints(g,"points"))&&c.addPoint(l);var q=g.material;q&&!q.length&&(q=[q]);var s=[];if(q){g=0;for(l=q.length;g<l;g++){var G=q[g],A;A=G;var H=a,B=new CubicVR.Material({name:A.name?A.name.$:null});A.shininess&&(B.shininess=b.getFloatNode(A,"shininess",B.shininess)/100);B.opacity=b.getFloatNode(A,"alpha",B.opacity);B.max_smooth=b.getFloatNode(A,
"max_smooth",B.max_smooth);B.color=b.getFloatDelimNode(A,"color",B.color);B.ambient=b.getFloatDelimNode(A,"ambient",B.ambient);B.diffuse=b.getFloatDelimNode(A,"diffuse",B.diffuse);B.specular=b.getFloatDelimNode(A,"specular",B.specular);h=void 0;if(h=b.getTextNode(A,"texture"))h=(H?H:"")+h,tex=m.Textures_ref[h]!==f?m.Textures_obj[m.Textures_ref[h]]:new CubicVR.Texture(h),B.setTexture(tex,e.texture.map.COLOR);if(h=b.getTextNode(A,"texture_luminosity"))h=(H?H:"")+h,tex=m.Textures_ref[h]!==f?m.Textures_obj[m.Textures_ref[h]]:
new CubicVR.Texture(h),B.setTexture(tex,e.texture.map.AMBIENT);if(h=b.getTextNode(A,"texture_normal"))h=(H?H:"")+h,tex=m.Textures_ref[h]!==f?m.Textures_obj[m.Textures_ref[h]]:new CubicVR.Texture(h),B.setTexture(tex,e.texture.map.NORMAL);if(h=b.getTextNode(A,"texture_specular"))h=(H?H:"")+h,tex=m.Textures_ref[h]!==f?m.Textures_obj[m.Textures_ref[h]]:new CubicVR.Texture(h),B.setTexture(tex,e.texture.map.SPECULAR);if(h=b.getTextNode(A,"texture_bump"))h=(H?H:"")+h,tex=m.Textures_ref[h]!==f?m.Textures_obj[m.Textures_ref[h]]:
new CubicVR.Texture(h),B.setTexture(tex,e.texture.map.BUMP);if(h=b.getTextNode(A,"texture_envsphere"))h=(H?H:"")+h,tex=m.Textures_ref[h]!==f?m.Textures_obj[m.Textures_ref[h]]:new CubicVR.Texture(h),B.setTexture(tex,e.texture.map.ENVSPHERE);if(h=b.getTextNode(A,"texture_alpha"))h=(H?H:"")+h,tex=m.Textures_ref[h]!==f?m.Textures_obj[m.Textures_ref[h]]:new CubicVR.Texture(h),B.setTexture(tex,e.texture.map.ALPHA);A=B;var u=null;h=H=null;G.uvmapper&&((H=r(G.uvmapper))&&!H.length?s.push([H,A]):h=H);(B=G.part)&&
!B.length&&(B=[B]);if(B&&B.length){var x=null,y=null;h=0;for(o=B.length;h<o;h++){var D=B[h],x=null;if(u=D.uvmapper)x=r(u),G.triangles&&(y=u=c.faces.length,x&&!x.length?(v(c,A,null,D),y=c.faces.length-1,c.calcFaceNormals(u,y),x.apply(c,A,f,u,y)):x&&x.length?v(c,A,x,D):H&&!H.length&&(v(c,A,null,D),y=c.faces.length-1,c.calcFaceNormals(u,y),H.apply(c,A,f,u,y)));if(D.procedural){(u=D.uvmapper)&&(x=r(u));var y=D.transform?b.getTransform(D.transform):f,u=f,D=D.procedural,C=b.getTextNode(D,"type");y&&(u=
new CubicVR.Transform,u.translate(y.position),u.pushMatrix(),u.rotate(y.rotation),u.pushMatrix(),u.scale(y.scale));H||(H=f);x={material:A,uvmapper:H||x};if("box"===C||"cube"===C)x.size=b.getFloatNode(D,"size"),c.booleanAdd(CubicVR.primitives.box(x),u);else if("sphere"===C)x.radius=b.getFloatNode(D,"radius"),x.lat=b.getIntNode(D,"lat"),x.lon=b.getIntNode(D,"lon"),c.booleanAdd(CubicVR.primitives.sphere(x),u);else if("cone"===C)x.base=b.getFloatNode(D,"base"),x.height=b.getFloatNode(D,"height"),x.lon=
b.getIntNode(D,"lon"),c.booleanAdd(CubicVR.primitives.cone(x),u);else if("plane"===C)x.size=b.getFloatNode(D,"size"),c.booleanAdd(CubicVR.primitives.plane(x),u);else if("cylinder"===C)x.radius=b.getFloatNode(D,"radius"),x.height=b.getFloatNode(D,"height"),x.lon=b.getIntNode(D,"lon"),c.booleanAdd(CubicVR.primitives.cylinder(x),u);else if("torus"===C)x.innerRadius=b.getFloatNode(D,"innerRadius"),x.outerRadius=b.getFloatNode(D,"outerRadius"),x.lat=b.getIntNode(D,"lat"),x.lon=b.getIntNode(D,"lon"),c.booleanAdd(CubicVR.primitives.torus(x),
u);else if("lathe"===C)x.points=b.getPoints(D,"p"),x.lon=b.getIntNode(D,"lon"),c.booleanAdd(CubicVR.primitives.lathe(x),u);else if("polygon"===C){y=b.getPoints(D,"p");y=new CubicVR.Polygon(y);(C=D.cut)&&!C.length&&(C=[C]);if(C.length){h=0;for(l=C.length;h<o;h++)y.cut(new CubicVR.Polygon(b.getPoints(C[h])))}x.front=0;x.back=0;x.frontShift=0;x.backShift=0;x.frontDepth=0;x.backDepth=0;if(D.extrude&&(D=D.extrude,x.front=b.getFloatNode(D,"front",0),x.back=b.getFloatNode(D,"back",0),x.frontShift=b.getFloatNode(D,
"frontBevelShift",0),x.backShift=b.getFloatNode(D,"backBevelShift",0),x.frontDepth=b.getFloatNode(D,"frontBevelDepth",0),x.backDepth=b.getFloatNode(D,"backBevelDepth",0),x.depth=b.getFloatNode(D,"depth",0),x.shift=b.getFloatNode(D,"shift",0),x.bevel=b.getFloatNode(D,"bevel",0),x.depth&&(!x.backDepth&&!x.frontDepth)&&(x.front=-x.depth/2,x.back=x.depth/2),x.shift&&(!x.backShift&&!x.frontShift)&&(x.frontShift=x.shift,x.backShift=x.shift),x.bevel&&!x.backDepth&&!x.frontDepth))x.frontDepth=x.bevel,x.backDepth=
x.bevel;D=y.toExtrudedBeveledMesh(new CubicVR.Mesh,x);D.setFaceMaterial(x.material);c.booleanAdd(D,u)}}}}else v(c,A,h,G)}}c.triangulateQuads();c.calcNormals();g=0;for(l=s.length;g<l;g++)s[g][0].apply(c,s[g][1]);c.compile();return d[n]=c}function o(b){return null===b?!1:b.getElementsByTagName("x").length||b.getElementsByTagName("y").length||b.getElementsByTagName("z").length||b.getElementsByTagName("fov").length}function q(b,a,c){var d=CubicVR.util,h=[];h[0]=b.getElementsByTagName("x");h[1]=b.getElementsByTagName("y");
h[2]=b.getElementsByTagName("z");h[3]=b.getElementsByTagName("fov");var l,m,o,s,q,r;for(r in h)if(h.hasOwnProperty(r)&&h[r]!==f&&h[r].length){l=h[r][0].getElementsByTagName("time");m=h[r][0].getElementsByTagName("value");o=h[r][0].getElementsByTagName("in");s=h[r][0].getElementsByTagName("out");q=h[r][0].getElementsByTagName("tcb");var v=null,B=null,u=null,x=b=null;o.length&&(b=d.collectTextNode(o[0]));s.length&&(x=d.collectTextNode(s[0]));l.length&&(v=d.floatDelimArray(d.collectTextNode(l[0])," "));
m.length&&(B=d.floatDelimArray(d.collectTextNode(m[0])," "));q.length&&(u=d.floatDelimArray(d.collectTextNode(q[0])," "));if(null!==v&&null!==B){l=0;for(m=v.length;l<m;l++)o=c.setKey(a,r,v[l],B[l]),u&&(o.tension=u[3*l],o.continuity=u[3*l+1],o.bias=u[3*l+2])}B=v=e.envelope.behavior.CONSTANT;if(b)switch(b){case "reset":v=e.envelope.behavior.RESET;break;case "constant":v=e.envelope.behavior.CONSTANT;break;case "repeat":v=e.envelope.behavior.REPEAT;break;case "oscillate":v=e.envelope.behavior.OSCILLATE;
break;case "offset":v=e.envelope.behavior.OFFSET;break;case "linear":v=e.envelope.behavior.LINEAR}if(x)switch(x){case "reset":B=e.envelope.behavior.RESET;break;case "constant":B=e.envelope.behavior.CONSTANT;break;case "repeat":B=e.envelope.behavior.REPEAT;break;case "oscillate":B=e.envelope.behavior.OSCILLATE;break;case "offset":B=e.envelope.behavior.OFFSET;break;case "linear":B=e.envelope.behavior.LINEAR}c.setBehavior(a,r,v,B)}}var f=m.undef,e=CubicVR.enums,d=[],b={getPoints:function(d,a,c){d=a?
b.getTextNode(d,a):d.$;if(!d)return f;d=d.split(" ");i=0;for(iMax=d.length;i<iMax;i++){d[i]=d[i].split(",");j=0;for(jMax=d[i].length;j<jMax;j++)d[i][j]=parseFloat(d[i][j]);c&&(d[i][2]=0)}return d},getTransform:function(b){var a=CubicVR.util;if(!b)return null;var c={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},d;postition=b.position;d=b.rotation;b=b.scale;d&&(c.rotation=a.floatDelimArray(d.$));b&&(c.scale=a.floatDelimArray(b.$));return d||b?c:null},getTextNode:function(b,a,c){b=b[a];if(!b)return c;
b.length&&(b=b[0]);return b.$?b.$:c},getFloatNode:function(d,a,c){return(d=b.getTextNode(d,a))?(d=parseFloat(d),d!=d?c:d):c},getIntNode:function(d,a,c){return(d=b.getTextNode(d,a))?(d=parseInt(d,10),d!=d?c:d):c},getFloatDelimNode:function(d,a,c,e){var f=CubicVR.util;return(d=b.getTextNode(d,a))?f.floatDelimArray(d,e):c},getIntDelimNode:function(d,a,c,e){var f=CubicVR.util;return(d=b.getTextNode(d,a))?f.intDelimArray(d,e):c}};return{loadMesh:l,loadScene:function(b,a,c){var d=CubicVR.util;a===f&&(a=
"");c===f&&(c="");for(var h=new CubicVR.Mesh,m=d.getXML(b),b=new CubicVR.Scene,r=[],w=m.getElementsByTagName("sceneobjects"),s,v,A,H=0,B=w[0].childNodes.length;H<B;H++){var u=w[0].childNodes[H];if("sceneobject"===u.tagName){var x="unnamed",y="",D="",h=u.getElementsByTagName("name");h.length&&(x=d.collectTextNode(h[0]));h=u.getElementsByTagName("parent");h.length&&(y=d.collectTextNode(h[0]));h=u.getElementsByTagName("model");h.length&&(D=d.collectTextNode(h[0]));A=v=s=null;h=u.getElementsByTagName("position");
h.length&&(s=h[0]);h=u.getElementsByTagName("rotation");h.length&&(v=h[0]);h=u.getElementsByTagName("scale");h.length&&(A=h[0]);h=null;""!==D&&(h=l(a+D,c));h=new CubicVR.SceneObject(h,x);o(s)?(h.motion||(h.motion=new CubicVR.Motion),q(s,e.motion.POS,h.motion)):s&&(h.position=d.floatDelimArray(d.collectTextNode(s)));o(v)?(h.motion||(h.motion=new CubicVR.Motion),q(v,e.motion.ROT,h.motion)):h.rotation=d.floatDelimArray(d.collectTextNode(v));o(A)?(h.motion||(h.motion=new CubicVR.Motion),q(A,e.motion.SCL,
h.motion)):h.scale=d.floatDelimArray(d.collectTextNode(A));b.bindSceneObject(h);""!==y&&r.push([h,y])}}for(var C in r)r.hasOwnProperty(C)&&b.getSceneObject(r[C][1]).bindChild(r[C][0]);a=m.getElementsByTagName("camera");a.length&&((v=s=null,c="",h=a[0].getElementsByTagName("name"),C=b.camera,m=null,h.length&&(c=h[0].firstChild.nodeValue),h=a[0].getElementsByTagName("target"),h.length&&(c=h[0].firstChild.nodeValue),""!==c&&(C.targetSceneObject=b.getSceneObject(c)),h=a[0].getElementsByTagName("position"),
h.length&&(s=h[0]),h=a[0].getElementsByTagName("rotation"),h.length&&(v=h[0]),h=a[0].getElementsByTagName("fov"),h.length&&(m=h[0]),o(s)?(C.motion||(C.motion=new CubicVR.Motion),q(s,e.motion.POS,C.motion)):s&&(C.position=d.floatDelimArray(s.firstChild.nodeValue)),o(v)?(C.motion||(C.motion=new CubicVR.Motion),q(v,e.motion.ROT,C.motion)):v&&(C.rotation=d.floatDelimArray(v.firstChild.nodeValue)),o(m))?(C.motion||(C.motion=new CubicVR.Motion),q(m,e.motion.FOV,C.motion)):m&&(C.fov=parseFloat(m.firstChild.nodeValue)));
return b}}});
CubicVR.RegisterModule("Worker",function(m){function v(a){var b=this;this.message=a.message||function(){};this.send=function(a,b){postMessage({message:a,data:b})};self.addEventListener("message",function(a){"init"!==a.data.message&&b.message(a.data)},!1)}function r(a){function b(a){setTimeout(function(){c.send("test",a)},1E3)}a&&b(a);var c=new v({message:b})}function l(a){function b(a){a=t.getURL(a);c.send("done",a.length)}var c;c=new v({message:function(a){b(a)}});a&&b(a)}function o(a){function b(a){a=t.getURL(a);
c.send("loaded",a)}var c,d;c=new v({message:function(a){if("parse"===a.message)d=new h,CubicVR.loadCollada("","",d,a.data),c.send("parsed");else if("getMesh"===a.message){if(a=d.meshMap[":"+a.data]){var b=a.triangulateQuads().compileVBO(a.compileMap());c.send("getMesh",{mesh:a,vbo:b})}}else throw Error("Not a SceneFileWorker command: "+a.message);}});a&&b(a)}function q(a){function b(a){var e=new d,f;for(f in a)a.hasOwnProperty(f)&&(e[f]=a[f]);a=e.triangulateQuads().compileVBO(e.compileMap());c.send("done",
a)}var c;c=new v({message:function(a){b(a)}});a&&b(a)}try{window||(self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}})}catch(f){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}var e=m.undef,d=CubicVR.Mesh,b=CubicVR.Texture,n=CubicVR.Material,a=CubicVR.SceneObject,c=CubicVR.Motion,g=CubicVR.Envelope,h=CubicVR.DeferredBin,t=CubicVR.util;return{Worker:function(a){this.worker=new Worker(CubicVR.getScriptLocation()+"CubicVR.js");this.message=
a.message||function(){};this.error=a.error||function(a){console.log("Error: "+a.message+": "+a.lineno)};this.type=a.type;var b=this;this.worker.onmessage=function(a){b.message(a.data)};this.worker.onerror=function(a){b.error(a)};this.init=function(a){b.send("init",{type:b.type,data:a})};this.send=function(a,c){b.worker.postMessage({message:a,data:c})};this.send("CubicVR_InitWorker",CubicVR.getScriptLocation());(a.data||a.autoStart)&&b.init(a.data)},ResourcePool:function(){function c(a){var b=a.parsed||
function(){},e={},f;a.url.match(/\.dae/)&&(f=new CubicVR.Worker({type:"sceneFile",data:a.url,message:function(a){if("loaded"===a.message){var a=(new DOMParser).parseFromString(a.data,"text/xml"),c=t.xml2badgerfish(a);console.log(a);f.send("parse",c)}else if("getMesh"===a.message){var c=new d,g;for(g in a.data.mesh)a.data.mesh.hasOwnProperty(g)&&(c[g]=a.data.mesh[g]);c.bindBuffer(c.bufferVBO(a.data.vbo));e.getMesh&&e.getMesh(c)}else"parsed"===a.message&&b()}}));this.getSceneObject=function(a,b){f.send("getMesh",
a);e.getMesh=b}}function e(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}var f=this,g={};this.createSceneFileManager=function(a){var b=new c({url:a.url,parsed:a.parsed});return g[a.url]=b};this.removeSceneFileManager=function(a){if("string"===typeof settings)delete g[settings];else for(var b in g)g[b]===a&&delete g[b]};this.createSceneObjectFromMesh=function(c){var g=c.scene,h=c.object,l=c.assetBase||"",m=f.createSceneFileManager({url:c.mesh,parsed:function(){h&&m.getSceneObject(h,
function(c){for(var c=e(c,new d),f=0,h=c.materials.length;f<h;++f){for(var m=e(c.materials[f],new n),o=0,s=m.textures.length;o<s;++o){var q=m.textures[f];m.textures[f]=new b(l+q.img_path,q.filter_type)}c.materials[f]=m}c=new a(c);g.bindSceneObject(c)})}})};this.loadFile=function(a,b){b=b||function(){};new CubicVR.Worker({type:"file",data:mesh,message:function(a){b(a.data)}})}},loadColladaWorker:function(f,h,l,m){var o;try{o=new Worker(CubicVR.getScriptLocation()+"collada.js")}catch(q){throw Error("Can't find collada.js");
}var t=[],r=[];o.onmessage=function(h){function o(a,b){for(var c in a)b[c]=a[c]}function q(a){if(a.motion){for(var b=a.motion.controllers,d=[],e=0,f=b.length;e<f;++e){var h=b[e];if(h){for(var l=[],m=0,n=h.length;m<n;++m){var s=h[m];if(s){var t=s.keys[0];1<s.keys.length&&(t.prev=null,t.next=s.keys[1],t=s.keys[1]);for(var r=1,u=s.keys.length-1;r<u;++r)t.prev=s.keys[r-1],t.next=s.keys[r+1],t=s.keys[r+1];1<s.keys.length&&(t=s.keys[s.keys.length-1],t.prev=s.keys[s.keys.length-2],t.next=null);s.firstKey=
s.keys[0];s.lastKey=s.keys[s.keys.length-1];s.keys=s.firstKey;t=new g;o(s,t);l[m]=t}else h[m]=null}d[e]=l}else b[e]=null}a.motion.controllers=d;b=new c;o(a.motion,b);a.motion=b}}function w(b){var c=new a;o(b,c);if(null!==b.obj){var g=r[b.obj.id];if(g===e)if(g=new d,o(b.obj,g),c.obj=g,r[b.obj.id]=g,m){if(0<g.points.length){m.addMesh(f,f+":"+g.id,g);for(var h=0,l=g.faces.length;h<l;++h){var n=g.faces[h],s=n.material;n.material=t[s]!==e?t[s]:0}}}else c.obj.triangulateQuads(),c.obj.calcNormals(),c.obj.compile(),
c.obj.clean();else c.obj=g}c.trans=new Transform;if(b.children&&0<b.children.length&&(c.children=[],b.children)){g=0;for(h=b.children.length;g<h;++g)l=w(b.children[g]),c.bindChild(l)}return c}var v;v=h.data.message;if("materials"==v){var A=JSON.parse(h.data.data),h=0;for(v=A.length;h<v;++h){var H=new n(A[h].name),I=H.material_id;o(A[h],H);H.material_id=I;t[A[h].material_id]=I;for(var I=0,L=A[h].textures.length;I<L;++I){var K=A[h].textures[I];if(K){var M=Texture_ref[K.img_path];M===e?(K=new b(K.img_path,
K.filter_type,m,f),H.textures[I]=K):H.textures[I]=Textures_obj[M]}else H.textures[I]=0}}}else if("scene"==v){A=JSON.parse(h.data.data);h=0;for(v=A.sceneObjects.length;h<v;++h)H=A.sceneObjects[h],null!==H.obj&&nop(),H.reassembled===e&&(q(H),H.reassembled=!0),A.sceneObjects[h]=w(H);H=new Scene;h=H.camera;v=h.transform;o(A.camera,h);o(A.camera.transform,v);q(h);H.camera=h;H.camera.transform=v;H.camera.frustum=new Frustum;h=0;for(v=A.sceneObjects.length;h<v;++h){I=A.sceneObjects[h];H.bindSceneObject(I);
try{I.getAABB()}catch(X){}}h=0;for(v=A.lights.length;h<v;++h)I=new Light,o(A.lights[h],I),I.trans=new Transform,q(I),H.bindLight(I);l(H)}else console.log("message from collada worker:",h.data.message)};o.onerror=function(a){console.log("error from collada worker:",a.message)};o.postMessage({message:"start",params:{meshUrl:f,prefix:h,rootDir:CubicVR.getScriptLocation()}})},InitWorker:function(){var a={test:r,prepareMesh:q,file:l,sceneFile:o};self.addEventListener("message",function(b){if("init"===
b.data.message){var c=b.data.data.type;if(c in a)new a[c](b.data.data.data);else throw Error("Invalid worker type.");}},!1)}}});
CubicVR.RegisterModule("Polygon",function(m){function v(a){for(var b=a.length,c=0,d=b-1,e=0;e<b;d=e++)c+=a[d][0]*a[e][1]-a[e][0]*a[d][1];return 0.5*c}function r(a){var b=[],d=a.length;if(3>d)return null;var e=[],f;if(0<v(a))for(f=0;f<d;f++)e[f]=f;else for(f=0;f<d;f++)e[f]=d-1-f;var l=2*d,m;m=0;for(f=d-1;2<d;){if(0>=l--)return null;var n=f;d<=n&&(n=0);f=n+1;d<=f&&(f=0);var o=f+1;d<=o&&(o=0);var q;a:{q=a;var r=n,x=f,y=o,D=d,C=e,E=void 0,z=void 0,J=void 0,I=void 0,L=void 0,K=void 0,M=void 0,X=void 0,
fa=void 0,z=q[C[r]][0],J=q[C[r]][1],I=q[C[x]][0],L=q[C[x]][1],K=q[C[y]][0],M=q[C[y]][1];if(c>(I-z)*(M-J)-(L-J)*(K-z))q=!1;else{for(E=0;E<D;E++)if(!(E==r||E==x||E==y)){var X=q[C[E]][0],fa=q[C[E]][1],Q=void 0,Ca=void 0,O=void 0,N=void 0,qa=void 0,fb=void 0,gb=void 0,Ma=void 0,pb=void 0,Na=void 0,hb=void 0,qb=void 0,Q=O=qa=void 0,Q=K-I,Ca=M-L,O=z-K,N=J-M,qa=I-z,fb=L-J,gb=X-z,Ma=fa-J,pb=X-I,Na=fa-L,hb=X-K,qb=fa-M,Q=Q*Na-Ca*pb,qa=qa*Ma-fb*gb,O=O*qb-N*hb;if(0<=Q&&0<=O&&0<=qa){q=!1;break a}}q=!0}}if(q){l=
e[n];n=e[f];o=e[o];b.push(l);b.push(n);b.push(o);m++;o=f;for(l=f+1;l<d;o++,l++)e[o]=e[l];d--;l=2*d}}return b}function l(b,c,d){d===a&&(d=0);var e;e=r(c);var f=CubicVR.util.repackArray(e,3,e.length/3),l=[],m=b.points.length;e=0;for(iMax=c.length;e<iMax;e++)l.push([c[e][0],c[e][1],d]);b.addPoint(l);e=0;for(iMax=f.length;e<iMax;e++)b.addFace([f[e][0]+m,f[e][1]+m,f[e][2]+m])}function o(a,b){var c=b[0]-a[0],d=b[1]-a[1];return Math.sqrt(c*c+d*d)}function q(a,b){var c,d,e=[],f=a.length,l=b.length,m=[];for(c=
0;c<f;c++)for(d=0;d<l;d++){var n=o(a[c],b[d]);e.push([n,c,d])}e.sort(function(a,b){return a[0]>b[0]});for(c=0;5>c;c++)for(d=0;d<e.length;d++)c!=d&&e[c][1]!=e[d][1]&&e[c][2]!=e[d][2]&&e[c][1]<e[d][1]&&e[c][2]<e[d][2]&&4>Math.abs(e[c][1]-e[d][1])&&4>Math.abs(e[c][2]-e[d][2])&&m.push([c,d]);m.sort(function(a,b){return e[a[0]][0]+e[a[1]][0]>e[b[0]][0]+e[b[1]][0]});10<m.length&&(m.length=10);d=[];for(c=0;c<m.length;c++)d.push([e[m[c][0]],e[m[c][1]]]);return d}function f(a,b){var c=q(a,b),d;if(!c.length)return null;
d=c[0][0];var e=c[0][1],c=e[1]-d[1],e=e[2]-d[2],f=a.slice(d[1]),f=f.concat(a.slice(0,d[1])),l=b.slice(d[2]),l=l.concat(b.slice(0,d[2])),m=[];for(d=c;d<f.length;d++)m.push(f[d]);m.push(f[0]);for(d=e;d<l.length;d++)m.push(l[d]);m.push(l[0]);var n=[];for(d=0;d<=c;d++)n.push(f[d]);for(d=0;d<=e;d++)n.push(l[d]);return[m,n]}function e(a){for(var b=[0,0],c=0;c<a.length;c++)b[0]+=a[c][0],b[1]+=a[c][1];b[0]/=a.length;b[1]/=a.length;return b}function d(a,b,c){for(var d=[],e=0;e<a.length;e++){var f=[a[e][0]-
b[0],a[e][1]-b[1]],l=Math.sqrt(f[0]*f[0]+f[1]*f[1])+c,f=Math.atan2(f[1],f[0]);d[e]=[b[0]+Math.cos(f)*l,b[1]+Math.sin(f)*l]}return d}function b(a,b,c,d,e){var f,l=a.points.length;if(b.length!=c.length)return null;var m=b.length;for(f=0;f<m;f++)a.addPoint([b[f][0],b[f][1],d]);for(f=0;f<m;f++)a.addPoint([c[f][0],c[f][1],e]);for(f=0;f<m-1;f++)a.addFace([l+f,l+f+1,l+(f+m+1),l+(f+m)]);f=m-1;a.addFace([l+f,l,l+m,l+(f+m)])}function n(a){this.points=a;0>this.area()&&(this.points=a.reverse());this.cuts=[];
this.result=[]}var a=m.undef,c=1.0E-10;n.prototype={cut:function(a){this.cuts.push(a)},flip:function(){this.points=this.points.reverse()},area:function(){return v(this.points)},toMesh:function(a){if(0!==this.points.length){var b;a||(a=new CubicVR.Mesh);this.result=[this.points];for(b=0;b<this.cuts.length;b++){var c=this.cuts[b].points.slice(0),c=c.reverse(),c=f(this.result[0],c);this.result[0]=c[0];this.result.push(c[1])}for(b=0;b<this.result.length;b++)l(a,this.result[b]);a.removeDoubles();return a}},
toExtrudedMesh:function(c,d,e){if(0!==this.points.length){var m,n;d===a&&(d=0);e===a&&(e=0);var o=d!=e;c||(c=new CubicVR.Mesh);this.result=[this.points];for(n=0;n<this.cuts.length;n++)m=this.cuts[n].points.slice(0),m=m.reverse(),m=f(this.result[0],m),this.result[0]=m[0],this.result.push(m[1]);m=new CubicVR.Mesh;for(n=0;n<this.result.length;n++)l(m,this.result[n],e);c.booleanAdd(m);m.flipFaces();if(o)for(n=0;n<m.points.length;n++)m.points[n][2]=d;c.booleanAdd(m);if(o){b(c,this.points,this.points,d,
e);for(n=0;n<this.cuts.length;n++)m=this.cuts[n].points.slice(0),m=m.reverse(),b(c,m,m,d,e)}c.removeDoubles();return c}},toExtrudedBeveledMesh:function(a,c,m,n,o,s,q){var r=[],v=[],B,u,x,y;if(0!==this.points.length){"object"===typeof c&&(q=c,c=q.front||0,m=q.back||0,n=q.frontDepth||0,o=q.frontShift||0,s=q.backDepth||0,q=q.backShift||0);var D=c!==m,C=0!==s,E=0!==n;a||(a=new CubicVR.Mesh);E?(u=e(this.points),u=d(this.points,u,-o),this.result=[u.slice(0)]):this.result=[this.points.slice(0)];for(y=0;y<
this.cuts.length;y++)x=e(this.cuts[y].points),x=d(this.cuts[y].points,x,o),x=x.reverse(),r.push(x),x=f(this.result[0],x),this.result[0]=x[0],this.result.push(x[1]);o=new CubicVR.Mesh;for(y=0;y<this.result.length;y++)l(o,this.result[y],c-n);o.flipFaces();a.booleanAdd(o);if(C||E){B=e(this.points);B=d(this.points,B,-q);this.result=[B.slice(0)];for(y=0;y<this.cuts.length;y++)x=e(this.cuts[y].points),x=d(this.cuts[y].points,x,q),x=x.reverse(),v.push(x),x=f(this.result[0],x),this.result[0]=x[0],this.result.push(x[1]);
o=new CubicVR.Mesh;for(y=0;y<this.result.length;y++)l(o,this.result[y],m+s)}else{for(y=0;y<o.points.length;y++)o.points[y][2]=m;o.flipFaces()}a.booleanAdd(o);E&&b(a,u,this.points,c-n,c);D&&b(a,this.points,this.points,c,m);C&&b(a,this.points,B,m,m+s);for(y=0;y<r.length;y++)x=this.cuts[y].points.slice(0).reverse(),E&&b(a,r[y],x,c-n,c),D&&b(a,x,x,c,m),C&&b(a,x,v[y],m,m+s);a.removeDoubles();return a}}};return{polygon:{triangulate2D:r,toMesh:l,findNearPair:function(a,b){for(var c=[0,0],d=o(a[0],b[0]),
e=a.length,f=b.length,m=0;m<e;m++)for(var l=0;l<f;l++){var n=o(a[m],b[l]);n<d&&(c[0]=m,c[1]=l,d=n)}return c},subtract:f,addOffset:function(a,b){for(var c=[],d=0,e=a.length;d<e;d++){var f=a[d];c.push([f[0]+b[0],f[1]+b[1]])}return c},normal:function(a){for(var b=[0,0,0],c=0,d=a.length;c<d;c++){var e=a[c],f=a[(c+1)%d];b[0]+=(e[1]-f[1])*(e[2]+f[2]);b[1]+=(e[2]-f[2])*(e[0]+f[0]);b[2]+=(e[0]-f[0])*(e[1]+f[1])}return m.vec3.normalize(b)}},Polygon:n}});
CubicVR.RegisterModule("ScenePhysics",function(m){function v(a,b){b.setX(a[0]);b.setY(a[1]);b.setZ(a[2])}function r(a,b){b.setX(a.x);b.setY(a.y);b.setZ(a.z);b.setW(a.w)}function l(a,b){b.x=a.x();b.y=a.y();b.z=a.z();b.w=a.w()}function o(a){return new Ammo.btVector3(a[0],a[1],a[2])}function q(a){var b=new Ammo.btQuaternion;b.setEulerZYX(a[2]*(Math.PI/180),a[1]*(Math.PI/180),a[0]*(Math.PI/180));return b}function f(a){return[a.x(),a.y(),a.z()]}function e(a){this.setManifold(a)}var d=m.undef,b=m.enums;
b.physics={body:{STATIC:0,DYNAMIC:1,GHOST:2,SOFT:3},constraint:{P2P:0},collision_flags:{STATIC_OBJECT:1,KINEMATIC_OBJECT:2,NO_CONTACT_RESPONSE:4,CUSTOM_MATERIAL_CALLBACK:8,CHARACTER_OBJECT:16,DISABLE_VISUALIZE_OBJECT:32},rigid_flags:{DISABLE_WORLD_GRAVITY:1},collision_types:{COLLISION_OBJECT:1,RIGID_BODY:2,GHOST_OBJECT:3,SOFT_BODY:4,HF_FLUID:5},collision_states:{ACTIVE_TAG:1,ISLAND_SLEEPING:2,WANTS_DEACTIVATION:3,DISABLE_DEACTIVATION:4,DISABLE_SIMULATION:5}};var n,a,c,g,h,t=function(a,b,c){var d;
!a.position&&a.sceneObject&&(d=a,a=a.sceneObject,b=d.properties,c=d.collision);d=m.get(d)||{};this.properties=new m.RigidProperties(b?m.get(b):{collision:c});this.collisionEvents=[];this.parent=null;this.init_position=a.position.slice(0);this.init_rotation=a.rotation.slice(0);this.init_linearVelocity=this.linearVelocity=d.linearVelocity||[0,0,0];this.init_angularVelocity=this.angularVelocity=d.angularVelocity||[0,0,0];this.init_impulse=this.impulse=d.impulse||[0,0,0];this.init_impulsePosition=this.impulsePosition=
d.impulsePosition||[0,0,0];this.collision_flags=this.rigid_flags=null;this.sceneObject=a;this.transform=new Ammo.btTransform;this.transform.setIdentity();this.transform.setOrigin(o(this.init_position));this.transform.setRotation(q(this.init_rotation));this.shape=null;this.motionState=new Ammo.btDefaultMotionState(this.transform);this.localInertia=new Ammo.btVector3(0,0,0);this.ghost=this.body=this.bodyInit=null;this.noDeactivate=!1};t.prototype={getProperties:function(){return this.properties},getSceneObject:function(){return this.sceneObject},
getInitialPosition:function(){return this.init_position},getInitialRotation:function(){return this.init_rotation},setInitialPosition:function(){this.init_position=init_position_in},setInitialRotation:function(){this.init_rotation=init_rotation_in},getType:function(){return this.properties.type},getMass:function(){return this.properties.mass},getRestitution:function(){return this.properties.restitution},getCollisionMap:function(){return this.properties.collision},setMass:function(a){this.properties.mass=
a;this.body&&this.body.setMassProps(a,this.localInertia)},setRestitution:function(a){this.restitution=a},getBody:function(){if(!this.body&&!this.ghost){var a=this.getCollisionShape();this.getType()===b.physics.body.GHOST?(this.body=null,this.ghost=new Ammo.btGhostObject,this.ghost.setCollisionShape(a),this.ghost.setWorldTransform(this.transform),this.ghost._cvr_rigidbody=this):(this.getMass()&&a.calculateLocalInertia(this.getMass(),this.localInertia),this.bodyInit=new Ammo.btRigidBodyConstructionInfo(this.getMass(),
this.motionState,a,this.localInertia),this.friction&&this.bodyInit.set_m_friction(this.friction),this.body=new Ammo.btRigidBody(this.bodyInit),this.getRestitution()&&this.body.setRestitution(this.getRestitution()),v(this.linearVelocity,g),this.body.setLinearVelocity(g),v(this.angularVelocity,g),this.body.setAngularVelocity(g),m.vec3.equal([0,0,0],this.impulse)||(v(this.impulse,g),v(this.impulsePosition,h),this.body.applyImpulse(g,h)),this.rigid_flags&&this.body.setFlags(this.rigid_flags),this.collision_flags&&
this.body.setFlags(this.collision_flags),this.body._cvr_rigidbody=this)}return this.body||this.ghost},updateSceneObject:function(b){if(this.body&&(this.body.isActive()||b))return this.body.getMotionState().getWorldTransform(n),b=n.getOrigin(),b.x!=b.x?console.log("origin is NaN"):(this.sceneObject.position[0]=b.x(),this.sceneObject.position[1]=b.y(),this.sceneObject.position[2]=b.z()),b=n.getRotation(),a.x=b.x(),a.y=b.y(),a.z=b.z(),a.w=b.w(),a.x!=a.x?console.log("rotation is NaN"):(b=a.toEuler(),
this.sceneObject.rotation[0]=b[0],this.sceneObject.rotation[1]=b[1],this.sceneObject.rotation[2]=b[2]),!0},reset:function(){if(this.body){var b=this.body.getWorldTransform().getOrigin();v(this.init_position,b);this.body.getWorldTransform().getRotation();this.resetMotion();b=this.init_rotation;a.fromEuler(b[0],b[1],b[2]);b=[a.x,a.y,a.z,a.w];c.setX(b[0]);c.setY(b[1]);c.setZ(b[2]);c.setW(b[3]);this.body.getWorldTransform().setRotation(c);this.activate()}},resetMotion:function(){v(this.init_linearVelocity,
g);this.body.setLinearVelocity(g);v(this.init_angularVelocity,g);this.body.setAngularVelocity(g);m.vec3.equal([0,0,0],this.init_impulse)||(v(this.init_impulse,g),v(this.init_impulsePosition,h),this.body.applyImpulse(g,h))},getCollisionShape:function(){if(!this.shape){var a;a=this.getCollisionMap();if(a.getResult())a=a.getResult();else{var c=a.getShapes(),d,e,f,g,h,l,r,t=[],w=null;e=0;for(f=c.length;e<f;e++){d=c[e];w=null;if(d.type===b.collision.shape.BOX)w=new Ammo.btBoxShape(new Ammo.btVector3(d.size[0]/
2,d.size[1]/2,d.size[2]/2));else if(d.type===b.collision.shape.SPHERE)w=new Ammo.btSphereShape(d.radius);else if(d.type===b.collision.shape.CAPSULE)w=new Ammo.btCapsuleShape(d.radius,d.height);else if(d.type===b.collision.shape.CYLINDER)w=new Ammo.btCylinderShape(new Ammo.btVector3(d.size[0]/2,d.size[1]/2,d.size[2]/2));else if(d.type===b.collision.shape.CONE)w=new Ammo.btConeShape(d.radius,d.height);else if(d.type===b.collision.shape.MESH){r=d.mesh;w=new Ammo.btTriangleMesh;l=d.size;var z=new Ammo.btVector3(0,
0,0),F=new Ammo.btVector3(0,0,0),I=new Ammo.btVector3(0,0,0),L=r.getMaterials();g=0;for(h=r.faces.length;g<h;g++){var K=r.faces[g];L[K.material].collision&&3===K.points.length&&(z.setValue(r.points[K.points[0]][0]*l[0],r.points[K.points[0]][1]*l[1],r.points[K.points[0]][2]*l[2]),F.setValue(r.points[K.points[1]][0]*l[0],r.points[K.points[1]][1]*l[1],r.points[K.points[1]][2]*l[2]),I.setValue(r.points[K.points[2]][0]*l[0],r.points[K.points[2]][1]*l[1],r.points[K.points[2]][2]*l[2]),w.addTriangle(z,F,
I))}0===this.getMass()||this.getType()==b.physics.body.STATIC||this.getType()==b.physics.body.GHOST?(this.setMass(0),w=new Ammo.btBvhTriangleMeshShape(w,!0)):w=new Ammo.btConvexTriangleMeshShape(w,!0)}else if(d.type===b.collision.shape.CONVEX_HULL){r=d.mesh;l=d.size;z=new Ammo.btVector3(0,0,0);w=new Ammo.btConvexHullShape;g=0;for(h=r.points.length;g<h;g++)v([r.points[g][0]*l[0],r.points[g][1]*l[1],r.points[g][2]*l[2]],z),w.addPoint(z)}else if(d.type===b.collision.shape.HEIGHTFIELD){F=z=r=l=0;if(d.landscape&&
!d.getHeightField&&d.landscape instanceof m.HeightField)d.heightfield=d.landscape;else if(d.landscape&&d.landscape instanceof m.Landscape){l=d.landscape.getHeightField().getDivX();z=d.landscape.getHeightField().getDivZ();r=d.landscape.getHeightField().getSizeX();F=d.landscape.getHeightField().getSizeZ();w=d.landscape.getHeightField().getFloat32Buffer();d.landscape.getHeightField();var M=Ammo.allocate(4*w.length,"float",Ammo.ALLOC_NORMAL);g=0;for(h=l*z;g<h;g++)Ammo.setValue(M+(g<<2),w[g],"float")}if(d.heightfield&&
d.heightfield instanceof m.HeightField){l=d.heightfield.getDivX();z=d.heightfield.getDivZ();r=d.heightfield.getSizeX();F=d.heightfield.getSizeZ();w=d.heightfield.getFloat32Array();M=Ammo.allocate(4*w.length,"float",Ammo.ALLOC_NORMAL);g=0;for(h=l*z;g<h;g++)Ammo.setValue(M+(g<<2),w[g],"float")}w=new Ammo.btHeightfieldTerrainShape(l,z,M,1,-100,100,1,0,!1);w.setUseDiamondSubdivision(!0);g=new Ammo.btVector3(r/l,1,F/z);w.setLocalScaling(g)}w&&(0!==d.margin&&w.setMargin(d.margin),t.push({cShape:d,btShape:w}))}c=
null;if(1===t.length)c=t[0].btShape;else if(1<t.length){n=new Ammo.btTransform;c=new Ammo.btCompoundShape(!1);e=0;for(f=t.length;e<f;e++)n.setIdentity(),n.setOrigin(o(t[e].cShape.position)),n.setRotation(q(t[e].cShape.rotation)),c.addChildShape(n,t[e].btShape)}a.setResult(c);a=c}this.shape=a}return this.shape},setAngularVelocity:function(a){this.angularVelocity=a;this.body&&(v(a,g),this.body.setAngularVelocity(g))},setGravity:function(a){this.gravity=a;this.body&&(v(a,g),this.body.setGravity(g))},
getGravity:function(){return this.gravity&&!this.body?this.gravity:f(this.body.getGravity())},setLinearVelocity:function(a){this.linearVelocity=a;this.body&&(v(a,g),this.body.setLinearVelocity(g))},applyImpulse:function(a,b){this.impulse=a||[0,0,0];this.impulsePosition=b||[0,0,0];this.body&&!m.vec3.equal([0,0,0],a)&&(v(this.impulse,g),v(this.impulsePosition,h),this.body.applyImpulse(g,h))},applyForce:function(a,b){this.body&&!m.vec3.equal([0,0,0],a)&&(v(a,g),v(b,h),this.body.applyImpulse(g,h))},getAngularVelocity:function(){return f(this.body.getAngularVelocity())},
getLinearVelocity:function(){return f(this.body.getLinearVelocity())},activate:function(a){this.noDeactivate=a||!1;this.body&&(this.noDeactivate&&this.body.setActivationState(b.physics.collision_states.DISABLE_DEACTIVATION),this.body.activate())},setAngularFactor:function(a){this.body&&a!==d&&(a.length||(a=[a,a,a]),v(a,g),this.body.setAngularFactor(g))},isActive:function(){return this.body?this.body.isActive():!1},isStatic:function(){return this.properties.type==b.physics.body.STATIC},setRigidFlags:function(a){this.rigid_flags=
a;this.body&&this.body.setFlags(a)},setCollisionFlags:function(a){this.collision_flags=a=m.parseEnum(b.physics.collision_flags,a);this.body&&this.body.setCollisionFlags(a)},setPosition:function(a){this.position=a;if(this.body||this.ghost)v(a,g),this.body&&this.body.getCenterOfMassTransform().setOrigin(g),this.ghost&&this.ghost.getWorldTransform().setOrigin(g)},getRotation:function(){if(!this.body&&!this.ghost)return this.init_rotation;this.body&&this.body.getCenterOfMassTransform().getRotation(c);
this.ghost&&this.ghost.getWorldTransform().getRotation(c);var a=new m.Quaternion;l(c,a);return a},setRotation:function(a){this.rotation=a.toEuler();if(this.body||this.ghost)r(a,c),this.body&&this.body.getCenterOfMassTransform().setRotation(c),this.ghost&&this.ghost.getWorldTransform().setRotation(c)},getRotationEuler:function(){if(!this.body&&!this.ghost)return this.init_rotation;var a=new m.Quaternion;this.body&&this.body.getCenterOfMassTransform().getRotation(c);this.ghost&&this.ghost.getWorldTransform().getRotation(c);
l(c,a);return a.toEuler()},setRotationEuler:function(a){this.rotation=a;c.setEuler(this.rotation[2]*(Math.PI/180),this.rotation[1]*(Math.PI/180),this.rotation[0]*(Math.PI/180));this.body&&this.body.getCenterOfMassTransform().setRotation(c);this.ghost&&this.body.getWorldTransform().setRotation(c)}};var F=function(a){a=a||{};this.ctype=m.parseEnum(b.physics.constraint,a.ctype)||b.physics.constraint.P2P;this.strength=a.strength||0.1;this.maxImpulse=a.maxImpulse||0;this.rigidBodyA=a.rigidBodyA||a.rigidBody||
null;this.rigidBodyB=a.rigidBodyB||null;this.positionA=a.positionA||[0,0,0];this.positionB=a.positionB||a.position||[0,0,0];this.damping=a.damping!=d?a.damping:1;this.btConstraint=null;this.localPivotA=o(this.positionA);this.localPivotB=o(this.positionB)};F.prototype={getConstraint:function(){if(!this.btConstraint){if(!this.rigidBodyA)return!1;this.ctype===b.physics.constraint.P2P&&(this.btConstraint=this.rigidBodyA&&this.rigidBodyB?new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),this.rigidBodyB.getBody(),
this.localPivotA,this.localPivotB):new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),this.localPivotA),this.btConstraint.get_m_setting().set_m_tau(this.strength),this.btConstraint.get_m_setting().set_m_damping(this.damping),this.maxImpulse&&this.btConstraint.get_m_setting().set_m_impulseClamp(this.maxImpulse),this.btConstraint===Ammo.NULL&&(this.btConstraint=null))}return this.btConstraint},setStrength:function(a){this.strength=a;this.btConstraint&&this.btConstraint.get_m_setting().set_m_tau(this.strength)},
setDamping:function(a){this.damping=a;this.btConstraint&&this.btConstraint.get_m_setting().set_damping(this.damping)},setMaxImpulse:function(a){this.maxImpulse=a;this.btConstraint&&this.btConstraint.get_m_setting().set_impulseClamp(this.maxImpulse)},getStrength:function(){return this.strength},setPosition:function(a){this.positionB=a;this.btConstraint&&(v(this.positionB,this.localPivotB),this.btConstraint.setPivotB(this.localPivotB))},getPosition:function(){return this.positionB}};e.prototype={getContact:function(){var a=
this.manifold.getContactPoint(j);return a===Ammo.NULL?null:{impulse:a.getAppliedImpulse(),lifetime:a.getLifeTime(),friction:a.get_m_combinedFriction(),positionA:f(a.getPositionWorldOnA()),positionB:f(a.getPositionWorldOnB())}},setManifold:function(a){this.numContacts=a.getNumContacts();this.manifold=a}};var w=function(){this.rigidObjects=[];this.ghostObjects=[];this.contactObjects=[];this.collisionObjects=[];this.active_count=0;this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration;
this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration);this.overlappingPairCache=new Ammo.btDbvtBroadphase;this.solver=new Ammo.btSequentialImpulseConstraintSolver;this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration);this.dynamicsWorld.setGravity(new Ammo.btVector3(0,-10,0));this.overlappingPairCache.getOverlappingPairCache().setInternalGhostPairCallback(new Ammo.btGhostPairCallback);if(!n||!a)g=
new Ammo.btVector3,h=new Ammo.btVector3,n=new Ammo.btTransform,a=new m.Quaternion,c=new Ammo.btQuaternion};w.prototype={addConstraint:function(a){var b=a.getConstraint();return b?(this.dynamicsWorld.addConstraint(b),a.rigidBodyA.activate(!0),!0):!1},removeConstraint:function(a){return(a=a.getConstraint())?(this.dynamicsWorld.removeConstraint(a),!0):!1},setGravity:function(a){v(a,g);this.dynamicsWorld.setGravity(g)},bindSceneObject:function(a,b){var c=new m.RigidBody(a,b);this.rigidObjects.push(c);
c.getBody();c.activate();this.dynamicsWorld.addRigidBody(c.getBody());c.updateSceneObject(!0);return c},bind:function(a){a instanceof m.Vehicle?a.initBody(this):a instanceof m.RigidBody&&this.bindRigidBody(a)},remove:function(a){a instanceof m.RigidBody&&this.removeRigidBody(a)},bindRigidBody:function(a){if(a.getType()===b.physics.body.GHOST){if(-1!==this.ghostObjects.indexOf(a))return;this.ghostObjects.push(a);var c=a.getBody();a.properties.blocker||c.setCollisionFlags(c.getCollisionFlags()+b.physics.collision_flags.NO_CONTACT_RESPONSE);
this.dynamicsWorld.addCollisionObject(c)}else{if(-1!==this.rigidObjects.indexOf(a))return;this.rigidObjects.push(a);c=a.getBody();a.activate();this.dynamicsWorld.addRigidBody(c);a.updateSceneObject(!0)}var d,e;if((d=a.getSceneObject())&&(e=d.getEventHandler()))e.hasEvent(b.event.CONTACT)&&this.contactObjects.push(a),e.hasEvent(b.event.COLLIDE)&&this.collisionObjects.push(a)},removeRigidBody:function(a){if(a.getType()===b.physics.body.GHOST){if(-1===this.ghostObjects.indexOf(a))return;this.ghostObjects.splice(this.ghostObjects.indexOf(a),
1);this.dynamicsWorld.removeCollisionObject(a.getBody())}else{if(-1===this.rigidObjects.indexOf(a))return;this.rigidObjects.splice(this.rigidObjects.indexOf(a),1);this.dynamicsWorld.removeRigidBody(a.getBody())}var c,d;if((c=a.getSceneObject())&&(d=c.getEventHandler()))d.hasEvent(b.event.CONTACT)&&-1!==this.contactObjects.indexOf(a)&&this.contactObjects.splice(this.contactObjects.indexOf(a),1),d.hasEvent(b.event.COLLIDE)&&-1!==this.collisionObjects.indexOf(a)&&this.collisionObjects.splice(this.collisionObjects.indexOf(a),
1)},getActiveCount:function(){return this.active_count},stepSimulation:function(a,b){this.dynamicsWorld.stepSimulation(a,b||2);for(var c=0,d=0,e=this.rigidObjects.length;d<e;d++)this.rigidObjects[d].updateSceneObject()&&c++;this.active_count=c},triggerEvents:function(){var a,c,d,f,g=this.dynamicsWorld;if(this.contactObjects.length){var h=g.getDispatcher().getNumManifolds();for(a=0;a<h;a++){var l=g.getDispatcher().getManifoldByIndexInternal(a),m=Ammo.wrapPointer(l.getBody0(),Ammo.btRigidBody)._cvr_rigidbody||
null,n=Ammo.wrapPointer(l.getBody1(),Ammo.btRigidBody)._cvr_rigidbody||null;if(m&&(f=m.getSceneObject())&&(c=f.getEventHandler())&&c.hasEvent(b.event.CONTACT))d=c.triggerEvent(b.event.CONTACT),d.self=m,d.other=n,d.contacts?d.contacts.setManifold(l):d.contacts=new e(l);else if(n&&n.isStatic()&&(f=n.getSceneObject())&&(c=f.getEventHandler())&&c.hasEvent(b.event.CONTACT))d=c.triggerEvent(b.event.CONTACT),d.other=m,d.self=n,d.contacts?d.contacts.setManifold(l):d.contacts=new e(l)}}g=this.collisionObjects.length;
for(a=0;a<g;a++)if(m=this.collisionObjects[a],(f=m.getSceneObject())&&(c=f.getEventHandler())&&c.hasEvent(b.event.COLLIDE))if(d=c.getProperties(b.event.COLLIDE),l=d.collidesWith,d.mf=d.mf||[],d.alg=d.alg||[],l&&l.length){h=[];m=m.getBody();a=0;for(iMax=l.length;a<iMax;a++){var n=l[a],o=n.getBody();d.mf[a]||(d.mf[a]=new Ammo.btManifoldResult(m,o));d.alg[a]||(d.alg[a]=this.dynamicsWorld.getDispatcher().findAlgorithm(m,o));d.alg[a].processCollision(m,o,this.dynamicsWorld.getDispatchInfo(),d.mf[a]);0<
d.mf[a].getPersistentManifold().getNumContacts()&&(h.push(n),this.dynamicsWorld.getDispatcher().clearManifold(d.mf[a].getPersistentManifold()))}if(h.length&&(d=c.triggerEvent(b.event.COLLIDE)))d.collisions=h}g=this.ghostObjects.length;for(a=0;a<g;a++)if(d=this.ghostObjects[a],f=d.getSceneObject())if((c=f.getEventHandler())&&c.hasEvent(b.event.CONTACT_GHOST))if(f=d.getBody(),h=f.getNumOverlappingObjects()){d=c.triggerEvent(b.event.CONTACT_GHOST);d.contacts=d.contacts||[];d.contacts.length>h&&(d.contacts.length=
h);for(c=0;c<h;c++)l=Ammo.btRigidBody.prototype.upcast(f.getOverlappingObject(c)),d.contacts[c]=l._cvr_rigidbody||null}},reset:function(){for(var a=0,b=this.rigidObjects.length;a<b;a++)this.rigidObjects[a].reset()},getRayHit:function(a,b,c,d){var e,a=o(a);e=o(b);c=c||!1;d=d||!1;b=new Ammo.ClosestRayResultCallback(a,e);this.dynamicsWorld.rayTest(a,e,b);if(b.hasHit()&&(body=Ammo.btRigidBody.prototype.upcast(b.get_m_collisionObject()),body!==Ammo.NULL&&!(body.isStaticObject()&&!c||body.isKinematicObject()&&
!d))){c=body;d=b.get_m_hitPointWorld();a=c.getCenterOfMassTransform().inverse().op_mul(d);if(e=c._cvr_rigidbody)return Ammo.destroy(b),{position:f(d),localPosition:f(a),rigidBody:e,ammoBody:c};Ammo.destroy(b);return{position:f(d),localPosition:f(a),rigidBody:null,ammoBody:c}}Ammo.destroy(b)}};return{ScenePhysics:w,Constraint:F,RigidProperties:function(a){this.type=m.parseEnum(b.physics.body,a.type);this.mass=a.mass!==d?a.mass:this.type?1:0;this.size=a.size||[1,1,1];this.restitution=a.restitution||
(this.type?0:1);this.friction=a.friction||1;if((this.collision=a.collision)&&!this.collision.getShapes)this.collision=new m.CollisionMap(this.collision);this.blocker=a.blocker||!1},RigidBody:t,vec3bt_copy:v,btvec3_copy:function(a,b){b[0]=a.x();b[1]=a.y();b[2]=a.z()},quatbt_copy:r,btquat_copy:l}});
CubicVR.RegisterModule("CollisionMap",function(m){var v=m.enums;v.collision={shape:{BOX:0,SPHERE:1,CYLINDER:2,CONE:3,CAPSULE:4,MESH:5,HEIGHTFIELD:6,CONVEX_HULL:7}};var r=function(l){this.shapes=[];this.result=null;if(l){l&&!l.length&&(l=[l]);for(var m=0,q=l.length;m<q;m++)this.addShape(l[m])}};r.prototype={addShape:function(l){l.type=m.parseEnum(v.collision.shape,l.type);l.position=l.position||[0,0,0];l.rotation=l.rotation||[0,0,0];l.size=l.size||[1,1,1];l.radius=l.radius||1;l.height=l.height||1;
l.margin=l.margin||0;l.mesh=l.mesh||null;this.shapes.push(l)},getShapes:function(){return this.shapes},setResult:function(l){this.result=l},getResult:function(){return this.result}};return{CollisionMap:r}});
CubicVR.RegisterModule("RigidVehicle",function(m){var v=m.undef,r=m.enums,l,o,q=function(e){var e=m.get(e)||{},d=e.mesh,b=e.collision;this.maxEngineForce=e.maxEngineForce||2E3;this.maxBreakingForce=e.maxBreakingForce||125;this.steeringClamp=e.steeringClamp||0.51;this.mass=e.mass||400;this.rightIndex=this.gVehicleSteering=this.gBreakingForce=this.gEngineForce=0;this.upIndex=1;this.forwardIndex=2;this.m_tuning=this.m_vehicle=this.m_vehicleRayCaster=null;this.wheelDirectionCS0=new Ammo.btVector3;this.wheelAxleCS=
new Ammo.btVector3;this.wheels=[];this.bodyMesh=d;this.bodyCollision=new m.CollisionMap(b);this.sceneObject=new m.SceneObject(this.bodyMesh);if(!l||!o)new Ammo.btVector3,new Ammo.btVector3,l=new Ammo.btTransform,o=new m.Quaternion,new Ammo.btQuaternion;if(e.wheels!=v){d=0;for(b=e.wheels.length;d<b;d++){var f=e.wheels[d];f instanceof m.VehicleWheel?this.addWheel(f):this.addWheel(new m.VehicleWheel(f))}}};q.prototype={getSceneObject:function(){return this.sceneObject},initBody:function(e){this.body=
new m.RigidBody(this.sceneObject,{collision:this.bodyCollision,mass:this.mass,restitution:0.1});m.vec3bt_copy([0,-1,0],this.wheelDirectionCS0);m.vec3bt_copy([-1,0,0],this.wheelAxleCS);this.gVehicleSteering=0;this.body.setLinearVelocity([0,0,0]);this.body.setAngularVelocity([0,0,0]);this.m_vehicleRayCaster=new Ammo.btDefaultVehicleRaycaster(e.dynamicsWorld);this.m_tuning=new Ammo.btVehicleTuning;this.m_vehicle=new Ammo.btRaycastVehicle(this.m_tuning,this.body.getBody(),this.m_vehicleRayCaster);this.body.getBody().setActivationState(r.physics.collision_states.DISABLE_DEACTIVATION);
this.m_vehicle.setCoordinateSystem(this.rightIndex,this.upIndex,this.forwardIndex);for(var d=new Ammo.btVector3,b=0;b<this.wheels.length;b++)m.vec3bt_copy(this.wheels[b].getWheelPosition(),d),this.m_vehicle.addWheel(d,this.wheelDirectionCS0,this.wheelAxleCS,this.wheels[b].getSuspensionRest(),this.wheels[b].getWheelRadius(),this.m_tuning,this.wheels[b].getSteering());e.dynamicsWorld.addVehicle(this.m_vehicle);e.bind(this.body);this.updateSuspension()},evaluate:function(){for(var e=this.m_vehicle.getNumWheels(),
d=0;d<e;d++){this.wheels[d].isSteering()&&this.m_vehicle.setSteeringValue(this.gVehicleSteering,d);this.wheels[d].isBraking()&&this.m_vehicle.setBrake(this.gBrakingForce,d);this.wheels[d].isDriving()&&this.m_vehicle.applyEngineForce(this.gEngineForce,d);this.m_vehicle.updateWheelTransform(d,!0);var b=this.m_vehicle.getWheelTransformWS(d),f=b.getOrigin();this.wheels[d].wheelObj.position[0]=f.x();this.wheels[d].wheelObj.position[1]=f.y();this.wheels[d].wheelObj.position[2]=f.z();b=b.getRotation();o.x=
b.x();o.y=b.y();o.z=b.z();o.w=b.w();b=o.toEuler();this.wheels[d].wheelObj.rotation[0]=b[0];this.wheels[d].wheelObj.rotation[1]=b[1];this.wheels[d].wheelObj.rotation[2]=b[2]}this.body.isActive()||this.body.activate();this.updateSceneObject(!0)},getRigidBody:function(){return this.body},updateSceneObject:function(e){if(this.body&&(this.body.isActive()||e))return this.body.getBody().getMotionState().getWorldTransform(l),e=l.getOrigin(),e.x!=e.x?console.log("origin is NaN"):(this.sceneObject.position[0]=
e.x(),this.sceneObject.position[1]=e.y(),this.sceneObject.position[2]=e.z()),e=l.getRotation(),o.x=e.x(),o.y=e.y(),o.z=e.z(),o.w=e.w(),o.x!=o.x?console.log("rotation is NaN"):(e=o.toEuler(),this.sceneObject.rotation[0]=e[0],this.sceneObject.rotation[1]=e[1],this.sceneObject.rotation[2]=e[2]),!0},setEngineForce:function(e){this.gEngineForce=e;this.gEngineForce>this.maxEngineForce&&(this.gEngineForce=this.maxEngineForce);this.gEngineForce<-this.maxEngineForce&&(this.gEngineForce=-this.maxEngineForce)},
getEngineForce:function(){return this.gEngineForce},incEngine:function(e){this.setEngineForce(this.getEngineForce()+e)},decEngine:function(e){this.setEngineForce(this.getEngineForce()-e)},setSteering:function(e){this.gVehicleSteering=e},getSteering:function(){return this.gVehicleSteering},incSteering:function(e){this.gVehicleSteering+=e;this.gVehicleSteering>this.steeringClamp&&(this.gVehicleSteering=this.steeringClamp);this.gVehicleSteering<-this.steeringClamp&&(this.gVehicleSteering=-this.steeringClamp)},
setBrake:function(e){this.gBreakingForce=e},getWheelGroundPosition:function(e){return this.wheels[e].wheelObj.getWorldPosition()-[0,wheels[e].getWheelRadius(),0]},getWheelSkid:function(e){return this.m_vehicle.getWheelInfo(e).get_m_skidInfo()},getRigidGround:function(e){this.m_vehicle.getWheelInfo(e)},addWheel:function(e,d){d===v&&(d=this.wheels.length);this.wheels[d]=e},getWheel:function(e){return this.wheels[e]},bindToScene:function(e){for(var d=this.wheels.length,b=0;b<d;b++)e.bind(this.getWheelObj(b));
e.bind(this.getSceneObject())},getWheelObj:function(e){return this.getWheel(e).wheelObj},updateSuspension:function(){var e,d=this.m_vehicle.getNumWheels();for(e=0;e<d;e++){var b=this.m_vehicle.getWheelInfo(e);b.set_m_suspensionStiffness(this.wheels[e].getSuspensionStiffness());b.set_m_suspensionRestLength1(this.wheels[e].getSuspensionRest());b.set_m_wheelsDampingRelaxation(this.wheels[e].getDampingRelaxation());b.set_m_wheelsDampingCompression(this.wheels[e].getDampingCompression());b.set_m_frictionSlip(this.wheels[e].getFrictionSlip());
b.set_m_rollInfluence(this.wheels[e].getRollInfluence());b.set_m_maxSuspensionForce(this.wheels[e].getMaxSuspensionForce());b.set_m_maxSuspensionTravelCm(this.wheels[e].getMaxSuspensionTravelCm())}if(this.m_vehicle){this.m_vehicle.resetSuspension();for(e=0;e<d;e++)this.m_vehicle.updateWheelTransform(e,!0)}},getMass:function(){return this.mass},setMass:function(e){this.mass=e;this.body&&this.body.setMass(this.mass)}};var f=function(e){e=m.get(e)||{};this.wheelRef=new m.SceneObject;this.wheelObj=new m.SceneObject;
this.wheelRef.scale=e.scale||[1,1,1];this.wheelRadius=e.radius||0;this.wheelWidth=e.width||0;e.mesh!=v&&this.setModel(e.mesh);this.suspensionStiffness=e.suspensionStiffness!=v?e.suspensionStiffness:5.88;this.suspensionRest=e.suspensionRest!=v?e.suspensionRest:0.05;this.dampingRelaxation=e.dampingRelaxation!=v?e.dampingRelaxation:0.88;this.dampingCompression=e.dampingCompression!=v?e.dampingCompression:0.83;this.frictionSlip=e.frictionSlip!=v?e.frictionSlip:10.5;this.rollInfluence=e.rollInfluence!=
v?e.rollInfluence:0.1;this.maxSuspensionForce=e.maxSuspensionForce!=v?e.maxSuspensionForce:6E3;this.maxSuspensionTravelCm=e.maxSuspensionTravelCm!=v?e.maxSuspensionTravelCm:500;this.wheelPosition=e.position||[0,0,0];this.wheelRotation=[0,0,0];this.steering=e.steering||!1;this.braking=e.braking||!1;this.driving=e.driving||!1};f.prototype={setModel:function(e,d,b){this.wheelModel=e;this.wheelRadius=d||0;this.wheelWidth=b||0;0===this.wheelRadius&&(this.wheelRadius=(this.wheelModel.bb[1][1]-this.wheelModel.bb[0][1])/
2,this.wheelRadius+=(this.wheelModel.bb[1][2]-this.wheelModel.bb[0][2])/2,this.wheelRadius/=2);0===this.wheelWidth&&(this.wheelWidth=this.wheelModel.bb[1][0]-this.wheelModel.bb[0][0]);this.wheelRef.obj=this.wheelModel;this.wheelObj.bindChild(this.wheelRef)},setSuspensionStiffness:function(e){this.suspensionStiffness=e},getSuspensionStiffness:function(){return this.suspensionStiffness},setSuspensionRest:function(e){this.suspensionRest=e},getSuspensionRest:function(){return this.suspensionRest},setDampingRelaxation:function(e){this.dampingRelaxation=
e},getDampingRelaxation:function(){return this.dampingRelaxation},setDampingCompression:function(e){this.dampingCompression=e},getDampingCompression:function(){return this.dampingCompression},setFrictionSlip:function(e){this.frictionSlip=e},getFrictionSlip:function(){return this.frictionSlip},setRollInfluence:function(e){this.rollInfluence=e},getRollInfluence:function(){return this.rollInfluence},setMaxSuspensionForce:function(e){this.maxSuspensionForce=e},getMaxSuspensionForce:function(){return this.maxSuspensionForce},
setMaxSuspensionTravelCm:function(e){this.maxSuspensionTravelCm=e},getMaxSuspensionTravelCm:function(){return this.maxSuspensionTravelCm},setWheelRadius:function(e){this.wheelRadius=e},getWheelRadius:function(){return this.wheelRadius},setWheelWidth:function(e){this.wheelWidth=e},getWheelWidth:function(){return this.wheelWidth},setWheelRotation:function(e){this.wheelRotation=e;this.wheelRef.setRotation(wheelRotation)},getWheelRotation:function(){return this.wheelRotation},setWheelPosition:function(e){this.wheelPosition=
e;this.wheelObj.position=wheelPosition},getWheelPosition:function(){return this.wheelPosition},setSteering:function(e){this.steering=e},getSteering:function(){return this.steering},isSteering:function(){return this.steering},setBraking:function(){this.braking=this.braking_in},isBraking:function(){return this.braking},setDriving:function(e){this.driving=e},isDriving:function(){return this.driving}};return{Vehicle:q,VehicleWheel:f}});window.CubicVRShader.CubicVRCoreVS="attribute vec3 vertexPosition;\nattribute vec3 vertexNormal;\nattribute vec2 vertexTexCoord;\n#if VERTEX_COLOR\nattribute vec3 vertexColor;\nvarying vec3 vertexColorOut;\n#endif\n#if VERTEX_MORPH\nattribute vec3 vertexMorphPosition;\nattribute vec3 vertexMorphNormal;\nuniform float materialMorphWeight;\n#endif\n#if POINT_SIZE||POINT_SPRITE\nuniform float pointSize;\n#endif\n#if POINT_SIZE && !POINT_SPRITE && POINT_CIRCLE\nvarying float ptSize;\n#if POINT_CIRCLE\nvarying vec2 sPos;\nuniform vec3 viewPort;\n#endif\n#endif\nvarying vec2 vertexTexCoordOut;\nuniform vec2 materialTexOffset;\n#if !LIGHT_PERPIXEL\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\nuniform vec3 lightDirection[LIGHT_COUNT];\nuniform vec3 lightPosition[LIGHT_COUNT];\nuniform vec3 lightSpecular[LIGHT_COUNT];\nuniform vec3 lightDiffuse[LIGHT_COUNT];\nuniform float lightIntensity[LIGHT_COUNT];\nuniform float lightDistance[LIGHT_COUNT];\n#if LIGHT_IS_SPOT\nuniform float lightCutOffAngle[LIGHT_COUNT];\n#endif\nvarying vec3 lightColorOut;\nvarying vec3 lightSpecularOut;\n#endif\nuniform vec3 materialDiffuse;\nuniform vec3 materialSpecular;\nuniform float materialShininess;\n#endif\nuniform mat4 matrixModelView;\nuniform mat4 matrixProjection;\nuniform mat4 matrixObject;\nuniform mat3 matrixNormal;\nvarying vec3 vertexNormalOut;\nvarying vec4 vertexPositionOut;\n#if !LIGHT_DEPTH_PASS\n#if LIGHT_SHADOWED\nvarying vec4 lightProjectionOut[LIGHT_COUNT];\nuniform mat4 lightShadowMatrix[LIGHT_COUNT];\n#endif\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nvarying vec3 envTexCoordOut;\n#else\nvarying vec2 envTexCoordOut;\n#endif\n#endif\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvarying vec3 envEyeVectorOut;\n#endif\n#endif \nvoid cubicvr_normalMap() {\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvec3 tangent;\nvec3 binormal;\nvec3 c1 = cross( vertexNormal, vec3(0.0, 0.0, 1.0) );\nvec3 c2 = cross( vertexNormal, vec3(0.0, 1.0, 0.0) );\nif ( length(c1) > length(c2) )  {\ntangent = c1;\n}  else {\ntangent = c2;\n}\ntangent = normalize(tangent);\nbinormal = cross(vertexNormal, tangent);\nbinormal = normalize(binormal);\nmat4 uMVOMatrix = matrixModelView * matrixObject;\nmat3 TBNMatrix = mat3( (vec3 (uMVOMatrix * vec4 (tangent, 0.0))),\n(vec3 (uMVOMatrix * vec4 (binormal, 0.0))),\n(vec3 (uMVOMatrix * vec4 (vertexNormal, 0.0)))\n);\nenvEyeVectorOut = vec3(uMVOMatrix * vec4(vertexPosition,1.0)) * TBNMatrix;\n#endif\n#endif\n}\nvoid cubicvr_environmentMap() {\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nenvTexCoordOut = normalize( vertexPositionOut.xyz );\n#else\nvec3 ws = (matrixModelView * vec4(vertexPosition,1.0)).xyz;\nvec3 r = reflect(ws, vertexNormalOut );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nenvTexCoordOut.s = r.x/m + 0.5;\nenvTexCoordOut.t = r.y/m + 0.5;\n#endif\n#endif\n#if VERTEX_COLOR\nvertexColorOut = vertexColor;\n#endif\n#endif\n}\nvoid cubicvr_shadowMap() {\n#if (LIGHT_IS_SPOT||LIGHT_IS_AREA) && LIGHT_SHADOWED\nfor (int i = 0; i < LIGHT_COUNT; i++)\n{\n#if LIGHT_SHADOWED\n#if VERTEX_MORPH\nlightProjectionOut[i] = lightShadowMatrix[i] * (matrixObject * vec4(vertexPosition+(vertexMorphPosition-vertexPosition)*materialMorphWeight, 1.0));\n#else\nlightProjectionOut[i] = lightShadowMatrix[i] * (matrixObject * vec4(vertexPosition, 1.0));\n#endif\n#endif\n}\n#endif\n}\nvoid cubicvr_lighting() {\n#if !LIGHT_PERPIXEL\n#if LIGHT_IS_POINT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 lightDirection = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(lightDirection);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lightDirection);\nfloat NdotL = max(dot(normalize(lightDirection),vertexNormalOut),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\naccum += att * NdotL * lightDiffuse[i] * materialDiffuse;\nfloat NdotHV = max(dot(vertexNormalOut, halfVector),0.0);\nvec3 spec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\nspecTotal += spec2;\n}\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#if LIGHT_IS_DIRECTIONAL\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),vertexNormalOut),0.0);\nif (NdotL > 0.0)   {\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\nNdotHV = max(dot(vertexNormalOut, halfVector),0.0);\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\nspecTotal += spec2;\n}\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#if LIGHT_IS_SPOT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 l = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lightDirection[i]));\nif ( spotDot < cos((lightCutOffAngle[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\natt *= spotEffect;\nvec3 v = normalize(-vertexPositionOut.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(vertexNormalOut, normalize(l)));\nfloat NdotH = max(0.0, dot(vertexNormalOut, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, materialShininess);\n}\nelse {\npower = 0.0;\n}\naccum += att * lightDiffuse[i] * materialDiffuse * NdotL;\nspec2 = lightSpecular[i] * materialSpecular * power;\nspecTotal += spec2*spotEffect;\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#endif \ncubicvr_normalMap();\ncubicvr_shadowMap();\ncubicvr_environmentMap();\n}\nvec2 cubicvr_texCoord() {\nreturn vertexTexCoord + materialTexOffset;\n}\nvec4 cubicvr_transform() {\n#if LIGHT_DEPTH_PASS\nvertexNormalOut = vec3(0.0,0.0,0.0);\n#endif\n#if VERTEX_MORPH\nvec4 vPos = matrixObject * vec4(vertexPosition+(vertexMorphPosition-vertexPosition)*materialMorphWeight, 1.0);\n#else\nvec4 vPos = matrixObject * vec4(vertexPosition, 1.0);\n#endif\nvertexPositionOut = matrixModelView * vPos;\n#if POINT_SIZE||POINT_SPRITE\nfloat d = length(vertexPositionOut);\ngl_PointSize = pointSize * sqrt( 1.0/(1.0 + d*d) );\n#if !POINT_SPRITE && POINT_CIRCLE\nptSize = gl_PointSize;\nvec4 screenPos = vec4(matrixProjection * vertexPositionOut);\nsPos = (screenPos.xy/screenPos.w)*vec2(viewPort.x/2.0,viewPort.y/2.0)+vec2(viewPort.x/2.0+0.5,viewPort.y/2.0+0.5);\n#endif\n#endif\nreturn vPos;\n}\nvec3 cubicvr_normal() {\n#if VERTEX_MORPH\nreturn normalize(matrixObject*vec4(vertexNormal+(vertexMorphNormal-vertexNormal)*materialMorphWeight,0.0)).xyz;\n#else\nreturn normalize(matrixObject*vec4(vertexNormal,0.0)).xyz;\n#endif\n}\n#define customShader_splice 1\nvoid main(void)\n{\nvertexTexCoordOut = cubicvr_texCoord();\ngl_Position =  matrixProjection * matrixModelView * cubicvr_transform();\n#if !LIGHT_DEPTH_PASS  \nvertexNormalOut = matrixNormal * cubicvr_normal();\ncubicvr_lighting();\n#endif \n}\n";
window.CubicVRShader.CubicVRCoreFS="#ifdef GL_ES\n#if LIGHT_PERPIXEL\nprecision mediump float;\n#else\nprecision lowp float;\n#endif\n#endif\n#if FOG_ENABLED\nuniform vec3 fogColor;\nuniform float fogDensity;\nuniform float fogNear;\nuniform float fogFar;\n#endif\nuniform vec3 materialAmbient;\nuniform vec3 lightAmbient;\nuniform vec3 materialColor;\n#if POINT_SIZE && !POINT_SPRITE && POINT_CIRCLE\nvarying float ptSize;\nvarying vec2 sPos;\n#endif\n#if LIGHT_PERPIXEL\nuniform vec3 materialDiffuse;\nuniform vec3 materialSpecular;\nuniform float materialShininess;\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\nuniform vec3 lightDirection[LIGHT_COUNT];\nuniform vec3 lightPosition[LIGHT_COUNT];\nuniform vec3 lightSpecular[LIGHT_COUNT];\nuniform vec3 lightDiffuse[LIGHT_COUNT];\nuniform float lightIntensity[LIGHT_COUNT];\nuniform float lightDistance[LIGHT_COUNT];\n#if LIGHT_IS_SPOT\nuniform float lightCutOffAngle[LIGHT_COUNT];\n#endif\n#endif\n#if LIGHT_IS_PROJECTOR\nuniform sampler2D lightProjectionMap[LIGHT_COUNT];\n#endif\n#if LIGHT_SHADOWED\nvarying vec4 lightProjectionOut[LIGHT_COUNT];\nuniform sampler2D lightShadowMap[LIGHT_COUNT];\nuniform vec3 lightDepthClip[LIGHT_COUNT];\n#endif\n#else \nvarying vec3 lightColorOut;\nvarying vec3 lightSpecularOut;\n#endif  \nvarying vec3 vertexNormalOut;\nvarying vec2 vertexTexCoordOut;\n#if VERTEX_COLOR\nvarying vec3 vertexColorOut;\n#endif\n#if FX_DEPTH_ALPHA||LIGHT_DEPTH_PASS||LIGHT_SHADOWED\nuniform vec3 postDepthInfo;\nfloat ConvertDepth3(float d) { return (postDepthInfo.x*postDepthInfo.y)/(postDepthInfo.y-d*(postDepthInfo.y-postDepthInfo.x));  }\nfloat DepthRange( float d ) { return ( d - postDepthInfo.x ) / ( postDepthInfo.y - postDepthInfo.x ); }\nfloat ConvertDepth3A(float d, float near, float far) { return (near*far)/(far-d*(far-near));  }\nfloat DepthRangeA( float d, float near, float far ) { return ( d - near ) / ( far - near ); }\n#endif\n#if LIGHT_DEPTH_PASS\nvec4 packFloatToVec4i(const float value)\n{\nconst vec4 bitSh = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\nconst vec4 bitMsk = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\nvec4 res = fract(value * bitSh);\nres -= res.xxyz * bitMsk;\nreturn res;\n}\n#endif\n#if LIGHT_SHADOWED\nfloat unpackFloatFromVec4i(const vec4 value)\n{\nconst vec4 bitSh = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\nreturn(dot(value, bitSh));\n}\n#if LIGHT_SHADOWED_SOFT\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec2 filterTaps[6];\nfilterTaps[0] = vec2(-0.326212,-0.40581);\nfilterTaps[1] = vec2(-0.840144,-0.07358);\nfilterTaps[2] = vec2(-0.695914,0.457137);\nfilterTaps[3] = vec2(-0.203345,0.620716);\nfilterTaps[4] = vec2(0.96234,-0.194983);\nfilterTaps[5] = vec2(0.473434,-0.480026);\n/*  filterTaps[6] = vec2(0.519456,0.767022);\nfilterTaps[7] = vec2(0.185461,-0.893124);\nfilterTaps[8] = vec2(0.507431,0.064425);\nfilterTaps[9] = vec2(0.89642,0.412458) ;\nfilterTaps[10] =vec2(-0.32194,-0.932615);\nfilterTaps[11] =vec2(-0.791559,-0.59771); */\nfloat shadow = 0.0;\nvec4  shadowSample;\nfloat distanceFromLight;\nfor (int i = 0; i < 6; i++) {\nshadowSample = texture2D(shadowTex,shadowCoord.st+filterTaps[i]*(2.0*texel_size));\ndistanceFromLight = unpackFloatFromVec4i(shadowSample);\nshadow += distanceFromLight <= shadowCoord.z ? 0.0 : 1.0 ;\n}\nshadow /= 6.0;\nreturn shadow;\n}\n#else\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec4 shadowSample = texture2D(shadowTex,shadowCoord.st);\nfloat distanceFromLight = unpackFloatFromVec4i(shadowSample);\nfloat shadow = 1.0;\nshadow = distanceFromLight <= (shadowCoord.z) ? 0.0 : 1.0 ;\nreturn shadow;\n}\n#endif\n#endif\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_COLOR\nuniform sampler2D textureColor;\n#endif\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvarying vec3 envEyeVectorOut;\n#endif\n#if TEXTURE_BUMP\nuniform sampler2D textureBump;\n#endif\n#if TEXTURE_ENVSPHERE\nuniform sampler2D textureEnvSphere;\nuniform float materialEnvironment;\n#if TEXTURE_NORMAL\nvarying vec3 envTexCoordOut;\n#else\nvarying vec2 envTexCoordOut;\n#endif\n#endif\n#if TEXTURE_REFLECT\nuniform sampler2D textureReflect;\n#endif\n#if TEXTURE_NORMAL\nuniform sampler2D textureNormal;\n#endif\nuniform float materialAlpha;\n#if TEXTURE_AMBIENT\nuniform sampler2D textureAmbient;\n#endif\n#if TEXTURE_SPECULAR\nuniform sampler2D textureSpecular;\n#endif\n#endif \n#if TEXTURE_ALPHA\nuniform sampler2D textureAlpha;\n#endif\nvarying vec4 vertexPositionOut;\nvec2 cubicvr_texCoord() {\n#if LIGHT_DEPTH_PASS\nreturn vertexTexCoordOut;\n#else\n#if POINT_SPRITE\nreturn gl_PointCoord;\n#else\n#if TEXTURE_BUMP\nfloat height = texture2D(textureBump, vertexTexCoordOut.xy).r;\nfloat v = (height) * 0.05 - 0.04; \nvec3 eye = normalize(envEyeVectorOut);\nreturn vertexTexCoordOut.xy + (eye.xy * v);\n#else\nreturn vertexTexCoordOut;\n#endif\n#endif\n#endif\n}\n#if TEXTURE_NORMAL && OES_STANDARD_DERIVATIVES && !LIGHT_DEPTH_PASS\n#extension GL_OES_standard_derivatives : enable\nmat3 cotangent_frame( vec3 N, vec3 p, vec2 uv ) {\nvec3 dp1 = dFdx( p );\nvec3 dp2 = dFdy( p );\nvec2 duv1 = dFdx( uv );\nvec2 duv2 = dFdy( uv );\nvec3 dp2perp = cross( dp2, N );\nvec3 dp1perp = cross( N, dp1 );\nvec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\nvec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\nfloat invmax = inversesqrt( max( dot(T,T), dot(B,B) ) );\nreturn mat3( T * invmax, B * invmax, N );\n}\n#define WITH_NORMALMAP_UNSIGNED 1\nvec3 perturb_normal( vec3 N, vec3 V, vec2 texCoord ) {\nvec3 map = texture2D( textureNormal, texCoord ).xyz;\n#ifdef WITH_NORMALMAP_UNSIGNED\nmap = map * 255./127. - 128./127.;\n#endif\n#ifdef WITH_NORMALMAP_2CHANNEL\nmap.z = sqrt( 1. - dot( map.xy, map.xy ) );\n#endif\n#ifdef WITH_NORMALMAP_GREEN_UP\nmap.y = -map.y;\n#endif\nmat3 TBN = cotangent_frame( N, -V, texCoord );\nreturn normalize( TBN * map );\n}\n#endif\nvec3 cubicvr_normal(vec2 texCoord) {\n#if TEXTURE_NORMAL && !LIGHT_DEPTH_PASS\n#if OES_STANDARD_DERIVATIVES\nreturn perturb_normal(vertexNormalOut, vertexPositionOut.xyz, texCoord);\n#else\nvec3 bumpNorm = vec3(texture2D(textureNormal, texCoord));\nvec3 n = (vec4(normalize(vertexNormalOut),1.0)).xyz;\nbumpNorm = (bumpNorm-0.5)*2.0;\nbumpNorm.y = -bumpNorm.y;\nreturn normalize((n+bumpNorm)/2.0);\n#endif\n#else\nreturn normalize(vertexNormalOut);\n#endif\n}\n#if FOG_ENABLED\nvec4 apply_fog(vec4 color) {\nvec4 outColor = color;\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n#if USE_FOG_EXP\nconst float LOG2 = 1.442695;\nfloat fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );\nfogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );\noutColor = mix( color, vec4( fogColor, color.w ), fogFactor );\n#endif\n#if USE_FOG_LINEAR\nfloat fogFactor = smoothstep( fogNear, fogFar, depth );\noutColor = mix( color, vec4( fogColor, color.w ), fogFactor );\n#endif\nreturn outColor;\n}\n#endif\nvec4 cubicvr_color(vec2 texCoord) {\nvec4 color = vec4(0.0,0.0,0.0,0.0);\n#if POINT_SIZE && !POINT_SPRITE && POINT_CIRCLE\nif (length(sPos-(gl_FragCoord.xy)) > ptSize/2.0) {\ndiscard;\n}\n#endif\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_COLOR\n#if !(LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA)\ncolor = texture2D(textureColor, texCoord).rgba;\ncolor.rgb *= materialColor;\n#else\ncolor = texture2D(textureColor, texCoord).rgba;\n#if !TEXTURE_ALPHA\nif (color.a<=0.9) {\ndiscard;\n}\n#endif\ncolor.rgb *= materialColor;\n#endif\n#if VERTEX_COLOR\ncolor *= vec4(vertexColorOut,1.0);\n#endif\n#else\n#if VERTEX_COLOR\ncolor = vec4(vertexColorOut,1.0);\n#else\ncolor = vec4(materialColor,1.0);\n#endif\n#endif\n#if TEXTURE_ALPHA\ncolor.a = texture2D(textureAlpha, texCoord).r;\n#if FX_DEPTH_ALPHA\nif (color.a < 0.9) discard;\n#else\n#if MATERIAL_ALPHA\ncolor.a *= materialAlpha;\n#else\nif (color.a < 0.9) discard;\n#endif\n#endif\n#else\n#if MATERIAL_ALPHA\ncolor.a = materialAlpha;\n#endif\n#endif\n#endif\nreturn color;\n}\nvec4 cubicvr_lighting(vec4 color_in, vec3 n, vec2 texCoord) {\nvec4 color = color_in;\n#if !LIGHT_DEPTH_PASS\nvec3 accum = lightAmbient;\n#if LIGHT_PERPIXEL\n#if LIGHT_IS_POINT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 lightDirection = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(lightDirection);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lightDirection);\nfloat NdotL = max(dot(normalize(lightDirection),n),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\naccum += att * NdotL * lightDiffuse[i] * materialDiffuse;\nfloat NdotHV = max(dot(n, halfVector),0.0);\n#if TEXTURE_SPECULAR\nvec3 spec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nvec3 spec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_DIRECTIONAL\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),n),0.0);\nif (NdotL > 0.0)   {\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\nNdotHV = max(dot(n, halfVector),0.0);\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_AREA\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),n),0.0);\nif (NdotL > 0.0)   {\nNdotHV = max(dot(n, halfVector),0.0);\n#if LIGHT_SHADOWED\nvec4 shadowCoord = lightProjectionOut[i] / lightProjectionOut[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lightDepthClip[i].x,lightDepthClip[i].y),lightDepthClip[i].x,lightDepthClip[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s > 0.000&&shadowCoord.s < 1.000 && shadowCoord.t > 0.000 && shadowCoord.t < 1.000) if (i == 0) { shadow = getShadowVal(lightShadowMap[0],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);}\n#if LIGHT_COUNT>1\nif (i == 1) { shadow = getShadowVal(lightShadowMap[1],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>2\nif (i == 2) { shadow = getShadowVal(lightShadowMap[2],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>3\nif (i == 3) { shadow = getShadowVal(lightShadowMap[3],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>4\nif (i == 4) { shadow = getShadowVal(lightShadowMap[4],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>5\nif (i == 5) { shadow = getShadowVal(lightShadowMap[5],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>6\nif (i == 6) { shadow = getShadowVal(lightShadowMap[6],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>7\nif (i == 7) { shadow = getShadowVal(lightShadowMap[7],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\naccum += shadow * lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n#else\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n#endif\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\n#if LIGHT_SHADOWED\nspec2 *= shadow;\n#endif\nspecTotal += spec2;\n#if LIGHT_SHADOWED\n#endif\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_SPOT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 l = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lightDirection[i]));\nif ( spotDot < cos((lightCutOffAngle[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\n#if !LIGHT_IS_PROJECTOR\natt *= spotEffect;\n#endif\nvec3 v = normalize(-vertexPositionOut.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(n, normalize(l)));\nfloat NdotH = max(0.0, dot(n, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, materialShininess);\n}\nelse {\npower = 0.0;\n}\n#if LIGHT_SHADOWED\nvec4 shadowCoord = lightProjectionOut[i] / lightProjectionOut[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lightDepthClip[i].x,lightDepthClip[i].y),lightDepthClip[i].x,lightDepthClip[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s >= 0.000&&shadowCoord.s <= 1.000 && shadowCoord.t >= 0.000 && shadowCoord.t <= 1.000) if (i == 0) { shadow = getShadowVal(lightShadowMap[0],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);}\n#if LIGHT_COUNT>1\nif (i == 1) { shadow = getShadowVal(lightShadowMap[1],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>2\nif (i == 2) { shadow = getShadowVal(lightShadowMap[2],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>3\nif (i == 3) { shadow = getShadowVal(lightShadowMap[3],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>4\nif (i == 4) { shadow = getShadowVal(lightShadowMap[4],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>5\nif (i == 5) { shadow = getShadowVal(lightShadowMap[5],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>6\nif (i == 6) { shadow = getShadowVal(lightShadowMap[6],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>7\nif (i == 7) { shadow = getShadowVal(lightShadowMap[7],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\natt = att * shadow;\n#endif\n#if LIGHT_IS_PROJECTOR && LIGHT_SHADOWED\nif (shadowCoord.s >= 0.0&&shadowCoord.s <= 1.0 && shadowCoord.t >= 0.0 && shadowCoord.t <= 1.0 && spotDot > cos((90.0)*(3.14159/180.0))) {\nvec3 projTex = texture2D(lightProjectionMap[i],shadowCoord.st).rgb;\naccum += att * projTex * lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n}\n#else\naccum += att * lightDiffuse[i] * materialDiffuse * NdotL;\n#endif\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * power;\n#else\nspec2 = lightSpecular[i] * materialSpecular * power;\n#endif\n#if LIGHT_SHADOWED\nspec2 *= shadow;\n#endif\nspecTotal += spec2*spotEffect;\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#if LIGHT_SHADOWED\n#endif\n#endif\n#else\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\ncolor.rgb *= lightColorOut;\ncolor.rgb += lightSpecularOut;\n#endif\n#endif \n#if TEXTURE_AMBIENT\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\ncolor.rgb += texture2D(textureAmbient, texCoord).rgb*(vec3(1.0,1.0,1.0)+materialColor*materialAmbient);\n#else\ncolor.rgb = color.rgb*texture2D(textureAmbient, texCoord).rgb;\n#endif\n#else\n#if TEXTURE_COLOR\ncolor.rgb += materialAmbient*texture2D(textureColor, texCoord).rgb;\n#else\ncolor.rgb += materialColor*materialAmbient;\n#endif\n#endif\n#endif\n#if FOG_ENABLED\nreturn apply_fog(color);\n#else\nreturn color;\n#endif\n}\nvec4 cubicvr_environment(vec4 color_in, vec3 n, vec2 texCoord) {\nvec4 color = color_in;\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_REFLECT\nfloat environmentAmount = texture2D( textureReflect, texCoord).r;\n#endif\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nvec3 r = reflect( envTexCoordOut, n );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nvec3 coord;\ncoord.s = r.x/m + 0.5;\ncoord.t = r.y/m + 0.5;\n#if TEXTURE_REFLECT\ncolor.rgb += materialColor*texture2D( textureEnvSphere, coord.st).rgb * environmentAmount;\n#else\ncolor.rgb += materialColor*texture2D( textureEnvSphere, coord.st).rgb * materialEnvironment;\n#endif\n#else\n#if TEXTURE_REFLECT\ncolor.rgb += materialColor*texture2D( textureEnvSphere, envTexCoordOut).rgb * environmentAmount;\n#else\ncolor.rgb += materialColor*texture2D( textureEnvSphere, envTexCoordOut).rgb * materialEnvironment;\n#endif\n#endif\n#endif \n#endif \n#if FX_DEPTH_ALPHA\n#if !MATERIAL_ALPHA\nfloat linear_depth = DepthRange( ConvertDepth3(gl_FragCoord.z) );\ncolor.a = linear_depth;\n#endif\n#endif\nreturn color;\n}\n#if LIGHT_DEPTH_PASS\nvec4 cubicvr_depthPack(vec2 texCoord) {\n#if TEXTURE_ALPHA\nfloat alphaVal = texture2D(textureAlpha, texCoord).r;\nif (alphaVal < 0.9) discard;\n#endif\nreturn packFloatToVec4i(DepthRange( ConvertDepth3(gl_FragCoord.z)));\n}\n#endif\n#define customShader_splice 1\nvoid main(void)\n{\nvec2 texCoord = cubicvr_texCoord();\n#if !LIGHT_DEPTH_PASS\nvec4 color = cubicvr_color(texCoord);\nvec3 normal = cubicvr_normal(texCoord);\ncolor = cubicvr_environment(color,normal,texCoord);\ncolor = cubicvr_lighting(color,normal,texCoord);\ngl_FragColor = clamp(color,0.0,1.0);\n#else \ngl_FragColor = cubicvr_depthPack(texCoord);\n#endif\n}\n";
